# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# SUMMA SOCIAL - REFER√àNCIA COMPLETA DEL PROJECTE
# Versi√≥ 1.26 - Desembre 2025
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 0. AQUEST DOCUMENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Aquest document √©s la **REFER√àNCIA MESTRA** de Summa Social.

Defineix:
- La visi√≥ del producte
- L'arquitectura funcional
- El model de dades
- Les funcionalitats existents i previstes
- Els l√≠mits i l'√†mbit del producte

**Jerarquia de documents:**
- Aquest document t√© **PRIORITAT ABSOLUTA**
- Qualsevol altre document (guies de desenvolupament, prompts per IA, manuals d'usuari, etc.) √©s complementari
- En cas de conflicte entre documents, aquest text **SEMPRE** t√© prioritat
- Cap LLM ni desenvolupador pot contradir el que est√† escrit aqu√≠

**Quan usar aquest document:**
- Per entendre qu√® fa i qu√® NO fa Summa Social
- Per prendre decisions de producte
- Per validar si una nova funcionalitat encaixa amb la visi√≥
- Per donar context a qualsevol IA que treballi amb el projecte

**Estructura de la documentaci√≥:**
```
/docs
‚îú‚îÄ‚îÄ SUMMA-SOCIAL-REFERENCIA-COMPLETA.md   # Aquest document (mestre)
‚îú‚îÄ‚îÄ DEV-SOLO-MANUAL.md                     # Manual operatiu pel mantenidor (NOU v1.20)
‚îú‚îÄ‚îÄ CHANGELOG.md                           # Historial de canvis detallat
‚îú‚îÄ‚îÄ manual-usuari-summa-social.md          # Per a usuaris finals
‚îî‚îÄ‚îÄ CATALEG-FUNCIONALITATS.md              # Refer√®ncia r√†pida de funcionalitats
```


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 1. INFORMACI√ì GENERAL
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 1.1 Qu√® √©s Summa Social?

Summa Social √©s una aplicaci√≥ web de gesti√≥ financera dissenyada espec√≠ficament per a petites i mitjanes entitats sense √†nim de lucre d'Espanya. L'aplicaci√≥ substitueix els fulls de c√†lcul (Excel/Google Sheets) per una eina intel¬∑ligent i centralitzada.

## 1.2 Problema que Resol

Les entitats espanyoles gestionen les seves finances amb fulls de c√†lcul, cosa que provoca:
- Errors humans en la categoritzaci√≥ de moviments
- Dificultat per generar informes fiscals obligatoris (Model 182, Model 347)
- Impossibilitat de tenir una visi√≥ consolidada de les finances
- P√®rdua de temps en tasques repetitives
- Dificultats per fer seguiment de donants i prove√Ødors
- Problemes per emetre certificats de donaci√≥
- Conciliaci√≥ banc√†ria manual i propensa a errors
- Gesti√≥ manual de devolucions banc√†ries

## 1.3 Soluci√≥

Eina centralitzada amb:
- Importaci√≥ autom√†tica d'extractes bancaris (CSV/XLSX)
- Categoritzaci√≥ intel¬∑ligent amb IA (Gemini)
- Auto-assignaci√≥ de contactes als moviments
- Generaci√≥ autom√†tica d'informes fiscals (Excel per gestoria)
- Certificats de donaci√≥ PDF amb firma digitalitzada
- Dashboard amb m√®triques en temps real
- Multi-organitzaci√≥ amb sistema de rols
- Divisor de remeses amb matching intel¬∑ligent
- **Importador de devolucions del banc (NOU v1.8)**
- **Importador de donacions Stripe (NOU v1.9)**
- **Multicomptes bancaris amb filtre i tra√ßabilitat (NOU v1.12)**

## 1.4 URLs i Recursos

| Recurs | URL |
|--------|-----|
| **Producci√≥** | https://summasocial.app |
| **Hosting Firebase** | https://studio--summa-social.us-central1.hosted.app |
| **Repositori** | https://github.com/raulvico1975/summa-social |
| **Entorn desenvolupament** | VS Code + Claude Code |

## 1.5 Stack Tecnol√≤gic

| Component | Tecnologia | Versi√≥ |
|-----------|------------|--------|
| Frontend | Next.js (App Router) | 14.x |
| Llenguatge | TypeScript | 5.x |
| UI Components | shadcn/ui | - |
| Estils | Tailwind CSS | 3.x |
| Base de dades | Firebase Firestore | - |
| Autenticaci√≥ | Firebase Auth | - |
| Emmagatzematge | Firebase Storage | - |
| IA | Genkit + Google Gemini | - |
| Idiomes | Catal√†, Espanyol, Franc√®s i Portugu√®s | i18n |
| Excel/CSV | SheetJS (xlsx) | - |
| PDF | jsPDF | - |

## 1.6 Sobre l'Usuari Desenvolupador

- **Nom**: Raul
- **Perfil**: NO programador - Assessor d'entitats que porta els comptes de diverses organitzacions
- **Entorn**: VS Code + Claude Code
- **Necessitats**: Codi COMPLET (mai fragments), passos verificables, respostes en CATAL√Ä

## 1.7 Prioritats Estrat√®giques 2025-2026

Per a les properes versions, Summa Social se centra en **dos blocs principals**:

### Bloc 1: Conciliaci√≥ Banc√†ria Real

| Funcionalitat | Descripci√≥ | Estat |
|---------------|------------|-------|
| **Multicomptes bancaris** | Suport per m√∫ltiples comptes amb filtre i tra√ßabilitat | ‚úÖ Implementat v1.12 |
| **Regles deterministes** | Categoritzaci√≥ autom√†tica per patrons de text (loteria, voluntariat) | ‚úÖ Implementat v1.12 |
| **Gesti√≥ de devolucions** | Importador de fitxers del banc, remeses parcials | ‚úÖ Implementat v1.8 |

### Bloc 2: Fiscalitat Fina Orientada a Gestoria

| Funcionalitat | Descripci√≥ | Estat |
|---------------|------------|-------|
| **Dades m√≠nimes obligat√≤ries** | CP i adre√ßa per Model 182 | ‚úÖ Implementat |
| **Consolidaci√≥ anual** | Import total per donant/prove√Ødor amb devolucions aplicades | ‚úÖ Implementat |
| **Excel net per gestoria** | Format est√†ndard Model 182 amb recurr√®ncia | ‚úÖ Implementat v1.7 |
| **Importador Stripe** | Dividir remeses Stripe amb tra√ßabilitat completa (donacions + comissions) | ‚úÖ Implementat v1.9 |

### Criteri de Prioritzaci√≥

> ‚ö†Ô∏è **Qualsevol nova funcionalitat s'ha de valorar segons si contribueix a aquests dos objectius.**
>
> Si una funcionalitat no millora la conciliaci√≥ banc√†ria ni la preparaci√≥ fiscal, **NO √©s priorit√†ria**.


## 1.8 Millores Transversals

A m√©s dels dos blocs prioritaris, Summa Social incorpora un conjunt de **millores transversals** que s√≥n sempre admissibles i prioritzables.

> ‚úÖ Aquestes l√≠nies de millora es poden implementar en **qualsevol moment**, sense necessitat d'avaluaci√≥ estrat√®gica addicional.

### 1.8.1 Millores de Robustesa
- Correcci√≥ d'errors o comportaments inesperats
- Validacions addicionals per evitar dades incompletes
- Maneig d'errors m√©s predictible i informatiu

### 1.8.2 Millores de Rendiment
- Optimitzaci√≥ de consultes i paginaci√≥ a Firestore
- Reducci√≥ de renders innecessaris en components React
- Simplificaci√≥ de fluxos intensius en mem√≤ria o c√†lcul

### 1.8.3 Millores de Seguretat
- Refor√ß de la protecci√≥ de dades sensibles
- Validaci√≥ estricta de l'input de l'usuari
- Millora i revisi√≥ del sistema de permisos i rols

### 1.8.4 Millores d'Experi√®ncia d'Usuari (UX/UI)
- Simplificaci√≥ d'interf√≠cies o formularis sense alterar funcionalitats
- Clarificaci√≥ de textos, etiquetes i missatges
- Reducci√≥ de passos innecessaris en fluxos d'√∫s actuals
- **Regla 10s** (NOU v1.11): qualsevol acci√≥ de captura m√≤bil ha de completar-se en menys de 10 segons

### 1.8.5 Millores de Mantenibilitat
- Refactors orientats a reduir complexitat o duplicaci√≥
- Reorganitzaci√≥ de fitxers o components per guanyar llegibilitat
- Eliminaci√≥ de depend√®ncies innecess√†ries o obsoletes

### 1.8.6 Millores de Diagn√≤stic i Observabilitat
- Logs m√©s clars i estructurats
- Avisos o mecanismes per facilitar la depuraci√≥
- Indicadors interns per detectar problemes

#### Logs Estructurats de Categoritzaci√≥ IA

El sistema de categoritzaci√≥ IA genera logs estructurats per facilitar el diagn√≤stic. Tots els logs utilitzen el prefix `[IA]`.

**Format dels logs:**

| Event | Format | Exemple |
|-------|--------|---------|
| Inici individual | `[IA] Iniciant categoritzacio per: "{desc}..."` | `[IA] Iniciant categoritzacio per: "TRANSFERENCIA DE N√íMINA..."` |
| √àxit individual | `[IA] OK: category="{cat}" confidence={n}% model=gemini-2.0-flash` | `[IA] OK: category="N√≤mines" confidence=95% model=gemini-2.0-flash` |
| Error individual | `[IA] ERROR: code={code} reason="{msg}" model=gemini-2.0-flash` | `[IA] ERROR: code=QUOTA_EXCEEDED reason="Quota exceeded" model=gemini-2.0-flash` |
| Inici batch | `[IA] Iniciant classificacio SEQ√úENCIAL de {n} moviments{mode}.` | `[IA] Iniciant classificacio SEQ√úENCIAL de 25 moviments (MODE R√ÄPID).` |
| Progr√©s batch | `[IA] Classificant {i}/{n}: "{desc}..."` | `[IA] Classificant 3/25: "PAGAMENT LLOGU..."` |
| √àxit batch item | `[IA] ‚úì {txId} ‚Üí "{category}"` | `[IA] ‚úì abc123 ‚Üí "Lloguer"` |
| Error batch item | `[IA] ‚úó {txId}: {code} - {message}` | `[IA] ‚úó abc123: RATE_LIMITED - Rate limited` |
| Backoff | `[IA] Backoff: nou delay = {ms}ms` | `[IA] Backoff: nou delay = 3000ms` |
| Quota esgotada | `[IA] QUOTA EXCEDIDA - Aturant proc√©s` | - |
| Cancel¬∑laci√≥ | `[IA] Cancel¬∑lat per l'usuari` | - |
| Finalitzaci√≥ | `[IA] {status}: {ok} OK, {err} errors en {s}s.` | `[IA] COMPLETAT: 23 OK, 2 errors en 45s.` |

**Codis d'error de l'API:**

| Codi | Descripci√≥ | Acci√≥ |
|------|------------|-------|
| `QUOTA_EXCEEDED` | Quota di√†ria d'IA esgotada (429 o 400 amb "limit/exceeded") | Aturar batch, notificar usuari |
| `RATE_LIMITED` | Massa peticions en poc temps | Aplicar backoff, continuar |
| `TRANSIENT` | Error temporal del servidor (503, 504, timeout) | Aplicar backoff, continuar |
| `INVALID_INPUT` | Dades de la transacci√≥ inv√†lides | Marcar com "Revisar", continuar |
| `AI_ERROR` | Error gen√®ric d'IA (clau inv√†lida, model no disponible) | Marcar com "Revisar", continuar |
| `NETWORK` | Error de xarxa (client-side) | Aplicar backoff, continuar |

**Events trackUX (analytics):**

| Event | Propietats | Quan |
|-------|------------|------|
| `ai.categorize.error` | `{ code, reason, model }` | Error en categoritzaci√≥ individual |
| `ai.bulk.run.start` | `{ count, bulkMode, sequential }` | Inici de batch |
| `ai.bulk.run.done` | `{ processedCount, errorCount, durationMs, bulkMode, quotaExceeded, cancelled }` | Fi de batch |
| `ai.bulk.toggle` | `{ enabled }` | SuperAdmin activa/desactiva mode r√†pid |
| `ai.bulk.fallback_quota` | `{ reason }` | Fallback autom√†tic per quota |

**Constants de timing:**

| Constant | Valor | Descripci√≥ |
|----------|-------|------------|
| `BASE_DELAY_NORMAL_MS` | 1500ms | Delay entre crides (mode normal) |
| `BASE_DELAY_BULK_MS` | 1200ms | Delay entre crides (mode r√†pid) |
| `MAX_DELAY_MS` | 8000ms | M√†xim delay amb backoff |
| `BACKOFF_MULTIPLIER` | 2 | Factor de multiplicaci√≥ del backoff |

**Fitxers relacionats:**
- `src/app/api/ai/categorize-transaction/route.ts` ‚Äî Route Handler de l'API
- `src/components/transactions/hooks/useTransactionCategorization.ts` ‚Äî Hook client
- `src/ai/genkit.ts` ‚Äî Configuraci√≥ Genkit

### Principi General

> üí° Aquestes millores s√≥n sempre compatibles amb la visi√≥ del producte i contribueixen directament a la seva estabilitat i longevitat.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 2. ARQUITECTURA T√àCNICA
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 2.1 Estructura de Fitxers

```
/src
  /app                          ‚Üí P√†gines (Next.js App Router)
    /[lang]                      ‚Üí Rutes p√∫bliques multiidioma (NOU v1.25)
      /login                     ‚Üí Login p√∫blic (/ca/login, /es/login, etc.)
      /privacy                   ‚Üí Pol√≠tica de privacitat
      /contact                   ‚Üí P√†gina de contacte
      layout.tsx                 ‚Üí Validaci√≥ idioma + generateStaticParams
    /[orgSlug]                   ‚Üí Rutes per organitzaci√≥ (app privada)
      /dashboard
        /page.tsx                ‚Üí Dashboard principal
        /movimientos             ‚Üí Gesti√≥ de transaccions
        /donantes                ‚Üí Gesti√≥ de donants
        /proveedores             ‚Üí Gesti√≥ de prove√Ødors
        /trabajadores            ‚Üí Gesti√≥ de treballadors
        /ejes-de-actuacion       ‚Üí Gesti√≥ de projectes/eixos
        /informes                ‚Üí Informes fiscals (182, 347)
          /certificats           ‚Üí Certificats de donaci√≥
        /configuracion           ‚Üí Configuraci√≥ de l'organitzaci√≥
      /login                     ‚Üí Login per organitzaci√≥
    /admin                       ‚Üí Panel SuperAdmin global
    /login                       ‚Üí Redirect stub ‚Üí /[lang]/login
    /privacy                     ‚Üí Redirect stub ‚Üí /[lang]/privacy
    /contacte                    ‚Üí Redirect stub ‚Üí /[lang]/contact
    /privacitat                  ‚Üí Redirect stub ‚Üí /[lang]/privacy (legacy)
  /components                    ‚Üí Components React reutilitzables
    /ui                          ‚Üí Components shadcn/ui
    /return-importer             ‚Üí Importador de devolucions (NOU v1.8)
      useReturnImporter.ts       ‚Üí Hook amb l√≤gica de matching
      ReturnImporter.tsx         ‚Üí Modal UI de l'importador
      index.ts                   ‚Üí Exports
    /stripe-importer             ‚Üí Importador de donacions Stripe (NOU v1.9)
      useStripeImporter.ts       ‚Üí Hook amb l√≤gica de parsing i matching
      StripeImporter.tsx         ‚Üí Modal UI de l'importador
      index.ts                   ‚Üí Exports
    /onboarding                  ‚Üí Components d'onboarding (ACTUALITZAT v1.20)
      WelcomeOnboardingModal.tsx ‚Üí Modal de benvinguda per primer admin
      OnboardingWizard.tsx       ‚Üí Wizard de configuraci√≥ inicial
    /admin                       ‚Üí Components del panell admin
      create-organization-dialog.tsx ‚Üí Modal crear organitzaci√≥
    donor-manager.tsx            ‚Üí Gesti√≥ de donants
    donor-importer.tsx           ‚Üí Importador massiu de donants
    supplier-manager.tsx         ‚Üí Gesti√≥ de prove√Ødors
    supplier-importer.tsx        ‚Üí Importador massiu de prove√Ødors
    transaction-table.tsx        ‚Üí Taula de moviments
    transaction-importer.tsx     ‚Üí Importador d'extractes
    remittance-splitter.tsx      ‚Üí Divisor de remeses
    donations-report-generator.tsx ‚Üí Generador Model 182
    donation-certificate-generator.tsx ‚Üí Generador certificats
    dashboard-*.tsx              ‚Üí Components del dashboard
  /firebase                      ‚Üí Configuraci√≥ i hooks de Firebase
  /hooks                         ‚Üí Hooks personalitzats de React
  /lib                           ‚Üí Utilitats, tipus i dades
    /data.ts                     ‚Üí Definicions de tipus (Donor, Supplier, etc.)
    /__tests__                   ‚Üí Tests unitaris (NOU v1.8)
      normalize.test.ts          ‚Üí 35 tests
      auto-match.test.ts         ‚Üí 24 tests
      model182.test.ts           ‚Üí 18 tests
  /i18n                          ‚Üí Traduccions
    /ca.ts                       ‚Üí Catal√† (idioma base, app privada)
    /es.ts                       ‚Üí Espanyol (app privada)
    /fr.ts                       ‚Üí Franc√®s (app privada)
    /public.ts                   ‚Üí Traduccions p√†gines p√∫bliques CA/ES/FR/PT (NOU v1.25)
    /locales/*.json              ‚Üí Bundles JSON per runtime (ca, es, fr, pt)
    # Criteri: fr.ts cont√© totes les claus; si falta traducci√≥, es mant√© text CA
  /ai                            ‚Üí Fluxos de Genkit (IA)
```

## 2.2 Model de Dades Firestore

```
organizations/
  ‚îî‚îÄ‚îÄ {orgId}/
      ‚îÇ
      ‚îú‚îÄ‚îÄ name: string                    # Nom de l'organitzaci√≥
      ‚îú‚îÄ‚îÄ taxId: string                   # CIF de l'entitat
      ‚îú‚îÄ‚îÄ slug: string                    # Identificador URL √∫nic
      ‚îú‚îÄ‚îÄ address: string                 # Adre√ßa fiscal
      ‚îú‚îÄ‚îÄ city: string                    # Ciutat
      ‚îú‚îÄ‚îÄ zipCode: string                 # Codi postal
      ‚îú‚îÄ‚îÄ phone: string                   # Tel√®fon
      ‚îú‚îÄ‚îÄ email: string                   # Email de contacte
      ‚îú‚îÄ‚îÄ website: string                 # P√†gina web
      ‚îú‚îÄ‚îÄ logoUrl: string | null          # URL del logo
      ‚îú‚îÄ‚îÄ signatureUrl: string | null     # URL de la firma digitalitzada
      ‚îú‚îÄ‚îÄ signerName: string | null       # Nom del signant
      ‚îú‚îÄ‚îÄ signerRole: string | null       # C√†rrec del signant
      ‚îÇ
      ‚îú‚îÄ‚îÄ onboarding/                     # Estat onboarding (NOU v1.20)
      ‚îÇ   ‚îî‚îÄ‚îÄ welcomeSeenAt: string | null  # YYYY-MM-DD quan primer admin ha vist modal
      ‚îÇ
      ‚îú‚îÄ‚îÄ settings/
      ‚îÇ   ‚îî‚îÄ‚îÄ preferences/
      ‚îÇ       ‚îî‚îÄ‚îÄ contactAlertThreshold: number
      ‚îÇ
      ‚îú‚îÄ‚îÄ members/
      ‚îÇ   ‚îî‚îÄ‚îÄ {userId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ role: "superadmin" | "admin" | "user" | "viewer"
      ‚îÇ       ‚îú‚îÄ‚îÄ email: string
      ‚îÇ       ‚îî‚îÄ‚îÄ displayName: string
      ‚îÇ
      ‚îú‚îÄ‚îÄ transactions/
      ‚îÇ   ‚îî‚îÄ‚îÄ {transactionId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ date: string                    # Data (YYYY-MM-DD)
      ‚îÇ       ‚îú‚îÄ‚îÄ description: string             # Concepte bancari
      ‚îÇ       ‚îú‚îÄ‚îÄ amount: number                  # Import (+ ingr√©s, - despesa)
      ‚îÇ       ‚îú‚îÄ‚îÄ category: string | null         # ID de categoria
      ‚îÇ       ‚îú‚îÄ‚îÄ categoryName: string | null     # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ emisorId: string | null         # ID del contacte
      ‚îÇ       ‚îú‚îÄ‚îÄ emisorName: string | null       # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ contactId: string | null        # ID contacte (alias emisorId)
      ‚îÇ       ‚îú‚îÄ‚îÄ contactType: string | null      # 'donor' | 'supplier' | 'employee'
      ‚îÇ       ‚îú‚îÄ‚îÄ contactName: string | null      # Nom contacte (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ projectId: string | null        # ID del projecte
      ‚îÇ       ‚îú‚îÄ‚îÄ projectName: string | null      # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ documentUrl: string | null      # URL document adjunt
      ‚îÇ       ‚îú‚îÄ‚îÄ notes: string | null            # Notes internes
      ‚îÇ       ‚îú‚îÄ‚îÄ isCounterpartTransfer: boolean  # Transfer√®ncia a contrapart?
      ‚îÇ       ‚îú‚îÄ‚îÄ transactionType: string | null  # 'return' si √©s devoluci√≥
      ‚îÇ       ‚îú‚îÄ‚îÄ donationStatus: string | null   # 'returned' si marcada
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de remeses:
      ‚îÇ       ‚îú‚îÄ‚îÄ isRemittance: boolean | null    # √âs una remesa agrupada?
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceItemCount: number | null  # Nombre total de quotes
      ‚îÇ       ‚îú‚îÄ‚îÄ source: 'bank' | 'remittance' | 'manual' | 'stripe' | null  # Origen
      ‚îÇ       ‚îú‚îÄ‚îÄ parentTransactionId: string | null  # ID remesa pare
      ‚îÇ       ‚îú‚îÄ‚îÄ bankAccountId: string | null        # ID compte bancari (NOU v1.12)
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de remeses de devolucions (NOU v1.8):
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceType: 'returns' | null    # Tipus de remesa
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceStatus: 'complete' | 'partial' | 'pending' | null
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceResolvedCount: number | null   # Filles creades
      ‚îÇ       ‚îú‚îÄ‚îÄ remittancePendingCount: number | null    # Pendents d'identificar
      ‚îÇ       ‚îú‚îÄ‚îÄ remittancePendingTotalAmount: number | null  # Import pendent ‚Ç¨
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de donacions Stripe (NOU v1.9):
      ‚îÇ       ‚îú‚îÄ‚îÄ stripePaymentId: string | null      # ID pagament (ch_xxx)
      ‚îÇ       ‚îú‚îÄ‚îÄ stripeTransferId: string | null     # ID payout (po_xxx)
      ‚îÇ       ‚îú‚îÄ‚îÄ transactionType: 'donation' | 'fee' | 'return' | null  # Tipus espec√≠fic
      ‚îÇ       ‚îÇ
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
      ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
      ‚îÇ
      ‚îú‚îÄ‚îÄ bankAccounts/                       # (NOU v1.12)
      ‚îÇ   ‚îî‚îÄ‚îÄ {bankAccountId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ name: string                   # Nom identificatiu
      ‚îÇ       ‚îú‚îÄ‚îÄ iban: string | null            # IBAN del compte
      ‚îÇ       ‚îú‚îÄ‚îÄ bankName: string | null        # Nom del banc
      ‚îÇ       ‚îú‚îÄ‚îÄ isDefault: boolean             # Compte per defecte?
      ‚îÇ       ‚îú‚îÄ‚îÄ isActive: boolean              # Actiu/Inactiu
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: string
      ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: string
      ‚îÇ
      ‚îú‚îÄ‚îÄ categories/
      ‚îÇ   ‚îî‚îÄ‚îÄ {categoryId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ name: string
      ‚îÇ       ‚îú‚îÄ‚îÄ type: "income" | "expense"
      ‚îÇ       ‚îî‚îÄ‚îÄ order: number
      ‚îÇ
      ‚îú‚îÄ‚îÄ emissors/  (tamb√© anomenats "contacts")
      ‚îÇ   ‚îî‚îÄ‚îÄ {emisorId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ name: string                    # Nom del contacte
      ‚îÇ       ‚îú‚îÄ‚îÄ taxId: string                   # NIF/CIF
      ‚îÇ       ‚îú‚îÄ‚îÄ zipCode: string                 # Codi postal
      ‚îÇ       ‚îú‚îÄ‚îÄ address: string                 # Adre√ßa (carrer, n√∫mero)
      ‚îÇ       ‚îú‚îÄ‚îÄ city: string                    # Ciutat
      ‚îÇ       ‚îú‚îÄ‚îÄ province: string                # Prov√≠ncia
      ‚îÇ       ‚îú‚îÄ‚îÄ email: string                   # Email
      ‚îÇ       ‚îú‚îÄ‚îÄ phone: string                   # Tel√®fon
      ‚îÇ       ‚îú‚îÄ‚îÄ iban: string                    # IBAN
      ‚îÇ       ‚îú‚îÄ‚îÄ type: "donor" | "supplier" | "employee"
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps espec√≠fics per DONANTS:
      ‚îÇ       ‚îú‚îÄ‚îÄ donorType: "individual" | "company"
      ‚îÇ       ‚îú‚îÄ‚îÄ membershipType: "one-time" | "recurring"
      ‚îÇ       ‚îú‚îÄ‚îÄ monthlyAmount: number           # Quota mensual
      ‚îÇ       ‚îú‚îÄ‚îÄ memberSince: string             # Data alta soci
      ‚îÇ       ‚îú‚îÄ‚îÄ status: "active" | "inactive"   # Estat
      ‚îÇ       ‚îú‚îÄ‚îÄ inactiveSince: string | null    # Data de baixa
      ‚îÇ       ‚îú‚îÄ‚îÄ returnCount: number             # Comptador devolucions
      ‚îÇ       ‚îú‚îÄ‚îÄ lastReturnDate: string          # √öltima devoluci√≥
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps comuns:
      ‚îÇ       ‚îú‚îÄ‚îÄ defaultCategoryId: string | null
      ‚îÇ       ‚îú‚îÄ‚îÄ notes: string
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
      ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
      ‚îÇ
      ‚îî‚îÄ‚îÄ projects/
          ‚îî‚îÄ‚îÄ {projectId}/
              ‚îú‚îÄ‚îÄ name: string
              ‚îú‚îÄ‚îÄ description: string
              ‚îú‚îÄ‚îÄ funderId: string | null
              ‚îú‚îÄ‚îÄ isActive: boolean
              ‚îú‚îÄ‚îÄ createdAt: timestamp
              ‚îî‚îÄ‚îÄ updatedAt: timestamp
```

## 2.3 Sistema d'Autenticaci√≥ i Rols

### Rols disponibles

| Rol | Descripci√≥ | Permisos |
|-----|------------|----------|
| **SuperAdmin** | Creador de l'organitzaci√≥ | Tot + Zona de Perill |
| **Admin** | Administrador | Tot excepte Zona de Perill |
| **User** | Usuari est√†ndard | Crear i editar, no eliminar ni configurar |
| **Viewer** | Nom√©s lectura | Veure dades, no modificar |

### Permisos detallats

| Acci√≥ | SuperAdmin | Admin | User | Viewer |
|-------|------------|-------|------|--------|
| Veure dashboard | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Veure moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Crear moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Editar moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Eliminar moviments | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Importar extractes | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Gestionar contactes | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Gestionar categories | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Gestionar membres | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Configurar organitzaci√≥ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Generar informes | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Zona de Perill | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |

### Persist√®ncia de sessi√≥

- **Tipus**: `browserSessionPersistence`
- La sessi√≥ caduca autom√†ticament en tancar el navegador
- Implementat a v1.7 per seguretat

### Logout per inactivitat

- **IdleLogoutProvider**: Component que tanca la sessi√≥ despr√©s de 30 minuts d'inactivitat
- Av√≠s 1 minut abans del logout
- Events monitoritzats: mouse, teclat, scroll, touch, click, canvi de visibilitat
- Redirecci√≥ a `/{slug}/login?reason=idle` (si l'usuari est√† dins una org) o `/login?reason=idle` (rutes globals)
- Segments reservats (no s√≥n slugs): `login`, `registre`, `redirect-to-org`, `admin`, `dashboard`, `privacy`, `api`, `q`, `quick`, `quick-expense`
- Implementat a `src/components/IdleLogoutProvider.tsx`

### Flux de redirecci√≥ d'organitzaci√≥

- **redirect-to-org**: P√†gina que determina l'organitzaci√≥ de l'usuari i redirigeix a `/{slug}/dashboard`
- Ordre de cerca: 1) `organizationId` al perfil, 2) query `collectionGroup('members')` pel uid
- Si no t√© acc√©s a cap org: mostra estat "no-org" amb opci√≥ de logout
- Query optimitzada O(1) amb `collectionGroup` + `documentId()` (implementat v1.16)

## 2.4 Multi-Organitzaci√≥

- Cada usuari pot pert√†nyer a m√∫ltiples organitzacions
- Les dades estan completament a√Øllades entre organitzacions
- L'URL inclou el slug de l'organitzaci√≥: `/[orgSlug]/dashboard/...`
- Un usuari pot tenir rols diferents a cada organitzaci√≥
- Sistema centralitzat de slugs per evitar duplicats

## 2.5 Tests Unitaris (NOU v1.8)

**77 tests unitaris** per funcions pures:

| Fitxer | Tests | Cobertura |
|--------|-------|-----------|
| `normalize.test.ts` | 35 | normalizeTaxId, normalizeIBAN, normalizeZipCode, formatNumberEU, parseNumberEU |
| `auto-match.test.ts` | 24 | normalizeForMatching, extractNameTokens, findMatchingContact |
| `model182.test.ts` | 18 | calculateModel182Totals, calculateTransactionNetAmount, isReturnTransaction |

**Hook pre-commit (Husky):** Els tests s'executen autom√†ticament abans de cada commit.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 3. FUNCIONALITATS DETALLADES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 3.1 DASHBOARD (ACTUALITZAT v1.20)

### 3.1.1 Targetes Principals (StatCards)

| Targeta | C√†lcul |
|---------|--------|
| **Ingressos** | Suma moviments amount > 0 |
| **Despeses operatives** | Suma amount < 0 EXCLOENT contraparts |
| **Balan√ß operatiu** | Ingressos - Despeses operatives |
| **Transfer√®ncies a contraparts** | Suma isCounterpartTransfer = true |

### 3.1.2 Bloc Donacions i Socis

| M√®trica | Comparativa |
|---------|-------------|
| Donacions | vs any anterior |
| Donants actius | vs any anterior |
| Socis actius | vs any anterior |
| Quotes socis | vs any anterior |

### 3.1.3 Bloc Obligacions Fiscals

| Obligaci√≥ | Data l√≠mit | Acci√≥ |
|-----------|------------|-------|
| Model 182 | 31 gener | Bot√≥ "Preparar" |
| Model 347 | 28 febrer | Bot√≥ "Preparar" |

### 3.1.4 Bloc Categories Principals (ACTUALITZAT v1.20)

Mostra les categories amb m√©s volum de despesa, excloent:
- Comissions banc√†ries (`transactionType === 'fee'` o `'return_fee'`)
- Moviments sense categoria (mostrats com a peu de taula neutral "Sense categoria")

### 3.1.5 Bloc Despesa per Projecte (ACTUALITZAT v1.20)

**Condicions de visibilitat:**
- M√≤dul Projectes activat (`featureFlags.projectModule`)
- Almenys 1 projecte actiu
- M√©s del 5% de les despeses assignades a projectes

**Contingut:**
- Top 3 projectes amb m√©s despesa assignada
- Percentatge del total per projecte
- CTA "Veure detall" ‚Üí `/dashboard/project-module/projects`

### 3.1.6 Filtre de Dates
- Any complet
- Trimestre
- Mes
- Personalitzat
- Tot

### 3.1.7 Modal de Benvinguda (NOU v1.20)

El Dashboard gestiona la modal de benvinguda per al primer admin:
- Comprova `shouldShowWelcomeModal()` al carregar
- Si retorna `true`, mostra `WelcomeOnboardingModal`
- Opcions: "Guia'm" (obre wizard) o "Comen√ßar pel meu compte" (tanca)

### 3.1.8 Blocs Desactivats

Els seg√ºents blocs estan **desactivats** (comentats al codi) a partir de v1.20:
- **Celebracions**: Missatges de fites positives (massa soroll, poc valor)
- **Alertes**: Avisos de moviments pendents (trasllat a altres pantalles)

> **Nota:** El dashboard √©s una eina de visualitzaci√≥ i seguiment, no de validaci√≥ ni govern. Les m√®triques mostrades s√≥n informatives i no constitueixen cap informe oficial.


## 3.2 GESTI√ì DE MOVIMENTS

### 3.2.1 Importaci√≥ d'Extractes Bancaris

**Formats suportats:**
- CSV (detecci√≥ autom√†tica de separador)
- XLSX / XLS (Excel)

**Proc√©s:**
1. Pujar fitxer (drag & drop o selecci√≥)
2. Detecci√≥ autom√†tica de columnes
3. Vista pr√®via
4. Detecci√≥ de duplicats
5. Importaci√≥ amb auto-assignaci√≥

### 3.2.2 Sistema d'Auto-Assignaci√≥ Intel¬∑ligent

**FASE 1: Matching per Nom (instantani)**
- Cerca el nom de cada contacte a la descripci√≥
- ~70% dels moviments assignats autom√†ticament

**FASE 2: IA amb Gemini (si cal)**
- Envia descripci√≥ a Gemini
- Suggereix contacte m√©s probable
- ~16% addicional

> **Blindatge:** La classificaci√≥ suggerida per IA no s'aplica autom√†ticament. L'usuari sempre ha de validar o confirmar l'assignaci√≥ proposada.

**Aplicaci√≥ de Categoria per Defecte:**
- Si contacte t√© defaultCategoryId ‚Üí s'aplica autom√†ticament

**Detecci√≥ For√ßada de Categories (NOU v1.12):**
- Loteria: patrons "loteria", "sorteig" ‚Üí categoria "Loteries i sorteigs"
- Voluntariat: patrons "voluntari", "voluntariat" ‚Üí categoria "Ingressos voluntariat"
- S'aplica a ingressos positius autom√†ticament durant la importaci√≥

### 3.2.3 Taula de Moviments

| Columna | Editable |
|---------|----------|
| Data | ‚úÖ |
| Descripci√≥ | ‚úÖ |
| Import | ‚úÖ |
| Categoria | ‚úÖ (selector amb cerca) |
| Contacte | ‚úÖ (selector amb cerca) |
| Projecte | ‚úÖ |
| Document | ‚úÖ (upload) |
| Nota | ‚úÖ |

### 3.2.4 Filtres
- Per data (any, trimestre, mes, personalitzat)
- Per categoria
- Per contacte
- Per projecte
- Per compte bancari (NOU v1.12)
- Per origen: bank, remittance, manual, stripe (NOU v1.12)
- Sense categoritzar
- Sense contacte
- **Devolucions pendents** (NOU v1.8)

### 3.2.5 Selecci√≥ M√∫ltiple i Accions en Bloc (NOU v1.13)

Permet seleccionar m√∫ltiples moviments i aplicar accions massives.

**Visibilitat:**
- Nom√©s disponible per rols `admin` i `user`
- Rol `viewer` no veu els checkboxes

**Elements UI:**
| Element | Descripci√≥ |
|---------|------------|
| Checkbox cap√ßalera | Selecciona/deselecciona tots els visibles |
| Checkbox fila | Selecciona moviment individual |
| Estat indeterminat | Quan hi ha selecci√≥ parcial |
| Barra d'accions | Apareix amb "N seleccionats" |

**Accions disponibles:**
| Acci√≥ | Descripci√≥ |
|-------|------------|
| **Assignar categoria...** | Obre di√†leg per seleccionar categoria |
| **Treure categoria** | Posa `category: null` a tots els seleccionats |

**Implementaci√≥ t√®cnica:**
- Estat: `Set<string>` per IDs seleccionats
- Batched writes: m√†xim 50 operacions per batch (l√≠mit Firestore)
- Tracking UX: `bulk.category.start/success/partial/error`

**Traduccions:** `movements.table.bulkSelection` (CA/ES/FR)

### 3.2.6 Banner de Devolucions Pendents (NOU v1.8)

Quan hi ha devolucions sense assignar, apareix un banner vermell:

> ‚ö†Ô∏è Hi ha devolucions pendents d'assignar [Revisar]

El bot√≥ "Revisar" filtra la taula per mostrar nom√©s devolucions pendents.

### 3.2.7 Reorganitzaci√≥ UX de la P√†gina de Moviments (NOU v1.14)

Nova estructura visual en 3 franges horitzontals:

| Franja | Contingut |
|--------|-----------|
| **Header** | T√≠tol + Bot√≥ "Nou moviment" + Bot√≥ "Filtres" (Sheet) + Men√∫ opcions taula |
| **Barra filtres actius** | Pills de filtres aplicats + bot√≥ "Neteja filtres" |
| **Taula** | Taula de moviments amb tot l'espai vertical disponible |

**Nous components:**

| Component | Fitxer | Descripci√≥ |
|-----------|--------|------------|
| `FiltersSheet` | `src/components/transactions/components/FiltersSheet.tsx` | Sheet lateral amb tots els filtres consolidats (tipus, origen, compte) |
| `TableOptionsMenu` | `src/components/transactions/components/TableOptionsMenu.tsx` | Men√∫ desplegable amb opcions de visualitzaci√≥ (ocultar desglose remeses, mostrar columna projecte) |

**Comportament:**
- El bot√≥ "Filtres" obre un Sheet lateral des de la dreta
- Els filtres aplicats apareixen com a "pills" sota el header
- El men√∫ d'opcions (icona ‚ãÆ o Settings) controla opcions de la taula

### 3.2.8 Drag & Drop de Documents (NOU v1.14)

Permet adjuntar documents arrossegant fitxers directament sobre una fila de moviment.

**Funcionament:**
- Arrossegar un fitxer sobre qualsevol fila activa el mode "drop"
- La fila mostra un overlay amb "Deixa anar per adjuntar"
- En deixar anar, el fitxer es puja a Storage i s'assigna al moviment

**Tipus acceptats:**
- PDF, imatges (JPG, PNG, GIF, WEBP), XML
- M√†xim 15MB per fitxer

**Components:**

| Component | Fitxer | Descripci√≥ |
|-----------|--------|------------|
| `RowDropTarget` | `src/components/files/row-drop-target.tsx` | Wrapper que afegeix drag & drop a files de taula |
| `attachDocumentToTransaction` | `src/lib/files/attach-document.ts` | Helper per pujar fitxer a Storage i actualitzar Firestore |

**Traduccions:** `movements.table.dropToAttach` (CA/ES/FR)

### 3.2.9 Indicadors Visuals de Remeses Processades (NOU v1.14)

Les remeses de donacions processades es mostren amb un estil visual distintiu per evitar confusi√≥.

**Objectiu:** L'usuari ha de poder identificar en 1 segon que una remesa ja est√† processada i no requereix acci√≥.

**Canvis visuals:**

| Element | Abans | Ara |
|---------|-------|-----|
| **Badge concepte** | `üëÅ 303/303 quotes` (gris) | `‚úì Remesa processada ¬∑ 303/303 quotes` (verd esmeralda) |
| **Fons fila** | Cap | `bg-emerald-50/30` (verd molt suau) |
| **Columna Contacte** | Bot√≥ "Assignar" | Gui√≥ "‚Äî" (no aplica) |

**Detalls t√®cnics:**
- Detecci√≥: `tx.isRemittance && tx.remittanceType !== 'returns'`
- Icona: `CheckCircle2` (lucide-react)
- Colors: `border-emerald-300 text-emerald-700 bg-emerald-50`

**Traduccions:** `movements.table.remittanceProcessedLabel`, `remittanceNotApplicable` (CA/ES/FR)


## 3.3 DIVISOR DE REMESES (INGRESSOS)

### 3.3.1 Qu√® √©s una Remesa?
Agrupaci√≥ de m√∫ltiples quotes de socis en un √∫nic ingr√©s bancari.

### 3.3.2 Formats suportats
- **CSV** amb detecci√≥ de separador
- **XLSX / XLS** (Excel)
- Detecci√≥ autom√†tica de fila inicial de dades

### 3.3.3 Proc√©s de Divisi√≥

1. **Seleccionar remesa** ‚Üí Men√∫ ‚ãÆ ‚Üí "Dividir remesa"
2. **Pujar detall** ‚Üí Fitxer CSV o Excel del banc
3. **Mapejat columnes**:
   - üü¢ Import
   - üîµ Nom
   - üü£ DNI/CIF
   - üî∑ IBAN
4. **Matching de socis** (prioritat):
   - Per DNI/CIF (m√†xima)
   - Per IBAN (alta)
   - Per Nom (mitjana)
5. **Detecci√≥ de socis de baixa**:
   - Av√≠s visual si es detecten socis marcats com "baixa"
   - Opci√≥ de reactivar individualment o tots alhora
6. **Processar**

### 3.3.4 Vista Agrupada de Remeses

- La remesa processada queda com **1 sola l√≠nia** al llistat de moviments
- Badge amb comptador de quotes: "üëÅ 303"
- **Filtre**: "Ocultar desglose de remesas" (activat per defecte)
- **Modal de detall**: Clicar el badge obre una modal amb:
  - Llista de totes les quotes individuals
  - Cerca per nom o DNI
  - Link directe al donant (clicar nom)
  - Resum del donant (hover)

### 3.3.5 Model de Dades de Remeses (Ingressos)

**Transacci√≥ pare (remesa):**
```
isRemittance: true
remittanceItemCount: 303
```

**Transaccions filles (quotes):**
```
source: 'remittance'
parentTransactionId: '{id_remesa}'
```

### 3.3.6 Guardar Configuraci√≥
Es pot guardar el mapejat per banc (Triodos, La Caixa, Santander, etc.)

### 3.3.7 Modal de Revisi√≥ Redissenyat (NOU v1.14)

El modal de revisi√≥ de remeses ("Revisi√≥ de la Remesa") s'ha redissenyat per millorar la usabilitat amb taules denses.

**Problemes resolts:**
- Modal massa estret per a taules amb moltes columnes
- Scroll conf√∫s (modal vs taula)
- Targetes de resum ocupaven massa espai

**Nou disseny:**

| Caracter√≠stica | Valor |
|----------------|-------|
| **Amplada** | 95% del viewport, m√†xim 1400px |
| **Al√ßada** | 90% del viewport |
| **Layout** | Flexbox vertical amb 3 zones fixes |

**Zones del modal:**

| Zona | Contingut | Comportament |
|------|-----------|--------------|
| **Header fix** | T√≠tol + Badges de resum compactes + Opcions de creaci√≥ de donants | No fa scroll |
| **Taula central** | Taula amb tots els donants/quotes | Scroll independent amb header sticky |
| **Footer fix** | Resum d'accions + Botons (Enrere, Processar) | No fa scroll |

**Badges de resum compactes:**
Els 4 blocs de resum (Total, Trobats, Nous amb DNI, Nous sense DNI) ara s√≥n badges en l√≠nia:

```
[303 donacions] [‚úì 280 trobats] [+ 15 nous amb DNI] [‚ö† 8 sense DNI] | [1.234,56‚Ç¨ / 1.234,56‚Ç¨]
```

**Implementaci√≥:**
- Classes: `w-[95vw] max-w-[1400px] h-[90vh] flex flex-col`
- Taula: `flex-1 min-h-0 overflow-auto`
- Header taula: `sticky top-0 bg-background z-10`


## 3.4 GESTI√ì DE DEVOLUCIONS (NOU v1.8)

### 3.4.1 Visi√≥ general

Les devolucions banc√†ries (rebuts retornats) es gestionen sense modificar el moviment bancari original.

| M√®tode | Quan usar-lo |
|--------|--------------|
| **Assignaci√≥ manual** | Devolucions individuals, una a una |
| **Importador de fitxer** | Devolucions massives o agrupades |

**Principi fonamental:** El moviment bancari original MAI es modifica ni s'esborra.

### 3.4.2 Flux real de devolucions (individuals i remeses)

**Tipus de devolucions:**

| Tipus | Descripci√≥ | Exemple |
|-------|------------|---------|
| **Individual** | Un apunt bancari √∫nic (‚àíX ‚Ç¨) | ‚àí25,00‚Ç¨ "DEVOL. RECIBO" |
| **Remesa** | Un apunt pare amb m√∫ltiples quotes filles | ‚àí150,00‚Ç¨ amb 6 filles de 25‚Ç¨ |

**Regles fonamentals:**

1. **Una devoluci√≥ individual** √©s un apunt bancari √∫nic amb import negatiu
2. **Una devoluci√≥ en remesa** √©s un apunt pare amb m√∫ltiples quotes filles
3. **El pare mai t√© `contactId`** ‚Äî el donant sempre s'assigna a les filles
4. **La fitxa del donant i el Model 182** es calculen exclusivament a partir de les filles amb `contactId`

**Implicaci√≥ fiscal:** Si una remesa t√© 4 filles per√≤ nom√©s 2 tenen donant assignat, nom√©s aquelles 2 resten al c√†lcul del Model 182 dels seus respectius donants.

### 3.4.3 Assignaci√≥ manual

1. Ves a **Moviments** ‚Üí Banner "Devolucions pendents" ‚Üí **Revisar**
2. Per cada devoluci√≥: bot√≥ **"Assignar donant"**
3. Cerca per nom, DNI, IBAN o email
4. Confirma l'assignaci√≥

### 3.4.4 Importador de fitxer del banc

#### Ubicaci√≥
- Moviments ‚Üí Fila de devoluci√≥ ‚Üí Icona üìÑ (pujar fitxer)
- O des del filtre "Devolucions pendents"

#### Bancs suportats

| Banc | Format | Particularitat |
|------|--------|----------------|
| Santander | XLSX | Data global a cap√ßalera, agrupa per fitxer |
| Triodos | CSV/XLS | Data per l√≠nia, agrupa per dia |
| Altres | CSV/XLSX | Detecci√≥ autom√†tica columnes |

#### Flux d'importaci√≥ amb fitxer del banc (v1.12)

**Pas 1: Parseig i normalitzaci√≥**
```
1. PARSEJAR FITXER ‚Üí Extreure IBAN, Import, Data, Nom
2. NORMALITZAR ‚Üí Imports positius, dateConfidence (line/file/none)
```

**Pas 2: Matching determinista de transaccions**

El sistema fa matching determinista amb els moviments bancaris:

| Ordre | Criteri | Toler√†ncia |
|-------|---------|------------|
| 1 | Import | ¬±0,02‚Ç¨ |
| 2 | Data | ¬±5 dies |
| 3 | IBAN (si disponible) | Exacte |

**Regles de desempat (NOU v1.12):**
- Si hi ha 1 candidat clar ‚Üí s'assigna autom√†ticament
- Si hi ha m√∫ltiples candidats ‚Üí desempat autom√†tic per **data m√©s propera**
- Nom√©s es marca com ambigu si l'empat √©s real (mateixa data i import)

**Pas 3: Matching de donants**

| Prioritat | Criteri | Normalitzaci√≥ |
|-----------|---------|---------------|
| 1 | IBAN | Sense espais, maj√∫scules |
| 2 | DNI/NIF | Sense guions, maj√∫scules |
| 3 | Nom | Sense accents, min√∫scules, exacte |

**NO es fa matching aproximat ni fuzzy.**

**Pas 4: Processament**
```
1. DETECTAR AGRUPACIONS ‚Üí Suma = moviment bancari (¬±0.02‚Ç¨, ¬±5 dies)
2. CREAR FILLES ‚Üí Per cada devoluci√≥ identificada
3. ACTUALITZAR PARE ‚Üí isRemittance, remittanceStatus, etc.
4. ACTUALITZAR DONANTS ‚Üí returnCount, lastReturnDate
```

#### Persist√®ncia (punt cr√≠tic)

> **IMPORTANT:** El matching no √©s nom√©s visual.
> Quan una devoluci√≥ queda resolta, el sistema actualitza el document real de la transacci√≥:
> - `contactId` ‚Üí ID del donant
> - `contactType` ‚Üí 'donor'
> - `transactionType` ‚Üí 'return'
>
> Aquesta persist√®ncia √©s obligat√≤ria perqu√® la devoluci√≥ compti al Model 182.

#### Detecci√≥ autom√†tica de columnes

| Camp | Patrons detectats |
|------|-------------------|
| IBAN | cuenta de adeudo, cuenta destino, iban, account |
| Import | importe, cantidad, amount, monto |
| Data | fecha de liquidaci√≥n, fecha rechazo, date |
| DNI | referencia externa, dni, nif |
| Nom | nombre cliente, nombre, titular |
| Motiu | motivo devoluci√≥n, motivo, reason |

### 3.4.5 Devolucions agrupades (remeses)

Alguns bancs agrupen m√∫ltiples devolucions en un sol moviment:

```
Extracte bancari:  -55,00‚Ç¨ "DEVOLUCION RECIBOS"
Fitxer detall:     10‚Ç¨ + 20‚Ç¨ + 15‚Ç¨ + 10‚Ç¨ = 55‚Ç¨
```

#### Comportament

1. El moviment original (-55‚Ç¨) es marca com a "remesa pare"
2. Es creen transaccions filles per cada devoluci√≥ identificada
3. El pare mant√© `amount`, `date`, `description` intactes

#### Estats de remesa (v1.12)

| Estat | Significat | Implicaci√≥ fiscal |
|-------|------------|-------------------|
| `complete` | Totes les filles tenen donant | Totes resten al 182 |
| `partial` | Algunes filles sense donant | Nom√©s les resoltes resten |
| `pending` | Cap filla creada encara | No afecta el 182 |

> **Important:** Encara que una remesa sigui `partial`, les filles resoltes **s√≠ que compten** per:
> - La fitxa del donant (returnCount)
> - El Model 182 (resta de l'import net)

#### Model de dades (Remeses de devolucions)

**Transacci√≥ pare:**
```typescript
isRemittance: true
remittanceType: 'returns'
remittanceStatus: 'complete' | 'partial' | 'pending'
remittanceItemCount: number           // Total devolucions
remittanceResolvedCount: number       // Amb donant
remittancePendingCount: number        // Sense donant
remittancePendingTotalAmount: number  // Suma pendents ‚Ç¨
// contactId: null (MAI s'assigna al pare)
```

**Transaccions filles:**
```typescript
source: 'remittance'
parentTransactionId: string    // ID del pare
transactionType: 'return'
amount: number                 // Negatiu
contactId: string              // ID donant
contactType: 'donor'
contactName: string            // Nom (desnormalitzat)
```

### 3.4.6 Remeses parcials

Si algunes devolucions no es poden identificar:

| Element | Estat |
|---------|-------|
| Devolucions amb donant | ‚Üí Es creen com a filles |
| Devolucions sense donant | ‚Üí Queden pendents |
| Remesa | ‚Üí `remittanceStatus: 'partial'` |

**Visualitzaci√≥:** Badge taronja "2/4 quotes (2 pendents: 25‚Ç¨)"

**Per completar una remesa parcial:**
1. Buscar el donant a Summa Social i actualitzar el seu IBAN
2. O crear el donant nou si no existeix
3. Tornar a importar el fitxer del banc

### 3.4.7 Impacte fiscal

| Document | C√†lcul |
|----------|--------|
| Model 182 | Total = Œ£ donacions - Œ£ devolucions |
| Certificats | Import = Œ£ donacions - Œ£ devolucions |

**Important:**
- El pare (remesa) NO t√© `contactId` ‚Üí No es compta
- Les filles S√ç tenen `contactId` ‚Üí Es compten com devolucions
- Si total ‚â§ 0 ‚Üí Donant no apareix al Model 182

> **Regla clau (v1.12):** Les devolucions resten al Model 182 quan existeixen filles amb `contactId`, independentment de l'estat global de la remesa (`partial` o `complete`).

### 3.4.8 UI de devolucions

#### Banner (Moviments)
- Un sol banner vermell: "Hi ha devolucions pendents d'assignar"
- CTA "Revisar" ‚Üí Filtra per devolucions pendents

#### Accions per fila

| Bot√≥ | Acci√≥ |
|------|-------|
| "Assignar donant" (vermell) | Di√†leg assignaci√≥ manual |
| üìÑ (icona) | Obre importador fitxer |

#### Criteri del bot√≥ "Assignar donant" (v1.12)

El bot√≥ "Assignar donant" **nom√©s es mostra** si:
1. La transacci√≥ √©s una devoluci√≥ individual (`transactionType === 'return'`)
2. I `contactId` √©s `null`

**Mai es mostra al pare d'una remesa de devolucions** (quan `isRemittance === true` i `remittanceType === 'returns'`).

#### Badge remesa

| Estat | Visualitzaci√≥ |
|-------|---------------|
| Completa | "4 quotes" |
| Parcial | Badge taronja "2/4 quotes (2 pendents: 25‚Ç¨)" |

#### Modal importador - Resultats del matching

| Badge | Significat |
|-------|------------|
| üü¢ **Individual** | Donant i transacci√≥ trobats |
| üîµ **Agrupada** | Part d'una remesa |
| üü† **Pendent** | Donant no identificat |

### 3.4.9 Mode SuperAdmin: recreaci√≥ de devolucions (NOU v1.12)

Eina **excepcional** per a migracions o correcci√≥ de dades hist√≤riques.

| Element | Descripci√≥ |
|---------|------------|
| Acc√©s | Nom√©s SuperAdmin |
| Ubicaci√≥ | Importador de devolucions ‚Üí checkbox "For√ßar recreaci√≥" |
| Acci√≥ | Elimina **totes** les filles d'un apunt pare i les recrea des del fitxer importat |

**Quan usar-la:**
- Migracions de dades hist√≤riques
- Correcci√≥ massiva d'errors de matching
- Sincronitzaci√≥ despr√©s de canvis a la base de donants

**Flux:**
1. SuperAdmin activa "For√ßar recreaci√≥ de devolucions"
2. Sistema demana confirmaci√≥ expl√≠cita
3. S'eliminen les filles existents del pare
4. Es recreen des del fitxer importat amb el matching actual
5. Es recalcula `remittanceStatus` del pare

> **Atenci√≥:** Aquesta opci√≥ **no √©s el flux normal d'usuari**. Nom√©s s'ha d'usar per corregir inconsist√®ncies o migrar dades.

### 3.4.10 L√≠mits del sistema

| Perm√®s | NO perm√®s |
|--------|-----------|
| Matching IBAN/DNI/Nom exacte | Fuzzy matching noms |
| Assignaci√≥ amb confirmaci√≥ | Assignaci√≥ autom√†tica |
| Remeses parcials | For√ßar remesa completa |
| Crear donant nou | Inventar dades |


## 3.5 REMESES OUT / PAGAMENTS (NOU v1.17)

### 3.5.1 Visi√≥ general

Les **remeses de pagaments** (OUT) permeten dividir una remesa de sortida (despesa) en m√∫ltiples transfer√®ncies a prove√Ødors o empleats, amb generaci√≥ de fitxer SEPA pain.001.

**Principi fonamental:** El moviment bancari original (pare) √©s **immutable**. El detall s√≥n transaccions filles amb `parentTransactionId`.

| Tipus | Direcci√≥ | Import pare | Exemple |
|-------|----------|-------------|---------|
| Remesa IN (quotes) | Ingr√©s (+) | Positiu | +5.430‚Ç¨ "REMESA RECIBOS" |
| Remesa OUT (pagaments) | Despesa (‚àí) | Negatiu | ‚àí3.200‚Ç¨ "REMESA PAGAMENTS" |

### 3.5.2 Flux de treball

1. **Identificar moviment** ‚Üí Despesa negativa agregada (ex: "REMESA N√íMINES TRIODOS")
2. **Men√∫ ‚ãÆ** ‚Üí "Dividir remesa"
3. **Pujar fitxer** ‚Üí CSV/Excel amb detall de pagaments
4. **Mapejat columnes**:
   - üü¢ Import (obligatori)
   - üîµ Nom beneficiari
   - üî∑ IBAN beneficiari
5. **Matching** ‚Üí Cerca prove√Ødors/treballadors per IBAN o nom
6. **Validaci√≥** ‚Üí Suma fills = |import pare| (toler√†ncia ¬±0,02‚Ç¨)
7. **Processar** ‚Üí Crea filles i (opcionalment) exporta SEPA

### 3.5.3 Model de dades

**Transacci√≥ pare (remesa de pagaments):**
```
isRemittance: true
remittanceId: '{uuid}'
remittanceItemCount: 15
```

**Transaccions filles (pagaments individuals):**
```
source: 'remittance'
parentTransactionId: '{id_remesa}'
isRemittanceItem: true
remittanceId: '{uuid}'
amount: -250.00          // negatiu (despesa)
contactId: '{proveidor}'
contactType: 'supplier' | 'employee'
```

**Document remesa (`/organizations/{orgId}/remittances/{remittanceId}`):**
```typescript
{
  id: string;
  orgId: string;
  parentTransactionId: string;
  direction: 'OUT';
  status: 'complete' | 'partial';

  totalAmount: number;        // Import total absolut (positiu)
  itemCount: number;          // Nombre de pagaments

  validation: {
    deltaCents: number;       // Difer√®ncia en c√®ntims (ideal: 0)
    isValid: boolean;         // |deltaCents| <= 2
    checkedAt: Timestamp;
  };

  createdAt: Timestamp;
  createdBy: string;
}
```

### 3.5.4 Invariant de suma

La suma absoluta de les filles ha de coincidir amb el valor absolut del pare.

```
|pare.amount| = Œ£ |fill.amount|     (toler√†ncia ¬±0,02‚Ç¨)
```

**Exemple:**
- Pare: ‚àí3.200,00‚Ç¨
- Fills: ‚àí1.200‚Ç¨ + ‚àí800‚Ç¨ + ‚àí600‚Ç¨ + ‚àí600‚Ç¨ = ‚àí3.200‚Ç¨
- Validaci√≥: |‚àí3.200| = |‚àí3.200| ‚úì

**Guardrails:**
- Si `|delta| > 2 c√®ntims` ‚Üí Banner d'av√≠s a la UI
- Si `delta !== 0` ‚Üí Bot√≥ "Processar" desactivat
- Camp `validation.deltaCents` guardat a Firestore per diagn√≤stic

### 3.5.5 Exportaci√≥ SEPA pain.001

El sistema pot generar un fitxer SEPA pain.001.001.03 per enviar al banc.

**Requisits per exportar:**
- Tots els pagaments han de tenir IBAN v√†lid
- Tots els imports han de ser positius (>0)
- La suma ha de quadrar amb el pare

**Camps del fitxer SEPA:**

| Element | Origen |
|---------|--------|
| `MsgId` | Auto-generat (`SEPA{timestamp}{random}`) |
| `CreDtTm` | Data actual ISO |
| `NbOfTxs` | Nombre de pagaments |
| `CtrlSum` | Suma total |
| `Dbtr/Nm` | Nom organitzaci√≥ |
| `DbtrAcct/IBAN` | IBAN organitzaci√≥ |
| `ReqdExctnDt` | Data d'execuci√≥ (usuari) |
| `CdtTrfTxInf/*` | Detall per cada pagament |

**Fitxers relacionats:**
- `src/lib/sepa/generate-pain001.ts` ‚Äî Generador XML
- `src/lib/sepa/parse-pain001.ts` ‚Äî Parser (per importar)
- `src/lib/sepa/index.ts` ‚Äî Exports p√∫blics

### 3.5.6 Desfer remesa OUT

Acci√≥ disponible al men√∫ ‚ãÆ del moviment pare si `isRemittance === true`.

**Flux "Desfer remesa":**
1. Elimina totes les transaccions filles
2. Elimina el document `/remittances/{remittanceId}`
3. Neteja camps del pare (`isRemittance`, `remittanceId`, `remittanceItemCount`)
4. Restaura pare a estat original

**Implementaci√≥:** Operaci√≥ at√≤mica amb `writeBatch()` i `deleteField()`.

**Acc√©s:** Qualsevol rol amb permisos d'edici√≥ (no requereix SuperAdmin).

### 3.5.7 UI i indicadors visuals

| Element | Comportament |
|---------|-------------|
| Badge pare | "‚úì Remesa ¬∑ 15 pagaments" (verd) |
| Fons fila | `bg-emerald-50/30` |
| Toggle filles | Clicar badge ‚Üí expandeix/col¬∑lapsa |
| Banner delta | Si `|delta| > 2¬¢` ‚Üí av√≠s taronja |
| Bot√≥ "Processar" | Desactivat si no quadra o falten IBANs |

### 3.5.8 Difer√®ncies amb Remeses IN

| Aspecte | Remeses IN (quotes) | Remeses OUT (pagaments) |
|---------|---------------------|-------------------------|
| Direcci√≥ | Ingr√©s (+) | Despesa (‚àí) |
| Contactes | Donants | Prove√Ødors/Treballadors |
| Matching | DNI/IBAN/Nom | IBAN/Nom |
| Export | No | SEPA pain.001 |
| Camps fills | `contactType: 'donor'` | `contactType: 'supplier'/'employee'` |

### 3.5.9 Observabilitat

**Logs de desenvolupament:**
```
[REMESA-OUT] Validaci√≥: delta=0¬¢, items=15, pare=-3200.00‚Ç¨
[REMESA-OUT] Processant: 15 pagaments, remittanceId={uuid}
[REMESA-OUT] SEPA generat: pain001_{date}_{timestamp}.xml
```

**Camps de diagn√≤stic a Firestore:**
- `remittances/{id}.validation.deltaCents`
- `remittances/{id}.validation.checkedAt`
- `remittances/{id}.createdBy`


## 3.6 GESTI√ì DE CONTACTES

### 3.6.1 Tipus de Contactes

| Tipus | Subtipus |
|-------|----------|
| **Donants** | Particular, Empresa |
| **Prove√Ødors** | Per categoria |
| **Treballadors** | - |

### 3.6.2 Donants - Camps

| Camp | Obligatori | Model 182 |
|------|------------|-----------|
| Nom | ‚úÖ | ‚úÖ |
| NIF/DNI | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Codi postal | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Ciutat | ‚ùå | ‚ùå |
| Prov√≠ncia | ‚ùå | ‚ùå |
| Adre√ßa | ‚ùå | ‚ùå |
| Tipus (Particular/Empresa) | ‚úÖ | ‚úÖ NATURALEZA |
| Modalitat (Puntual/Soci) | ‚úÖ | ‚ùå |
| Estat (Actiu/Baixa) | ‚ùå | ‚ùå |
| Data de baixa | ‚ùå | ‚ùå |
| Quota mensual | ‚ùå | ‚ùå |
| IBAN | ‚ùå | ‚ùå |
| Email | ‚ùå | ‚ùå |
| Tel√®fon | ‚ùå | ‚ùå |
| Categoria per defecte | ‚ùå | ‚ùå |
| **Comptador devolucions** | ‚ùå | ‚ùå |
| **Data √∫ltima devoluci√≥** | ‚ùå | ‚ùå |

### 3.6.3 Gesti√≥ d'Estat Actiu/Baixa

- **Filtre per estat**: Per defecte es mostren nom√©s actius
- **Badge visual**: Els donants de baixa mostren badge "Baixa"
- **Reactivar**: Bot√≥ per tornar a donar d'alta un soci
- **Edici√≥**: Es pot canviar l'estat des del formulari d'edici√≥
- **Importador**: Detecta columna "Estado/Estat" autom√†ticament

### 3.6.4 Importador de Donants

**Columnes detectades autom√†ticament:**

| Camp | Patrons de detecci√≥ |
|------|---------------------|
| Nom | nom, nombre, name |
| DNI/CIF | dni, nif, cif, taxid, documento |
| Codi postal | cp, codipostal, codigopostal, zipcode |
| Ciutat | ciudad, ciutat, city, localidad, poblaci√≥n |
| Prov√≠ncia | provincia, province, comunidad, regi√≥n |
| Adre√ßa | direccion, adre√ßa, address, domicilio, calle |
| Tipus | tipus, tipo, type, persona |
| Modalitat | modalitat, modalidad, membership, soci |
| Estat | estado, estat, status, activo, baja, baixa |
| Import | import, importe, quota, cuota, amount |
| IBAN | iban, compte, cuenta, banc |
| Email | email, correu, correo, mail |
| Tel√®fon | telefon, telefono, phone |
| Categoria | categoria, category |

**Funcionalitat "Actualitzar existents":**

- Checkbox opcional a la previsualitzaci√≥
- Si un DNI ja existeix i el checkbox est√† activat ‚Üí Actualitza en lloc d'ometre
- Camps actualitzables: status, zipCode, address, email, phone, iban, membershipType, donorType
- NO actualitza: name, taxId, createdAt (per seguretat)

### 3.6.5 Prove√Ødors - Camps

| Camp | Obligatori | Model 347 |
|------|------------|-----------|
| Nom | ‚úÖ | ‚úÖ |
| NIF/CIF | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Categoria per defecte | ‚ùå | ‚ùå |
| Adre√ßa | ‚ùå | ‚ùå |
| IBAN | ‚ùå | ‚ùå |

### 3.6.6 Exportaci√≥ de Donants a Excel (NOU v1.16)

Bot√≥ "Exportar" a la llista de donants per descarregar un fitxer Excel.

**Columnes exportades:**

| Columna | Font |
|---------|------|
| Nom | `donor.name` |
| NIF | `donor.taxId` |
| Quota mensual | `donor.monthlyAmount` (formatat ‚Ç¨) |
| IBAN | `donor.iban` (formatat amb espais) |
| Estat | "Alta", "Baixa" o "Pendent devoluci√≥" |

**Comportament:**
- Llista ordenada alfab√®ticament per nom
- Nom del fitxer: `donants_YYYY-MM-DD.xlsx`
- Amplada de columnes ajustada autom√†ticament

**Fitxer:** `src/lib/donors-export.ts`

### 3.6.7 DonorDetailDrawer

Panel lateral que s'obre clicant el nom d'un donant:
- Informaci√≥ completa del donant
- Historial de donacions (paginat)
- **Historial de devolucions** (NOU v1.8)
- Resum per any
- Generaci√≥ de certificats


## 3.7 PROJECTES / EIXOS D'ACTUACI√ì

| Camp | Obligatori |
|------|------------|
| Nom | ‚úÖ |
| Descripci√≥ | ‚ùå |
| Finan√ßador | ‚ùå |
| Actiu | ‚úÖ |

Estad√≠stiques per projecte:
- Total ingressos
- Total despeses
- Balan√ß


## 3.8 INFORMES FISCALS

### 3.8.1 Model 182 - Declaraci√≥ de Donacions

**Data l√≠mit:** 31 de gener

**Exportaci√≥ Excel per Gestoria:**

| Columna | Valor | Font |
|---------|-------|------|
| NIF | DNI/CIF | donor.taxId |
| NOMBRE | Nom complet | donor.name |
| CLAVE | "A" | Fix (dinerari Llei 49/2002) |
| PROVINCIA | Codi 2 d√≠gits | donor.zipCode.substring(0,2) |
| PORCENTAJE | *(buit)* | Gestoria ho calcula |
| VALOR | Import any actual | Suma donacions - devolucions |
| VALOR_1 | Import any -1 | Hist√≤ric |
| VALOR_2 | Import any -2 | Hist√≤ric |
| RECURRENTE | "X" o buit | Si VALOR_1 > 0 AND VALOR_2 > 0 |
| NATURALEZA | "F" o "J" | individual ‚Üí F, company ‚Üí J |

**Gesti√≥ de devolucions:**
- `transactionType === 'return'` ‚Üí Es resta autom√†ticament
- `donationStatus === 'returned'` ‚Üí Es resta autom√†ticament
- Les filles de remeses amb `contactId` ‚Üí Es compten
- Els pares de remeses sense `contactId` ‚Üí S'ignoren

**Fitxer generat:** `Model182_{org}_{any}.xlsx`

### 3.8.2 Model 347 - Operacions amb Tercers

**Data l√≠mit:** 28 de febrer

**Llindar:** > 3.005,06‚Ç¨ anuals per prove√Ødor

**Exportaci√≥:** CSV amb NIF, Nom, Import total

### 3.8.3 Certificats de Donaci√≥

**Tipus:**
- Individual (per donaci√≥)
- Anual (totes les donacions d'un any)
- Massiu (ZIP amb tots)

**Format PDF:**
- Logo de l'organitzaci√≥
- Firma digitalitzada
- Text legal Llei 49/2002

**C√†lcul de l'import:**
- Import = Œ£ donacions - Œ£ devolucions
- Si import ‚â§ 0 ‚Üí No es genera certificat


## 3.9 CONFIGURACI√ì

### 3.9.1 Dades de l'Organitzaci√≥
Nom, CIF, adre√ßa, ciutat, CP, tel√®fon, email, web, logo

### 3.9.2 Configuraci√≥ de Certificats
Firma digitalitzada, nom signant, c√†rrec

### 3.9.3 Prefer√®ncies
Llindar alertes contacte: 0‚Ç¨, 50‚Ç¨, 100‚Ç¨, 500‚Ç¨

### 3.9.4 Categories Comptables
Categories d'ingressos i despeses personalitzables

### 3.9.5 Gesti√≥ de Membres
Convidar, canviar rol, eliminar

### 3.9.6 Zona de Perill (SuperAdmin)

Accions irreversibles nom√©s per SuperAdmin:

| Acci√≥ | Descripci√≥ |
|-------|------------|
| Esborrar tots els donants | Elimina tots els donants de l'organitzaci√≥ |
| Esborrar tots els prove√Ødors | Elimina tots els prove√Ødors |
| Esborrar tots els treballadors | Elimina tots els treballadors |
| Esborrar tots els moviments | Elimina totes les transaccions |
| Esborrar √∫ltima remesa | Esborra les transaccions filles i restaura la remesa original |

**Esborrar √∫ltima remesa:**
- Busca l'√∫ltima remesa processada (isRemittance === true)
- Mostra info: data, concepte, import, nombre de quotes
- Demana confirmaci√≥ escrivint "BORRAR"
- Esborra totes les transaccions filles
- Restaura la transacci√≥ original per tornar-la a processar

### 3.9.7 Sistema de traduccions (i18n)

#### Context i problema resolt

El sistema anterior (nom√©s `ca.ts`, `es.ts`, `fr.ts`) requeria un developer per afegir o modificar traduccions. Aix√≤ bloquejava:
- Traducci√≥ externa (traductors sense acc√©s al codi)
- Afegir idiomes nous sense deploy
- Correccions r√†pides de textos

El nou sistema permet gesti√≥ completa des del SuperAdmin sense tocar codi.

#### Arquitectura

- **Source of truth editable**: Firebase Storage
  `i18n/{lang}.json`

- **Fallback local (repo)**:
  `src/i18n/locales/{lang}.json`

- **Legacy fallback**:
  Objectes TypeScript (`ca.ts`, `es.ts`, `fr.ts`) nom√©s per codi antic

#### Ordre de c√†rrega en runtime

1. JSON a Firebase Storage (`i18n/{lang}.json`)
2. JSON local del repositori (`src/i18n/locales/{lang}.json`)
3. Fallback a la clau (`"dashboard.title"`)

#### Contracte d'√∫s

- **`t.xxx.yyy`** ‚Üí sistema legacy (objecte TypeScript)
- **`tr("xxx.yyy")`** ‚Üí sistema nou (JSON pla)

**‚ùå Prohibit: `t("xxx.yyy")`** (no existeix, causa error de producci√≥)

#### Idiomes disponibles

| Codi | Idioma | TS (legacy) | JSON | Estat |
|------|--------|-------------|------|-------|
| `ca` | Catal√† | ‚úÖ | ‚úÖ | Base (complet) |
| `es` | Espa√±ol | ‚úÖ | ‚úÖ | Complet |
| `fr` | Fran√ßais | ‚úÖ | ‚úÖ | Complet |
| `pt` | Portugu√™s | ‚ùå | ‚úÖ | JSON-only |

#### Selector d'idioma

- Ubicaci√≥: Men√∫ usuari (cantonada superior dreta)
- Persist√®ncia: `localStorage`
- Comportament: Canvi immediat sense recarregar

#### Operativa SuperAdmin (Traduccions)

1. Accedir a SuperAdmin ‚Üí Traduccions
2. Seleccionar idioma
3. Descarregar JSON
4. Editar externament (Excel / POEditor / editor JSON)
5. Pujar JSON validat
6. Clicar "Publicar" (invalida cache global)

Els canvis s√≥n immediats per a tots els usuaris.

#### Afegir un idioma nou

1. Afegir codi d'idioma a `Language` (`src/i18n/index.ts`)
2. Crear `src/i18n/locales/{lang}.json` (copiat de `ca.json`)
3. Afegir idioma als selectors (app + SuperAdmin)
4. Descarregar plantilla via SuperAdmin
5. Traduir, pujar i publicar

#### Scripts

```bash
# Exportar traduccions TS a JSON i generar report de claus
npm run i18n:export
```

Exemple de report:
```
[i18n] Key comparison report:
  Base (ca): 850 keys
  es: ‚úì Perfect match (850 keys)
  fr: ‚úì Perfect match (850 keys)
  pt: ‚úì Perfect match (850 keys)
```

#### Fitxers clau

| Fitxer | Responsabilitat |
|--------|-----------------|
| `src/i18n/index.ts` | Tipus `Language`, context, hook |
| `src/i18n/provider.tsx` | Provider, listener versi√≥, carrega JSON |
| `src/i18n/json-runtime.ts` | Loader Storage/local, cache, `trFactory` |
| `src/i18n/locales/*.json` | Bundles JSON (fallback local) |
| `src/i18n/ca.ts`, `es.ts`, `fr.ts` | Traduccions TS legacy |
| `src/i18n/public.ts` | Traduccions p√†gines p√∫bliques (NOU v1.25) |
| `scripts/i18n/export-all.ts` | Export TS ‚Üí JSON |

Per a m√©s detall operatiu, veure `docs/i18n.md`.


### 3.9.8 i18n per a Rutes P√∫bliques (NOU v1.25)

#### Context i problema resolt

Les p√†gines p√∫bliques (login, privacy, contact) estaven nom√©s en catal√† amb textos hardcoded. Per millorar:
- SEO internacional amb canonical + hreflang
- Experi√®ncia d'usuari en el seu idioma preferit
- Consist√®ncia amb l'app privada (4 idiomes)

#### Arquitectura

Per evitar col¬∑lisi√≥ entre `[lang]` i `[orgSlug]` (tots dos segments din√†mics al root),
les p√†gines p√∫bliques estan sota un segment real `public`:

```
/src/app/public/[lang]/       ‚Üí Segment real + din√†mic (intern)
  /page.tsx                   ‚Üí HOME multiidioma
  /funcionalitats/page.tsx    ‚Üí Funcionalitats
  /login/page.tsx             ‚Üí P√†gina login multiidioma
  /privacy/page.tsx           ‚Üí Pol√≠tica de privacitat
  /contact/page.tsx           ‚Üí P√†gina de contacte
  layout.tsx                  ‚Üí Validaci√≥ idioma + SSG params

/src/app/page.tsx             ‚Üí Redirect stub ‚Üí /${lang}
/src/app/funcionalitats/page.tsx ‚Üí Redirect stub ‚Üí /${lang}/funcionalitats
/src/app/login/page.tsx       ‚Üí Redirect stub ‚Üí /${lang}/login
/src/app/privacy/page.tsx     ‚Üí Redirect stub ‚Üí /${lang}/privacy
/src/app/contacte/page.tsx    ‚Üí Redirect stub ‚Üí /${lang}/contact
/src/app/privacitat/page.tsx  ‚Üí Redirect stub ‚Üí /${lang}/privacy (legacy)
```

**Middleware rewrite:** `/fr/...` ‚Üí `/public/fr/...` (URL p√∫blica es mant√©)

**Slugs reservats** (no es poden usar com orgSlug):
`ca`, `es`, `fr`, `pt`, `public`, `login`, `admin`, `dashboard`, `privacy`, `api`, `q`, `registre`, `redirect-to-org`

#### Idiomes suportats (rutes p√∫bliques)

| Codi | Idioma | URL exemple |
|------|--------|-------------|
| `ca` | Catal√† | `/ca/login`, `/ca/privacy`, `/ca/contact` |
| `es` | Espa√±ol | `/es/login`, `/es/privacy`, `/es/contact` |
| `fr` | Fran√ßais | `/fr/login`, `/fr/privacy`, `/fr/contact` |
| `pt` | Portugu√™s | `/pt/login`, `/pt/privacy`, `/pt/contact` |

#### Detecci√≥ autom√†tica d'idioma

Quan un usuari accedeix a `/login` (sense idioma), el sistema:

1. Llegeix l'header `Accept-Language` del navegador
2. Parseja i ordena per qualitat (`q=0.9`, etc.)
3. Troba el primer idioma suportat
4. Redirigeix a `/{lang}/login`

**Exemple:**
```
Accept-Language: pt-BR,pt;q=0.9,en;q=0.8
‚Üí Redirigeix a /pt/login

Accept-Language: de-DE,de;q=0.9,en;q=0.8
‚Üí Redirigeix a /ca/login (default, alemany no suportat)
```

#### Fitxers clau

| Fitxer | Responsabilitat |
|--------|-----------------|
| `src/lib/public-locale.ts` | Tipus `PublicLocale`, `detectPublicLocale()`, `generatePublicPageMetadata()` |
| `src/i18n/public.ts` | Traduccions completes per home, funcionalitats, login, privacy, contact (CA/ES/FR/PT) |
| `src/middleware.ts` | Rewrite `/fr/...` ‚Üí `/public/fr/...` + protecci√≥ segments reservats |
| `src/app/public/[lang]/layout.tsx` | Validaci√≥ idioma + `generateStaticParams()` per SSG |
| `src/app/public/[lang]/*/page.tsx` | P√†gines amb traduccions i metadades SEO |
| `src/components/IdleLogoutProvider.tsx` | RESERVED_SEGMENTS (inclou idiomes) |

#### SEO: Canonical i Hreflang

Cada p√†gina p√∫blica genera metadades SEO correctes:

```typescript
// Exemple per /ca/privacy
{
  alternates: {
    canonical: "https://summasocial.app/ca/privacy",
    languages: {
      ca: "https://summasocial.app/ca/privacy",
      es: "https://summasocial.app/es/privacy",
      fr: "https://summasocial.app/fr/privacy",
      pt: "https://summasocial.app/pt/privacy"
    }
  }
}
```

Aix√≤ genera els tags HTML:
```html
<link rel="canonical" href="https://summasocial.app/ca/privacy" />
<link rel="alternate" hreflang="ca" href="https://summasocial.app/ca/privacy" />
<link rel="alternate" hreflang="es" href="https://summasocial.app/es/privacy" />
<link rel="alternate" hreflang="fr" href="https://summasocial.app/fr/privacy" />
<link rel="alternate" hreflang="pt" href="https://summasocial.app/pt/privacy" />
```

#### Estructura de traduccions (public.ts)

```typescript
// src/i18n/public.ts
export interface PublicTranslations {
  common: {
    appName: string;
    tagline: string;
    close: string;
    backToHome: string;
    // ...
  };
  login: {
    title: string;
    welcomeTitle: string;
    welcomeDescription: string;
    sessionExpired: string;
    // ...
  };
  privacy: {
    title: string;
    sections: {
      whoWeAre: { title: string; intro: string; /* ... */ };
      whatData: { /* ... */ };
      // 9 seccions completes
    };
  };
  contact: {
    title: string;
    subtitle: string;
    responseTime: string;
  };
}

// Traduccions per cada idioma
const ca: PublicTranslations = { /* ... */ };
const es: PublicTranslations = { /* ... */ };
const fr: PublicTranslations = { /* ... */ };
const pt: PublicTranslations = { /* ... */ };

export const publicTranslations: Record<PublicLocale, PublicTranslations> = {
  ca, es, fr, pt
};
```

#### √ös a les p√†gines

```tsx
// src/app/[lang]/login/page.tsx
import { getPublicTranslations } from '@/i18n/public';
import { isValidPublicLocale } from '@/lib/public-locale';

export default function LoginPage({ params }: { params: { lang: string } }) {
  const lang = isValidPublicLocale(params.lang) ? params.lang : 'ca';
  const t = getPublicTranslations(lang);

  return (
    <h1>{t.login.welcomeTitle}</h1>
    // "Benvingut a Summa Social" / "Bienvenido a Summa Social" / etc.
  );
}
```

#### Compatibilitat amb URLs antigues

Les URLs antigues continuen funcionant amb redirect:

| URL antiga | Redirigeix a |
|------------|--------------|
| `/login` | `/{detectat}/login` |
| `/privacy` | `/{detectat}/privacy` |
| `/privacitat` | `/{detectat}/privacy` |
| `/contacte` | `/{detectat}/contact` |

On `{detectat}` √©s l'idioma detectat via Accept-Language (default: `ca`).

#### Difer√®ncia amb i18n de l'app privada

| Aspecte | App privada (`/[orgSlug]/dashboard`) | P√†gines p√∫bliques (`/[lang]/*`) |
|---------|--------------------------------------|----------------------------------|
| **Traduccions** | `src/i18n/ca.ts`, `es.ts`, `fr.ts` + JSON | `src/i18n/public.ts` |
| **Tipus** | `Language` (`ca`, `es`, `fr`) | `PublicLocale` (`ca`, `es`, `fr`, `pt`) |
| **Persist√®ncia idioma** | `localStorage` (selector usuari) | URL path (`/ca/`, `/es/`, etc.) |
| **Detecci√≥** | Prefer√®ncia guardada | `Accept-Language` header |
| **SEO** | No aplica (app privada) | Canonical + hreflang |
| **SSG** | No (din√†mic) | S√≠ (`generateStaticParams`) |


## 3.10 IMPORTADOR STRIPE (NOU v1.9)

### 3.10.1 Visi√≥ general

L'importador Stripe permet dividir les liquidacions (payouts) de Stripe en transaccions individuals, identificant cada donaci√≥ i separant les comissions.

| Caracter√≠stica | Valor |
|----------------|-------|
| **Format entrada** | CSV exportat de Stripe ("Pagos ‚Üí Columnes predeterminades") |
| **Matching donants** | Per email (exacte, case insensitive) |
| **Creaci√≥ autom√†tica donants** | NO |
| **Gesti√≥ comissions** | Despesa agregada per payout |

**Principi fonamental:** El moviment bancari original (payout) MAI es modifica.

### 3.10.2 Flux d'√∫s

```
1. L'usuari veu un ingr√©s de Stripe al llistat de moviments
2. Men√∫ ‚ãÆ ‚Üí "Dividir remesa Stripe"
3. Puja el CSV exportat de Stripe
4. El sistema agrupa per Transfer (payout) i cerca el que quadra amb l'import bancari
5. Previsualitzaci√≥: donacions + comissions + matching donants
6. L'usuari revisa i assigna manualment els pendents
7. Confirma ‚Üí Es creen les transaccions filles
```

### 3.10.3 Condici√≥ per mostrar l'acci√≥

L'opci√≥ "Dividir remesa Stripe" apareix si:

```typescript
const canSplitStripeRemittance = (tx: Transaction): boolean => {
  const isIncome = tx.amount > 0;
  const isNotAlreadyDivided = tx.transactionType !== 'donation' && tx.transactionType !== 'fee';
  const isNotRemittance = !tx.isRemittance;
  
  if (!isIncome || !isNotAlreadyDivided || !isNotRemittance) return false;
  
  // Transaccions noves (ja tenen source)
  if (tx.source === 'stripe') return true;
  
  // Fallback legacy (backward compatibility)
  const descUpper = tx.description?.toUpperCase() || '';
  return descUpper.includes('STRIPE') || descUpper.includes('TRANSFERENCIA DE STRIPE');
};
```

### 3.10.4 Camps CSV requerits

| Camp Stripe | √ös a Summa Social | Obligatori |
|-------------|-------------------|------------|
| `id` | Tra√ßabilitat (`stripePaymentId`) | ‚úÖ |
| `Created date (UTC)` | Data de la donaci√≥ | ‚úÖ |
| `Amount` | Import brut | ‚úÖ |
| `Fee` | Comissi√≥ Stripe | ‚úÖ |
| `Customer Email` | Matching amb donant | ‚úÖ |
| `Status` | Filtrar nom√©s `succeeded` | ‚úÖ |
| `Transfer` | Agrupaci√≥ per payout (`po_xxx`) | ‚úÖ |
| `Amount Refunded` | Detectar reemborsos | ‚úÖ |
| `Description` | Concepte (opcional) | ‚ùå |

### 3.10.5 Filtratge autom√†tic

| Condici√≥ | Acci√≥ |
|----------|-------|
| `Status !== 'succeeded'` | Excloure silenciosament |
| `Amount Refunded > 0` | Excloure + mostrar av√≠s |

### 3.10.6 Agrupaci√≥ per payout

Les donacions s'agrupen pel camp `Transfer` (po_xxx):

```typescript
interface PayoutGroup {
  transferId: string;    // po_xxx
  rows: StripeRow[];     // Donacions del payout
  gross: number;         // Œ£ Amount
  fees: number;          // Œ£ Fee
  net: number;           // gross - fees
}
```

### 3.10.7 Match amb el banc

**Criteri:** Per import net (¬±0,02‚Ç¨ de toler√†ncia)

```typescript
const tolerance = 0.02;
const match = Math.abs(payoutGroup.net - bankTransaction.amount) <= tolerance;
```

> ‚ö†Ô∏è El banc NO porta el `Transfer` (po_xxx). El match √©s exclusivament per import.

### 3.10.8 Matching de donants

| Prioritat | Criteri | Implementaci√≥ |
|-----------|---------|---------------|
| 1 | Email | `donor.email.toLowerCase() === stripeRow.customerEmail.toLowerCase()` |

**Regles estrictes:**
- NO fuzzy matching
- NO crear donants autom√†ticament
- Si no hi ha match ‚Üí fila queda "Pendent d'assignar"

### 3.10.9 Transaccions generades

**Per cada donaci√≥ (N ingressos):**

```typescript
{
  date: stripeRow.createdDate,
  description: ensureStripeInDescription(stripeRow.description, stripeRow.customerEmail),
  amount: stripeRow.amount,              // Import BRUT (positiu)
  contactId: matchedDonor?.id || null,
  contactType: matchedDonor ? 'donor' : null,
  contactName: matchedDonor?.name || null,
  source: 'stripe',
  transactionType: 'donation',
  parentTransactionId: bankTransaction.id,
  stripePaymentId: stripeRow.id,         // ch_xxx
  stripeTransferId: selectedGroup.transferId,  // po_xxx
  categoryId: matchedDonor?.defaultCategoryId || null
}
```

**Per les comissions (1 despesa agregada):**

```typescript
{
  date: bankTransaction.date,
  description: `Comissions Stripe - ${count} donacions`,
  amount: -totalFees,                    // Negatiu (despesa)
  source: 'stripe',
  transactionType: 'fee',
  parentTransactionId: bankTransaction.id,
  stripeTransferId: selectedGroup.transferId,
  categoryId: bankFeesCategoryId         // Categoria 'bankFees'
}
```

**Cercabilitat (sufix autom√†tic):**

```typescript
function ensureStripeInDescription(desc: string | null, email: string): string {
  const base = desc || `Donaci√≥ Stripe - ${email}`;
  if (base.toUpperCase().includes('STRIPE')) return base;
  return `${base} (via Stripe)`;
}
```

### 3.10.10 Model de dades

**Camps espec√≠fics Stripe a Transaction:**

| Camp | Tipus | Descripci√≥ |
|------|-------|------------|
| `source` | `'stripe'` | Identifica origen |
| `transactionType` | `'donation' \| 'fee'` | Tipus de transacci√≥ |
| `stripePaymentId` | `string \| null` | ID pagament (`ch_xxx`) - Idempot√®ncia |
| `stripeTransferId` | `string \| null` | ID payout (`po_xxx`) - Correlaci√≥ |
| `parentTransactionId` | `string` | ID del moviment bancari pare |

### 3.10.11 Impacte fiscal

| Document | Tractament |
|----------|------------|
| **Model 182** | Nom√©s compten les filles amb `contactId` i `transactionType: 'donation'` |
| **Certificats** | Import = Œ£ donacions Stripe del donant |
| **Comissions** | NO afecten fiscalitat donants (s√≥n despeses de l'entitat) |

### 3.10.12 UI

**Pas 1: Pujar fitxer**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dividir remesa Stripe                   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Import al banc: 115,55 ‚Ç¨                ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Arrossega el CSV aqu√≠]                 ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚ö†Ô∏è No obrir el CSV amb Excel abans      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Pas 2: Revisi√≥**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3 donacions trobades                                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ Brut:        120,00 ‚Ç¨                                           ‚îÇ
‚îÇ Comissions:   -4,45 ‚Ç¨                                           ‚îÇ
‚îÇ Net:         115,55 ‚Ç¨ ‚úÖ (quadra amb banc)                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ
‚îÇ ‚úÖ lourdes@example.com    ‚Üí Lourdes Hoyal       50,00 ‚Ç¨         ‚îÇ
‚îÇ ‚úÖ pere@example.com       ‚Üí Pere Mart√≠          30,00 ‚Ç¨         ‚îÇ
‚îÇ ‚ö†Ô∏è nou@email.com          ‚Üí [Assignar]          40,00 ‚Ç¨         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                              [Cancel¬∑lar] [Processar]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3.10.13 Errors i missatges

| Codi | Condici√≥ | Missatge |
|------|----------|----------|
| `ERR_NO_COLUMNS` | Falten columnes | "El CSV no t√© les columnes necess√†ries: {columnes}" |
| `ERR_NO_MATCH` | Cap payout quadra | "No s'ha trobat cap payout que coincideixi amb {amount} ‚Ç¨" |
| `ERR_AMOUNT_MISMATCH` | Import no quadra | "L'import no quadra. Esperats {expected} ‚Ç¨, calculats {actual} ‚Ç¨" |
| `ERR_NO_BANK_FEES_CATEGORY` | Falta categoria | "No s'ha trobat la categoria de despeses banc√†ries" |
| `WARN_REFUNDED` | Hi ha reemborsos | "S'han excl√≤s {count} donacions reemborsades ({amount} ‚Ç¨)" |
| `WARN_NO_DONOR` | Sense match | "{count} donacions pendents d'assignar donant" |

### 3.10.14 L√≠mits del sistema

| Perm√®s | NO perm√®s |
|--------|-----------|
| Matching per email exacte | Fuzzy matching |
| Assignaci√≥ manual pendents | Creaci√≥ autom√†tica donants |
| M√∫ltiples payouts al CSV | Connexi√≥ directa API Stripe |
| Exclusi√≥ reemborsos | Processament autom√†tic refunds |

### 3.10.15 Estructura de fitxers

```
/src/components/stripe-importer/
  ‚îú‚îÄ‚îÄ useStripeImporter.ts    # Hook amb l√≤gica de parsing i matching
  ‚îú‚îÄ‚îÄ StripeImporter.tsx      # Component UI (modal)
  ‚îî‚îÄ‚îÄ index.ts                # Exports
```

**Punt de connexi√≥:** `transaction-table.tsx` ‚Üí men√∫ ‚ãÆ si `canSplitStripeRemittance(tx)`


## 3.11 M√íDUL PROJECTES ‚Äî JUSTIFICACI√ì ASSISTIDA (NOU v1.10)

### 3.11.0 Navegaci√≥ del M√≤dul Projectes (NOU v1.14)

El m√≤dul Projectes t√© una entrada √∫nica al sidebar amb un submenu col¬∑lapsable.

**Estructura del sidebar:**

| Nivell | Element | Ruta |
|--------|---------|------|
| Pare | **Projectes** (icona FolderKanban) | ‚Äî |
| ‚îî‚îÄ Fill 1 | Gesti√≥ de projectes | `/dashboard/project-module/projects` |
| ‚îî‚îÄ Fill 2 | Assignaci√≥ de despeses | `/dashboard/project-module/expenses` |

**Component:** `Collapsible` de shadcn/ui

**Comportament:**
- Per defecte tancat
- S'obre/tanca fent clic al pare
- Icona `ChevronRight` rota 90¬∞ quan obert
- Estil suau per a subelements (mida i color redu√Øts)

**Fitxer:** `src/components/dashboard-sidebar-content.tsx`

**Traduccions:**
- `sidebar.projectModule`: "Projectes"
- `sidebar.projectModuleManage`: "Gesti√≥ de projectes"
- `sidebar.projectModuleExpenses`: "Assignaci√≥ de despeses"

### 3.11.1 Objectiu del m√≤dul

Permetre a una persona t√®cnica quadrar la justificaci√≥ econ√≤mica d'un projecte (ACCD, Fons Catal√†, etc.) a partir de les despeses reals existents, sense treballar en Excel, sense preconfiguracions r√≠gides i sense modificar dades fins a la validaci√≥ final.

> ‚ö†Ô∏è **Aquest m√≤dul √©s extern al core de Summa Social** i segueix el patr√≥ d'exports descrit a l'Annex C.

### 3.11.2 Principis de disseny (no negociables)

| Principi | Descripci√≥ |
|----------|------------|
| **Sense mapa obligatori** | No existeix un mapa r√≠gid partides entitat ‚Üî finan√ßador |
| **Sense classificaci√≥ pr√®via** | No es for√ßa la classificaci√≥ pr√®via de despeses |
| **Sense workflows** | No hi ha workflows d'aprovaci√≥ ni estats de "justificat" |
| **Sense entitats noves** | No es creen entitats noves per simular |
| **Reversible** | Tot el proc√©s √©s reversible fins a "Aplicar" |

### 3.11.3 Pantalla base: Gesti√≥ Econ√≤mica del Projecte

| Element | Descripci√≥ |
|---------|------------|
| Targetes resum | Pressupostat / Executat / Pendent |
| Bloc principal | Seguiment Econ√≤mic (partides) |
| CTA | "Quadrar justificaci√≥" |

**Cap proc√©s de justificaci√≥ obliga a sortir d'aquesta pantalla.**

#### C√†lcul del pressupost

| Condici√≥ | Pressupost mostrat |
|----------|-------------------|
| Projecte **amb** partides | Suma de `budgetedAmountEUR` de totes les partides |
| Projecte **sense** partides | Camp `budgetEUR` del projecte |

```typescript
interface BudgetLinesData {
  sum: number;
  hasLines: boolean;  // Permet distingir "0 partides" de "partides amb sum=0"
}

const budgeted = budgetLinesData?.hasLines
  ? budgetLinesData.sum
  : (project.budgetEUR ?? 0);
```

#### Importador de pressupost (NOU v1.16)

Wizard d'importaci√≥ de partides des d'Excel (.xlsx) amb 5 passos:

| Pas | Descripci√≥ |
|-----|------------|
| 1. Fitxer | Pujar fitxer Excel (.xlsx) |
| 2. Pestanya | Seleccionar sheet (si n'hi ha m√∫ltiples) |
| 3. Columnes | Mapar columnes: nom, import del finan√ßador principal, codi (opcional) |
| 4. Agrupaci√≥ | Triar mode: agrupar subpartides a partida o importar tal qual |
| 5. Revisi√≥ | Previsualitzaci√≥ amb checkboxes per incloure/excloure |

**Caracter√≠stiques:**
- Auto-detecta columnes per patrons de cap√ßalera
- Parseja formats EU (1.234,56) i EN (1234.56)
- Exclou autom√†ticament files de totals/subtotals
- Mode "Agrupar" suma subpartides al seu pare (evita duplicitats)
- Substitueix completament el pressupost existent (batch delete + batch create)

**Important:**
- Nom√©s importa la columna del finan√ßador principal (p.ex. ACCD)
- No suport multi-finan√ßador ni contrapartida
- No suport PDF (nom√©s Excel)

**Fitxers:**
- `src/lib/budget-import.ts`: Utilitats de parsing
- `src/components/project-module/budget-import-wizard.tsx`: Wizard UI

### 3.11.4 Mode "Quadrar justificaci√≥ del projecte"

- Vista assistida superposada (modal)
- L'usuari continua veient el seguiment econ√≤mic
- Organitzaci√≥ per **partida**, no per despesa
- Dos modes segons desviaci√≥:
  - **Infraexecuci√≥** ‚Üí afegir despeses
  - **Sobreexecuci√≥** ‚Üí treure o reduir imputacions

### 3.11.5 Infraexecuci√≥: afegir despeses

El sistema suggereix despeses del pool per defecte:
- Font = offBank (despeses fora de banc)
- Dins del per√≠ode del projecte
- No assignades o parcialment assignades

Les sugger√®ncies es basen en:
- Fam√≠lia sem√†ntica de la categoria
- Keywords a la descripci√≥
- Import que encaixa amb el d√®ficit

L'usuari pot:
- Acceptar una proposta sencera
- **Ampliar criteris de cerca** (afegir fonts, fora per√≠ode, altres projectes)
- Seleccionar manualment

**Les sugger√®ncies s√≥n heur√≠stiques, mai bloquegen, mai escriuen dades.**

#### Algorisme de scoring (v1.12)

| Factor | Punts | Descripci√≥ |
|--------|-------|------------|
| Categoria coincident | +3 | La despesa pertany a la mateixa fam√≠lia sem√†ntica |
| Descripci√≥ coincident | +2 | Keywords de la despesa apareixen a la partida |
| Import encaixa | +1 | L'import √©s ‚â§ d√®ficit de la partida |
| Assignada altre projecte | -3 | Penalitzaci√≥ per risc de desquadrar altre projecte |

**Pool de candidats per defecte:**
- Font = offBank (despeses fora de banc)
- Dins del per√≠ode del projecte
- No assignades o parcialment assignades

**Etiquetes informatives (NO afecten scoring):**

| Etiqueta | Condici√≥ | Visualitzaci√≥ |
|----------|----------|---------------|
| Sense document | `hasDocument = false` | Badge groc |
| Categoria pendent | Categoria "Revisar" o buida | Badge taronja amb icona |
| Sense contrapart | `counterpartyName` buit | Badge gris |

> ‚ö†Ô∏è **Canvi v1.12:** "Sense document" i "sense contrapart" ja no penalitzen el scoring. S√≥n etiquetes informatives que l'usuari veu per√≤ que no condicionen l'ordre de les sugger√®ncies.

#### Fam√≠lies sem√†ntiques

```typescript
const CATEGORY_FAMILIES = {
  viatges: ['transport', 'dietes', 'allotjament', 'taxi', 'avi√≥', ...],
  personal: ['n√≤mina', 'salari', 'seguretat social', ...],
  serveis: ['consultoria', 'assessorament', 'honoraris', ...],
  material: ['subministrament', 'fungible', 'oficina', ...],
  formacio: ['formaci√≥', 'curs', 'taller', ...],
  comunicacio: ['comunicaci√≥', 'm√†rqueting', 'difusi√≥', ...],
};
```

#### Classificaci√≥ de propostes

| Etiqueta | Criteri | Visualitzaci√≥ |
|----------|---------|---------------|
| `perfect` | Delta ‚â§ 0,50‚Ç¨ | Badge verd "Exacte" |
| `close` | Delta ‚â§ 2% del d√®ficit | Badge blau "Proper" |
| `approx` | Resta | Badge gris "Aproximat" |

### 3.11.6 Sobreexecuci√≥: treure despeses

Es pot:
- Treure **tota** la despesa de la partida
- Treure nom√©s una **part** de l'import (split parcial)

La part treta queda:
- Dins del projecte
- Sense partida assignada

> ‚ö†Ô∏è **El split parcial √©s una funcionalitat clau, no un edge case.** Aquesta √©s la forma m√©s habitual i realista de quadrar justificacions.

### 3.11.7 Simulaci√≥ (capa cr√≠tica)

| Element | Comportament |
|---------|--------------|
| Moviments | Es fan en mem√≤ria |
| Escriptura | NO fins que l'usuari clica "Aplicar" |
| Visualitzaci√≥ | Execuci√≥ abans / despr√©s, efecte per partida |
| Aplicar | Usa els hooks existents (`useSaveExpenseLink`) |

### 3.11.8 Tipus de canvi i justificaci√≥

- El projecte defineix un tipus de canvi de refer√®ncia
- Les despeses de terreny poden tenir moneda original
- La justificaci√≥ sempre es quadra en EUR
- Camps de justificaci√≥:
  - No s√≥n obligatoris
  - S'editen nom√©s quan cal justificar
  - Existeixen per respondre al finan√ßador, no per comptabilitat

### 3.11.9 Qu√® NO fa Summa (expl√≠cit)

| NO fa | Motiu |
|-------|-------|
| No valida formalment justificacions | No som auditors |
| No bloqueja desviacions | L'usuari decideix |
| No obliga a quadrar al c√®ntim | Realisme operatiu |
| No substitueix el criteri t√®cnic | Eina, no workflow |
| No converteix la justificaci√≥ en proc√©s r√≠gid | Flexibilitat > rigidesa |

> **Blindatge:** Les assignacions i simulacions del m√≤dul de projectes no modifiquen ni condicionen els c√†lculs fiscals ni els informes oficials (Model 182, certificats).

### 3.11.10 Estructura de fitxers

```
/src/app/[orgSlug]/
  ‚îú‚îÄ‚îÄ quick-expense/                    # Landing fora de dashboard (NOU v1.22)
  ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                    # Layout m√≠nim (OrganizationProvider)
  ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                      # P√†gina landing
  ‚îî‚îÄ‚îÄ dashboard/project-module/
      ‚îú‚îÄ‚îÄ expenses/
      ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Llistat de despeses elegibles
      ‚îÇ   ‚îú‚îÄ‚îÄ [txId]/page.tsx           # Detall d'una despesa
      ‚îÇ   ‚îî‚îÄ‚îÄ capture/page.tsx          # Captura r√†pida de terreny (NOU v1.11)
      ‚îú‚îÄ‚îÄ projects/
      ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Llista de projectes
      ‚îÇ   ‚îî‚îÄ‚îÄ [projectId]/
      ‚îÇ       ‚îú‚îÄ‚îÄ budget/page.tsx       # Gesti√≥ Econ√≤mica (pantalla base)
      ‚îÇ       ‚îî‚îÄ‚îÄ edit/page.tsx         # Edici√≥ del projecte
      ‚îî‚îÄ‚îÄ quick-expense/
          ‚îî‚îÄ‚îÄ page.tsx                  # Redirect 307 a /{orgSlug}/quick-expense

/src/app/quick/
  ‚îî‚îÄ‚îÄ page.tsx                          # Shortcut global ‚Üí detecta org ‚Üí landing

/src/components/project-module/
  ‚îú‚îÄ‚îÄ balance-project-modal.tsx         # Modal "Quadrar justificaci√≥"
  ‚îú‚îÄ‚îÄ quick-expense-screen.tsx          # Component UI de captura r√†pida
  ‚îî‚îÄ‚îÄ ...

/src/lib/
  ‚îú‚îÄ‚îÄ project-module-types.ts           # Tipus del m√≤dul
  ‚îî‚îÄ‚îÄ project-module-suggestions.ts     # Scoring i combinacions (NOU v1.10)
```

### 3.11.11 Drag & Drop de documents a Assignaci√≥ de despeses (NOU v1.16)

Permet pujar documents arrossegant-los directament sobre cada fila de despesa a la safata d'assignaci√≥ (`/project-module/expenses`).

**Comportament:**

| Element | Descripci√≥ |
|---------|------------|
| Drop zone | Cada fila de la taula de despeses |
| Feedback visual | Ring blau i fons semitransparent durant arrossegament |
| Auto-naming | Format `YYYY.MM.DD_concepte_normalitzat.ext` |
| Tipus acceptats | PDF, imatges, Word, Excel |
| Mida m√†xima | 10 MB per fitxer |

**Implementaci√≥:**
- Despeses off-bank: S'afegeix a l'array `attachments[]`
- Despeses banc√†ries: S'assigna al camp `document` (objecte √∫nic)
- Nom generat autom√†ticament amb `buildDocumentFilename()`

**Component:** `DroppableExpenseRow` dins `expenses/page.tsx`

**Renomenar documents:**
- Bot√≥ llapis a cada attachment pujat
- Edici√≥ inline del nom (sense extensi√≥)
- Enter per guardar, Escape per cancel¬∑lar

### 3.11.12 Captura de despeses de terreny (NOU v1.11)

| Element | Descripci√≥ |
|---------|------------|
| Ruta | `/project-module/expenses/capture` |
| Objectiu | Pujada r√†pida de comprovants des del m√≤bil |
| Criteri | "Captura ara, assignaci√≥ despr√©s" |
| Temps objectiu | < 10 segons per pujada |

**Filosofia:**
- L'usuari de terreny (editor) fa foto i envia
- L'administraci√≥ (admin) revisa, classifica i assigna
- Camps m√≠nims: import, data, foto del comprovant
- Camp `needsReview: true` per defecte

**Rols:** (segons el camp `role` de `members`)
| Rol | Veu | Pot fer |
|-----|-----|---------|
| `viewer` | Res | Res |
| `user` | Nom√©s les seves pujades | Pujar comprovants |
| `admin` | Totes les pujades | Revisar, classificar, assignar |

> Nota: A la UI el rol `user` es mostra com "Editor" o "Usuari de terreny".

**Camps rellevants (OffBankExpense):**
- `needsReview: boolean` ‚Äî indica si est√† pendent de revisi√≥
- `attachments: Attachment[]` ‚Äî fitxers adjunts (justificants)
- `uploadedBy: string` ‚Äî UID de qui ha pujat
- `quickMode: boolean` ‚Äî indica pujada r√†pida (sense camps opcionals)

**Noms estandarditzats de fitxers (NOU v1.12):**
- Format: `{projectCode}_{date}_{concept}_{amount}{ext}`
- Exemple: `PROJ001_2025-01-15_Material_oficina_125.50.pdf`
- S'aplica a despeses off-bank i documents adjunts a transaccions

### 3.11.13 Model de dades

**Veure Annex C.3** per l'estructura Firestore completa del m√≤dul projectes.

Camps afegits v1.10:

| Col¬∑lecci√≥ | Camp | Tipus | Descripci√≥ |
|------------|------|-------|------------|
| `projects` | `budgetEUR` | `number \| null` | Pressupost global (fallback si no hi ha partides) |
| `budgetLines` | `budgetedAmountEUR` | `number` | Import pressupostat de la partida |

### 3.11.14 Quick Expense Landing (NOU v1.22)

Pantalla dedicada per a l'entrada r√†pida de despeses des del m√≤bil, **sense layout de dashboard** (sense sidebar, header ni breadcrumbs).

**Arquitectura de rutes:**

| Ruta | Funci√≥ | Tipus |
|------|--------|-------|
| `/{orgSlug}/quick-expense` | Landing can√≤nica | P√†gina amb layout m√≠nim |
| `/quick` | Shortcut global | Redirecci√≥ a landing (detecta org de l'usuari) |
| `/{orgSlug}/dashboard/project-module/quick-expense` | Ruta antiga | Redirect 307 per backward-compatibility |

**Decisions arquitect√≤niques:**

| Decisi√≥ | Motiu |
|---------|-------|
| Fora de `/dashboard` | Next.js App Router no permet "saltar" layouts intermedis |
| Layout propi m√≠nim | Nom√©s `OrganizationProvider` + `InitializeData`, sense sidebar/header |
| Redirect 307 antic | Mant√© compatibilitat amb bookmarks i enlla√ßos existents |
| Shortcut `/quick` | Permet "Afegir a pantalla d'inici" sense necessitat de saber l'org |

**Permisos:**

| Rol | Pot accedir |
|-----|-------------|
| `superadmin` | ‚úÖ |
| `admin` | ‚úÖ |
| `user` | ‚úÖ |
| `viewer` | ‚ùå (redirigit a dashboard) |

**Flux d'acc√©s (ACTUALITZAT v1.24):**

```
/quick ‚Üí (si no user) ‚Üí /login?next=/quick
       ‚Üí (si user) ‚Üí /redirect-to-org?next=/quick-expense
                                    ‚Üì
                      detecta orgSlug via perfil/membres
                                    ‚Üì
                      /{orgSlug}/quick-expense (landing sense sidebar)
                                    ‚Üì
                      Bot√≥ "Tornar" ‚Üí /{orgSlug}/dashboard/project-module/expenses
```

**Middleware Routing (ACTUALITZAT v1.24):**

El middleware (`src/middleware.ts`) protegeix certes rutes per evitar loops de redirecci√≥:

```typescript
const PROTECTED_ROUTES = [
  '/redirect-to-org',  // Detecci√≥ d'org
  '/admin',            // Panell SuperAdmin
  '/login',            // Autenticaci√≥
  '/quick',            // Shortcut Quick Expense
  '/registre',         // Registre p√∫blic
];
```

**Regles del middleware:**
1. Mai redirigir rutes protegides (evita loops)
2. Sempre preservar `?next` quan redirigeix a `/redirect-to-org`
3. Sempre preservar tots els searchParams en redireccions

**Fitxers principals:**

| Fitxer | Funci√≥ |
|--------|--------|
| `src/middleware.ts` | Routing central amb PROTECTED_ROUTES |
| `src/app/[orgSlug]/quick-expense/layout.tsx` | Layout m√≠nim (OrganizationProvider) |
| `src/app/[orgSlug]/quick-expense/page.tsx` | P√†gina landing |
| `src/app/quick/page.tsx` | Shortcut global (delega a redirect-to-org) |
| `src/app/[orgSlug]/dashboard/project-module/quick-expense/page.tsx` | Redirect 307 legacy |
| `src/components/project-module/quick-expense-screen.tsx` | Component UI compartit |

**Connexi√≥ amb expenses:**

El bot√≥ c√†mera a la safata de despeses (`/dashboard/project-module/expenses`) apunta a `/{orgSlug}/quick-expense`:

```tsx
<Link href={buildUrl('/quick-expense')}>
  <Camera className="h-4 w-4" />
</Link>
```

### 3.11.15 Hub de Guies Procedimentals (NOU v1.23)

Centre d'ajuda contextual amb guies pas-a-pas per a les operacions m√©s freq√ºents de Summa Social.

**Ubicaci√≥:** `/{orgSlug}/dashboard/guides`

**Caracter√≠stiques:**
- Guies procedimentals amb format `whatIs` + `steps[]` + `avoid[]`
- Traduccions CA/ES/FR/PT amb fallback a catal√†
- CTAs directes a pantalla + enlla√ß al manual
- Indicadors visuals: `lookFirst`, `doNext`, `avoid`, `costlyError`
- Validador i18n automatitzat (`npm run i18n:validate-guides`)

**Guies disponibles:**

| ID | T√≠tol | Contingut |
|----|-------|-----------|
| `firstDay` | Primer dia | Checklist d'inici r√†pid |
| `firstMonth` | Primer mes | Guia d'operativa mensual |
| `monthClose` | Tancament mensual | Procediment de tancament |
| `movements` | Gesti√≥ de moviments | Operativa b√†sica |
| `importMovements` | Importar extracte | Pas a pas importaci√≥ |
| `bulkCategory` | Categoritzaci√≥ massiva | Selecci√≥ m√∫ltiple |
| `changePeriod` | Canviar de per√≠ode | Filtre per data |
| `selectBankAccount` | Seleccionar compte | Multicompte bancari |
| `attachDocument` | Adjuntar document | Drag & drop |
| `returns` | Devolucions | Gesti√≥ de retorns |
| `remittances` | Remeses d'ingressos | Divisi√≥ de remeses |
| `splitRemittance` | Dividir remesa | Split manual |
| `stripeDonations` | Donacions Stripe | Importador Stripe |
| `travelReceipts` | Tiquets de viatge | Captura r√†pida |
| `donors` | Gesti√≥ de donants | CRUD donants |
| `reports` | Informes fiscals | 182, 347, certificats |
| `projects` | M√≤dul projectes | Justificaci√≥ assistida |
| `monthlyFlow` | Flux mensual | Operativa recurrent |
| `yearEndFiscal` | Tancament fiscal | Fi d'any |
| `accessSecurity` | Acc√©s i seguretat | Multi-usuari |
| `initialLoad` | C√†rrega inicial | Primera configuraci√≥ |

**Format de traduccions (claus i18n):**

```
guides.{guideId}.title        ‚Äî T√≠tol de la guia
guides.{guideId}.intro        ‚Äî Introducci√≥ (opcional si whatIs)
guides.{guideId}.whatIs       ‚Äî Descripci√≥ breu
guides.{guideId}.steps.0-N    ‚Äî Passos ordenats
guides.{guideId}.avoid.0-N    ‚Äî Errors a evitar
guides.{guideId}.lookFirst.0-N ‚Äî Qu√® mirar primer
guides.{guideId}.doNext.0-N   ‚Äî Passos seg√ºents
guides.{guideId}.costlyError  ‚Äî Error cr√≠tic a destacar
guides.cta.{guideId}          ‚Äî Text del bot√≥ CTA
```

**Fitxers principals:**

| Fitxer | Funci√≥ |
|--------|--------|
| `src/app/[orgSlug]/dashboard/guides/page.tsx` | Hub central amb llista de guies |
| `src/i18n/locales/{ca,es,fr,pt}.json` | Traduccions (claus `guides.*`) |
| `scripts/i18n/validate-guides-translations.ts` | Validador de completitud |

**Validador i18n:**

```bash
npm run i18n:validate-guides
```

Comprova:
- Claus page-level obligat√≤ries (`guides.pageTitle`, `guides.viewManual`...)
- CTA per cada guia (`guides.cta.{guideId}`)
- T√≠tol i intro/whatIs per cada guia
- Arrays amb √≠ndexos consecutius (sense gaps)
- Claus extra que no existeixen al base (CA)


## 3.10 PANELL SUPERADMIN GLOBAL (NOU v1.20)

Panell de control exclusiu per al SuperAdmin del sistema, accessible des de `/admin`.

### 3.10.1 Acc√©s i Seguretat

| Aspecte | Detall |
|---------|--------|
| **URL** | `/admin` (sense orgSlug) |
| **Acc√©s** | Nom√©s `SUPER_ADMIN_UID` (definit a `src/lib/data.ts`) |
| **Redirecci√≥** | Si no √©s SuperAdmin ‚Üí redirigeix a `/dashboard` |

### 3.10.2 Funcionalitats

| Secci√≥ | Descripci√≥ |
|--------|------------|
| **Estad√≠stiques** | Total organitzacions, actives, suspeses |
| **Llista d'organitzacions** | Taula amb nom, CIF, estat, data creaci√≥ |
| **Accions per organitzaci√≥** | Entrar (impersonar), suspendre/reactivar |
| **Nova organitzaci√≥** | Crear organitzaci√≥ manualment |
| **Migrar slugs** | Migraci√≥ d'organitzacions sense slug |

### 3.10.3 Reset de Contrasenya (NOU v1.20)

Secci√≥ per enviar correus de restabliment de contrasenya:

| Element | Detall |
|---------|--------|
| **Input** | Email de l'usuari |
| **Acci√≥** | `sendPasswordResetEmail()` de Firebase Auth |
| **Seguretat** | Missatge gen√®ric sempre ("Si l'adre√ßa existeix...") per no revelar si l'email existeix |

### 3.10.4 Secci√≥ Diagn√≤stic (NOU v1.20)

Enlla√ßos r√†pids per a manteniment i diagn√≤stic:

| Enlla√ß | Dest√≠ |
|--------|-------|
| **Firebase Console** | `console.firebase.google.com/project/summa-social/overview` |
| **Cloud Logging** | `console.cloud.google.com/logs/query?project=summa-social` |
| **DEV-SOLO-MANUAL.md** | Path copiable al porta-retalls |

### 3.10.5 Salut del Sistema - Sentinelles (NOU v1.23)

Sistema autom√†tic de detecci√≥ d'incid√®ncies accessible nom√©s des de `/admin`.

**Model de dades:** Col¬∑lecci√≥ `systemIncidents` a Firestore (nom√©s SuperAdmin pot llegir).

**Sentinelles:**

| ID | Nom | Tipus | Qu√® detecta |
|----|-----|-------|-------------|
| S1 | Permisos | CRITICAL | Errors "Missing or insufficient permissions" |
| S2 | Moviments | CRITICAL | Errors CLIENT_CRASH a ruta /movimientos |
| S3 | Importadors | CRITICAL | Errors d'importaci√≥ (banc, CSV, Stripe) |
| S4 | Exports | CRITICAL | Errors d'exportaci√≥ (Excel, PDF, SEPA) |
| S5 | Remeses OUT | CRITICAL | Invariants violades (deltaCents‚â†0, isValid=false) |
| S6 | Encallaments | CONSULTA | Transaccions sense classificar > 30 dies |
| S7 | Fiscal 182 | CONSULTA | Donants sense dades fiscals |
| S8 | Activitat | CONSULTA | Organitzacions inactives > 60 dies |

**Pol√≠tica d'alertes:**
- S1‚ÄìS5: Generen incidents autom√†tics quan es detecta l'error
- S6‚ÄìS8: Nom√©s consulta, sense incidents autom√†tics

**Deduplicaci√≥:**
- Cada error genera una `signature` √∫nica (hash de type+route+message+stack)
- Si el mateix error es repeteix, s'incrementa el comptador
- Si un incident RESOLVED torna a apar√®ixer, es reobre autom√†ticament

**Accions disponibles:**
- **ACK**: Silencia temporalment (l'he vist, per√≤ encara treballo en la soluci√≥)
- **Resolt**: Tanca l'incident (corregit)

**Filtres anti-soroll:**
Errors ignorats autom√†ticament (no creen incidents):
- `ERR_BLOCKED_BY_CLIENT` ‚Äî Adblockers o extensions del navegador
- `ResizeObserver loop` ‚Äî Error benigne de layout
- `ChunkLoadError` / `Loading chunk` ‚Äî Problemes de xarxa temporals
- `Network request failed` / `Failed to fetch` ‚Äî Xarxa temporal
- `Script error.` ‚Äî Errors cross-origin sense informaci√≥ √∫til
- `AbortError` ‚Äî Requests cancel¬∑lats intencionalment

**Fitxers principals:**
- `src/lib/system-incidents.ts` ‚Äî Model, deduplicaci√≥, filtres, buildIncidentFixPack
- `src/components/ErrorBoundaryGlobal.tsx` ‚Äî Capturador client
- `src/components/admin/system-health.tsx` ‚Äî UI sentinelles + bot√≥ "Copiar prompt"
- `functions/src/alerts/sendIncidentAlert.ts` ‚Äî Cloud Function alertes email

**Alertes email (v1.1):**
- Cloud Function `sendIncidentAlert` envia email via Resend (prove√Ødor ja existent)
- Criteris d'enviament:
  - `severity === CRITICAL`
  - `status === OPEN` (mai si ACK o RESOLVED)
  - `count >= 2` O ruta core (movimientos, fiscalitat, project-module...)
  - Cooldown 24h per incident (un email per finestra)
- Email inclou prompt de reparaci√≥ per Claude Code
- Flag `ALERTS_ENABLED` (per defecte `false` en dev)
- Sense depend√®ncies noves: usa Resend API directament

**L√≠mits:**
- Nom√©s visible per SuperAdmin a `/admin`
- S6‚ÄìS8 requereixen implementaci√≥ de consultes espec√≠fiques

### 3.10.6 Fitxers principals

| Fitxer | Funci√≥ |
|--------|--------|
| `src/app/admin/page.tsx` | P√†gina del panell SuperAdmin |
| `src/components/admin/create-organization-dialog.tsx` | Modal crear organitzaci√≥ |
| `src/lib/data.ts` | Constant `SUPER_ADMIN_UID` |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 4. FORMATS D'IMPORTACI√ì I EXPORTACI√ì
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 4.1 Importaci√≥ d'Extractes Bancaris

| Format | Extensions | Detecci√≥ |
|--------|------------|----------|
| CSV | .csv, .txt | Separador auto (;,\t) |
| Excel | .xlsx, .xls | SheetJS |

**Columnes detectades:** Data, Concepte/Descripci√≥, Import/Quantitat

## 4.2 Importaci√≥ de Donants

| Format | Extensions |
|--------|------------|
| Excel | .xlsx, .xls |
| CSV | .csv |

**Columnes:** Veure secci√≥ 3.5.4

## 4.3 Importaci√≥ de Prove√Ødors

| Format | Extensions |
|--------|------------|
| Excel | .xlsx, .xls |
| CSV | .csv |

## 4.4 Divisor de Remeses (Ingressos)

| Format | Extensions |
|--------|------------|
| CSV | .csv, .txt |
| Excel | .xlsx, .xls |

## 4.5 Importador de Devolucions (NOU v1.8)

| Format | Extensions | Banc |
|--------|------------|------|
| Excel | .xlsx | Santander |
| CSV | .csv | Triodos |
| XLS | .xls | Triodos |

**Columnes detectades autom√†ticament:** IBAN, Import, Data, DNI, Nom, Motiu

## 4.6 Importador Stripe (NOU v1.9)

| Format | Extensions | Font |
|--------|------------|------|
| CSV | .csv | Stripe Dashboard ‚Üí Pagos ‚Üí Exportar |

**Columnes requerides:** id, Created date (UTC), Amount, Fee, Customer Email, Status, Transfer, Amount Refunded

**Veure secci√≥ 3.9 per detalls complets.**

## 4.7 Exportacions

| Informe | Format | Nom fitxer |
|---------|--------|------------|
| Model 182 | Excel (.xlsx) | Model182_{org}_{any}.xlsx |
| Model 347 | CSV | Model347_{org}_{any}.csv |
| Certificats | PDF / ZIP | certificat_{donant}_{any}.pdf |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 5. CAMPS REQUERITS PER INFORME FISCAL
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 5.1 Model 182 - Donants

| Camp Summa Social | Camp Model 182 | Obligatori |
|-------------------|----------------|------------|
| taxId | NIF DECLARADO | ‚úÖ |
| name | APELLIDOS Y NOMBRE | ‚úÖ |
| zipCode (2 primers) | PROVINCIA | ‚úÖ |
| donorType | NATURALEZA (F/J) | ‚úÖ |
| - | CLAVE | ‚úÖ (fix "A") |
| Suma transaccions | VALOR | ‚úÖ |
| Suma any -1 | VALOR_1 | ‚ùå |
| Suma any -2 | VALOR_2 | ‚ùå |
| Hist√≤ric | RECURRENTE | ‚ùå |

## 5.2 Model 347 - Prove√Ødors

| Camp Summa Social | Camp Model 347 | Obligatori |
|-------------------|----------------|------------|
| taxId | NIF | ‚úÖ |
| name | NOMBRE/RAZON SOCIAL | ‚úÖ |
| Suma transaccions | IMPORTE | ‚úÖ |

## 5.3 Certificats de Donaci√≥

| Camp | Obligatori |
|------|------------|
| Nom donant | ‚úÖ |
| NIF donant | ‚úÖ |
| Import (net de devolucions) | ‚úÖ |
| Data | ‚úÖ |
| Nom organitzaci√≥ | ‚úÖ |
| CIF organitzaci√≥ | ‚úÖ |
| Nom signant | ‚úÖ |
| C√†rrec signant | ‚úÖ |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 6. TERMINOLOGIA IMPORTANT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Terme | Definici√≥ |
|-------|-----------|
| **Transfer√®ncies a contraparts** | Enviaments a organitzacions s√≤cies internacionals |
| **Remesa (ingressos)** | Agrupaci√≥ de quotes de socis en un √∫nic ingr√©s |
| **Remesa (devolucions)** | Agrupaci√≥ de devolucions en un √∫nic moviment negatiu |
| **Devoluci√≥** | Rebut retornat pel banc (compte sense fons, IBAN erroni, etc.) |
| **Matching** | Assignaci√≥ autom√†tica de contactes per coincid√®ncia |
| **Categoria per defecte** | Categoria que s'aplica autom√†ticament |
| **Model 182** | Declaraci√≥ de donatius - l√≠mit 31 gener |
| **Model 347** | Operacions amb tercers >3.005,06‚Ç¨ - l√≠mit 28 febrer |
| **Soci** | Donant recurrent amb quota peri√≤dica |
| **Donant puntual** | Donant amb aportacions espor√†diques |
| **Emissor** | Terme intern per qualsevol contacte |
| **Eix d'actuaci√≥** | Sin√≤nim de projecte |
| **Gestoria** | Professional extern que presenta models fiscals |
| **Recurr√®ncia** | Ha donat els 2 anys anteriors consecutius |
| **Remesa parcial** | Remesa amb algunes devolucions pendents d'identificar |
| **dateConfidence** | Fiabilitat de la data: 'line' (per fila), 'file' (global), 'none' |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 7. OPTIMITZACIONS T√àCNIQUES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 7.1 Rendiment
- Memoitzaci√≥ de contexts Firebase
- Cleanup de timeouts i subscripcions
- L√≠mits a queries Firestore (m√†x 500)
- CollectionGroup queries
- AbortController per cancel¬∑lar peticions

## 7.2 Firebase Storage
- CORS configurat per c√†rrega d'imatges
- Logo i firma als PDFs generats al client

## 7.3 Autenticaci√≥
- Session persistence (caduca en tancar navegador)

## 7.4 Modals Radix UI (NOU v1.8)
- Fix bloqueig `aria-hidden` en tancar modals
- DropdownMenu controlat per evitar conflictes
- `setTimeout` + `blur()` abans d'obrir modals des de men√∫s

## 7.5 Convencions UI/UX (NOU v1.17)

### 7.5.1 Contracte Crom√†tic

| Color | √ös exclusiu |
|-------|-------------|
| **Vermell** (`text-destructive`, `bg-red-*`) | Errors, accions destructives, alertes |
| **Verd** (`text-green-*`, `bg-green-*`) | √àxit, estat positiu |
| **Groc/Taronja** (`text-amber-*`, `bg-amber-*`) | Advert√®ncies, pendents |
| **Gris** (`text-muted-foreground`) | Informaci√≥ secund√†ria, marcadors neutres |

**Regla clau:** El vermell MAI s'usa per indicadors neutres com marcadors de camps requerits (`*`).
Els camps requerits usen `text-muted-foreground` per evitar confusi√≥ amb errors.

### 7.5.2 Cap√ßaleres de P√†gina

**Patr√≥ est√†ndard:**
```tsx
<h1 className="text-2xl font-bold tracking-tight font-headline">{t√≠tol}</h1>
<p className="text-muted-foreground">{subt√≠tol descriptiu}</p>
```

| P√†gina | T√≠tol | Subt√≠tol |
|--------|-------|----------|
| Dashboard | "Dashboard" | "Visi√≥ general de la situaci√≥ financera de l'organitzaci√≥." |
| Moviments | "Moviments" | "Importa, revisa i assigna categories, contactes i documents." |
| Donants | "Donants" | "Gestiona donants i prepara dades per al Model 182 i certificats." |
| Prove√Ødors | "Prove√Ødors" | "Gestiona prove√Ødors i prepara dades per al Model 347." |
| Assignaci√≥ despeses | "Assignaci√≥ de despeses" | "Assigna despeses sense projecte als teus projectes." |

### 7.5.3 Densitat de Taules

**Configuraci√≥ base (`src/components/ui/table.tsx`):**

| Element | Estil |
|---------|-------|
| `TableRow` | `border-b border-border/50 hover:bg-muted/30` |
| `TableHead` | `h-10 px-3 text-xs text-muted-foreground` |
| `TableCell` | `px-3 py-2` |

**Principis:**
- Separadors subtils (`border-border/50`) per evitar soroll visual
- Hover suau (`bg-muted/30`) que no competeix amb el focus
- Cap√ßaleres compactes per√≤ llegibles (`text-xs`, `h-10`)

### 7.5.4 Breadcrumbs

**Quan usar:**
- P√†gines de nivell 2 o superior (dins d'un m√≤dul)
- Quan la navegaci√≥ amb bot√≥ "enrere" no √©s suficient

**Quan NO usar:**
- P√†gines de nivell 1 (Dashboard, Moviments, Donants, etc.)
- P√†gines amb navegaci√≥ lateral visible

**Implementaci√≥:**
```tsx
import { Breadcrumb, BreadcrumbList, BreadcrumbItem, BreadcrumbLink, BreadcrumbPage, BreadcrumbSeparator } from "@/components/ui/breadcrumb"

<Breadcrumb>
  <BreadcrumbList>
    <BreadcrumbItem>
      <BreadcrumbLink asChild>
        <Link href="/dashboard/project-module/projects">{t.breadcrumb?.projects}</Link>
      </BreadcrumbLink>
    </BreadcrumbItem>
    <BreadcrumbSeparator />
    <BreadcrumbItem>
      <BreadcrumbPage>{t.breadcrumb?.expenseAssignment}</BreadcrumbPage>
    </BreadcrumbItem>
  </BreadcrumbList>
</Breadcrumb>
```

### 7.5.5 Accessibilitat (Keyboard + Focus)

| Element | Comportament |
|---------|-------------|
| Di√†legs (Radix) | `Esc` tanca autom√†ticament |
| Editors inline | `Enter` confirma, `Esc` cancel¬∑la |
| Botons icona | M√≠nim `36x36px` hit target |
| Focus rings | `focus-visible:ring-2 focus-visible:ring-ring` |

**Aria labels obligatoris per botons nom√©s icona:**
```tsx
<Button variant="ghost" size="icon" aria-label={t.common.edit}>
  <Pencil className="h-4 w-4" />
</Button>
```

### 7.5.6 Empty States

**To institucional, mai humor√≠stic:**
- ‚úÖ "No hi ha moviments per mostrar"
- ‚ùå "Encara no has afegit cap moviment! Comen√ßa ara!"

**Estructura:**
```tsx
<div className="text-center py-8 text-muted-foreground">
  <p>{t.emptyState.noResults}</p>
</div>
```

### 7.5.7 Tooltips IA

Quan una acci√≥ usa IA, el tooltip ha de ser descriptiu i no implicar confirmaci√≥:
- ‚úÖ "Classifica autom√†ticament amb IA"
- ‚ùå "Vols que la IA classifiqui?"

### 7.5.8 Confirmacions Destructives

**Sempre requerides per:**
- Eliminaci√≥ de dades
- Accions irreversibles
- Operacions massives

**Format:**
```tsx
<AlertDialog>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>{t.confirm.deleteTitle}</AlertDialogTitle>
      <AlertDialogDescription>{t.confirm.deleteDescription}</AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>{t.common.cancel}</AlertDialogCancel>
      <AlertDialogAction className="bg-destructive">{t.common.delete}</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```
- Components com `DonorSearchCombobox` reescrits sense `cmdk` per evitar problemes de portals niuats

## 7.6 Onboarding / Benvinguda Inicial (ACTUALITZAT v1.20)

### Objectiu
Donar la benvinguda al primer admin d'una nova organitzaci√≥ amb una √∫nica modal simple, sense bloquejar l'√∫s de l'aplicaci√≥.

### Principis
- **Modal √∫nica**: Una sola modal de benvinguda, sense checklist persistent.
- **No bloquejant**: L'usuari pot continuar sense completar res.
- **Primer admin**: Nom√©s el primer admin (per `joinedAt`) veu la modal.
- **Definitiu**: Un cop vista, `welcomeSeenAt` s'escriu i la modal no torna a apar√®ixer.

### Flux simplificat (v1.20)

1. **Primera c√†rrega del Dashboard**: Si l'usuari √©s el primer admin i `welcomeSeenAt` no existeix, es mostra la modal de benvinguda.
2. **Opci√≥ "Guia'm"**: Obre el wizard de configuraci√≥ (dades fiscals, firma, categories).
3. **Opci√≥ "Comen√ßar pel meu compte"**: Tanca la modal i permet treballar directament.
4. **En ambd√≥s casos**: Es marca `welcomeSeenAt` a Firestore ‚Üí la modal no torna.

### Model de dades

```typescript
// A Organization (src/lib/data.ts)
onboarding?: {
  welcomeSeenAt?: string;  // YYYY-MM-DD quan el primer admin ha vist la modal
};
```

### L√≤gica de decisi√≥

| Condici√≥ | Resultat |
|----------|----------|
| `welcomeSeenAt` existeix | No mostrar modal |
| Usuari NO √©s primer admin | No mostrar modal |
| Usuari √©s primer admin + `welcomeSeenAt` no existeix | Mostrar modal |

**Primer admin**: L'admin amb `joinedAt` m√©s antic. Si nom√©s hi ha un admin, √©s ell. Si no hi ha `joinedAt`, fallback a √∫nic admin.

### Fitxers principals

| Fitxer | Funci√≥ |
|--------|--------|
| `src/lib/onboarding.ts` | `isFirstAdmin()`, `shouldShowWelcomeModal()` |
| `src/components/onboarding/WelcomeOnboardingModal.tsx` | Modal de benvinguda |
| `src/components/onboarding/OnboardingWizard.tsx` | Wizard de configuraci√≥ (obert des de modal o Configuraci√≥) |

### Canvis respecte v1.18

| v1.18 | v1.20 |
|-------|-------|
| Checklist persistent al Dashboard | Modal √∫nica, apareix una sola vegada |
| P√†gina `/onboarding` dedicada | Eliminada, wizard s'obre des de modal o Configuraci√≥ |
| `OnboardingChecklist.tsx` | Eliminat |
| `onboardingSkippedAt` | Substitu√Øt per `onboarding.welcomeSeenAt` |
| L√≤gica complexa `computeOnboardingStatus()` | Simplificat a `shouldShowWelcomeModal()` |

## 7.7 Perfil de Rendiment (NOU v1.21)

### Escala objectiu
Summa Social est√† optimitzat per a **<100 usuaris concurrents** amb marge operatiu. El l√≠mit pr√†ctic dep√®n del volum de dades per organitzaci√≥ (transaccions, contactes).

### Optimitzacions aplicades

| Problema | Soluci√≥ | Fitxer |
|----------|---------|--------|
| N+1 queries (links) | Batching amb `documentId()` en chunks de 10 | `src/hooks/use-project-module.ts:172` |
| N+1 queries (expenses) | Batching paral¬∑lel off-bank + bank | `src/hooks/use-project-module.ts:388` |
| N+1 llistat projectes | Lazy-load de budgetLines, usar `project.budgetEUR` | `src/app/.../projects/page.tsx` |
| Inst√†ncia √∫nica | `maxInstances: 3` a Firebase App Hosting | `apphosting.yaml` |
| Listener audit logs | `limit(100)` | `src/app/.../super-admin/page.tsx:149` |
| Listener donor drawer | `limit(500)` + filtre client | `src/components/donor-detail-drawer.tsx:157` |

### Patr√≥ de batching Firestore

Quan cal carregar m√∫ltiples documents per ID, usar aquest patr√≥:

```typescript
import { documentId } from 'firebase/firestore';

function chunkArray<T>(arr: T[], size: number): T[][] {
  const out: T[][] = [];
  for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
  return out;
}

// Carregar en paral¬∑lel (m√†xim 10 IDs per query, l√≠mit Firestore)
const chunks = chunkArray(ids, 10);
const snaps = await Promise.all(
  chunks.map((chunkIds) =>
    getDocs(query(collectionRef, where(documentId(), 'in', chunkIds)))
  )
);
```

### Listeners `onSnapshot` - Classificaci√≥

| Fitxer | Tipus | Decisi√≥ |
|--------|-------|---------|
| `use-collection.tsx` | Hook base | CORE - no tocar |
| `use-doc.tsx` | Hook base | CORE - no tocar |
| `use-bank-accounts.ts` | Comptes bancaris | OK - pocs docs, real-time √∫til |
| `donor-detail-drawer.tsx` | Transaccions donant | Limitat a 500, filtre client |
| `super-admin/page.tsx` | Audit logs | Limitat a 100 |

### Qu√® NO cal fer (sense evid√®ncia de necessitat)

- Refactors de model (denormalitzacions)
- Observabilitat avan√ßada (Sentry)
- Pujar `maxInstances` a 5+
- Reescriure hooks base
- Paginaci√≥ infinita a moviments (nom√©s si org t√© >1000 visibles)

### Quan escalar

Indicadors que requeririen intervenci√≥:
- Lat√®ncia UI >2s consistent
- Errors Firestore per quota
- Usuaris reportant lentitud


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 8. FLUX DE TREBALL RECOMANAT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 8.1 Configuraci√≥ Inicial

1. Configurar dades de l'organitzaci√≥
2. Pujar logo
3. Configurar firma i signant
4. Revisar categories
5. Importar contactes des d'Excel
6. Assignar categoria per defecte a cada contacte
7. Crear projectes/eixos

## 8.2 Dia a Dia

1. Descarregar extracte del banc (mensual)
2. Importar a Summa Social
3. Revisar alertes al Dashboard
4. Corregir moviments pendents
5. Dividir remeses si n'hi ha
6. **Gestionar devolucions pendents** (NOU v1.8)

## 8.3 Gesti√≥ de Devolucions (NOU v1.8)

1. Veure banner "Devolucions pendents" a Moviments
2. Clicar "Revisar"
3. Per cada devoluci√≥:
   - Si saps de qui √©s ‚Üí "Assignar donant"
   - Si tens el fitxer del banc ‚Üí Icona üìÑ ‚Üí Importar fitxer
4. Revisar remeses parcials i completar-les

## 8.4 Fi d'Any

1. Revisar donants amb dades incompletes
2. **Verificar devolucions assignades**
3. Generar Excel Model 182 (abans 31 gener)
4. Enviar a gestoria
5. Generar Model 347 (abans 28 febrer)
6. Emetre certificats als donants


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 9. SINCRONITZACI√ì I DESPLEGAMENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 9.1 Entorn
- IDE: VS Code
- Assistent IA: Claude Code
- Control de versions: Git + GitHub

## 9.2 Flux
```
1. Demanar canvis a Claude Code
2. Claude Code modifica fitxers
3. git add . && git commit -m "descripci√≥"
4. git push
5. Desplegament autom√†tic
```

## 9.3 URLs
- Producci√≥: https://summasocial.app
- Firebase: https://studio--summa-social.us-central1.hosted.app

## 9.4 Tests (NOU v1.8)
- 77 tests unitaris
- Hook pre-commit amb Husky
- `npm test` abans de cada commit


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 10. ROADMAP / FUNCIONALITATS PENDENTS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## Completades v1.16
- ‚úÖ Drag & drop de documents a la safata de despeses (per fila)
- ‚úÖ Auto-naming de documents amb `buildDocumentFilename()` (format YYYY.MM.DD_concepte.ext)
- ‚úÖ Renomenar documents inline (bot√≥ llapis, Enter/Escape)
- ‚úÖ Exportaci√≥ Excel de donants (nom, NIF, quota, IBAN, estat)

## Completades v1.10
- ‚úÖ M√≤dul Projectes: justificaci√≥ assistida per partides
- ‚úÖ Mode infraexecuci√≥: afegir despeses amb sugger√®ncies heur√≠stiques
- ‚úÖ Mode sobreexecuci√≥: treure o reduir imputacions (split parcial)
- ‚úÖ Simulaci√≥ en mem√≤ria fins a "Aplicar"
- ‚úÖ Pressupost unificat als cards (suma partides vs global)
- ‚úÖ Scoring per fam√≠lies sem√†ntiques (viatges, personal, serveis, etc.)

## Completades v1.9
- ‚úÖ Importador Stripe (dividir payouts en donacions + comissions)
- ‚úÖ Matching donants per email exacte
- ‚úÖ Tra√ßabilitat completa (stripePaymentId, stripeTransferId)

## Completades v1.8
- ‚úÖ Importador de devolucions del banc (Santander, Triodos)
- ‚úÖ Detecci√≥ autom√†tica d'agrupacions de devolucions
- ‚úÖ Remeses parcials de devolucions
- ‚úÖ Matching per IBAN ‚Üí DNI ‚Üí Nom exacte
- ‚úÖ UX simplificada per devolucions
- ‚úÖ Tests unitaris (77 tests) + Husky pre-commit
- ‚úÖ Fixes bloqueig aria-hidden modals Radix
- ‚úÖ Estat actiu/baixa per donants
- ‚úÖ Importador actualitza donants existents
- ‚úÖ Vista agrupada de remeses (1 l√≠nia + modal detall)
- ‚úÖ Detecci√≥ i reactivaci√≥ de socis de baixa a remeses
- ‚úÖ Link al donant des de modal de remesa
- ‚úÖ Eina per esborrar √∫ltima remesa (Zona Perill)

## Completades v1.7
- ‚úÖ Suport Excel per divisor de remeses
- ‚úÖ Camps city/province a l'importador de donants
- ‚úÖ Exportaci√≥ Excel Model 182 per gestoria (amb recurr√®ncia)
- ‚úÖ Session persistence (seguretat)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 11. HISTORIAL DE VERSIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Versi√≥ | Data | Canvis principals |
|--------|------|-------------------|
| 1.0 | Nov 2024 | Versi√≥ inicial, single-user |
| 1.5 | Nov 2024 | Multi-organitzaci√≥, sistema de rols |
| 1.6 | Des 2024 | DonorDetailDrawer, certificats amb firma, Zona Perill, divisor remeses |
| 1.7 | Des 2024 | Excel Model 182 per gestoria, suport Excel remeses, camps city/province, session persistence |
| 1.8 | Des 2024 | Importador devolucions del banc, remeses parcials, suport multi-banc (Santander/Triodos), tests unitaris, fixes modals Radix, UX simplificada |
| 1.9 | Des 2025 | Importador Stripe (payouts ‚Üí donacions + comissions), matching per email, tra√ßabilitat completa |
| **1.10** | **Des 2025** | **M√≤dul Projectes: justificaci√≥ assistida per partides, sugger√®ncies heur√≠stiques, split parcial de despeses, simulaci√≥ en mem√≤ria** |
| **1.11** | **Des 2025** | **Captura de despeses de terreny (quickMode, pujada r√†pida <10s), i18n Franc√®s complet (fr.ts), selector d'idioma amb 3 opcions** |
| **1.12** | **Des 2025** | **Multicomptes bancaris (CRUD, filtre per compte, tra√ßabilitat bankAccountId), filtre per origen (source), di√†leg crear donant a importador devolucions, mode bulk NET** |
| **1.13** | **Des 2025** | **Selecci√≥ m√∫ltiple a Moviments (checkboxes + accions en bloc), assignar/treure categoria massivament, batched writes Firestore (50 ops/batch), traduccions CA/ES/FR** |
| **1.14** | **Des 2025** | **Reorganitzaci√≥ UX Moviments (FiltersSheet, TableOptionsMenu), drag & drop documents, indicadors visuals remeses processades, modal RemittanceSplitter redissenyat (wide layout), sidebar Projectes col¬∑lapsable** |
| **1.15** | **Des 2025** | **Documentaci√≥ completa de regles de normalitzaci√≥ de dades (noms, NIF/NIE/CIF, IBAN, email, tel√®fon E.164, adreces, normalizedName per deduplicaci√≥)** |
| **1.16** | **Des 2025** | **Importador de pressupost Excel (wizard 5 passos, agrupaci√≥ subpartides, columna finan√ßador principal), fix redirect-to-org O(1) amb collectionGroup, fix idle logout redirecci√≥ a login d'org** |
| **1.17** | **Des 2025** | **Polish UX: convencions UI documentades (contracte crom√†tic, cap√ßaleres est√†ndard, densitat taules, breadcrumbs, accessibilitat, empty states, tooltips IA, confirmacions destructives)** |
| **1.18** | **Des 2025** | **Onboarding: configuraci√≥ inicial per admins (checklist Dashboard, wizard, "Ho far√© despr√©s", camp onboardingSkippedAt), no bloquejant, discret, definitiu** |
| **1.19** | **Des 2025** | **Simplificaci√≥ onboarding a modal de benvinguda √∫nica per primer admin, eliminaci√≥ checklist persistent** |
| **1.20** | **Des 2025** | **Panell Admin: reset contrasenya + secci√≥ diagn√≤stic (Firebase Console, Cloud Logging, DEV-SOLO-MANUAL.md). Dashboard: neteja blocs Celebracions/Alertes, millora taula categories (exclou comissions), bloc projectes condicional. Nou document docs/DEV-SOLO-MANUAL.md per manteniment.** |
| **1.21** | **Des 2025** | **i18n p√†gina p√∫blica (ca/es), SEO tags amb canonical + hreflang, m√≤dul documents pendents hardened (permisos, guardrails, UI responsive)** |
| **1.22** | **29 Des 2025** | **Quick Expense Landing: ruta can√≤nica `/{orgSlug}/quick-expense` fora de `/dashboard` (sense sidebar/header), shortcut global `/quick`, redirect 307 per backward-compatibility, arquitectura neta sense hacks de layout** |
| **1.23** | **30 Des 2025** | **System Health Sentinelles (S1‚ÄìS8): detecci√≥ autom√†tica d'errors amb deduplicaci√≥, alertes email per incidents CRITICAL, filtres anti-soroll. Hub de Guies: guies procedimentals amb traduccions CA/ES/FR/PT (changePeriod, selectBankAccount, monthClose), validador i18n.** |
| **1.24** | **31 Des 2025** | **Routing hardening: simplificaci√≥ `/quick` (delega a `/redirect-to-org`), middleware amb PROTECTED_ROUTES per evitar loops, preservaci√≥ de `?next` params.** |
| **1.25** | **31 Des 2025** | **i18n rutes p√∫bliques complet (CA/ES/FR/PT): estructura `[lang]` per login, privacy i contact. Detecci√≥ autom√†tica idioma via Accept-Language. SEO amb canonical + hreflang per 4 idiomes. Redirect stubs per compatibilitat URLs antigues. Nou fitxer `src/i18n/public.ts` amb traduccions separades de l'app privada.** |
| **1.26** | **31 Des 2025** | **Resoluci√≥ col¬∑lisi√≥ `[lang]` vs `[orgSlug]`: arquitectura `public/[lang]` amb middleware rewrite (URL p√∫blica intacta). HOME i Funcionalitats multiidioma. x-default hreflang. Slugs reservats (ca/es/fr/pt/public). Rutes can√≤niques: `/{lang}/funcionalitats`, `/{lang}/privacy`, `/{lang}/contact`. Aliases naturals: FR (`fonctionnalites`, `confidentialite`), ES (`funcionalidades`, `privacidad`, `contacto`), PT (`funcionalidades`, `privacidade`, `contacto`).** |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 12. √ÄMBIT I L√çMITS DEL PRODUCTE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 12.1 Qu√® NO Far√† Summa Social (Per Disseny)

| Funcionalitat Exclosa | Motiu |
|-----------------------|-------|
| **Generaci√≥ de fitxers BOE** | Les entitats deleguen a gestories |
| **Presentaci√≥ telem√†tica AEAT** | Complexitat legal elevada |
| **Integraci√≥ directa APIs banc√†ries** | Requereix certificacions |
| **Comptabilitat doble entrada** | NO √©s programa de comptabilitat |
| **Facturaci√≥ electr√≤nica** | Fora d'√†mbit |
| **Models d'IA opacs** | Tota IA ha de ser determinista o supervisada |
| **Fuzzy matching de noms** | Massa risc d'errors en fiscalitat |
| **Assignaci√≥ autom√†tica sense confirmaci√≥** | L'usuari sempre ha de validar |

## 12.2 Focus del Producte

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                 ‚îÇ
‚îÇ   1. GESTIONAR MOVIMENTS BANCARIS                              ‚îÇ
‚îÇ      Importar, categoritzar, assignar contactes                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   2. RECONCILIAR BANC                                          ‚îÇ
‚îÇ      Saldos, detecci√≥ d'errors, control, devolucions           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   3. PREPARAR FISCALITAT                                       ‚îÇ
‚îÇ      Model 182, Model 347, certificats de donaci√≥              ‚îÇ
‚îÇ      ‚Üí Output: Excel net per enviar a la gestoria              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   4. ORDENAR DONANTS / PROVE√èDORS / PROJECTES                  ‚îÇ
‚îÇ      Base de dades centralitzada i actualitzada                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   5. DASHBOARD DE SEGUIMENT                                    ‚îÇ
‚îÇ      Visualitzaci√≥ d'informaci√≥ clau per seguiment general     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## 12.3 Qu√® NO Garanteix el Sistema

| NO garanteix | Motiu |
|--------------|-------|
| Abs√®ncia d'errors humans | L'usuari pot introduir dades incorrectes |
| Substituci√≥ de revisi√≥ professional | No som assessors fiscals ni auditors |
| Validaci√≥ de documents oficials | Els fitxers generats s√≥n per a la gestoria |
| Bloqueig d'accions incorrectes | L'usuari t√© llibertat operativa total |

> **Responsabilitat:** Summa Social √©s una eina de suport. La responsabilitat final sobre les dades i els informes fiscals recau en l'organitzaci√≥ i els seus assessors professionals.

## 12.4 P√∫blic Objectiu

| S√≠ | No |
|----|----|
| Entitats petites i mitjanes d'Espanya | Grans entitats amb ERP propi |
| Entitats sense √†nim de lucre | Empreses amb √†nim de lucre |
| Fundacions petites | Administracions p√∫bliques |
| Associacions culturals, socials | Entitats fora d'Espanya |

## 12.4 Filosofia de Desenvolupament

> **"Menys √©s m√©s"**
>
> Summa Social resol **molt b√©** uns problemes concrets (conciliaci√≥ + fiscalitat) en lloc de resoldre **regular** molts problemes diferents.
>
> Cada funcionalitat nova ha de passar el filtre:
> - Redueix errors a l'entitat? ‚úÖ
> - Estalvia temps real? ‚úÖ
> - √âs mantenible per una sola persona? ‚úÖ
> - Contribueix als objectius estrat√®gics? ‚úÖ


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 13. REGLES PER A L'√öS DE LLMs
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| # | Regla |
|---|-------|
| 1 | Cap proposta pot contradir l'√Ämbit i L√≠mits (Secci√≥ 12) |
| 2 | No modificar l'esquema Firestore existent |
| 3 | No eliminar ni renomenar camps |
| 4 | Nom√©s afegir camps opcionals si √©s imprescindible |
| 5 | No afegir depend√®ncies noves sense justificaci√≥ |
| 6 | Nom√©s funcions pures i codi modular |
| 7 | Prioritat per simplicitat i manteniment baix |
| 8 | No IA que "aprengui" autom√†ticament |
| 9 | Tot alineat amb Bloc 1 (Conciliaci√≥) o Bloc 2 (Fiscalitat) |
| 10 | Millores Transversals sempre admissibles |
| 11 | **NO fuzzy matching de noms** |
| 12 | **NO assignaci√≥ autom√†tica sense confirmaci√≥ de l'usuari** |

## 13.1 Comportament Esperat

**Quan se li demani codi:**
- Proporcionar codi COMPLET
- Indicar path del fitxer
- Incloure passos de verificaci√≥
- Respondre en CATAL√Ä

## 13.2 Patrons de Codi Obligatoris

### Firestore: `null` vs `undefined`

> ‚ö†Ô∏è **CR√çTIC**: Firestore **NO accepta `undefined`** com a valor de camp.

**MAL** (provoca error):
```typescript
const newTxData = {
  contactType: contactId ? 'donor' : undefined,  // ‚ùå ERROR
  projectId: transaction.projectId,               // ‚ùå ERROR si √©s undefined
};
batch.set(docRef, newTxData);
```

**B√â** (patr√≥ correcte):
```typescript
const newTxData = {
  contactType: contactId ? 'donor' : null,        // ‚úÖ null acceptat
  projectId: transaction.projectId ?? null,       // ‚úÖ converteix undefined a null
};
batch.set(docRef, newTxData);
```

**Alternativa** (ometre camp si no existeix):
```typescript
const newTxData = {
  ...(contactId && { contactType: 'donor' }),     // ‚úÖ nom√©s afegeix si existeix
  ...(transaction.projectId && { projectId: transaction.projectId }),
};
```

**Regla general**: Tots els camps opcionals han de ser `string | null`, mai `undefined`.

### Gesti√≥ de transaccions consumides (NOU v1.8)

> ‚ö†Ô∏è **CR√çTIC**: NO usar `splice()` per marcar transaccions com a usades.

**MAL** (mutaci√≥ d'array):
```typescript
const idx = pendingReturns.findIndex(t => t.id === matchingTx.id);
if (idx > -1) pendingReturns.splice(idx, 1);  // ‚ùå Mutaci√≥ fr√†gil
```

**B√â** (Set d'IDs):
```typescript
const usedTransactionIds = new Set<string>();

const matchingTx = pendingReturns.find(tx => 
  !usedTransactionIds.has(tx.id) && ...
);

if (matchingTx) {
  usedTransactionIds.add(matchingTx.id);  // ‚úÖ Immutable
}
```

**Quan se li demani nova funcionalitat:**
- Validar si encaixa amb blocs estrat√®gics
- Si no encaixa, informar i suggerir alternatives


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 14. PARAULES CLAU I INTENCIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Terme | Interpretaci√≥ Correcta | ‚ö†Ô∏è NO significa |
|-------|------------------------|-----------------|
| "Conciliaci√≥ banc√†ria" | Saldos, desquadraments, regles, devolucions | Integraci√≥ amb bancs |
| "Fiscalitat" | Model 182, 347, certificats, Excel | Presentaci√≥ a AEAT |
| "Excel net" | Fitxer simple per gestoria | Fitxer BOE oficial |
| "Determinista" | Regla fixa, mateix resultat | IA aut√≤noma |
| "Auto-assignaci√≥" | Matching + categoria defecte | IA sense supervisi√≥ |
| "Remesa" | Agrupaci√≥ quotes socis O devolucions | Qualsevol ingr√©s |
| "Gestoria" | Professional extern | L'entitat mateixa |
| "Matching exacte" | IBAN/DNI/Nom id√®ntic | Fuzzy, aproximat |
| "Remesa parcial" | Algunes devolucions pendents | Remesa incompleta per error |
| "Payout Stripe" | Liquidaci√≥ de Stripe al banc (po_xxx) | Donaci√≥ individual |
| "Comissi√≥ Stripe" | Despesa agregada per payout | Cost per donaci√≥ |
| "Remesa Stripe" | Payout dividit en donacions individuals | Connexi√≥ API Stripe |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 15. NORMALITZACI√ì DE DADES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 15.1 Principi General

Totes les dades d'entrada es normalitzen abans de desar-les a Firestore. L'objectiu √©s garantir:
- Consist√®ncia en les cerques i el matching
- Deduplicaci√≥ fiable
- Formats v√†lids per a fiscalitat (Model 182, 347)

> **Fitxer principal**: `src/lib/normalize.ts`

## 15.2 Noms de Persones F√≠siques

### Regles de capitalitzaci√≥

| Entrada | Sortida | Regla |
|---------|---------|-------|
| `JOAN GARCIA` | `Joan Garcia` | Cada paraula amb maj√∫scula inicial |
| `maria del carmen` | `Maria del Carmen` | Part√≠cules en min√∫scula |
| `pau de la font` | `Pau de la Font` | Part√≠cules: de, del, de la, de les, dels |

### Part√≠cules i excepcions

Les seg√ºents part√≠cules es mantenen en min√∫scula quan van entre mots:
- `de`, `del`, `de la`, `de les`, `dels`
- `i`, `y`
- `la`, `el`, `les`, `els` (quan s√≥n articles)

**Apostrofats** (catal√†):
- `d'Amat` ‚Üí mant√© l'ap√≤strof i maj√∫scula al nom
- `l'Hospitalet` ‚Üí mant√© format

**Exemple**:
```
Input:  "MARIA DELS ANGELS DE LA FONT I PUIG"
Output: "Maria dels √Ängels de la Font i Puig"
```

## 15.3 Noms de Persones Jur√≠diques

### Sufixos de societat

| Entrada | Sortida normalitzada |
|---------|---------------------|
| `S L`, `s.l`, `SL` | `S.L.` |
| `S A`, `s.a`, `SA` | `S.A.` |
| `S L U`, `slu`, `S.L.U` | `S.L.U.` |
| `S COOP`, `s. coop` | `S.Coop.` |
| `S C P`, `scp` | `S.C.P.` |
| `C B`, `cb` | `C.B.` |

**Exemple**:
```
Input:  "CONSULTORIA TECH sl"
Output: "Consultoria Tech S.L."
```

### Fundacions i associacions

| Tipus | Paraules clau | Tracte |
|-------|---------------|--------|
| Fundaci√≥ | `Fundaci√≥`, `Fundaci√≥n` | Maj√∫scula inicial |
| Associaci√≥ | `Associaci√≥`, `Asociaci√≥n` | Maj√∫scula inicial |

## 15.4 NIF, NIE i CIF

### Formats acceptats i normalitzaci√≥

| Entrada | Sortida | V√†lid |
|---------|---------|-------|
| `12345678-Z` | `12345678Z` | ‚úÖ |
| `12345678 z` | `12345678Z` | ‚úÖ |
| `x-1234567-w` | `X1234567W` | ‚úÖ |
| `b-12345678` | `B12345678` | ‚úÖ |

### Regles

1. **Eliminar**: espais, guions, punts
2. **Convertir**: tot a maj√∫scules
3. **Validar**: lletra de control (opcional, nom√©s av√≠s)

### Patrons v√†lids

| Tipus | Patr√≥ | Exemple |
|-------|-------|---------|
| NIF | `8 d√≠gits + lletra` | `12345678Z` |
| NIE | `X/Y/Z + 7 d√≠gits + lletra` | `X1234567W` |
| CIF | `lletra + 8 car√†cters` | `B12345678` |

## 15.5 IBAN

### Normalitzaci√≥

| Entrada | Sortida |
|---------|---------|
| `ES91 2100 0418 4502 0005 1332` | `ES91210004184502000051332` |
| `es91-2100-0418-4502-0005-1332` | `ES91210004184502000051332` |

### Regles

1. **Eliminar**: espais, guions
2. **Convertir**: tot a maj√∫scules
3. **Validar**: longitud 24 car√†cters (Espanya)

> **Emmagatzematge**: Sempre sense espais ni guions
> **Visualitzaci√≥**: Amb espais cada 4 car√†cters (`formatIBAN()`)

## 15.6 Email

### Normalitzaci√≥

| Entrada | Sortida |
|---------|---------|
| `  Joan.Garcia@Gmail.COM  ` | `joan.garcia@gmail.com` |
| `Maria@Empresa.Es` | `maria@empresa.es` |

### Regles

1. **Trim**: eliminar espais al principi i final
2. **Lowercase**: tot en min√∫scules
3. **Validar**: format email b√†sic (cont√© `@` i `.`)

## 15.7 Tel√®fon

### Normalitzaci√≥ a E.164

| Entrada | Sortida |
|---------|---------|
| `612 34 56 78` | `+34612345678` |
| `+34 612-345-678` | `+34612345678` |
| `0034612345678` | `+34612345678` |
| `612345678` | `+34612345678` |

### Regles

1. **Eliminar**: espais, guions, par√®ntesis, punts
2. **Normalitzar prefix**:
   - Si comen√ßa per `0034` ‚Üí reempla√ßar per `+34`
   - Si comen√ßa per `34` ‚Üí afegir `+`
   - Si comen√ßa per `6` o `9` ‚Üí afegir `+34`
3. **Resultat**: format E.164 (`+34XXXXXXXXX`)

> **Emmagatzematge**: Format E.164
> **Visualitzaci√≥**: Amb espais (`formatPhone()`)

## 15.8 Adreces

### Camps separats (no normalitzaci√≥ agressiva)

Les adreces es desen en camps separats sense modificar excessivament:

| Camp | Normalitzaci√≥ |
|------|---------------|
| `street` | Trim, sense canvis de capitalitzaci√≥ |
| `city` | Trim |
| `province` | Trim |
| `postalCode` | Trim, nom√©s d√≠gits, 5 car√†cters |
| `country` | Trim, default `Espanya` |

### Codi Postal

| Entrada | Sortida |
|---------|---------|
| `08001` | `08001` |
| `8001` | `08001` |
| `08-001` | `08001` |

> **Regla**: Sempre 5 d√≠gits, amb zero inicial si cal

## 15.9 Espais en Blanc

### Regles generals

1. **Trim**: eliminar espais al principi i final de tots els camps
2. **Col¬∑lapsar**: m√∫ltiples espais consecutius ‚Üí un sol espai
3. **Eliminar NBSP**: reempla√ßar `\u00A0` per espai normal

```typescript
function normalizeWhitespace(s: string): string {
  return s
    .replace(/\u00A0/g, ' ')  // NBSP ‚Üí espai
    .replace(/\s+/g, ' ')     // col¬∑lapsar
    .trim();                   // trim
}
```

## 15.10 Clau de Deduplicaci√≥ (normalizedName)

### Prop√≤sit

Camp calculat per detectar duplicats i fer matching aproximat.

### C√†lcul

```typescript
function normalizedName(name: string): string {
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')  // eliminar accents
    .replace(/[^a-z0-9]/g, '')        // nom√©s alfanum√®ric
    .trim();
}
```

### Exemples

| Nom original | normalizedName |
|--------------|----------------|
| `Joan Garc√≠a` | `joangarcia` |
| `Mar√≠a del Carmen` | `mariadelcarmen` |
| `Fundaci√≥ l'√Äncora` | `fundaciolancora` |

> **√ös**: Cercar duplicats, no per matching fiscal (que usa NIF/IBAN exactes)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX A ‚Äî DECISIONS IRREVERSIBLES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| # | Decisi√≥ | Estat |
|---|---------|-------|
| 1 | **Base de dades**: Firestore | üîí TANCAT |
| 2 | **Model de dades**: Collections estables | üîí TANCAT |
| 3 | **Rol**: Conciliaci√≥ + Fiscalitat | üîí TANCAT |
| 4 | **Arquitectura**: Next.js 14 + Firebase | üîí TANCAT |
| 5 | **IA**: Nom√©s Genkit + Gemini | üîí TANCAT |
| 6 | **√Ämbit**: No ERP, CRM, facturaci√≥ | üîí TANCAT |
| 7 | **Matching**: Nom√©s exacte (IBAN/DNI/Nom) | üîí TANCAT |
| 8 | **Moviments bancaris**: Immutables | üîí TANCAT |

> ‚õî **Cap LLM pot proposar:**
> - Migrar a SQL, MongoDB, Supabase
> - Canviar Next.js per altre framework
> - Afegir backend separat
> - Fine-tuning de models IA
> - Funcionalitats CRM, ERP, facturaci√≥
> - Integraci√≥ directa APIs banc√†ries
> - Fuzzy matching de noms
> - Modificar/esborrar moviments bancaris originals

> ‚úÖ **Un LLM S√ç pot proposar:**
> - Millores dins l'arquitectura actual
> - Nous camps opcionals a Firestore
> - Noves subcollections si imprescindible
> - Optimitzacions de rendiment
> - Millores UX sense canviar funcionalitat
> - Nous patrons de matching EXACTE (email, tel√®fon...)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX B ‚Äî DOCUMENT PER GPT ASSISTENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## CONTEXT

Summa Social √©s una aplicaci√≥ de gesti√≥ financera per entitats espanyoles.
Gestiona moviments bancaris, donants, prove√Ødors i fiscalitat (Model 182, 347, certificats).
El m√≤dul de devolucions resol el problema de rebuts retornats pel banc sense identificar.

## CONCEPTES CLAU

- DEVOLUCI√ì = Rebut que el banc no ha pogut cobrar i retorna a l'entitat
- REMESA = Agrupaci√≥ de m√∫ltiples moviments en un sol apunt bancari
- REMESA PARCIAL = Remesa amb algunes devolucions pendents d'identificar
- MATCHING = Assignaci√≥ de contacte per coincid√®ncia exacta (IBAN/DNI/Nom)

## FLUX DEVOLUCIONS

1. Usuari veu banner "Devolucions pendents" a Moviments
2. Clica "Revisar" ‚Üí Filtra per devolucions
3. Per cada devoluci√≥:
   - "Assignar donant" ‚Üí Cerca manual
   - Icona üìÑ ‚Üí Importador de fitxer del banc
4. L'importador fa matching per IBAN ‚Üí DNI ‚Üí Nom exacte
5. Es creen transaccions filles, el pare queda immutable

## BANCS SUPORTATS

- Santander: XLSX, data global a cap√ßalera
- Triodos: CSV/XLS, data per l√≠nia
- Altres: Detecci√≥ autom√†tica de columnes

## ERRORS COMUNS

| Error | Causa | Soluci√≥ |
|-------|-------|---------|
| "No s'ha trobat cap donant" | IBAN diferent | Actualitzar IBAN del donant |
| "M√∫ltiples candidates" | Diverses transaccions possibles | Assignar manualment |
| "Sense data fiable" | Banc no informa data | Normal, funciona igualment |

## FRASES PER RESPONDRE

- "Les devolucions es resten autom√†ticament del total un cop assignades."
- "El moviment bancari original no es toca."
- "Si una remesa queda parcial, pots completar-la m√©s tard."
- "Summa Social no fa assignacions autom√†tiques sense coincid√®ncia exacta."

## L√çMITS

- NO fuzzy matching de noms
- NO assignaci√≥ autom√†tica sense confirmaci√≥
- NO modificar moviments bancaris
- Les remeses parcials requereixen acci√≥ manual


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX C ‚Äî EXPORTS I M√íDULS DESACOBLATS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## C.1 Principi Arquitect√≤nic

Summa Social pot generar **feeds de dades de nom√©s lectura** mitjan√ßant Cloud Functions.

Aquests feeds serveixen perqu√® m√≤duls externs consumeixin dades sense afectar el core de l'aplicaci√≥. L'objectiu √©s permetre extensions opcionals mantenint la integritat i simplicitat del producte principal.

## C.2 Patr√≥ Oficial

| Responsabilitat | Actor |
|-----------------|-------|
| **Escriptura del feed** | Backend de Summa Social (Cloud Functions) |
| **Lectura del feed** | Aplicacions o m√≤duls externs |
| **Escriptura al m√≤dul extern** | Nom√©s el m√≤dul extern |

> ‚ö†Ô∏è **Regla fonamental**: Cap m√≤dul extern pot escriure dins del core de Summa Social.

## C.3 Exemple Normatiu: M√≤dul de Projectes

### Estructura Firestore

**Feed de despeses (escriu Summa, llegeix m√≤dul extern):**

```
/organizations/{orgId}/exports/projectExpenses/items/{txId}
```

**Assignacions a projectes (fora de Summa, escriu m√≤dul extern):**

```
/organizations/{orgId}/projectModule/_/expenseLinks/{txId}
```

**Projectes del m√≤dul:**

```
/organizations/{orgId}/projectModule/_/projects/{projectId}
```

> Nota: El document `_` √©s un placeholder t√®cnic necessari per complir l'estructura de Firestore (segments alterns col¬∑lecci√≥/document).

### Join Client-Side

El m√≤dul extern fa el join entre:
- La despesa (del feed `exports/projectExpenses/items`)
- L'assignaci√≥ (de `projectModule/_/expenseLinks`)

Summa Social no coneix ni gestiona les assignacions.

## C.4 L√≠mits Expl√≠cits del Producte

Summa Social **NO**:
- Gestiona projectes (m√©s enll√† dels eixos d'actuaci√≥ existents)
- Gestiona subvencions
- Fa justificacions econ√≤miques
- Controla pressupostos de projectes

Qualsevol funcionalitat en aquesta l√≠nia √©s **externa i opcional**, i s'ha d'implementar fora del core mitjan√ßant el patr√≥ d'exports descrit.

## C.5 Firestore Rules

### CollectionGroup per membres (v1.16)

Permet a un usuari trobar les seves membresies via `collectionGroup`:

```javascript
match /{path=**}/members/{memberId} {
  allow read: if isSignedIn() && request.auth.uid == memberId;
}
```

### Exports i projectModule

Els feeds d'exports s√≥n de nom√©s lectura per als clients:

```javascript
match /exports/{exportType} {
  allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
  allow write: if false; // Nom√©s Cloud Functions

  match /items/{itemId} {
    allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
    allow write: if false; // Nom√©s Cloud Functions
  }
}

match /projectModule/{document=**} {
  allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
  allow write: if (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']) || isSuperAdmin();
}
```

## C.6 √çndexos Firestore (M√≤dul Projectes)

Els √≠ndexos necessaris per al m√≤dul de projectes:

### expenseLinks (projectModule/_/expenseLinks)

| Col¬∑lecci√≥ | Camps | Ordre | √ös |
|------------|-------|-------|-----|
| expenseLinks | `projectIds` (array-contains) | - | Filtrar despeses per projecte |
| expenseLinks | `budgetLineIds` (array-contains) | - | Filtrar despeses per partida pressupost√†ria |

> **Nota**: No s'utilitza `orderBy` en aquestes queries per evitar necessitat d'√≠ndexos compostos. L'ordenaci√≥ es fa client-side.

### exports/projectExpenses/items

| Col¬∑lecci√≥ | Camps | Ordre |
|------------|-------|-------|
| items | `isEligibleForProjects`, `deletedAt`, `date` | date DESC |

> **Nota**: Aquest √≠ndex ja existeix per al feed de despeses elegibles.

### Backfill de budgetLineIds

Les assignacions creades abans de la implementaci√≥ del camp `budgetLineIds` no el tindran poblat. El codi implementa un fallback:
1. Si la query per `budgetLineIds` retorna 0 resultats i hi ha `projectId` disponible
2. Es carreguen els links del projecte i es filtra client-side per `assignments[].budgetLineId`
3. Es trackeja amb `expenses.filter.fallback_used` per monitoritzaci√≥


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX D: NOVETATS DEL PRODUCTE (v1.26)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## D.1 Descripci√≥ del Sistema

Sistema unificat per comunicar novetats del producte als usuaris a trav√©s de m√∫ltiples canals:
- **Campaneta (inst√†ncia)**: Mostra N √∫ltimes novetats dins l'aplicaci√≥
- **Web p√∫blic**: P√†gina `/novetats` per SEO i sharing
- **Social**: Copy per X i LinkedIn (manual)

## D.2 Arquitectura

### Font √∫nica: Firestore `productUpdates`

```
/productUpdates/{updateId}
  id: string
  title: string
  description: string
  link: string | null
  isActive: boolean
  publishedAt: Timestamp
  createdAt: Timestamp

  // Detall (TEXT PLA, NO HTML)
  contentLong?: string | null
  guideUrl?: string | null
  videoUrl?: string | null

  // Web
  web?: {
    enabled: boolean
    slug: string
    excerpt?: string | null
    content?: string | null
  } | null

  // Social
  social?: {
    enabled: boolean
    xText?: string | null
    linkedinText?: string | null
    linkUrl?: string | null
  } | null
```

### Web p√∫blic: JSON est√†tic (NO Firestore directe)

El web p√∫blic `/novetats` NO llegeix Firestore directament per seguretat.

**Flux:**
1. SuperAdmin genera novetat amb `web.enabled: true`
2. SuperAdmin clica "Exportar web JSON" ‚Üí descarrega `novetats-data.json`
3. Commit manual a `public/novetats-data.json`
4. Deploy

## D.3 Guardrails (NO NEGOCIABLES)

| Regla | Motiu |
|-------|-------|
| NO HTML a `contentLong` | XSS prevention, render segur |
| NO `dangerouslySetInnerHTML` | Seguretat |
| NO Firestore list p√∫blic | Evitar leaks i costos |
| NO `undefined` a writes | Firestore errors |
| NO deps noves | Estabilitat |

## D.4 Fitxers Principals

```
src/hooks/use-product-updates.ts           # Hook Firestore + fallback
src/lib/render-structured-text.tsx         # Render text pla (NO HTML)
src/lib/firestore-utils.ts                 # stripUndefined helpers
src/components/notifications/              # Campaneta + modal
src/components/admin/product-updates-section.tsx  # SuperAdmin
src/app/api/ai/generate-product-update/    # Endpoint IA
src/app/public/[lang]/novetats/            # Web p√∫blic
public/novetats-data.json                  # JSON est√†tic web
```

## D.5 Ritual Publicaci√≥ Web

1. Crear/editar novetat amb `web.enabled: true` a SuperAdmin
2. Clicar "Exportar web JSON"
3. Substituir `public/novetats-data.json` amb el fitxer descarregat
4. `git add && git commit && git push`
5. Deploy (Firebase Hosting)

> **Important**: El web NO s'actualitza autom√†ticament. Cal fer commit + deploy.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# FI DEL DOCUMENT
# √öltima actualitzaci√≥: Desembre 2025 - Versi√≥ 1.26
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
