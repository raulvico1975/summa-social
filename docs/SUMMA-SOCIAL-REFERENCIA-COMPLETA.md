# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# SUMMA SOCIAL - REFER√àNCIA COMPLETA DEL PROJECTE
# Versi√≥ 1.41 - Febrer 2026
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 0. AQUEST DOCUMENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Aquest document √©s la **REFER√àNCIA MESTRA** de Summa Social.

Defineix:
- La visi√≥ del producte
- L'arquitectura funcional
- El model de dades
- Les funcionalitats existents i previstes
- Els l√≠mits i l'√†mbit del producte

**Jerarquia de documents:**
- Aquest document t√© **PRIORITAT ABSOLUTA**
- Qualsevol altre document (guies de desenvolupament, prompts per IA, manuals d'usuari, etc.) √©s complementari
- En cas de conflicte entre documents, aquest text **SEMPRE** t√© prioritat
- Cap LLM ni desenvolupador pot contradir el que est√† escrit aqu√≠

**Quan usar aquest document:**
- Per entendre qu√® fa i qu√® NO fa Summa Social
- Per prendre decisions de producte
- Per validar si una nova funcionalitat encaixa amb la visi√≥
- Per donar context a qualsevol IA que treballi amb el projecte

**Estructura de la documentaci√≥:**
```
/docs
‚îú‚îÄ‚îÄ SUMMA-SOCIAL-REFERENCIA-COMPLETA.md   # Aquest document (mestre)
‚îú‚îÄ‚îÄ DEV-SOLO-MANUAL.md                     # Manual operatiu pel mantenidor (NOU v1.20)
‚îú‚îÄ‚îÄ CHANGELOG.md                           # Historial de canvis detallat
‚îú‚îÄ‚îÄ manual-usuari-summa-social.md          # Per a usuaris finals
‚îî‚îÄ‚îÄ CATALEG-FUNCIONALITATS.md              # Refer√®ncia r√†pida de funcionalitats
```


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 1. INFORMACI√ì GENERAL
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 1.1 Qu√® √©s Summa Social?

Summa Social √©s una aplicaci√≥ web de gesti√≥ financera dissenyada espec√≠ficament per a petites i mitjanes entitats sense √†nim de lucre d'Espanya. L'aplicaci√≥ substitueix els fulls de c√†lcul (Excel/Google Sheets) per una eina intel¬∑ligent i centralitzada.

## 1.2 Problema que Resol

Les entitats espanyoles gestionen les seves finances amb fulls de c√†lcul, cosa que provoca:
- Errors humans en la categoritzaci√≥ de moviments
- Dificultat per generar informes fiscals obligatoris (Model 182, Model 347)
- Impossibilitat de tenir una visi√≥ consolidada de les finances
- P√®rdua de temps en tasques repetitives
- Dificultats per fer seguiment de donants i prove√Ødors
- Problemes per emetre certificats de donaci√≥
- Conciliaci√≥ banc√†ria manual i propensa a errors
- Gesti√≥ manual de devolucions banc√†ries

## 1.3 Soluci√≥

Eina centralitzada amb:
- Importaci√≥ autom√†tica d'extractes bancaris (CSV/XLSX)
- Categoritzaci√≥ intel¬∑ligent amb IA (Gemini)
- Auto-assignaci√≥ de contactes als moviments
- Generaci√≥ autom√†tica d'informes fiscals (Excel per gestoria)
- Certificats de donaci√≥ PDF amb firma digitalitzada
- Dashboard amb m√®triques en temps real
- Multi-organitzaci√≥ amb sistema de rols
- Divisor de remeses amb matching intel¬∑ligent
- **Importador de devolucions del banc (NOU v1.8)**
- **Importador de donacions Stripe (NOU v1.9)**
- **Multicomptes bancaris amb filtre i tra√ßabilitat (NOU v1.12)**

## 1.4 URLs i Recursos

| Recurs | URL |
|--------|-----|
| **Producci√≥** | https://summasocial.app |
| **Hosting Firebase** | https://studio--summa-social.us-central1.hosted.app |
| **Repositori** | https://github.com/raulvico1975/summa-social |
| **Entorn desenvolupament** | VS Code + Claude Code |

## 1.5 Stack Tecnol√≤gic

| Component | Tecnologia | Versi√≥ |
|-----------|------------|--------|
| Frontend | Next.js (App Router) | 15.x |
| Llenguatge | TypeScript | 5.x |
| UI Components | shadcn/ui | - |
| Estils | Tailwind CSS | 3.x |
| Base de dades | Firebase Firestore | - |
| Autenticaci√≥ | Firebase Auth | - |
| Emmagatzematge | Firebase Storage | - |
| IA | Genkit + Google Gemini | - |
| Idiomes | Catal√†, Espanyol, Franc√®s i Portugu√®s | i18n |
| Excel/CSV | SheetJS (xlsx) | - |
| PDF | jsPDF | - |

## 1.6 Sobre l'Usuari Desenvolupador

- **Nom**: Raul
- **Perfil**: NO programador - Assessor d'entitats que porta els comptes de diverses organitzacions
- **Entorn**: VS Code + Claude Code
- **Necessitats**: Codi COMPLET (mai fragments), passos verificables, respostes en CATAL√Ä

## 1.7 Prioritats Estrat√®giques 2025-2026

Per a les properes versions, Summa Social se centra en **dos blocs principals**:

### Bloc 1: Conciliaci√≥ Banc√†ria Real

| Funcionalitat | Descripci√≥ | Estat |
|---------------|------------|-------|
| **Multicomptes bancaris** | Suport per m√∫ltiples comptes amb filtre i tra√ßabilitat | ‚úÖ Implementat v1.12 |
| **Regles deterministes** | Categoritzaci√≥ autom√†tica per patrons de text (loteria, voluntariat) | ‚úÖ Implementat v1.12 |
| **Gesti√≥ de devolucions** | Importador de fitxers del banc, remeses parcials | ‚úÖ Implementat v1.8 |

#### Invariant de comptes bancaris

- Cada organitzaci√≥ ha de tenir sempre almenys 1 compte bancari actiu.
- El sistema no permet:
  - eliminar l'√∫ltim compte actiu,
  - desactivar-lo,
  - importar extractes sense compte assignat.
- Tots els moviments bancaris pertanyen sempre a un compte (`bankAccountId` obligatori).
- El dedupe i els avisos de solapament s√≥n per compte bancari, no globals.

### Bloc 2: Fiscalitat Fina Orientada a Gestoria

| Funcionalitat | Descripci√≥ | Estat |
|---------------|------------|-------|
| **Dades m√≠nimes obligat√≤ries** | CP i adre√ßa per Model 182 | ‚úÖ Implementat |
| **Consolidaci√≥ anual** | Import total per donant/prove√Ødor amb devolucions aplicades | ‚úÖ Implementat |
| **Excel net per gestoria** | Format est√†ndard Model 182 amb recurr√®ncia | ‚úÖ Implementat v1.7 |
| **Importador Stripe** | Dividir remeses Stripe amb tra√ßabilitat completa (donacions + comissions) | ‚úÖ Implementat v1.9 |

### Invariants Fiscals (A1-A3)

El sistema garanteix les seg√ºents invariants per assegurar la integritat de les dades fiscals:

#### A1: contactId segons tipus de transacci√≥

| Tipus | contactId |
|-------|-----------|
| `transactionType === 'return'` | **OBLIGATORI** |
| `source === 'remittance'` + `amount > 0` (quotes IN) | **OBLIGATORI** |
| `source === 'stripe'` + `transactionType === 'donation'` | Opcional (no fiscal fins assignaci√≥) |
| `transactionType === 'fee'` | **MAI** (sempre null) |

**Nota sobre Stripe:** Les donacions Stripe sense `contactId` es creen per√≤ queden excloses autom√†ticament de Model 182, certificats de donaci√≥ i c√†lcul de net per donant fins que l'usuari assigni un donant manualment.

#### A2: Coher√®ncia de signes (amount)

| Tipus | amount |
|-------|--------|
| `transactionType === 'return'` | `< 0` (sempre negatiu) |
| `transactionType === 'donation'` | `> 0` (sempre positiu) |
| `transactionType === 'fee'` | `< 0` (sempre negatiu) |

#### A3: Estat del donant no bloqueja fiscal

L'estat del donant (`inactive`, `pending_return`, `archived`, `deleted`) **NO bloqueja** la imputaci√≥ fiscal si existeix `contactId`. L'estat nom√©s afecta l'operativa interna, no el dret fiscal.

#### A4: Coher√®ncia source ‚Üî bankAccountId (NOU v1.34)

| source | bankAccountId | Camps bloquejats (date, amount, description) |
|--------|---------------|----------------------------------------------|
| `bank` | **obligatori** | üîí Bloquejats |
| `stripe` | **obligatori** | üîí Bloquejats |
| `remittance` | heretat del pare | üîí Bloquejats |
| `manual` | `null` | ‚úèÔ∏è Editables |

**Comportament:**
- Transaccions amb `bankAccountId != null` tenen `date`, `amount` i `description` desactivats al di√†leg d'edici√≥.
- Les filles de remesa hereten autom√†ticament el `bankAccountId` del pare.
- Les despeses off-bank (m√≤dul projectes) van a col¬∑lecci√≥ separada (`offBankExpenses`), no afectades per aquesta regla.

**Health Check P0:**
- `source='bank'` o `source='stripe'` sense `bankAccountId` ‚Üí ERROR
- `bankAccountId` present amb `source` diferent de `bank`/`stripe`/`remittance` ‚Üí ERROR

#### Notes de robustesa

- **Reimports:** Idempotents per `bankAccountId` + `importRuns`
- **Multiusuari:** Processaments protegits amb lock per `parentTxId`
- **Eliminaci√≥ accidental:** Soft-delete per transaccions fiscals (return, remittance)

#### Punts de validaci√≥

Les invariants es validen abans d'escriure qualsevol transacci√≥ fiscal a Firestore:
- `useReturnImporter.ts` (creaci√≥ de filles return)
- `StripeImporter.tsx` (creaci√≥ de donacions i comissions)
- `remittance-splitter.tsx` (divisi√≥ de remeses)

**Comportament en violaci√≥:**
1. Llen√ßar Error amb missatge descriptiu
2. Reportar SystemIncident amb `type='INVARIANT_BROKEN'`, `severity='CRITICAL'`
3. Abortar l'operaci√≥ d'escriptura

### Criteri de Prioritzaci√≥

> ‚ö†Ô∏è **Qualsevol nova funcionalitat s'ha de valorar segons si contribueix a aquests dos objectius.**
>
> Si una funcionalitat no millora la conciliaci√≥ banc√†ria ni la preparaci√≥ fiscal, **NO √©s priorit√†ria**.


## 1.8 Millores Transversals

A m√©s dels dos blocs prioritaris, Summa Social incorpora un conjunt de **millores transversals** que s√≥n sempre admissibles i prioritzables.

> ‚úÖ Aquestes l√≠nies de millora es poden implementar en **qualsevol moment**, sense necessitat d'avaluaci√≥ estrat√®gica addicional.

### 1.8.1 Millores de Robustesa
- Correcci√≥ d'errors o comportaments inesperats
- Validacions addicionals per evitar dades incompletes
- Maneig d'errors m√©s predictible i informatiu

### 1.8.2 Millores de Rendiment
- Optimitzaci√≥ de consultes i paginaci√≥ a Firestore
- Reducci√≥ de renders innecessaris en components React
- Simplificaci√≥ de fluxos intensius en mem√≤ria o c√†lcul

### 1.8.3 Millores de Seguretat
- Refor√ß de la protecci√≥ de dades sensibles
- Validaci√≥ estricta de l'input de l'usuari
- Millora i revisi√≥ del sistema de permisos i rols

### 1.8.4 Millores d'Experi√®ncia d'Usuari (UX/UI)
- Simplificaci√≥ d'interf√≠cies o formularis sense alterar funcionalitats
- Clarificaci√≥ de textos, etiquetes i missatges
- Reducci√≥ de passos innecessaris en fluxos d'√∫s actuals
- **Regla 10s** (NOU v1.11): qualsevol acci√≥ de captura m√≤bil ha de completar-se en menys de 10 segons

### 1.8.5 Millores de Mantenibilitat
- Refactors orientats a reduir complexitat o duplicaci√≥
- Reorganitzaci√≥ de fitxers o components per guanyar llegibilitat
- Eliminaci√≥ de depend√®ncies innecess√†ries o obsoletes

### 1.8.6 Millores de Diagn√≤stic i Observabilitat
- Logs m√©s clars i estructurats
- Avisos o mecanismes per facilitar la depuraci√≥
- Indicadors interns per detectar problemes

#### Logs Estructurats de Categoritzaci√≥ IA

El sistema de categoritzaci√≥ IA genera logs estructurats per facilitar el diagn√≤stic. Tots els logs utilitzen el prefix `[IA]`.

**Format dels logs:**

| Event | Format | Exemple |
|-------|--------|---------|
| Inici individual | `[IA] Iniciant categoritzacio per: "{desc}..."` | `[IA] Iniciant categoritzacio per: "TRANSFERENCIA DE N√íMINA..."` |
| √àxit individual | `[IA] OK: category="{cat}" confidence={n}% model=gemini-2.0-flash` | `[IA] OK: category="N√≤mines" confidence=95% model=gemini-2.0-flash` |
| Error individual | `[IA] ERROR: code={code} reason="{msg}" model=gemini-2.0-flash` | `[IA] ERROR: code=QUOTA_EXCEEDED reason="Quota exceeded" model=gemini-2.0-flash` |
| Inici batch | `[IA] Iniciant classificacio SEQ√úENCIAL de {n} moviments{mode}.` | `[IA] Iniciant classificacio SEQ√úENCIAL de 25 moviments (MODE R√ÄPID).` |
| Progr√©s batch | `[IA] Classificant {i}/{n}: "{desc}..."` | `[IA] Classificant 3/25: "PAGAMENT LLOGU..."` |
| √àxit batch item | `[IA] ‚úì {txId} ‚Üí "{category}"` | `[IA] ‚úì abc123 ‚Üí "Lloguer"` |
| Error batch item | `[IA] ‚úó {txId}: {code} - {message}` | `[IA] ‚úó abc123: RATE_LIMITED - Rate limited` |
| Backoff | `[IA] Backoff: nou delay = {ms}ms` | `[IA] Backoff: nou delay = 3000ms` |
| Quota esgotada | `[IA] QUOTA EXCEDIDA - Aturant proc√©s` | - |
| Cancel¬∑laci√≥ | `[IA] Cancel¬∑lat per l'usuari` | - |
| Finalitzaci√≥ | `[IA] {status}: {ok} OK, {err} errors en {s}s.` | `[IA] COMPLETAT: 23 OK, 2 errors en 45s.` |

**Codis d'error de l'API:**

| Codi | Descripci√≥ | Acci√≥ |
|------|------------|-------|
| `QUOTA_EXCEEDED` | Quota di√†ria d'IA esgotada (429 o 400 amb "limit/exceeded") | Aturar batch, notificar usuari |
| `RATE_LIMITED` | Massa peticions en poc temps | Aplicar backoff, continuar |
| `TRANSIENT` | Error temporal del servidor (503, 504, timeout) | Aplicar backoff, continuar |
| `INVALID_INPUT` | Dades de la transacci√≥ inv√†lides | Marcar com "Revisar", continuar |
| `AI_ERROR` | Error gen√®ric d'IA (clau inv√†lida, model no disponible) | Marcar com "Revisar", continuar |
| `NETWORK` | Error de xarxa (client-side) | Aplicar backoff, continuar |

**Events trackUX (analytics):**

| Event | Propietats | Quan |
|-------|------------|------|
| `ai.categorize.error` | `{ code, reason, model }` | Error en categoritzaci√≥ individual |
| `ai.bulk.run.start` | `{ count, bulkMode, sequential }` | Inici de batch |
| `ai.bulk.run.done` | `{ processedCount, errorCount, durationMs, bulkMode, quotaExceeded, cancelled }` | Fi de batch |
| `ai.bulk.toggle` | `{ enabled }` | SuperAdmin activa/desactiva mode r√†pid |
| `ai.bulk.fallback_quota` | `{ reason }` | Fallback autom√†tic per quota |

**Constants de timing:**

| Constant | Valor | Descripci√≥ |
|----------|-------|------------|
| `BASE_DELAY_NORMAL_MS` | 1500ms | Delay entre crides (mode normal) |
| `BASE_DELAY_BULK_MS` | 1200ms | Delay entre crides (mode r√†pid) |
| `MAX_DELAY_MS` | 8000ms | M√†xim delay amb backoff |
| `BACKOFF_MULTIPLIER` | 2 | Factor de multiplicaci√≥ del backoff |

**Fitxers relacionats:**
- `src/app/api/ai/categorize-transaction/route.ts` ‚Äî Route Handler de l'API
- `src/components/transactions/hooks/useTransactionCategorization.ts` ‚Äî Hook client
- `src/ai/genkit.ts` ‚Äî Configuraci√≥ Genkit

### Principi General

> üí° Aquestes millores s√≥n sempre compatibles amb la visi√≥ del producte i contribueixen directament a la seva estabilitat i longevitat.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 2. ARQUITECTURA T√àCNICA
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 2.1 Estructura de Fitxers

```
/src
  /app                          ‚Üí P√†gines (Next.js App Router)
    /public/[lang]               ‚Üí Rutes p√∫bliques multiidioma (segment real `public`)
      /page.tsx                  ‚Üí HOME multiidioma
      /funcionalitats/page.tsx   ‚Üí Funcionalitats (CA)
      /funcionalidades/page.tsx  ‚Üí Funcionalitats (ES)
      /fonctionnalites/page.tsx  ‚Üí Funcionalitats (FR)
      /privacy/page.tsx          ‚Üí Pol√≠tica de privacitat (CA/EN)
      /privacidad/page.tsx       ‚Üí Pol√≠tica de privacitat (ES)
      /confidentialite/page.tsx  ‚Üí Pol√≠tica de privacitat (FR)
      /privacidade/page.tsx      ‚Üí Pol√≠tica de privacitat (PT)
      /contact/page.tsx          ‚Üí Contacte (CA/EN)
      /contacto/page.tsx         ‚Üí Contacte (ES)
      /novetats/page.tsx         ‚Üí Novetats del producte
      /novetats/[slug]/page.tsx  ‚Üí Detall novetat
      layout.tsx                 ‚Üí Validaci√≥ idioma + generateStaticParams
    /[orgSlug]                   ‚Üí Rutes per organitzaci√≥ (app privada)
      /dashboard
        /page.tsx                ‚Üí Dashboard principal
        /movimientos             ‚Üí Gesti√≥ de transaccions
        /donantes                ‚Üí Gesti√≥ de donants
        /proveedores             ‚Üí Gesti√≥ de prove√Ødors
        /trabajadores            ‚Üí Gesti√≥ de treballadors
        /ejes-de-actuacion       ‚Üí Gesti√≥ de projectes/eixos
        /informes                ‚Üí Informes fiscals (182, 347)
          /certificats           ‚Üí Certificats de donaci√≥
        /configuracion           ‚Üí Configuraci√≥ de l'organitzaci√≥
      /login                     ‚Üí Login per organitzaci√≥
    /admin                       ‚Üí Panel SuperAdmin global
    /login                       ‚Üí Redirect stub ‚Üí /{lang}/login (via middleware)
    /privacy                     ‚Üí Redirect stub ‚Üí /{lang}/privacy
    /contacte                    ‚Üí Redirect stub ‚Üí /{lang}/contact
    /privacitat                  ‚Üí Redirect stub ‚Üí /{lang}/privacy (legacy)
    /funcionalitats              ‚Üí Redirect stub ‚Üí /{lang}/funcionalitats
    /registre                    ‚Üí P√†gina de registre
  /components                    ‚Üí Components React reutilitzables
    /ui                          ‚Üí Components shadcn/ui
    /return-importer             ‚Üí Importador de devolucions (NOU v1.8)
      useReturnImporter.ts       ‚Üí Hook amb l√≤gica de matching
      ReturnImporter.tsx         ‚Üí Modal UI de l'importador
      index.ts                   ‚Üí Exports
    /stripe-importer             ‚Üí Importador de donacions Stripe (NOU v1.9)
      useStripeImporter.ts       ‚Üí Hook amb l√≤gica de parsing i matching
      StripeImporter.tsx         ‚Üí Modal UI de l'importador
      index.ts                   ‚Üí Exports
    /onboarding                  ‚Üí Components d'onboarding (ACTUALITZAT v1.20)
      WelcomeOnboardingModal.tsx ‚Üí Modal de benvinguda per primer admin
      OnboardingWizard.tsx       ‚Üí Wizard de configuraci√≥ inicial
    /admin                       ‚Üí Components del panell admin
      create-organization-dialog.tsx ‚Üí Modal crear organitzaci√≥
    donor-manager.tsx            ‚Üí Gesti√≥ de donants
    donor-importer.tsx           ‚Üí Importador massiu de donants
    supplier-manager.tsx         ‚Üí Gesti√≥ de prove√Ødors
    supplier-importer.tsx        ‚Üí Importador massiu de prove√Ødors
    transaction-table.tsx        ‚Üí Taula de moviments
    transaction-importer.tsx     ‚Üí Importador d'extractes
    remittance-splitter.tsx      ‚Üí Divisor de remeses
    donations-report-generator.tsx ‚Üí Generador Model 182
    donation-certificate-generator.tsx ‚Üí Generador certificats
    dashboard-*.tsx              ‚Üí Components del dashboard
  /firebase                      ‚Üí Configuraci√≥ i hooks de Firebase
  /hooks                         ‚Üí Hooks personalitzats de React
  /services                      ‚Üí Serveis (admin.ts, auth.ts)
  /lib                           ‚Üí Utilitats, tipus i dades
    /data.ts                     ‚Üí Definicions de tipus (Transaction, Contact, etc.)
    /fiscal                      ‚Üí L√≤gica fiscal (invariants, locks, softDelete)
    /contacts                    ‚Üí Helpers de contactes (filterActiveContacts)
    /sepa                        ‚Üí Generadors SEPA (pain.001, pain.008)
    /files                       ‚Üí Gesti√≥ de fitxers (attach-document, sha256)
    /notifications.ts            ‚Üí Product updates (deprecated, fallback local)
    /__tests__                   ‚Üí Tests unitaris (7 fitxers)
  /scripts                       ‚Üí Scripts d'utilitat i demo
  /help                          ‚Üí Contingut d'ajuda per idioma (ca/, es/, fr/)
  /i18n                          ‚Üí Traduccions
    /ca.ts                       ‚Üí Catal√† (idioma base, app privada)
    /es.ts                       ‚Üí Espanyol (app privada)
    /fr.ts                       ‚Üí Franc√®s (app privada)
    # pt NO t√© .ts ‚Äî √©s JSON-only (veure secci√≥ 3.9.7)
    /public.ts                   ‚Üí Traduccions p√†gines p√∫bliques CA/ES/FR/PT
    /locales/*.json              ‚Üí Bundles JSON per runtime (ca, es, fr, pt)
    /provider.tsx                ‚Üí Provider, listener versi√≥, carrega JSON
    /json-runtime.ts             ‚Üí Loader Storage/local, cache, trFactory
    /index.ts                    ‚Üí Tipus Language, context, hook
  /ai                            ‚Üí Fluxos de Genkit (IA)
```

## 2.2 Model de Dades Firestore

```
organizations/
  ‚îî‚îÄ‚îÄ {orgId}/
      ‚îÇ
      ‚îú‚îÄ‚îÄ name: string                    # Nom de l'organitzaci√≥
      ‚îú‚îÄ‚îÄ taxId: string                   # CIF de l'entitat
      ‚îú‚îÄ‚îÄ slug: string                    # Identificador URL √∫nic
      ‚îú‚îÄ‚îÄ status: 'active' | 'suspended' | 'pending'  # Estat de l'org
      ‚îú‚îÄ‚îÄ address: string                 # Adre√ßa fiscal
      ‚îú‚îÄ‚îÄ city: string                    # Ciutat
      ‚îú‚îÄ‚îÄ province: string               # Prov√≠ncia
      ‚îú‚îÄ‚îÄ zipCode: string                 # Codi postal
      ‚îú‚îÄ‚îÄ phone: string                   # Tel√®fon
      ‚îú‚îÄ‚îÄ email: string                   # Email de contacte
      ‚îú‚îÄ‚îÄ website: string                 # P√†gina web
      ‚îú‚îÄ‚îÄ logoUrl: string | null          # URL del logo
      ‚îú‚îÄ‚îÄ signatureUrl: string | null     # URL de la firma digitalitzada
      ‚îú‚îÄ‚îÄ signatoryName: string | null    # Nom del signant
      ‚îú‚îÄ‚îÄ signatoryRole: string | null    # C√†rrec del signant
      ‚îú‚îÄ‚îÄ language: 'ca' | 'es' | null   # Idioma per defecte de l'org
      ‚îú‚îÄ‚îÄ features?: OrganizationFeatures # Feature flags (projectModule, etc.)
      ‚îú‚îÄ‚îÄ isDemo?: boolean                # Organitzaci√≥ demo?
      ‚îú‚îÄ‚îÄ contactAlertThreshold: number   # Llindar alertes contacte (default: 50)
      ‚îÇ
      ‚îú‚îÄ‚îÄ onboarding/                     # Estat onboarding
      ‚îÇ   ‚îî‚îÄ‚îÄ welcomeSeenAt: string | null  # YYYY-MM-DD quan primer admin ha vist modal
      ‚îÇ
      ‚îú‚îÄ‚îÄ createdAt: string
      ‚îú‚îÄ‚îÄ createdBy: string               # UID del creador
      ‚îú‚îÄ‚îÄ updatedAt: string
      ‚îÇ
      ‚îú‚îÄ‚îÄ members/
      ‚îÇ   ‚îî‚îÄ‚îÄ {userId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ role: "admin" | "user" | "viewer"
      ‚îÇ       ‚îú‚îÄ‚îÄ email: string
      ‚îÇ       ‚îú‚îÄ‚îÄ displayName: string
      ‚îÇ       ‚îú‚îÄ‚îÄ joinedAt: string
      ‚îÇ       ‚îî‚îÄ‚îÄ invitedBy?: string
      ‚îÇ
      ‚îú‚îÄ‚îÄ transactions/
      ‚îÇ   ‚îî‚îÄ‚îÄ {transactionId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ date: string                    # Data (YYYY-MM-DD)
      ‚îÇ       ‚îú‚îÄ‚îÄ description: string             # Concepte bancari
      ‚îÇ       ‚îú‚îÄ‚îÄ amount: number                  # Import (+ ingr√©s, - despesa)
      ‚îÇ       ‚îú‚îÄ‚îÄ category: string | null         # ID de categoria
      ‚îÇ       ‚îú‚îÄ‚îÄ categoryName: string | null     # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ emisorId: string | null         # ID del contacte
      ‚îÇ       ‚îú‚îÄ‚îÄ emisorName: string | null       # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ contactId: string | null        # ID contacte (alias emisorId)
      ‚îÇ       ‚îú‚îÄ‚îÄ contactType: string | null      # 'donor' | 'supplier' | 'employee'
      ‚îÇ       ‚îú‚îÄ‚îÄ contactName: string | null      # Nom contacte (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ projectId: string | null        # ID del projecte
      ‚îÇ       ‚îú‚îÄ‚îÄ projectName: string | null      # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ documentUrl: string | null      # URL document adjunt
      ‚îÇ       ‚îú‚îÄ‚îÄ notes: string | null            # Notes internes
      ‚îÇ       ‚îú‚îÄ‚îÄ transactionType: string | null  # 'normal' | 'return' | 'return_fee' | 'donation' | 'fee'
      ‚îÇ       ‚îú‚îÄ‚îÄ donationStatus: string | null   # 'returned' si marcada
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de remeses:
      ‚îÇ       ‚îú‚îÄ‚îÄ isRemittance: boolean | null    # √âs una remesa agrupada?
      ‚îÇ       ‚îú‚îÄ‚îÄ isRemittanceItem: boolean       # √âs una filla de remesa?
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceId: string | null     # Ref a doc remittances/{id}
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceItemCount: number | null  # Nombre total de quotes
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceDirection: 'IN' | 'OUT' | null  # Direcci√≥ de la remesa
      ‚îÇ       ‚îú‚îÄ‚îÄ source: 'bank' | 'remittance' | 'manual' | 'stripe' | null  # Origen
      ‚îÇ       ‚îú‚îÄ‚îÄ parentTransactionId: string | null  # ID remesa pare
      ‚îÇ       ‚îú‚îÄ‚îÄ bankAccountId: string | null        # ID compte bancari (obligatori si source=bank|stripe)
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de remeses de devolucions:
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceType: 'returns' | 'donations' | 'payments' | null
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceStatus: 'complete' | 'partial' | 'pending' | null
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceResolvedCount: number | null   # Filles creades
      ‚îÇ       ‚îú‚îÄ‚îÄ remittancePendingCount: number | null    # Pendents d'identificar
      ‚îÇ       ‚îú‚îÄ‚îÄ remittancePendingTotalAmount: number | null  # Import pendent ‚Ç¨
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceExpectedTotalCents: number | null
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceResolvedTotalCents: number | null
      ‚îÇ       ‚îú‚îÄ‚îÄ remittancePendingTotalCents: number | null
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de donacions Stripe:
      ‚îÇ       ‚îú‚îÄ‚îÄ stripePaymentId: string | null      # ID pagament (ch_xxx)
      ‚îÇ       ‚îú‚îÄ‚îÄ stripeTransferId: string | null     # ID payout (po_xxx)
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de splits i links:
      ‚îÇ       ‚îú‚îÄ‚îÄ isSplit: boolean                    # Transacci√≥ dividida?
      ‚îÇ       ‚îú‚îÄ‚îÄ linkedTransactionId: string | null  # Link a devoluci√≥/donaci√≥
      ‚îÇ       ‚îú‚îÄ‚îÄ linkedTransactionIds: string[]      # Links m√∫ltiples
      ‚îÇ       ‚îÇ
      ‚îÇ       # Soft-delete (arxivament):
      ‚îÇ       ‚îú‚îÄ‚îÄ archivedAt: string | null           # ISO timestamp si arxivada
      ‚îÇ       ‚îú‚îÄ‚îÄ archivedByUid: string | null        # UID de qui va arxivar
      ‚îÇ       ‚îú‚îÄ‚îÄ archivedReason: string | null       # Motiu
      ‚îÇ       ‚îú‚îÄ‚îÄ archivedFromAction: 'user_delete' | 'superadmin_cleanup' | null
      ‚îÇ       ‚îÇ
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
      ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
      ‚îÇ
      ‚îú‚îÄ‚îÄ bankAccounts/
      ‚îÇ   ‚îî‚îÄ‚îÄ {bankAccountId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ name: string                   # Nom identificatiu
      ‚îÇ       ‚îú‚îÄ‚îÄ iban: string | null            # IBAN del compte
      ‚îÇ       ‚îú‚îÄ‚îÄ bankName: string | null        # Nom del banc
      ‚îÇ       ‚îú‚îÄ‚îÄ isDefault: boolean             # Compte per defecte?
      ‚îÇ       ‚îú‚îÄ‚îÄ isActive: boolean              # Actiu/Inactiu
      ‚îÇ       ‚îú‚îÄ‚îÄ creditorId: string | null      # ICS / SEPA Creditor Identifier (pain.008)
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: string
      ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: string
      ‚îÇ
      ‚îú‚îÄ‚îÄ remittances/
      ‚îÇ   ‚îî‚îÄ‚îÄ {remittanceId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ direction: 'IN' | 'OUT'         # Direcci√≥
      ‚îÇ       ‚îú‚îÄ‚îÄ type: 'donations' | 'returns' | 'payments'
      ‚îÇ       ‚îú‚îÄ‚îÄ parentTransactionId: string     # Ref a transacci√≥ pare
      ‚îÇ       ‚îú‚îÄ‚îÄ transactionIds: string[]        # Llista de filles actives
      ‚îÇ       ‚îú‚îÄ‚îÄ inputHash: string               # SHA-256 del input (idempot√®ncia)
      ‚îÇ       ‚îú‚îÄ‚îÄ status: 'active' | 'undone'     # Estat del doc
      ‚îÇ       ‚îú‚îÄ‚îÄ itemCount: number
      ‚îÇ       ‚îú‚îÄ‚îÄ resolvedCount: number
      ‚îÇ       ‚îú‚îÄ‚îÄ pendingCount: number
      ‚îÇ       ‚îú‚îÄ‚îÄ expectedTotalCents: number
      ‚îÇ       ‚îú‚îÄ‚îÄ resolvedTotalCents: number
      ‚îÇ       ‚îú‚îÄ‚îÄ pendingTotalCents: number
      ‚îÇ       ‚îú‚îÄ‚îÄ bankAccountId: string | null
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: string
      ‚îÇ       ‚îú‚îÄ‚îÄ createdBy: string
      ‚îÇ       ‚îÇ
      ‚îÇ       ‚îî‚îÄ‚îÄ pending/                        # Filles pendents d'assignar
      ‚îÇ           ‚îî‚îÄ‚îÄ {pendingId}/
      ‚îÇ               ‚îú‚îÄ‚îÄ nameRaw: string
      ‚îÇ               ‚îú‚îÄ‚îÄ taxId: string | null
      ‚îÇ               ‚îú‚îÄ‚îÄ iban: string | null
      ‚îÇ               ‚îú‚îÄ‚îÄ amountCents: number
      ‚îÇ               ‚îú‚îÄ‚îÄ reason: string
      ‚îÇ               ‚îú‚îÄ‚îÄ sourceRowIndex: number
      ‚îÇ               ‚îî‚îÄ‚îÄ createdAt: string
      ‚îÇ
      ‚îú‚îÄ‚îÄ categories/
      ‚îÇ   ‚îî‚îÄ‚îÄ {categoryId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ name: string
      ‚îÇ       ‚îú‚îÄ‚îÄ type: "income" | "expense"
      ‚îÇ       ‚îî‚îÄ‚îÄ order: number
      ‚îÇ
      ‚îú‚îÄ‚îÄ emissors/  (tamb√© anomenats "contacts")
      ‚îÇ   ‚îî‚îÄ‚îÄ {emisorId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ name: string                    # Nom del contacte
      ‚îÇ       ‚îú‚îÄ‚îÄ taxId: string                   # NIF/CIF
      ‚îÇ       ‚îú‚îÄ‚îÄ zipCode: string                 # Codi postal
      ‚îÇ       ‚îú‚îÄ‚îÄ address: string                 # Adre√ßa (carrer, n√∫mero)
      ‚îÇ       ‚îú‚îÄ‚îÄ city: string                    # Ciutat
      ‚îÇ       ‚îú‚îÄ‚îÄ province: string                # Prov√≠ncia
      ‚îÇ       ‚îú‚îÄ‚îÄ email: string                   # Email
      ‚îÇ       ‚îú‚îÄ‚îÄ phone: string                   # Tel√®fon
      ‚îÇ       ‚îú‚îÄ‚îÄ iban: string                    # IBAN
      ‚îÇ       ‚îú‚îÄ‚îÄ type: "donor" | "supplier" | "employee"
      ‚îÇ       ‚îú‚îÄ‚îÄ roles: ContactRoles | null      # Sistema progressiu de rols
      ‚îÇ       ‚îú‚îÄ‚îÄ archivedAt: string | null       # Soft-delete (ISO timestamp)
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps espec√≠fics per DONANTS:
      ‚îÇ       ‚îú‚îÄ‚îÄ donorType: "individual" | "company"
      ‚îÇ       ‚îú‚îÄ‚îÄ membershipType: "one-time" | "recurring"
      ‚îÇ       ‚îú‚îÄ‚îÄ monthlyAmount: number           # Quota
      ‚îÇ       ‚îú‚îÄ‚îÄ periodicityQuota: 'monthly' | 'quarterly' | 'semiannual' | 'annual' | null  # Periodicitat quota
      ‚îÇ       ‚îú‚îÄ‚îÄ contactPersonName: string | null   # Persona de contacte (nom√©s PJ)
      ‚îÇ       ‚îú‚îÄ‚îÄ memberSince: string             # Data alta soci
      ‚îÇ       ‚îú‚îÄ‚îÄ status: "active" | "pending_return" | "inactive"
      ‚îÇ       ‚îú‚îÄ‚îÄ inactiveSince: string | null    # Data de baixa
      ‚îÇ       ‚îú‚îÄ‚îÄ returnCount: number             # Comptador devolucions
      ‚îÇ       ‚îú‚îÄ‚îÄ lastReturnDate: string          # √öltima devoluci√≥
      ‚îÇ       ‚îú‚îÄ‚îÄ sepaMandate: SepaMandate | null # Mandat SEPA (pain.008)
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps comuns:
      ‚îÇ       ‚îú‚îÄ‚îÄ defaultCategoryId: string | null
      ‚îÇ       ‚îú‚îÄ‚îÄ notes: string
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
      ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
      ‚îÇ
      ‚îî‚îÄ‚îÄ projects/
          ‚îî‚îÄ‚îÄ {projectId}/
              ‚îú‚îÄ‚îÄ name: string
              ‚îú‚îÄ‚îÄ description: string
              ‚îú‚îÄ‚îÄ funderId: string | null
              ‚îú‚îÄ‚îÄ isActive: boolean
              ‚îú‚îÄ‚îÄ createdAt: timestamp
              ‚îî‚îÄ‚îÄ updatedAt: timestamp
```

## 2.3 Sistema d'Autenticaci√≥ i Rols

### Rols d'organitzaci√≥ (`OrganizationRole`)

| Rol | Descripci√≥ | Permisos |
|-----|------------|----------|
| **Admin** | Administrador de l'organitzaci√≥ | Tot excepte Zona de Perill |
| **User** | Usuari est√†ndard | Crear i editar, no eliminar ni configurar |
| **Viewer** | Nom√©s lectura | Veure dades, no modificar |

### SuperAdmin (global, fora d'organitzaci√≥)

El SuperAdmin **no √©s un rol d'organitzaci√≥**. Es gestiona globalment:

- **Ruta Firestore:** `systemSuperAdmins/{uid}` (si el document existeix, l'usuari √©s SuperAdmin)
- **Constant:** `SUPER_ADMIN_UID` a `src/lib/admin/is-superadmin.ts`
- **Helper:** `isSuperAdmin(uid)` ‚Äî comprova exist√®ncia del document
- **Permisos:** Tot + Zona de Perill + Panell `/admin` + Gesti√≥ traduccions + Product Updates

### Permisos detallats

| Acci√≥ | SuperAdmin | Admin | User | Viewer |
|-------|------------|-------|------|--------|
| Veure dashboard | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Veure moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Crear moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Editar moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Eliminar moviments | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Importar extractes | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Gestionar contactes | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Gestionar categories | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Gestionar membres | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Configurar organitzaci√≥ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Generar informes | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Zona de Perill | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |

### Persist√®ncia de sessi√≥

- **Tipus**: `browserSessionPersistence`
- La sessi√≥ caduca autom√†ticament en tancar el navegador
- Implementat a v1.7 per seguretat

### Logout per inactivitat

- **IdleLogoutProvider**: Component que tanca la sessi√≥ despr√©s de 30 minuts d'inactivitat
- Av√≠s 1 minut abans del logout
- Events monitoritzats: mouse, teclat, scroll, touch, click, canvi de visibilitat
- Redirecci√≥ a `/{slug}/login?reason=idle` (si l'usuari est√† dins una org) o `/login?reason=idle` (rutes globals)
- Segments reservats (no s√≥n slugs): `login`, `registre`, `redirect-to-org`, `admin`, `dashboard`, `privacy`, `api`, `q`, `quick`, `quick-expense`
- Implementat a `src/components/IdleLogoutProvider.tsx`

### Flux de redirecci√≥ d'organitzaci√≥

- **redirect-to-org**: P√†gina que determina l'organitzaci√≥ de l'usuari i redirigeix a `/{slug}/dashboard`
- Ordre de cerca: 1) `organizationId` al perfil, 2) query `collectionGroup('members')` pel uid
- Si no t√© acc√©s a cap org: mostra estat "no-org" amb opci√≥ de logout
- Query optimitzada O(1) amb `collectionGroup` + `documentId()` (implementat v1.16)

## 2.4 Multi-Organitzaci√≥

- Cada usuari pot pert√†nyer a m√∫ltiples organitzacions
- Les dades estan completament a√Øllades entre organitzacions
- L'URL inclou el slug de l'organitzaci√≥: `/[orgSlug]/dashboard/...`
- Un usuari pot tenir rols diferents a cada organitzaci√≥
- Sistema centralitzat de slugs per evitar duplicats

## 2.5 Tests Unitaris (NOU v1.8)

Tests unitaris per funcions pures a `src/lib/__tests__/`:

| Fitxer | Cobertura |
|--------|-----------|
| `normalize.test.ts` | normalizeTaxId, normalizeIBAN, normalizeZipCode, formatNumberEU, parseNumberEU |
| `auto-match.test.ts` | normalizeForMatching, extractNameTokens, findMatchingContact |
| `model182.test.ts` | calculateModel182Totals, calculateTransactionNetAmount, isReturnTransaction |
| `stripe-importer.test.ts` | Parsing i matching Stripe |
| `build-document-filename.test.ts` | Generaci√≥ de noms de fitxer |
| `calculate-donor-net.test.ts` | C√†lcul net per donant (donacions - devolucions) |
| `fiscal-invariant.test.ts` | Validaci√≥ invariants fiscals A1-A3 |

**Hook pre-commit (Husky):** Els tests s'executen autom√†ticament abans de cada commit.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 3. FUNCIONALITATS DETALLADES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 3.1 DASHBOARD (ACTUALITZAT v1.30)

### 3.1.1 Bloc "Diners" (veritat banc√†ria)

Dataset: `filteredTransactions` ‚Äî nom√©s apunts bancaris reals (ledger).

| Targeta | C√†lcul |
|---------|--------|
| **Ingressos** | Suma moviments amount > 0 |
| **Despeses operatives** | Suma amount < 0 EXCLOENT transfer√®ncies a terreny |
| **Terreny (Transfer√®ncies)** | Suma `category === 'missionTransfers'` |
| **Saldo operatiu** | Ingressos + Despeses + Terreny |

### 3.1.2 Bloc "Qui ens sost√©" (veritat relacional) ‚Äî ACTUALITZAT v1.30

Dataset: `socialMetricsTxs` ‚Äî transaccions amb `contactId`, inclou fills de remesa.

| M√®trica | Descripci√≥ | Comparativa |
|---------|------------|-------------|
| **Quotes de socis** | Import de contactes `membershipType='recurring'` | vs any anterior |
| **Donacions puntuals** | Import de contactes `membershipType='one-time'` | vs any anterior |
| **Altres ingressos** | Residual: Ingressos - Quotes - Donacions | ‚Äî |
| **Socis actius** | Contactes recurring amb moviments al per√≠ode | vs any anterior |
| **Donants actius** | Contactes one-time amb moviments al per√≠ode | vs any anterior |

**Nota reconciliaci√≥ (v1.30):**
- El KPI "Altres ingressos" nom√©s es mostra si el valor √©s > 0.
- Inclou: subvencions, loteria, reintegraments, interessos, ingressos sense contacte.
- Objectiu: el gestor pot reconciliar mentalment Dashboard amb extracte bancari.

### 3.1.3 Bloc Obligacions Fiscals

| Obligaci√≥ | Data l√≠mit | Acci√≥ |
|-----------|------------|-------|
| Model 182 | 31 gener | Bot√≥ "Preparar" |
| Model 347 | 28 febrer | Bot√≥ "Preparar" |

### 3.1.4 Bloc Categories Principals (ACTUALITZAT v1.20)

Mostra les categories amb m√©s volum de despesa, excloent:
- Comissions banc√†ries (`transactionType === 'fee'` o `'return_fee'`)
- Moviments sense categoria (mostrats com a peu de taula neutral "Sense categoria")

### 3.1.5 Bloc Despesa per Projecte (ACTUALITZAT v1.20)

**Condicions de visibilitat:**
- M√≤dul Projectes activat (`featureFlags.projectModule`)
- Almenys 1 projecte actiu
- M√©s del 5% de les despeses assignades a projectes

**Contingut:**
- Top 3 projectes amb m√©s despesa assignada
- Percentatge del total per projecte
- CTA "Veure detall" ‚Üí `/dashboard/project-module/projects`

### 3.1.6 Filtre de Dates
- Any complet
- Trimestre
- Mes
- Personalitzat
- Tot

### 3.1.7 Modal de Benvinguda (NOU v1.20)

El Dashboard gestiona la modal de benvinguda per al primer admin:
- Comprova `shouldShowWelcomeModal()` al carregar
- Si retorna `true`, mostra `WelcomeOnboardingModal`
- Opcions: "Guia'm" (obre wizard) o "Comen√ßar pel meu compte" (tanca)

### 3.1.8 Blocs Desactivats

Els seg√ºents blocs estan **desactivats** (comentats al codi) a partir de v1.20:
- **Celebracions**: Missatges de fites positives (massa soroll, poc valor)
- **Alertes**: Avisos de moviments pendents (trasllat a altres pantalles)

> **Nota:** El dashboard √©s una eina de visualitzaci√≥ i seguiment, no de validaci√≥ ni govern. Les m√®triques mostrades s√≥n informatives i no constitueixen cap informe oficial.


## 3.2 GESTI√ì DE MOVIMENTS

### 3.2.1 Importaci√≥ d'Extractes Bancaris

**Formats suportats:**
- CSV (detecci√≥ autom√†tica de separador)
- XLSX / XLS (Excel)

**Proc√©s:**
1. Pujar fitxer (drag & drop o selecci√≥)
2. Detecci√≥ autom√†tica de columnes
3. Vista pr√®via
4. Detecci√≥ de duplicats
5. Importaci√≥ amb auto-assignaci√≥

### 3.2.2 Sistema d'Auto-Assignaci√≥ Intel¬∑ligent

**FASE 1: Matching per Nom (instantani)**
- Cerca el nom de cada contacte a la descripci√≥
- ~70% dels moviments assignats autom√†ticament

**FASE 2: IA amb Gemini (si cal)**
- Envia descripci√≥ a Gemini
- Suggereix contacte m√©s probable
- ~16% addicional

> **Blindatge:** La classificaci√≥ suggerida per IA no s'aplica autom√†ticament. L'usuari sempre ha de validar o confirmar l'assignaci√≥ proposada.

**Aplicaci√≥ de Categoria per Defecte:**
- Si contacte t√© defaultCategoryId ‚Üí s'aplica autom√†ticament

**Detecci√≥ For√ßada de Categories (NOU v1.12):**
- Loteria: patrons "loteria", "sorteig" ‚Üí categoria "Loteries i sorteigs"
- Voluntariat: patrons "voluntari", "voluntariat" ‚Üí categoria "Ingressos voluntariat"
- S'aplica a ingressos positius autom√†ticament durant la importaci√≥

### 3.2.3 Taula de Moviments

| Columna | Editable |
|---------|----------|
| Data | ‚úÖ |
| Descripci√≥ | ‚úÖ |
| Import | ‚úÖ |
| Categoria | ‚úÖ (selector amb cerca) |
| Contacte | ‚úÖ (selector amb cerca) |
| Projecte | ‚úÖ |
| Document | ‚úÖ (upload) |
| Nota | ‚úÖ |

### 3.2.4 Filtres
- Per data (any, trimestre, mes, personalitzat)
- Per categoria
- Per contacte
- Per projecte
- Per compte bancari (NOU v1.12)
- Per origen: bank, remittance, manual, stripe (NOU v1.12)
- Sense categoritzar
- Sense contacte
- **Devolucions pendents** (NOU v1.8)

### 3.2.5 Selecci√≥ M√∫ltiple i Accions en Bloc (NOU v1.13)

Permet seleccionar m√∫ltiples moviments i aplicar accions massives.

**Visibilitat:**
- Nom√©s disponible per rols `admin` i `user`
- Rol `viewer` no veu els checkboxes

**Elements UI:**
| Element | Descripci√≥ |
|---------|------------|
| Checkbox cap√ßalera | Selecciona/deselecciona tots els visibles |
| Checkbox fila | Selecciona moviment individual |
| Estat indeterminat | Quan hi ha selecci√≥ parcial |
| Barra d'accions | Apareix amb "N seleccionats" |

**Accions disponibles:**
| Acci√≥ | Descripci√≥ |
|-------|------------|
| **Assignar categoria...** | Obre di√†leg per seleccionar categoria |
| **Treure categoria** | Posa `category: null` a tots els seleccionats |

**Implementaci√≥ t√®cnica:**
- Estat: `Set<string>` per IDs seleccionats
- Batched writes: m√†xim 50 operacions per batch (l√≠mit Firestore)
- Tracking UX: `bulk.category.start/success/partial/error`

**Traduccions:** `movements.table.bulkSelection` (CA/ES/FR)

### 3.2.6 Banner de Devolucions Pendents (NOU v1.8)

Quan hi ha devolucions sense assignar, apareix un banner vermell:

> ‚ö†Ô∏è Hi ha devolucions pendents d'assignar [Revisar]

El bot√≥ "Revisar" filtra la taula per mostrar nom√©s devolucions pendents.

### 3.2.7 Reorganitzaci√≥ UX de la P√†gina de Moviments (NOU v1.14)

Nova estructura visual en 3 franges horitzontals:

| Franja | Contingut |
|--------|-----------|
| **Header** | T√≠tol + Bot√≥ "Nou moviment" + Bot√≥ "Filtres" (Sheet) + Men√∫ opcions taula |
| **Barra filtres actius** | Pills de filtres aplicats + bot√≥ "Neteja filtres" |
| **Taula** | Taula de moviments amb tot l'espai vertical disponible |

**Nous components:**

| Component | Fitxer | Descripci√≥ |
|-----------|--------|------------|
| `FiltersSheet` | `src/components/transactions/components/FiltersSheet.tsx` | Sheet lateral amb tots els filtres consolidats (tipus, origen, compte) |
| `TransactionsFilters` | `src/components/transactions/components/TransactionsFilters.tsx` | Barra de filtres actius amb pills |

**Opcions de visualitzaci√≥ (hardcoded a `transactions-table.tsx`):**
- `hideRemittanceItems = true` ‚Äî Els √≠tems de remesa no es mostren a la taula principal (ledger mode)
- `showProjectColumn = false` ‚Äî La columna de projecte est√† sempre oculta

**Comportament:**
- El bot√≥ "Filtres" obre un Sheet lateral des de la dreta
- Els filtres aplicats apareixen com a "pills" sota el header

### 3.2.8 Drag & Drop de Documents (ACTUALITZAT v1.42)

Permet adjuntar documents arrossegant fitxers directament sobre una fila de moviment, o clicant la icona de document.

**Funcionament:**
- Arrossegar un fitxer sobre qualsevol fila activa el mode "drop"
- La fila mostra un overlay amb "Deixa anar per adjuntar"
- En deixar anar (o clicar la icona), es mostra un **AlertDialog amb suggeriment de renom** (v1.42)
- L'usuari pot acceptar el nom suggerit o mantenir l'original
- El fitxer es puja a Storage i s'assigna al moviment

**Renom suggerit en adjuntar (NOU v1.42):**

Format: `YYYY.MM.DD_contacte.ext` (ex: `2026.02.10_Vodafone.pdf`)

Prioritat per construir el nom:
1. Nom del contacte del moviment
2. Nota del moviment
3. Descripci√≥ del moviment
4. Fallback: "moviment"

**Tipus acceptats:**
- PDF, imatges (JPG, PNG, GIF, WEBP), XML
- M√†xim 15MB per fitxer

**Components:**

| Component | Fitxer | Descripci√≥ |
|-----------|--------|------------|
| `RowDropTarget` | `src/components/files/row-drop-target.tsx` | Wrapper que afegeix drag & drop a files de taula |
| `attachDocumentToTransaction` | `src/lib/files/attach-document.ts` | Helper per pujar fitxer a Storage i actualitzar Firestore |
| `transactions-table.tsx` | `src/components/transactions-table.tsx` | AlertDialog de renom (v1.42) |

**Traduccions:** `movements.table.dropToAttach`, `movements.table.renameBeforeAttach.*` (CA/ES/FR)

### 3.2.8.1 Documents Pendents - Drag & Drop (NOU v1.28)

La p√†gina de Documents Pendents (`/movimientos/pendents`) accepta drag & drop com a punt d'entrada equivalent al bot√≥ "Pujar".

**Funcionament:**
- Arrossegar fitxers sobre la p√†gina activa overlay visual "Deixa anar per pujar"
- En deixar anar, s'obre el modal d'upload amb els fitxers precarregats
- Formats admesos: PDF, XML, JPG, JPEG, PNG
- Validaci√≥ al drop handler: si cap fitxer √©s v√†lid ‚Üí toast d'error (no s'obre modal buit)

**Components:**
- `handlePageDrop` a `src/app/[orgSlug]/dashboard/movimientos/pendents/page.tsx`
- `PendingDocumentsUploadModal` amb prop `initialFiles`

**Traduccions:** `pendingDocs.upload.dropHere`, `invalidFiles`, `invalidFilesDesc` (CA/ES/FR/PT)

### 3.2.8.2 Documents Pendents ‚Äî Robustesa i Relink (NOU v1.33)

Millores de robustesa al m√≤dul de documents pendents:

| Millora | Descripci√≥ |
|---------|------------|
| **Acci√≥ "Re-vincular"** | Permet re-vincular un document que havia perdut l'storage path a la seva transacci√≥ original |
| **Upload diagnostic guard** | Diagn√≤stic contextual d'errors de pujada amb informaci√≥ de depuraci√≥ |
| **Gesti√≥ idempotent** | Si un document ja no existeix a Firestore, l'operaci√≥ d'eliminaci√≥ no falla |
| **Transaccions orfenes** | `deleteMatchedPendingDocument` gestiona correctament transaccions que ja no tenen document associat |
| **Bloqueig eliminaci√≥** | No es pot eliminar un document si prov√© de la safata de pendents; es permet desfer la conciliaci√≥ |
| **Hard reset drag/upload** | L'estat de drag & drop es reinicia completament entre operacions (force remount) |
| **Comptadors per tab** | Cada tab mostra el nombre de documents que cont√© |
| **Etiquetes de categoria i18n** | Les categories es mostren amb traduccions en lloc de claus internes |
| **Auto-unmatch en eliminar transacci√≥** | Eliminar un moviment conciliat desf√† autom√†ticament la conciliaci√≥ del document pendent vinculat (torna a Confirmat). Si aix√≤ falla, no s'elimina el moviment. |

**Fitxers principals:**
- `src/app/[orgSlug]/dashboard/movimientos/pendents/page.tsx`
- `src/components/pending-documents/pending-document-card.tsx`
- `src/components/pending-documents/pending-document-row.tsx`
- `src/components/pending-documents/reconciliation-modal.tsx`

### 3.2.8.3 Documents Pendents ‚Äî Renom suggerit post-extracci√≥ (NOU v1.42)

Quan un document pendent t√© data de factura i prove√Ødor extrets per IA, el sistema suggereix renombrar el fitxer amb un format estandarditzat.

**Format suggerit:** `YYYY.MM.DD_prove√Ødor.ext` (ex: `2026.01.15_Vodafone.pdf`)

**Funcionament:**
- El suggeriment apareix dins la targeta expandida del document (bot√≥ "Renombrar")
- Es basa en `extractedData.invoiceDate` i `extractedData.supplierName`
- Si falta la data o el prove√Ødor, no es mostra suggeriment
- El nom del prove√Ødor es normalitza: lowercase, sense accents, espais ‚Üí gui√≥ baix

**Abast del renom:**
- **Cosm√®tic:** Actualitza `file.filename` a Firestore via `updateDoc`
- **NO modifica** el fitxer original a Firebase Storage (l'URL es mant√©)
- El nom nou es reflecteix a la UI i als exports, per√≤ l'objecte a Storage conserva el nom original

**Fitxers:**
- `src/components/pending-documents/pending-document-card.tsx` ‚Äî UI del suggeriment
- `src/lib/pending-documents/api.ts` ‚Äî `renamePendingDocumentFile()` helper

**Traduccions:** `pendingDocs.rename.*` (CA/ES/FR)

### 3.2.9 Indicadors Visuals de Remeses Processades (NOU v1.14)

Les remeses de donacions processades es mostren amb un estil visual distintiu per evitar confusi√≥.

**Objectiu:** L'usuari ha de poder identificar en 1 segon que una remesa ja est√† processada i no requereix acci√≥.

**Canvis visuals:**

| Element | Abans | Ara |
|---------|-------|-----|
| **Badge concepte** | `üëÅ 303/303 quotes` (gris) | `‚úì Remesa processada ¬∑ 303/303 quotes` (verd esmeralda) |
| **Fons fila** | Cap | `bg-emerald-50/30` (verd molt suau) |
| **Columna Contacte** | Bot√≥ "Assignar" | Gui√≥ "‚Äî" (no aplica) |

**Detalls t√®cnics:**
- Detecci√≥: `tx.isRemittance && tx.remittanceType !== 'returns'`
- Icona: `CheckCircle2` (lucide-react)
- Colors: `border-emerald-300 text-emerald-700 bg-emerald-50`

**Traduccions:** `movements.table.remittanceProcessedLabel`, `remittanceNotApplicable` (CA/ES/FR)


## 3.3 DIVISOR DE REMESES (INGRESSOS)

### 3.3.1 Qu√® √©s una Remesa?
Agrupaci√≥ de m√∫ltiples quotes de socis en un √∫nic ingr√©s bancari.

### 3.3.2 Formats suportats
- **CSV** amb detecci√≥ de separador
- **XLSX / XLS** (Excel)
- Detecci√≥ autom√†tica de fila inicial de dades

### 3.3.3 Proc√©s de Divisi√≥

1. **Seleccionar remesa** ‚Üí Men√∫ ‚ãÆ ‚Üí "Dividir remesa"
2. **Pujar detall** ‚Üí Fitxer CSV o Excel del banc
3. **Mapejat columnes**:
   - üü¢ Import
   - üîµ Nom
   - üü£ DNI/CIF
   - üî∑ IBAN
4. **Matching de socis** (prioritat):
   - Per DNI/CIF (m√†xima)
   - Per IBAN (alta)
   - Per Nom (mitjana)
5. **Detecci√≥ de socis de baixa**:
   - Av√≠s visual si es detecten socis marcats com "baixa"
   - Opci√≥ de reactivar individualment o tots alhora
6. **Processar**

### 3.3.4 Vista Agrupada de Remeses

- La remesa processada queda com **1 sola l√≠nia** al llistat de moviments
- Badge amb comptador de quotes: "üëÅ 303"
- **Filtre**: "Ocultar desglose de remesas" (activat per defecte)
- **Modal de detall**: Clicar el badge obre una modal amb:
  - Llista de totes les quotes individuals
  - Cerca per nom o DNI
  - Link directe al donant (clicar nom)
  - Resum del donant (hover)

### 3.3.5 Model de Dades de Remeses (Ingressos)

**Transacci√≥ pare (remesa):**
```
isRemittance: true
remittanceItemCount: 303
remittanceId: string          // Refer√®ncia al doc remittances/{id}
remittanceStatus: 'complete' | 'partial' | 'pending'
```

**Transaccions filles (quotes):**
```
source: 'remittance'
parentTransactionId: '{id_remesa}'
contactId: string             // ID del donant
contactType: 'donor'
archivedAt: null | string     // null = activa, ISO timestamp = arxivada
```

**Document remesa (`/organizations/{orgId}/remittances/{remittanceId}`):**
```
direction: 'IN'
parentTransactionId: string
transactionIds: string[]      // Llista de filles actives
inputHash: string             // SHA-256 del input per idempot√®ncia
totalAmount: number           // C√®ntims
status: 'active' | 'undone'
createdAt: string
updatedAt: string
```

### 3.3.5b Flux de Vida d'una Remesa IN (NOU v1.31)

El flux correcte per gestionar remeses IN √©s:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PROCESSAR  ‚îÇ ‚îÄ‚îÄ‚ñ∫ ‚îÇ   DESFER    ‚îÇ ‚îÄ‚îÄ‚ñ∫ ‚îÇ REPROCESSAR ‚îÇ
‚îÇ  /process   ‚îÇ     ‚îÇ   /undo     ‚îÇ     ‚îÇ  /process   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                   ‚îÇ                   ‚îÇ
       ‚ñº                   ‚ñº                   ‚ñº
  Crea filles        Arxiva filles       Crea filles
  + doc remesa       (archivedAt)        noves
```

**Regles fonamentals:**
- Mai processar dues vegades sense desfer
- Desfer sempre arxiva (soft-delete), mai esborra
- Reprocessar parteix de zero (filles noves)
- Les filles arxivades no compten per Model 182 ni certificats

### 3.3.5c Guardrails del Sistema (NOU v1.31)

**Client (UI):**
- Bloqueja si `isRemittance === true`
- Missatge: "Aquesta remesa ja est√† processada. Desf√©s-la abans de tornar-la a processar."
- Mostra banner d'inconsist√®ncia si `/check` detecta problemes

**Servidor (`/api/remittances/in/process`):**
- Rebutja amb `409 REMITTANCE_ALREADY_PROCESSED` si `isRemittance === true`
- Valida invariants: suma filles = import pare (¬±2 c√®ntims)
- Hash SHA-256 del input per detectar reintents t√®cnics vs reprocessaments

**Servidor (`/api/remittances/in/undo`):**
1. Arxiva filles per `transactionIds[]` del doc remesa
2. Fallback: arxiva per `parentTransactionId` (dades legacy)
3. Post-check: exigeix 0 filles actives al final
4. Marca doc remesa com `status: 'undone'`

**Servidor (`/api/remittances/in/check`):**
- Verifica consist√®ncia: filles actives = `transactionIds[]`
- Nom√©s per remeses IN (import positiu)
- Retorna issues detectades (COUNT_MISMATCH, SUM_MISMATCH, etc.)

### 3.3.5d Desfer una Remesa (Pas a Pas)

1. Ves a **Moviments** ‚Üí Localitza la remesa processada (badge verd)
2. Clica el badge ‚Üí S'obre el modal de detall
3. Clica **"Desfer remesa"** (a la part inferior del modal)
4. Confirma l'acci√≥
5. Les quotes individuals s'arxiven (archivedAt = timestamp)
6. El pare torna a l'estat original (isRemittance = false)
7. Ja pots tornar a processar amb un fitxer diferent si cal

**Quan desfer una remesa:**
- Has carregat el fitxer equivocat (d'un altre mes)
- Hi ha errors en el matching de donants
- Vols tornar a processar amb dades corregides

**Important:** Desfer NO esborra res. Les filles queden arxivades per tra√ßabilitat.

### 3.3.6 Guardar Configuraci√≥
Es pot guardar el mapejat per banc (Triodos, La Caixa, Santander, etc.)

### 3.3.7 Modal de Revisi√≥ Redissenyat (NOU v1.14)

El modal de revisi√≥ de remeses ("Revisi√≥ de la Remesa") s'ha redissenyat per millorar la usabilitat amb taules denses.

**Problemes resolts:**
- Modal massa estret per a taules amb moltes columnes
- Scroll conf√∫s (modal vs taula)
- Targetes de resum ocupaven massa espai

**Nou disseny:**

| Caracter√≠stica | Valor |
|----------------|-------|
| **Amplada** | 95% del viewport, m√†xim 1400px |
| **Al√ßada** | 90% del viewport |
| **Layout** | Flexbox vertical amb 3 zones fixes |

**Zones del modal:**

| Zona | Contingut | Comportament |
|------|-----------|--------------|
| **Header fix** | T√≠tol + Badges de resum compactes + Opcions de creaci√≥ de donants | No fa scroll |
| **Taula central** | Taula amb tots els donants/quotes | Scroll independent amb header sticky |
| **Footer fix** | Resum d'accions + Botons (Enrere, Processar) | No fa scroll |

**Badges de resum compactes:**
Els 4 blocs de resum (Total, Trobats, Nous amb DNI, Nous sense DNI) ara s√≥n badges en l√≠nia:

```
[303 donacions] [‚úì 280 trobats] [+ 15 nous amb DNI] [‚ö† 8 sense DNI] | [1.234,56‚Ç¨ / 1.234,56‚Ç¨]
```

**Implementaci√≥:**
- Classes: `w-[95vw] max-w-[1400px] h-[90vh] flex flex-col`
- Taula: `flex-1 min-h-0 overflow-auto`
- Header taula: `sticky top-0 bg-background z-10`

### 3.3.8 Matching de Remeses: Criteris, Exclusions i Tra√ßabilitat (NOU v1.28)

#### Problema resolt

Abans de v1.28, el motor de matching de remeses tenia tres problemes:

1. **Donants fantasma**: Contactes arxivats o eliminats apareixien com a match i es recreaven
2. **Falsos positius num√®rics**: Refer√®ncies banc√†ries (ex: "123456") feien match per nom amb donants que tenien n√∫meros al nom
3. **Manca de tra√ßabilitat**: No era possible saber com s'havia fet el match (IBAN, DNI o Nom)

#### Pre-filtrat obligatori

Abans de fer qualsevol matching, el sistema filtra els candidats amb:

```
filterActiveContacts(contacts):
  - Exclou contactes amb archivedAt (arxivats)
  - Exclou contactes amb deletedAt (eliminats soft)
  - Exclou contactes amb status === 'inactive'
```

**Invariant:** Nom√©s contactes actius entren al motor de matching.

#### Ordre de matching (prioritat)

| Prioritat | Camp | Criteri | Fiabilitat |
|-----------|------|---------|------------|
| **1** | IBAN | Exacte, normalitzat (sense espais, maj√∫scules) | M√†xima |
| **2** | DNI/NIE/CIF | Validaci√≥ fiscal real (`isValidSpanishTaxId()`) | Alta |
| **3** | Nom | Tots els tokens del CSV existeixen al donant | Mitjana |

#### Bloqueig de noms num√®rics

El matching per nom es desactiva si:
- El nom del CSV √©s purament num√®ric (ex: "123456", "00123")
- El nom del donant √©s purament num√®ric

**Funci√≥:** `isNumericLikeName(str)` ‚Üí `true` si nom√©s cont√© d√≠gits despr√©s d'eliminar espais i guions.

**Exemple:**
| Valor CSV | Match per nom? |
|-----------|----------------|
| "MARIA GARCIA" | ‚úì S√≠ |
| "123456" | ‚úó No (bloquejat) |
| "GARCIA-123" | ‚úì S√≠ |

#### Tra√ßabilitat del match

Cada match inclou:

| Camp | Tipus | Descripci√≥ |
|------|-------|------------|
| `matchMethod` | `'iban' \| 'taxId' \| 'name' \| null` | Com s'ha trobat el match |
| `matchValueMasked` | `string` | Valor emmascarament per auditoria |

**Format del valor emmascarament:**

| M√®tode | Format | Exemple |
|--------|--------|---------|
| IBAN | √öltims 4 d√≠gits | `¬∑¬∑¬∑1234` |
| DNI | √öltims 3 car√†cters | `¬∑¬∑¬∑78Z` |
| Nom | Primers 2 tokens | `Maria Garcia` |

#### Visualitzaci√≥ a la UI

El badge de match mostra el m√®tode i el valor:

```
[‚úì Trobat] Maria Garc√≠a L√≥pez [IBAN ¬∑¬∑¬∑1234]
[‚úì Trobat] Juan P√©rez [DNI ¬∑¬∑¬∑45X]
[‚úì Trobat] Ana L√≥pez [Nom Ana L√≥pez]
```

Colors del badge:
- **Verd** (`text-green-600`): Match actiu
- **Ambre** (`text-amber-600`): Match inactiu (donant de baixa)

#### Comportament amb donants arxivats

- **Mai es fan servir per matching** (pre-filtrat obligatori)
- Si una remesa antiga apunta a un donant que posteriorment s'ha arxivat:
  - La filla mant√© el `contactId` (hist√≤ric)
  - Per√≤ el Model 182 ja no el compta (donant inactiu)
- Si es reprocessa una remesa:
  - El donant arxivat no apareix com a candidat
  - La fila queda com "pendent" o "nou"

#### Impacte funcional

| Problema | Soluci√≥ |
|----------|---------|
| Duplicats fantasma | Eliminats pel pre-filtrat |
| Recreaci√≥ incorrecta de donants | El donant arxivat no fa match |
| Auditoria impossible | Badge amb m√®tode + valor emmascarament |
| Neteges "comen√ßar de zero" | Compatible: arxivar tots no afecta futures remeses |

#### Fitxers clau

| Fitxer | Funci√≥ |
|--------|--------|
| `src/lib/contacts/filterActiveContacts.ts` | Helper centralitzat amb `filterActiveContacts()`, `isNumericLikeName()`, `maskMatchValue()` |
| `src/components/transactions-table.tsx` | Aplica `filterActiveContacts()` als donants del llistat |
| `src/components/remittance-splitter.tsx` | Aplica `filterActiveContacts()` abans de matching + UI de badges |

#### Invariants fixats

1. **Nom√©s contactes actius** entren al motor de matching
2. **Cap match per nom** si el valor no √©s sem√†ntic (num√®ric)
3. **Tot match √©s explicable** visualment amb m√®tode i valor
4. **El filtratge √©s centralitzat** (un sol helper per a tota l'app)


## 3.3.9 SEPA DOMICILIACIONS (pain.008) ‚Äî REMESES DE COBRAMENT (NOU v1.31)

### 3.3.9.1 Visi√≥ i l√≠mits (contracte)

Aquesta funcionalitat genera fitxers **SEPA Direct Debit** (*pain.008*) per **cobrar quotes de socis per domiciliaci√≥ banc√†ria**.

**√âs PRE-BANC**: crea el fitxer que es puja al banc.
**No √©s el "divisor de remeses"** (que √©s POST-BANC i serveix per desagregar un ingr√©s ja cobrat).

**Fora d'abast (no implementat):**
- Gestor complet de **mandats SEPA** (refer√®ncia mandat, data signatura, seq√º√®ncia FRST/RCUR/FNAL/OOFF)
- CORE vs B2B avan√ßat
- Gesti√≥ normativa de devolucions SEPA (R-transactions) a nivell de mandat

> Principi: Summa genera un pain.008 operatiu per ONGs petites, amb criteri conservador i sense convertir-se en un gestor bancari.

---

### 3.3.9.2 Requisits (bloquejants)

Per generar una remesa pain.008 cal:

**A) Compte bancari emissor (de l'entitat)**
- `bankAccounts/{bankAccountId}.iban` ‚Üí obligatori
- `bankAccounts/{bankAccountId}.creditorId` (**ICS / SEPA Creditor Identifier**) ‚Üí obligatori

**B) Socis (deutors)**
- Cada soci incl√≤s ha de tenir:
  - `iban` v√†lid
  - import de quota > 0
- La UI ha de mostrar quins socis s√≥n inv√†lids i excloure'ls del fitxer.

---

### 3.3.9.3 On es configura l'ICS (Creditor ID)

**Ruta UI:** Configuraci√≥ ‚Üí Comptes bancaris ‚Üí Editar compte

Camp: **"Creditor ID SEPA (ICS)"**
Persist√®ncia: `creditorId: string | null` (mai `undefined`).

---

### 3.3.9.4 Sortida: fitxer XML pain.008

El sistema genera un XML compatible amb el banc per a la c√†rrega de remeses de cobrament.

**Camps m√≠nims que han d'apar√®ixer:**
- Creditor (entitat): nom + IBAN + `creditorId` (ICS)
- Deutor (soci): nom + IBAN
- Import i moneda (EUR)
- Data de cobrament (usuari)

**Nom de fitxer recomanat:**
`sepa_pain008_{YYYY-MM-DD}_{bankAccountName}.xml`

---

### 3.3.9.5 UX / Errors

Si falta `creditorId` al compte seleccionat:
- Blocatge de generaci√≥ (no permet descarregar)
- Missatge: "La cuenta seleccionada no tiene identificador de acreedor SEPA configurado."

Si hi ha socis sense IBAN:
- Excloure'ls del fitxer
- Mostrar llista "inv√†lids" amb acci√≥ r√†pida: anar a la fitxa del soci

---

### 3.3.9.6 Difer√®ncia amb Remesa IN (POST-BANC)

| Flux | Moment | Objectiu | Fitxer |
|------|--------|----------|--------|
| SEPA Domiciliacions | Pre-banc | Generar cobrament | **pain.008** |
| Divisor de remesa IN | Post-banc | Desagregar ingr√©s cobrat | cap (es processa CSV/XLSX del banc) |

### 3.3.9.7 Wizard SEPA pain.008 (ACTUALITZAT v1.42)

**Acc√©s:** Donants ‚Üí Remeses de cobrament

**Passos del wizard:**

| Pas | Nom | Funci√≥ |
|-----|-----|--------|
| 1 | Configuraci√≥ | Seleccionar compte bancari, data cobrament, periodicitat |
| 2 | Selecci√≥ | Triar socis a incloure (pre-selecci√≥ autom√†tica, bulk, cerca, filtre) |
| 3 | Revisi√≥ | Validar i descarregar XML |

**Periodicitat de quota (NOU v1.32):**

Camp `periodicityQuota` al contacte:

| Valor | Descripci√≥ |
|-------|------------|
| `monthly` | Mensual |
| `quarterly` | Trimestral |
| `semiannual` | Semestral |
| `annual` | Anual |
| `manual` | Cobrament manual (no domiciliat) |
| `null` | No definit |

**Filtre per periodicitat:** El wizard permet filtrar socis per periodicitat per generar remeses segmentades.

**Pre-selecci√≥ autom√†tica per periodicitat (ACTUALITZAT v1.42):**

Quan l'usuari selecciona una periodicitat al Pas 1, el sistema pre-marca autom√†ticament els socis que "toca cobrar" al Pas 2, basant-se en:

1. **Camp `sepaPain008LastRunAt`:** Data de l'√∫ltim cobrament SEPA de cada donant (substitut de l'antic `lastSepaRunDate`)
2. **Periodicitat del soci:** Nom√©s es pre-seleccionen els socis que tenen la periodicitat corresponent al filtre

**L√≤gica d'intervals (v1.42):**

- **Mensual:** Comparaci√≥ a nivell de mes natural. Si `YYYY-MM(lastRunAt) == YYYY-MM(collectionDate)` ‚Üí ja cobrat, no toca. Altrament ‚Üí toca cobrar.
- **Trimestral / Semestral / Anual:** Interval des de l'√∫ltim cobrament. `nextDue = addMonths(lastRunAt, N)` on N = 3 / 6 / 12. Toca cobrar si `YYYY-MM(collectionDate) >= YYYY-MM(nextDue)`.
- **Comparaci√≥ any-mes:** El dia s'ignora en tots els casos. Un donant anual cobrat el 15-oct-2025 ven√ß qualsevol dia d'octubre de 2026 (no cal esperar al dia 15).
- **Clamping de dies:** `addMonths` fa clamping autom√†tic (31 gen + 3m = 30 abr).
- **Sense `lastRunAt`:** El donant es considera candidat (toca cobrar). Per a no-mensuals, es mostra un av√≠s recomanant informar la data.

**Exemples:**

| Periodicitat | √öltim cobrament | Data remesa | Resultat |
|--------------|-----------------|-------------|----------|
| Mensual | 2026-01-15 | 2026-02-01 | ‚úÖ Toca cobrar |
| Mensual | 2026-02-03 | 2026-02-28 | ‚ùå Ja cobrat (mateix mes) |
| Trimestral | 2026-01-15 | 2026-03-01 | ‚ùå No toca (nextDue = abr-2026) |
| Trimestral | 2026-01-15 | 2026-04-10 | ‚úÖ Toca cobrar (abr >= abr) |
| Anual | 2025-10-15 | 2026-10-01 | ‚úÖ Toca cobrar (oct >= oct) |
| Anual | 2025-10-15 | 2026-09-30 | ‚ùå No toca (set < oct) |

**Tests:** 25 tests unitaris a `tests/sepa-pain008/donor-collection-status.test.ts`

**L√≤gica:** `src/lib/sepa/pain008/donor-collection-status.ts` ‚Äî m√≤dul `isDueForCollection()` que calcula si un donant toca cobrar.

**Selecci√≥ for√ßada amb revisi√≥ (NOU v1.42):**

- Els donants marcats com **"No toca encara"** (badge gris) es poden seleccionar manualment
- En fer-ho, apareix un **AlertDialog de confirmaci√≥** amb el recompte de donants for√ßats
- Els donants for√ßats es marquen amb **`needsReview: true`** al XML generat
- Permet cobrar excepcions (nou soci, canvi de periodicitat) sense perdre la tra√ßabilitat

**UI del Pas 2 ‚Äî Selecci√≥ (ACTUALITZAT v1.42):**

| Columna | Contingut | Notes |
|---------|-----------|-------|
| Checkbox | Selecci√≥ individual | Donants bloquejats seleccionables amb confirmaci√≥ |
| Nom | Nom del soci | ‚Äî |
| IBAN | IBAN formatat | `whitespace-nowrap` |
| Quota | Import ‚Ç¨ | ‚Äî |
| Darrer cobrament | Data curta ("des25") | Abans "√öltim pain" |
| Periodicitat | Label (Mensual, Trimestral...) | Abans "Estat" amb badge complex |

**Mem√≤ria d'execuci√≥ (run memory):**

- Camp `sepaPain008LastRunAt` al contacte: data de l'√∫ltima execuci√≥ pain.008 que va incloure aquest donant
- Import/export Excel: columna "√öltim cobrament SEPA"
- Permet identificar quins socis ja s'han cobrat recentment
- √ötil per evitar duplicitats en remeses parcials

**Col¬∑lecci√≥ `sepaCollectionRuns`:**

Cada execuci√≥ del wizard crea un document amb:
- `status`: draft | exported | sent | processed
- `scheme`: CORE | B2B
- `bankAccountId`, `creditorId`, `creditorName`, `creditorIban`
- `collectionDate`, `totalAmount`, `itemCount`
- `items[]`: array amb detall de cada cobrament (amb `needsReview` si for√ßat)
- `selectionCriteria`: periodicitat i cerca aplicats

**Fitxers:**
- `src/components/sepa-collection/SepaCollectionWizard.tsx` ‚Äî Wizard principal
- `src/components/sepa-collection/StepConfig.tsx` ‚Äî Pas configuraci√≥
- `src/components/sepa-collection/StepSelection.tsx` ‚Äî Pas selecci√≥
- `src/components/sepa-collection/StepReview.tsx` ‚Äî Pas revisi√≥
- `src/lib/sepa/pain008/generate-pain008.ts` ‚Äî Generador XML
- `src/lib/sepa/pain008/donor-collection-status.ts` ‚Äî L√≤gica isDueForCollection
- `src/lib/sepa/pain008/sequence-type.ts` ‚Äî L√≤gica SeqTp (FRST/RCUR/OOFF/FNAL)
- `src/lib/sepa/pain008/iban-length.ts` ‚Äî Validaci√≥ longitud IBAN per pa√≠s

### 3.3.9.8 Dialecte Santander ‚Äî pain.008 (NOU v1.36)

Documentaci√≥ del comportament real del Santander al processar fitxers pain.008.
Coneixement acumulat per proves reals (febrer 2026).

#### A) Encoding i format

| Aspecte | Requeriment Santander |
|---------|----------------------|
| Namespace | `urn:iso:std:iso:20022:tech:xsd:pain.008.001.02` (NO `.08`) |
| Encoding XML | UTF-8 |
| `CreDtTm` | Format `YYYY-MM-DDTHH:MM:SS+HH:MM` (sense mil¬∑lisegons) |
| `BtchBookg` | `true` (obligatori, tot i que ISO no l'exigeix) |
| `xsi:schemaLocation` | Obligatori a l'element `<Document>` |

#### B) Camps obligatoris (encara que ISO no els exigeixi)

| Camp | Ubicaci√≥ | Valor |
|------|----------|-------|
| `OrgId/Othr/Id` | Dins `InitgPty` (GrpHdr) | `creditorId` de l'organitzaci√≥ |
| `BtchBookg` | Dins `PmtInf` | `true` |
| `CdtrSchmeId` | Dins `PmtInf` | `creditorId` amb `<Prtry>SEPA</Prtry>` |

#### C) Camps prohibits o ignorats pel Santander

| Camp | Ubicaci√≥ | Problema |
|------|----------|----------|
| `Dbtr/Id/PrvtId` | Dins `DrctDbtTxInf` | NIF del deutor dins XML ‚Äî Santander l'ignora i pot causar rebuig |
| `EndToEndId` amb valor generat | Dins `PmtId` | Usar `NOTPROVIDED` (Santander no retorna l'E2E als extractes) |

#### D) Regles SeqTp (Sequence Type)

| SeqTp | Quan usar |
|-------|-----------|
| `RCUR` | **Per defecte** per tots els mandats recurrents amb historial de cobrament |
| `FRST` | Nom√©s per mandats nous creats dins Summa **que mai s'han cobrat a cap sistema** |
| `OOFF` | Cobraments puntuals (`membershipType === 'one-time'`) |
| `FNAL` | √öltim cobrament d'un mandat (override manual) |

**Risc amb FRST en migracions:**
Si els donants ja es cobraven per domiciliaci√≥ amb un altre sistema i es migren a Summa sense historial (`sepaPain008LastRunAt = null`, `sepaMandate.lastCollectedAt = null`), la l√≤gica els marca com FRST. El Santander **rebutja** perqu√® ja coneix els mandats com a recurrents.

**Soluci√≥ permanent:** Informar `sepaMandate.lastCollectedAt` amb la data de l'√∫ltima remesa del sistema antic, o amb la data de migraci√≥.

**Soluci√≥ temporal (activa feb 2026):** `determineSequenceType()` retorna `'RCUR'` fix. Marcat com `// TEMP` i `// TODO` al codi.

#### E) L√≠mits d'identificadors SEPA (max 35 car√†cters)

| Camp | Restricci√≥ | Car√†cters permesos |
|------|------------|-------------------|
| `MsgId` | ‚â§ 35 chars | A-Z, a-z, 0-9, `-` |
| `PmtInfId` | ‚â§ 35 chars | A-Z, a-z, 0-9, `-` |
| `EndToEndId` | ‚â§ 35 chars | A-Z, a-z, 0-9, `-` |
| `MndtId` (UMR) | ‚â§ 35 chars | A-Z, a-z, 0-9, `-` |

El helper `ensureMax35()` a `generate-pain008.ts` neteja i retalla qualsevol identificador.

#### F) Errors reals trobats (taula de refer√®ncia)

| Error banc (Santander) | Causa real | Soluci√≥ Summa |
|------------------------|------------|---------------|
| "L√≠nea 21 - El valor 'PRE2026...0-1' excede la longitud m√°xima permitida: '35'" | `PmtInfId` = `messageId` (35 chars) + `-1` = 37 chars | Aplicar `ensureMax35()` al `PmtInfId` |
| Rebuig massiu de tots els rebuts sense error clar | `SeqTp = FRST` per donants migrats que Santander ja coneix com RCUR | For√ßar `RCUR` o informar `lastCollectedAt` |
| "Formato de fichero no v√°lido" | Namespace `pain.008.001.08` (versi√≥ incorrecta) | Usar namespace `pain.008.001.02` |
| "Formato de fecha incorrecto" | `CreDtTm` amb mil¬∑lisegons (`2026-02-04T13:15:29.046+01:00`) | Eliminar mil¬∑lisegons del timestamp |


## 3.4 GESTI√ì DE DEVOLUCIONS (NOU v1.8)

### 3.4.1 Visi√≥ general

Les devolucions banc√†ries (rebuts retornats) es gestionen sense modificar el moviment bancari original.

| M√®tode | Quan usar-lo |
|--------|--------------|
| **Assignaci√≥ manual** | Devolucions individuals, una a una |
| **Importador de fitxer** | Devolucions massives o agrupades |

**Principi fonamental:** El moviment bancari original MAI es modifica ni s'esborra.

### 3.4.2 Flux real de devolucions (individuals i remeses)

**Tipus de devolucions:**

| Tipus | Descripci√≥ | Exemple |
|-------|------------|---------|
| **Individual** | Un apunt bancari √∫nic (‚àíX ‚Ç¨) | ‚àí25,00‚Ç¨ "DEVOL. RECIBO" |
| **Remesa** | Un apunt pare amb m√∫ltiples quotes filles | ‚àí150,00‚Ç¨ amb 6 filles de 25‚Ç¨ |

**Regles fonamentals:**

1. **Una devoluci√≥ individual** √©s un apunt bancari √∫nic amb import negatiu
2. **Una devoluci√≥ en remesa** √©s un apunt pare amb m√∫ltiples quotes filles
3. **El pare mai t√© `contactId`** ‚Äî el donant sempre s'assigna a les filles
4. **La fitxa del donant i el Model 182** es calculen exclusivament a partir de les filles amb `contactId`

**Implicaci√≥ fiscal:** Si una remesa t√© 4 filles per√≤ nom√©s 2 tenen donant assignat, nom√©s aquelles 2 resten al c√†lcul del Model 182 dels seus respectius donants.

### 3.4.3 Assignaci√≥ manual

1. Ves a **Moviments** ‚Üí Banner "Devolucions pendents" ‚Üí **Revisar**
2. Per cada devoluci√≥: bot√≥ **"Assignar donant"**
3. Cerca per nom, DNI, IBAN o email
4. Confirma l'assignaci√≥

### 3.4.4 Importador de fitxer del banc

#### Ubicaci√≥
- Moviments ‚Üí Fila de devoluci√≥ ‚Üí Icona üìÑ (pujar fitxer)
- O des del filtre "Devolucions pendents"

#### Bancs suportats

| Banc | Format | Particularitat |
|------|--------|----------------|
| Santander | XLSX | Data global a cap√ßalera, agrupa per fitxer |
| Triodos | CSV/XLS | Data per l√≠nia, agrupa per dia |
| Altres | CSV/XLSX | Detecci√≥ autom√†tica columnes |

#### Flux d'importaci√≥ amb fitxer del banc (v1.12)

**Pas 1: Parseig i normalitzaci√≥**
```
1. PARSEJAR FITXER ‚Üí Extreure IBAN, Import, Data, Nom
2. NORMALITZAR ‚Üí Imports positius, dateConfidence (line/file/none)
```

**Pas 2: Matching determinista de transaccions**

El sistema fa matching determinista amb els moviments bancaris:

| Ordre | Criteri | Toler√†ncia |
|-------|---------|------------|
| 1 | Import | ¬±0,02‚Ç¨ |
| 2 | Data | ¬±5 dies |
| 3 | IBAN (si disponible) | Exacte |

**Regles de desempat (NOU v1.12):**
- Si hi ha 1 candidat clar ‚Üí s'assigna autom√†ticament
- Si hi ha m√∫ltiples candidats ‚Üí desempat autom√†tic per **data m√©s propera**
- Nom√©s es marca com ambigu si l'empat √©s real (mateixa data i import)

**Pas 3: Matching de donants**

| Prioritat | Criteri | Normalitzaci√≥ |
|-----------|---------|---------------|
| 1 | IBAN | Sense espais, maj√∫scules |
| 2 | DNI/NIF | Sense guions, maj√∫scules |
| 3 | Nom | Sense accents, min√∫scules, exacte |

**NO es fa matching aproximat ni fuzzy.**

**Pas 4: Processament**
```
1. DETECTAR AGRUPACIONS ‚Üí Suma = moviment bancari (¬±0.02‚Ç¨, ¬±5 dies)
2. CREAR FILLES ‚Üí Per cada devoluci√≥ identificada
3. ACTUALITZAR PARE ‚Üí isRemittance, remittanceStatus, etc.
4. ACTUALITZAR DONANTS ‚Üí returnCount, lastReturnDate
```

#### Persist√®ncia (punt cr√≠tic)

> **IMPORTANT:** El matching no √©s nom√©s visual.
> Quan una devoluci√≥ queda resolta, el sistema actualitza el document real de la transacci√≥:
> - `contactId` ‚Üí ID del donant
> - `contactType` ‚Üí 'donor'
> - `transactionType` ‚Üí 'return'
>
> Aquesta persist√®ncia √©s obligat√≤ria perqu√® la devoluci√≥ compti al Model 182.

#### Detecci√≥ autom√†tica de columnes

| Camp | Patrons detectats |
|------|-------------------|
| IBAN | cuenta de adeudo, cuenta destino, iban, account |
| Import | importe, cantidad, amount, monto |
| Data | fecha de liquidaci√≥n, fecha rechazo, date |
| DNI | referencia externa, dni, nif |
| Nom | nombre cliente, nombre, titular |
| Motiu | motivo devoluci√≥n, motivo, reason |

### 3.4.5 Devolucions agrupades (remeses)

Alguns bancs agrupen m√∫ltiples devolucions en un sol moviment:

```
Extracte bancari:  -55,00‚Ç¨ "DEVOLUCION RECIBOS"
Fitxer detall:     10‚Ç¨ + 20‚Ç¨ + 15‚Ç¨ + 10‚Ç¨ = 55‚Ç¨
```

#### Comportament

1. El moviment original (-55‚Ç¨) es marca com a "remesa pare"
2. Es creen transaccions filles per cada devoluci√≥ identificada
3. El pare mant√© `amount`, `date`, `description` intactes

#### Estats de remesa (v1.12)

| Estat | Significat | Implicaci√≥ fiscal |
|-------|------------|-------------------|
| `complete` | Totes les filles tenen donant | Totes resten al 182 |
| `partial` | Algunes filles sense donant | Nom√©s les resoltes resten |
| `pending` | Cap filla creada encara | No afecta el 182 |

> **Important:** Encara que una remesa sigui `partial`, les filles resoltes **s√≠ que compten** per:
> - La fitxa del donant (returnCount)
> - El Model 182 (resta de l'import net)

#### Model de dades (Remeses de devolucions)

**Transacci√≥ pare:**
```typescript
isRemittance: true
remittanceType: 'returns'
remittanceStatus: 'complete' | 'partial' | 'pending'
remittanceItemCount: number           // Total devolucions
remittanceResolvedCount: number       // Amb donant
remittancePendingCount: number        // Sense donant
remittancePendingTotalAmount: number  // Suma pendents ‚Ç¨
// contactId: null (MAI s'assigna al pare)
```

**Transaccions filles:**
```typescript
source: 'remittance'
parentTransactionId: string    // ID del pare
transactionType: 'return'
amount: number                 // Negatiu
contactId: string              // ID donant
contactType: 'donor'
contactName: string            // Nom (desnormalitzat)
```

### 3.4.6 Remeses parcials

Si algunes devolucions no es poden identificar:

| Element | Estat |
|---------|-------|
| Devolucions amb donant | ‚Üí Es creen com a filles |
| Devolucions sense donant | ‚Üí Queden pendents |
| Remesa | ‚Üí `remittanceStatus: 'partial'` |

**Visualitzaci√≥:** Badge taronja "2/4 quotes (2 pendents: 25‚Ç¨)"

**Per completar una remesa parcial:**
1. Buscar el donant a Summa Social i actualitzar el seu IBAN
2. O crear el donant nou si no existeix
3. Tornar a importar el fitxer del banc

### 3.4.7 Impacte fiscal

| Document | C√†lcul |
|----------|--------|
| Model 182 | Total = Œ£ donacions - Œ£ devolucions |
| Certificats | Import = Œ£ donacions - Œ£ devolucions |

**Important:**
- El pare (remesa) NO t√© `contactId` ‚Üí No es compta
- Les filles S√ç tenen `contactId` ‚Üí Es compten com devolucions
- Si total ‚â§ 0 ‚Üí Donant no apareix al Model 182

> **Regla clau (v1.12):** Les devolucions resten al Model 182 quan existeixen filles amb `contactId`, independentment de l'estat global de la remesa (`partial` o `complete`).

### 3.4.8 UI de devolucions

#### Banner (Moviments)
- Un sol banner vermell: "Hi ha devolucions pendents d'assignar"
- CTA "Revisar" ‚Üí Filtra per devolucions pendents

#### Accions per fila

| Bot√≥ | Acci√≥ |
|------|-------|
| "Assignar donant" (vermell) | Di√†leg assignaci√≥ manual |
| üìÑ (icona) | Obre importador fitxer |

#### Criteri del bot√≥ "Assignar donant" (v1.12)

El bot√≥ "Assignar donant" **nom√©s es mostra** si:
1. La transacci√≥ √©s una devoluci√≥ individual (`transactionType === 'return'`)
2. I `contactId` √©s `null`

**Mai es mostra al pare d'una remesa de devolucions** (quan `isRemittance === true` i `remittanceType === 'returns'`).

#### Badge remesa

| Estat | Visualitzaci√≥ |
|-------|---------------|
| Completa | "4 quotes" |
| Parcial | Badge taronja "2/4 quotes (2 pendents: 25‚Ç¨)" |

#### Modal importador - Resultats del matching

| Badge | Significat |
|-------|------------|
| üü¢ **Individual** | Donant i transacci√≥ trobats |
| üîµ **Agrupada** | Part d'una remesa |
| üü† **Pendent** | Donant no identificat |

### 3.4.9 Mode SuperAdmin: recreaci√≥ de devolucions (NOU v1.12)

Eina **excepcional** per a migracions o correcci√≥ de dades hist√≤riques.

| Element | Descripci√≥ |
|---------|------------|
| Acc√©s | Nom√©s SuperAdmin |
| Ubicaci√≥ | Importador de devolucions ‚Üí checkbox "For√ßar recreaci√≥" |
| Acci√≥ | Elimina **totes** les filles d'un apunt pare i les recrea des del fitxer importat |

**Quan usar-la:**
- Migracions de dades hist√≤riques
- Correcci√≥ massiva d'errors de matching
- Sincronitzaci√≥ despr√©s de canvis a la base de donants

**Flux:**
1. SuperAdmin activa "For√ßar recreaci√≥ de devolucions"
2. Sistema demana confirmaci√≥ expl√≠cita
3. S'eliminen les filles existents del pare
4. Es recreen des del fitxer importat amb el matching actual
5. Es recalcula `remittanceStatus` del pare

> **Atenci√≥:** Aquesta opci√≥ **no √©s el flux normal d'usuari**. Nom√©s s'ha d'usar per corregir inconsist√®ncies o migrar dades.

### 3.4.10 L√≠mits del sistema

| Perm√®s | NO perm√®s |
|--------|-----------|
| Matching IBAN/DNI/Nom exacte | Fuzzy matching noms |
| Assignaci√≥ amb confirmaci√≥ | Assignaci√≥ autom√†tica |
| Remeses parcials | For√ßar remesa completa |
| Crear donant nou | Inventar dades |

### 3.4.11 Guardrail per Remeses de Devolucions (OUT) (NOU v1.31)

Les remeses de devolucions (OUT) tenen **impacte fiscal directe** perqu√® redueixen el total de donacions declarades al Model 182.

**Flux perm√®s:**

| Acci√≥ | Perm√®s |
|-------|--------|
| Processar | ‚úÖ |
| Tornar a processar sense desfer | ‚ùå Bloquejat |
| Desfer | ‚úÖ |
| Desfer + tornar a processar | ‚úÖ |

**Comportament del servidor:**
- `POST /api/remittances/in/process` amb import negatiu (OUT) ‚Üí `409 REMITTANCE_ALREADY_PROCESSED` si ja est√† processada
- No hi ha endpoint de `sanitize` ni `check` per OUT
- Qualsevol correcci√≥ passa per: **Desfer ‚Üí Processar**

**Per qu√® aquesta restricci√≥?**
- Les remeses OUT creen devolucions que resten del total fiscal del donant
- Reprocessar sense desfer podria duplicar devolucions (impacte fiscal)
- El flux controlat (desfer primer) garanteix integritat de dades

**Exemple pr√†ctic:**
1. Has processat una remesa de devolucions per√≤ has assignat un donant malament
2. Clica el badge de la remesa ‚Üí Modal de detall
3. Clica "Desfer remesa"
4. Les filles s'arxiven (soft-delete)
5. Torna a processar el fitxer amb l'assignaci√≥ correcta

> **Nota:** El banner d'inconsist√®ncia (que apareix per remeses IN) NO es mostra per OUT. Aix√≤ √©s intencionat perqu√® OUT no t√© invariants de consist√®ncia equivalents.

### 3.4.12 Checklist de Gesti√≥ de Devolucions

**Flux mensual recomanat:**

1. ‚òê Importa l'extracte del banc amb les devolucions
2. ‚òê Revisa el banner "Devolucions pendents" a Moviments
3. ‚òê Descarrega el fitxer de detall de devolucions del banc
4. ‚òê Importa el fitxer per fer matching autom√†tic
5. ‚òê Revisa les devolucions no identificades
6. ‚òê Actualitza IBAN dels donants si cal
7. ‚òê Processa el fitxer
8. ‚òê Verifica que les devolucions apareixen a la fitxa dels donants afectats

**Abans del gener (Model 182):**

1. ‚òê Assegura't que totes les devolucions de l'any estan assignades
2. ‚òê Verifica que no hi ha devolucions pendents
3. ‚òê Comprova que el total de cada donant √©s correcte (donacions - devolucions)
4. ‚òê Si un donant t√© total ‚â§ 0, confirma que no apareix al Model 182


## 3.5 REMESES OUT / PAGAMENTS (NOU v1.17)

### 3.5.1 Visi√≥ general

Les **remeses de pagaments** (OUT) permeten dividir una remesa de sortida (despesa) en m√∫ltiples transfer√®ncies a prove√Ødors o empleats, amb generaci√≥ de fitxer SEPA pain.001.

**Principi fonamental:** El moviment bancari original (pare) √©s **immutable**. El detall s√≥n transaccions filles amb `parentTransactionId`.

| Tipus | Direcci√≥ | Import pare | Exemple |
|-------|----------|-------------|---------|
| Remesa IN (quotes) | Ingr√©s (+) | Positiu | +5.430‚Ç¨ "REMESA RECIBOS" |
| Remesa OUT (pagaments) | Despesa (‚àí) | Negatiu | ‚àí3.200‚Ç¨ "REMESA PAGAMENTS" |

### 3.5.2 Flux de treball

1. **Identificar moviment** ‚Üí Despesa negativa agregada (ex: "REMESA N√íMINES TRIODOS")
2. **Men√∫ ‚ãÆ** ‚Üí "Dividir remesa"
3. **Pujar fitxer** ‚Üí CSV/Excel amb detall de pagaments
4. **Mapejat columnes**:
   - üü¢ Import (obligatori)
   - üîµ Nom beneficiari
   - üî∑ IBAN beneficiari
5. **Matching** ‚Üí Cerca prove√Ødors/treballadors per IBAN o nom
6. **Validaci√≥** ‚Üí Suma fills = |import pare| (toler√†ncia ¬±0,02‚Ç¨)
7. **Processar** ‚Üí Crea filles i (opcionalment) exporta SEPA

### 3.5.3 Model de dades

**Transacci√≥ pare (remesa de pagaments):**
```
isRemittance: true
remittanceId: '{uuid}'
remittanceItemCount: 15
```

**Transaccions filles (pagaments individuals):**
```
source: 'remittance'
parentTransactionId: '{id_remesa}'
isRemittanceItem: true
remittanceId: '{uuid}'
amount: -250.00          // negatiu (despesa)
contactId: '{proveidor}'
contactType: 'supplier' | 'employee'
```

**Document remesa (`/organizations/{orgId}/remittances/{remittanceId}`):**
```typescript
{
  id: string;
  orgId: string;
  parentTransactionId: string;
  direction: 'OUT';
  status: 'complete' | 'partial';

  totalAmount: number;        // Import total absolut (positiu)
  itemCount: number;          // Nombre de pagaments

  validation: {
    deltaCents: number;       // Difer√®ncia en c√®ntims (ideal: 0)
    isValid: boolean;         // |deltaCents| <= 2
    checkedAt: Timestamp;
  };

  createdAt: Timestamp;
  createdBy: string;
}
```

### 3.5.4 Invariant de suma

La suma absoluta de les filles ha de coincidir amb el valor absolut del pare.

```
|pare.amount| = Œ£ |fill.amount|     (toler√†ncia ¬±0,02‚Ç¨)
```

**Exemple:**
- Pare: ‚àí3.200,00‚Ç¨
- Fills: ‚àí1.200‚Ç¨ + ‚àí800‚Ç¨ + ‚àí600‚Ç¨ + ‚àí600‚Ç¨ = ‚àí3.200‚Ç¨
- Validaci√≥: |‚àí3.200| = |‚àí3.200| ‚úì

**Guardrails:**
- Si `|delta| > 2 c√®ntims` ‚Üí Banner d'av√≠s a la UI
- Si `delta !== 0` ‚Üí Bot√≥ "Processar" desactivat
- Camp `validation.deltaCents` guardat a Firestore per diagn√≤stic

### 3.5.5 Exportaci√≥ SEPA pain.001

El sistema pot generar un fitxer SEPA pain.001.001.03 per enviar al banc.

**Requisits per exportar:**
- Tots els pagaments han de tenir IBAN v√†lid
- Tots els imports han de ser positius (>0)
- La suma ha de quadrar amb el pare

**Camps del fitxer SEPA:**

| Element | Origen |
|---------|--------|
| `MsgId` | Auto-generat (`SEPA{timestamp}{random}`) |
| `CreDtTm` | Data actual ISO |
| `NbOfTxs` | Nombre de pagaments |
| `CtrlSum` | Suma total |
| `Dbtr/Nm` | Nom organitzaci√≥ |
| `DbtrAcct/IBAN` | IBAN organitzaci√≥ |
| `ReqdExctnDt` | Data d'execuci√≥ (usuari) |
| `CdtTrfTxInf/*` | Detall per cada pagament |

**Fitxers relacionats:**
- `src/lib/sepa/generate-pain001.ts` ‚Äî Generador XML
- `src/lib/sepa/parse-pain001.ts` ‚Äî Parser (per importar)
- `src/lib/sepa/index.ts` ‚Äî Exports p√∫blics

### 3.5.6 Desfer remesa OUT

Acci√≥ disponible al men√∫ ‚ãÆ del moviment pare si `isRemittance === true`.

**Flux "Desfer remesa":**
1. Elimina totes les transaccions filles
2. Elimina el document `/remittances/{remittanceId}`
3. Neteja camps del pare (`isRemittance`, `remittanceId`, `remittanceItemCount`)
4. Restaura pare a estat original

**Implementaci√≥:** Operaci√≥ at√≤mica amb `writeBatch()` i `deleteField()`.

**Acc√©s:** Qualsevol rol amb permisos d'edici√≥ (no requereix SuperAdmin).

### 3.5.7 UI i indicadors visuals

| Element | Comportament |
|---------|-------------|
| Badge pare | "‚úì Remesa ¬∑ 15 pagaments" (verd) |
| Fons fila | `bg-emerald-50/30` |
| Toggle filles | Clicar badge ‚Üí expandeix/col¬∑lapsa |
| Banner delta | Si `|delta| > 2¬¢` ‚Üí av√≠s taronja |
| Bot√≥ "Processar" | Desactivat si no quadra o falten IBANs |

### 3.5.8 Difer√®ncies amb Remeses IN

| Aspecte | Remeses IN (quotes) | Remeses OUT (pagaments) |
|---------|---------------------|-------------------------|
| Direcci√≥ | Ingr√©s (+) | Despesa (‚àí) |
| Contactes | Donants | Prove√Ødors/Treballadors |
| Matching | DNI/IBAN/Nom | IBAN/Nom |
| Export | No | SEPA pain.001 |
| Camps fills | `contactType: 'donor'` | `contactType: 'supplier'/'employee'` |

### 3.5.9 Observabilitat

**Logs de desenvolupament:**
```
[REMESA-OUT] Validaci√≥: delta=0¬¢, items=15, pare=-3200.00‚Ç¨
[REMESA-OUT] Processant: 15 pagaments, remittanceId={uuid}
[REMESA-OUT] SEPA generat: pain001_{date}_{timestamp}.xml
```

**Camps de diagn√≤stic a Firestore:**
- `remittances/{id}.validation.deltaCents`
- `remittances/{id}.validation.checkedAt`
- `remittances/{id}.createdBy`


## 3.6 GESTI√ì DE CONTACTES

### 3.6.1 Tipus de Contactes

| Tipus | Subtipus |
|-------|----------|
| **Donants** | Particular, Empresa |
| **Prove√Ødors** | Per categoria |
| **Treballadors** | - |

### 3.6.2 Donants - Camps

| Camp | Obligatori | Model 182 |
|------|------------|-----------|
| Nom | ‚úÖ | ‚úÖ |
| NIF/DNI | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Codi postal | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Ciutat | ‚ùå | ‚ùå |
| Prov√≠ncia | ‚ùå | ‚ùå |
| Adre√ßa | ‚ùå | ‚ùå |
| Tipus (Particular/Empresa) | ‚úÖ | ‚úÖ NATURALEZA |
| Modalitat (Puntual/Soci) | ‚úÖ | ‚ùå |
| Periodicitat (Mensual/Trimestral/Semestral/Anual) | ‚ùå | ‚ùå |
| Persona de contacte (nom√©s Empresa) | ‚ùå | ‚ùå |
| Estat (Actiu/Baixa) | ‚ùå | ‚ùå |
| Data de baixa | ‚ùå | ‚ùå |
| Quota | ‚ùå | ‚ùå |
| IBAN | ‚ùå | ‚ùå |
| Email | ‚ùå | ‚ùå |
| Tel√®fon | ‚ùå | ‚ùå |
| Categoria per defecte | ‚ùå | ‚ùå |
| **√öltim cobrament SEPA** (`sepaPain008LastRunAt`) | ‚ùå | ‚ùå |
| **Comptador devolucions** | ‚ùå | ‚ùå |
| **Data √∫ltima devoluci√≥** | ‚ùå | ‚ùå |

### 3.6.3 Gesti√≥ d'Estat Actiu/Baixa

- **Filtre per estat**: Per defecte es mostren nom√©s actius
- **Badge visual**: Els donants de baixa mostren badge "Baixa"
- **Reactivar**: Bot√≥ per tornar a donar d'alta un soci
- **Edici√≥**: Es pot canviar l'estat des del formulari d'edici√≥
- **Importador**: Detecta columna "Estado/Estat" autom√†ticament

### 3.6.3b Filtres al Dashboard de Donants (NOU v1.41)

El dashboard de donants disposa de filtres combinables amb l√≤gica AND:

| Filtre | Valors | Camp Firestore |
|--------|--------|----------------|
| **Estat** | Alta / Baixa | `status` |
| **Tipus** | Particular / Empresa | `donorType` |
| **Modalitat** | Soci / Puntual | `membershipType` |
| **Periodicitat** | Mensual / Trimestral / Semestral / Anual | `periodicityQuota` |
| **Cerca** | Text lliure | Nom, NIF (client-side) |
| **Incomplets** | S√≠ / No | Falten dades Model 182 |
| **Devolucions** | S√≠ / No | `returnCount > 0` |

**Comportament:**
- Cada opci√≥ mostra comptador de donants que hi coincideixen
- Tots els filtres es combinen amb AND
- UI: botons toggle sense bot√≥ "Tots" expl√≠cit (desseleccionar = sense filtre)
- i18n complet (ca, es, fr)

**Fitxer:** `src/components/donor-manager.tsx`

### 3.6.3c Persona de Contacte per Empreses (NOU v1.41)

Camp opcional `contactPersonName` visible nom√©s quan `donorType === 'company'`. Purament informatiu, no afecta c√†lculs fiscals ni remeses.

- UI: camp de text al formulari d'edici√≥ (condicional per tipus Empresa)
- Import/Export: columna "Persona de contacte" a la plantilla Excel
- Fitxer tipus: `src/lib/data.ts` (Donor interface)

### 3.6.3d Quota amb Sufix de Periodicitat (NOU v1.41)

La quota ara mostra el sufix de periodicitat al llistat i al detall:

| Periodicitat | Sufix |
|--------------|-------|
| Mensual | /mes |
| Trimestral | /trim |
| Semestral | /sem |
| Anual | /any |

**Helper:** `src/lib/donors/periodicity-suffix.ts` ‚Äî `getPeriodicitySuffix(periodicityQuota)`

La plantilla d'importaci√≥ ara usa el header "Quota" (abans "Quota mensual").

### 3.6.4 Importador de Donants (ACTUALITZAT v1.28)

**Plantilla oficial √∫nica:**
- Descarregable dins l'importador ("Descarregar plantilla")
- Detecci√≥ autom√†tica 100% sense mapeig manual
- Format: Export = Import (les mateixes columnes)

**Columnes de la plantilla oficial:**

| Columna | Camp | Obligatori |
|---------|------|------------|
| Nom | name | ‚úÖ |
| NIF | taxId | ‚ö†Ô∏è Per Model 182 |
| Tipus | donorType | ‚úÖ |
| Modalitat | membershipType | ‚úÖ |
| Estat | status | ‚ùå |
| Quota | monthlyAmount | ‚ùå |
| Periodicitat | periodicityQuota | ‚ùå |
| Persona de contacte | contactPersonName | ‚ùå |
| IBAN | iban | ‚ùå |
| Adre√ßa | address | ‚ùå |
| Codi postal | zipCode | ‚ö†Ô∏è Per Model 182 |
| Ciutat | city | ‚ùå |
| Prov√≠ncia | province | ‚ùå |
| Tel√®fon | phone | ‚ùå |
| Email | email | ‚ùå |
| Categoria | defaultCategoryId | ‚ùå |
| √öltim cobrament SEPA | sepaPain008LastRunAt | ‚ùå |

**Categoria per defecte:**
- Si l'Excel porta columna "Categoria", es fa matching amb categories existents
- Si no es troba la categoria: s'usa el fallback configurat (microcopy informatiu)
- Matching normalitzat (sense accents, case-insensitive)

**Funcionalitat "Actualitzar existents":**

- Checkbox opcional a la previsualitzaci√≥
- Si un DNI ja existeix i el checkbox est√† activat ‚Üí Actualitza en lloc d'ometre
- Camps actualitzables: status, zipCode, address, email, phone, iban, membershipType, donorType, periodicityQuota, contactPersonName
- NO actualitza: name, taxId, createdAt (per seguretat)

### 3.6.5 Prove√Ødors - Camps

| Camp | Obligatori | Model 347 |
|------|------------|-----------|
| Nom | ‚úÖ | ‚úÖ |
| NIF/CIF | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Categoria per defecte | ‚ùå | ‚ùå |
| Adre√ßa | ‚ùå | ‚ùå |
| IBAN | ‚ùå | ‚ùå |

### 3.6.5.1 Importador de Prove√Ødors (ACTUALITZAT v1.28)

**Plantilla oficial √∫nica:**
- Descarregable dins l'importador ("Descarregar plantilla")
- Detecci√≥ autom√†tica 100% sense mapeig manual
- Format: Export = Import (les mateixes columnes)

**Columnes de la plantilla oficial:**

| Columna | Camp | Obligatori |
|---------|------|------------|
| Nom | name | ‚úÖ |
| CIF | taxId | ‚ö†Ô∏è Per Model 347 |
| Adre√ßa | address | ‚ùå |
| Codi postal | zipCode | ‚ùå |
| Ciutat | city | ‚ùå |
| Prov√≠ncia | province | ‚ùå |
| Tel√®fon | phone | ‚ùå |
| Email | email | ‚ùå |
| IBAN | iban | ‚ùå |
| Categoria | defaultCategoryId | ‚ùå |

**Categoria per defecte (agn√≤stica v1.28):**
- Matching amb TOTES les categories (income + expense), no nom√©s expense
- Si una categoria existeix amb el mateix nom com income i expense ‚Üí warning "ambigua"
- L'usuari ha de revisar manualment les files amb warning
- Matching normalitzat (sense accents, case-insensitive)

**Deduplicaci√≥ (v1.28):**
- Ignora prove√Ødors amb `deletedAt` o `archivedAt` en la detecci√≥ de duplicats
- Un prove√Ødor eliminat i reimportat es crea com a nou

### 3.6.6 Exportaci√≥ de Donants a Excel (NOU v1.16)

Bot√≥ "Exportar" a la llista de donants per descarregar un fitxer Excel.

**Columnes exportades:**

| Columna | Font |
|---------|------|
| Nom | `donor.name` |
| NIF | `donor.taxId` |
| Quota | `donor.monthlyAmount` (formatat ‚Ç¨) + sufix periodicitat |
| Periodicitat | `donor.periodicityQuota` (Mensual/Trimestral/Semestral/Anual) |
| Persona de contacte | `donor.contactPersonName` (nom√©s PJ) |
| IBAN | `donor.iban` (formatat amb espais) |
| Estat | "Alta", "Baixa" o "Pendent devoluci√≥" |
| √öltim cobrament SEPA | `donor.sepaPain008LastRunAt` (data formatada) |

**Comportament:**
- Llista ordenada alfab√®ticament per nom
- Nom del fitxer: `donants_YYYY-MM-DD.xlsx`
- Amplada de columnes ajustada autom√†ticament

**Fitxer:** `src/lib/donors-export.ts`

### 3.6.7 DonorDetailDrawer

Panel lateral que s'obre clicant el nom d'un donant:
- Informaci√≥ completa del donant
- Historial de donacions (paginat)
- **Historial de devolucions** (NOU v1.8)
- Resum per any
- Generaci√≥ de certificats

### 3.6.8 Din√†mica de Donants (ACTUALITZAT v1.40)

Panell d'an√†lisi que mostra l'evoluci√≥ dels donants segons el per√≠ode seleccionat.

**Acc√©s:** Donants ‚Üí Bloc "Din√†mica de donants" (part inferior de la pantalla)

**Redisseny v1.40:** 5 blocs uniformes amb separaci√≥ Persones F√≠siques (PF) / Persones Jur√≠diques (PJ):

**Categories d'an√†lisi:**

| Categoria | Definici√≥ | Ordenaci√≥ |
|-----------|-----------|-----------|
| **Altes** | Primer moviment dins el per√≠ode (sense hist√≤ric anterior) | Per data primer moviment (desc) |
| **Baixes** | Donants que tenien hist√≤ric per√≤ zero moviments dins el per√≠ode actual | Per data √∫ltim moviment (desc) |
| **Aportaci√≥ a l'al√ßa** | Import al per√≠ode actual > import al per√≠ode anterior | Per delta positiu (desc) |
| **Aportaci√≥ a la baixa** | Import al per√≠ode actual < import al per√≠ode anterior | Per delta negatiu (asc) |
| **Top 15** | 15 donants amb major aportaci√≥ al per√≠ode, amb split PF / PJ | Per import total (desc) |

**Distincions PF / PJ (NOU v1.40):**
- **Persona F√≠sica (PF):** `contactType === 'individual'` o NIF comen√ßa per d√≠git / X / Y / Z
- **Persona Jur√≠dica (PJ):** `contactType === 'company'` o resta de patrons NIF
- Top 15 mostra dues llistes separades quan hi ha ambd√≥s tipus

**Transaccions elegibles:**
- T√© `contactId` (vinculat a donant)
- No arxivada (`archivedAt` buit)
- No √©s pare de remesa (`isRemittance=true` sense `isRemittanceItem`)

**Per√≠ode anterior:**
- Any ‚Üí any -1
- Trimestre ‚Üí trimestre anterior (Q1 ‚Üí Q4 any -1)
- Mes ‚Üí mes anterior (Gen ‚Üí Des any -1)
- Rang personalitzat ‚Üí mateixa durada abans del `from`
- "Tot el per√≠ode" ‚Üí No t√© anterior definit (algunes m√®triques no disponibles)

**API tolerant (nullable):**
- Si el rang no √©s computable, retorna `null` (UI mostra "no hi ha dades suficients")
- Cap throw, cap data inventada

**Fitxers:**
- `src/lib/donor-dynamics.ts` ‚Äî C√†lcul de din√†miques
- `src/components/donor-manager.tsx` ‚Äî UI del panell


## 3.7 PROJECTES / EIXOS D'ACTUACI√ì

| Camp | Obligatori |
|------|------------|
| Nom | ‚úÖ |
| Descripci√≥ | ‚ùå |
| Finan√ßador | ‚ùå |
| Actiu | ‚úÖ |

Estad√≠stiques per projecte:
- Total ingressos
- Total despeses
- Balan√ß


## 3.8 INFORMES FISCALS

### 3.8.1 Model 182 - Declaraci√≥ de Donacions

**Data l√≠mit:** 31 de gener

**Exportaci√≥ Excel per Gestoria:**

| Columna | Valor | Font |
|---------|-------|------|
| NIF | DNI/CIF | donor.taxId |
| NOMBRE | Nom complet | donor.name |
| CLAVE | "A" | Fix (dinerari Llei 49/2002) |
| PROVINCIA | Codi 2 d√≠gits | donor.zipCode.substring(0,2) |
| PORCENTAJE | *(buit)* | Gestoria ho calcula |
| VALOR | Import any actual | Suma donacions - devolucions |
| VALOR_1 | Import any -1 | Hist√≤ric |
| VALOR_2 | Import any -2 | Hist√≤ric |
| RECURRENTE | "X" o buit | Si VALOR_1 > 0 AND VALOR_2 > 0 |
| NATURALEZA | "F" o "J" | individual ‚Üí F, company ‚Üí J |

**Gesti√≥ de devolucions:**
- `transactionType === 'return'` ‚Üí Es resta autom√†ticament
- `donationStatus === 'returned'` ‚Üí Es resta autom√†ticament
- Les filles de remeses amb `contactId` ‚Üí Es compten
- Els pares de remeses sense `contactId` ‚Üí S'ignoren

**Fitxer generat:** `model182_{any}.xlsx`

#### Export addicional: plantilla gestoria (A‚ÄìG)

Format simplificat amb 7 columnes per enviar directament a la gestoria. **No substitueix l'export est√†ndard.**

| Columna | Nom | Descripci√≥ | Font |
|---------|-----|------------|------|
| A | NIF | DNI/CIF normalitzat (sense espais ni guions, maj√∫scules) | `normalizeTaxId(donor.taxId)` |
| B | COGNOMS_NOM | Maj√∫scules, sense accents, espais col¬∑lapsats | `removeAccents(donor.name).toUpperCase()` |
| C | PROVINCIA | 2 d√≠gits del CP (preserva zero inicial) | `donor.zipCode.substring(0,2)` |
| D | CLAVE | F0 (soci recurrent) / A0 (donatiu puntual) | `donor.membershipType` |
| E | PORCENTAJE | Sempre buit (la gestoria ho calcula) | ‚Äî |
| F | IMPORTE | Import anual en euros (num√®ric, 2 decimals) | Suma donacions - devolucions |
| G | RECURRENCIA | 1 si ha donat els 2 anys anteriors; 2 si no ha donat cap; buit si nom√©s 1 any | `valor1` i `valor2` |

**Fitxer generat:** `model182_gestoria_A-G_{any}.xlsx`

**Criteri de recurr√®ncia (columna G):**
- `1` ‚Üí valor1 > 0 AND valor2 > 0
- `2` ‚Üí valor1 === 0 AND valor2 === 0
- Buit ‚Üí nom√©s un dels dos anys t√© import > 0

#### Export AEAT (fitxer oficial) ‚Äî NOU v1.32

Format de longitud fixa per a "Presentaci√≥ mitjan√ßant fitxer" a la Seu Electr√≤nica de l'AEAT. **No substitueix els altres exports** ‚Äî √©s un tercer bot√≥ addicional.

**Caracter√≠stiques t√®cniques:**
- Registres de 250 car√†cters exactes per l√≠nia
- Separador de l√≠nia: CRLF (`\r\n`)
- Codificaci√≥: ISO-8859-1 (Latin-1)
- 1 registre Tipus 1 (declarant) + N registres Tipus 2 (declarats)

**Registre Tipus 1 (posicions principals):**
| Pos | Camp | Font |
|-----|------|------|
| 1-4 | Tipus + Model | `1182` |
| 5-8 | Exercici | Any seleccionat |
| 9-17 | NIF declarant | `org.taxId` |
| 18-57 | Denominaci√≥ | `org.name` |
| 59-67 | Tel√®fon | `org.phone` |
| 68-107 | Contacte | `org.signatoryName` (invertit) |
| 136-144 | Total registres | Comptador donants |
| 145-159 | Import total | Suma imports |
| 160 | Naturalesa declarant | `1` (Llei 49/2002) |

**Registre Tipus 2 (posicions principals):**
| Pos | Camp | Font |
|-----|------|------|
| 1-4 | Tipus + Model | `2182` |
| 18-26 | NIF declarat | `donor.taxId` |
| 36-75 | Cognoms i nom | `donor.name` (invertit) |
| 76-77 | Codi prov√≠ncia | `donor.zipCode.substring(0,2)` |
| 78 | Clau | `A` (Llei 49/2002) |
| 79-83 | % deducci√≥ | `08000` / `04000` / `04500` |
| 84-96 | Import | C√®ntims sense decimals visibles |
| 105 | Naturalesa | `F` (individual) / `J` (company) |
| 132 | Recurr√®ncia | `1` / `2` / ` ` |

**Validaci√≥ bloquejant (NO genera fitxer si falta):**
- `org.taxId` ‚Üí CIF de 9 car√†cters v√†lid
- `org.name` ‚Üí Denominaci√≥
- `org.signatoryName` ‚Üí Persona de contacte
- `donor.taxId` ‚Üí NIF de 9 car√†cters v√†lid per a TOTS els donants
- `donor.zipCode` ‚Üí M√≠nim 2 d√≠gits per a TOTS
- `donor.donorType` ‚Üí `individual` o `company` per a TOTS

**Fitxer generat:** `modelo182_{any}.txt`

**√ös:**
1. Generar informe per l'any desitjat
2. Clic "Export AEAT (fitxer oficial)"
3. Si hi ha errors de validaci√≥ ‚Üí toast amb llista d'errors
4. Si tot OK ‚Üí desc√†rrega autom√†tica del fitxer `.txt`
5. Pujar a Seu Electr√≤nica AEAT ‚Üí "Presentaci√≥ mitjan√ßant fitxer"

#### Criteris fiscals aplicats per Summa

**1) Qu√® declara Summa al Model 182**

Nom√©s donacions fiscalment v√†lides:
- Volunt√†ries i sense contraprestaci√≥
- Amb `contactId` assignat
- No arxivades (`archivedAt` absent)
- Netes de devolucions (transactionType: 'return' o donationStatus: 'returned')

**2) C√†lcul de recurr√®ncia (criteri AEAT)**

- **Recurrent** = ha donat a N-1 i N-2 (anys anteriors a l'exercici)
- No importa import ni periodicitat, nom√©s que hi hagi donatiu registrat

Aplicaci√≥ fiscal del percentatge de deducci√≥:

| Tipus | Primers 250‚Ç¨ | Resta (no recurrent) | Resta (recurrent) |
|-------|--------------|----------------------|-------------------|
| Persona F√≠sica (IRPF) | 80% | 40% | 45% |
| Persona Jur√≠dica (IS) | 40% | 40% | 50% |

**3) Validacions pr√®vies a l'export AEAT**

*Errors bloquejants (NO es pot generar fitxer):*
- CIF/NIF de l'organitzaci√≥ inv√†lid o absent
- Denominaci√≥ social absent
- Persona signant absent (Configuraci√≥ > Signant)

*Errors de donants (EXCLUSIONS, no bloquegen):*
- NIF/CIF buit
- NIF/CIF amb car√†cters inv√†lids
- NIF/CIF amb longitud incorrecta (ha de ser exactament 9)
- Codi postal incomplet (m√≠nim 2 d√≠gits)
- Tipus de donant no informat (F/J)

**4) Export parcial amb exclosos**

Si hi ha donants amb errors:
- NO bloqueja l'export
- Es mostra una modal de confirmaci√≥ amb els exclosos
- L'usuari pot:
  - **Descarregar CSV d'exclosos** ‚Üí per contactar i corregir
  - **Exportar igualment** ‚Üí genera fitxer sense els exclosos
  - **Cancel¬∑lar i revisar dades** ‚Üí torna a la pantalla per corregir

**5) CSV de donants exclosos**

| Camp | Descripci√≥ |
|------|------------|
| name | Nom del donant |
| taxId | NIF/CIF informat (pot estar buit o incorrecte) |
| issue | Incid√®ncia detectada (tradu√Øda a l'idioma de l'usuari) |
| email | Email del contacte (si existeix) |
| phone | Tel√®fon del contacte (si existeix) |

Objectiu: contactar els donants abans de presentar el 182 definitiu.

**6) Format del nom (persones jur√≠diques)**

Summa normalitza sufixos legals:
- `S A` ‚Üí `SA`
- `S L` ‚Üí `SL`
- `S L U` ‚Üí `SLU`

Evita errors AEAT 20701 per separacions artificials en denominacions socials.

**7) Responsabilitat de l'usuari**

- Summa no inventa ni infereix dades fiscals
- Donants exclosos:
  - No s√≥n declarats al fitxer AEAT
  - No generen dret a deducci√≥ fiscal
- Corregir dades incompletes o incorrectes √©s responsabilitat de l'entitat abans de presentar el 182 final
- L'entitat ha de verificar que el fitxer generat √©s coherent amb la seva comptabilitat

### 3.8.2 Model 347 - Operacions amb Tercers

**Data l√≠mit:** 28 de febrer

**Llindar:** > 3.005,06‚Ç¨ anuals per prove√Ødor

**Exportaci√≥:** CSV amb NIF, Nom, Import total

### 3.8.3 Certificats de Donaci√≥

**Tipus:**
- Individual (per donaci√≥)
- Anual (totes les donacions d'un any)
- Massiu (ZIP amb tots)

**Format PDF:**
- Logo de l'organitzaci√≥
- Firma digitalitzada
- Text legal Llei 49/2002

**C√†lcul de l'import:**
- Import = Œ£ donacions - Œ£ devolucions
- Si import ‚â§ 0 ‚Üí No es genera certificat


## 3.9 CONFIGURACI√ì

### 3.9.1 Dades de l'Organitzaci√≥
Nom, CIF, adre√ßa, ciutat, CP, tel√®fon, email, web, logo

### 3.9.2 Configuraci√≥ de Certificats
Firma digitalitzada, nom signant, c√†rrec

### 3.9.3 Prefer√®ncies
Llindar alertes contacte: 0‚Ç¨, 50‚Ç¨, 100‚Ç¨, 500‚Ç¨

### 3.9.4 Categories Comptables (ACTUALITZAT v1.28)

Categories d'ingressos i despeses personalitzables.

**Importador de Categories:**
- Plantilla oficial √∫nica dins l'importador ("Descarregar plantilla")
- Detecci√≥ autom√†tica 100% sense mapeig manual
- Normalitzaci√≥ de label (maj√∫scules, sense accents) per matching
- Scroll autom√†tic a preview si hi ha errors
- Motiu d'omissi√≥ visible per cada fila (duplicat, sense nom, etc.)

**Eliminar Categoria:**
- Advert√®ncia amb comptador de moviments afectats
- Els moviments no s'esborren, nom√©s perden la categoria assignada

**Zona de Perill (Categories):**
- Bot√≥ "Esborrar totes les categories" dins la secci√≥ Danger Zone
- Requereix confirmaci√≥ escrivint "ESBORRAR"
- Les categories per defecte es regeneren autom√†ticament

### 3.9.5 Gesti√≥ de Membres
Convidar, canviar rol, eliminar

### 3.9.6 Zona de Perill (SuperAdmin)

Accions irreversibles nom√©s per SuperAdmin:

| Acci√≥ | Descripci√≥ |
|-------|------------|
| Esborrar tots els donants | Elimina tots els donants de l'organitzaci√≥ |
| Esborrar tots els prove√Ødors | Elimina tots els prove√Ødors |
| Esborrar tots els treballadors | Elimina tots els treballadors |
| Esborrar tots els moviments | Elimina totes les transaccions |
| Esborrar √∫ltima remesa | Esborra les transaccions filles i restaura la remesa original |

**Esborrar √∫ltima remesa:**
- Busca l'√∫ltima remesa processada (isRemittance === true)
- Mostra info: data, concepte, import, nombre de quotes
- Demana confirmaci√≥ escrivint "BORRAR"
- Esborra totes les transaccions filles
- Restaura la transacci√≥ original per tornar-la a processar

### 3.9.7 Sistema de traduccions (i18n)

#### Context i problema resolt

El sistema anterior (nom√©s `ca.ts`, `es.ts`, `fr.ts`) requeria un developer per afegir o modificar traduccions. Aix√≤ bloquejava:
- Traducci√≥ externa (traductors sense acc√©s al codi)
- Afegir idiomes nous sense deploy
- Correccions r√†pides de textos

El nou sistema permet gesti√≥ completa des del SuperAdmin sense tocar codi.

#### Arquitectura

- **Source of truth editable**: Firebase Storage
  `i18n/{lang}.json`

- **Fallback local (repo)**:
  `src/i18n/locales/{lang}.json`

- **Legacy fallback**:
  Objectes TypeScript (`ca.ts`, `es.ts`, `fr.ts`) nom√©s per codi antic

#### Ordre de c√†rrega en runtime

1. JSON a Firebase Storage (`i18n/{lang}.json`)
2. JSON local del repositori (`src/i18n/locales/{lang}.json`)
3. Fallback a la clau (`"dashboard.title"`)

#### Contracte d'√∫s

- **`t.xxx.yyy`** ‚Üí sistema legacy (objecte TypeScript)
- **`tr("xxx.yyy")`** ‚Üí sistema nou (JSON pla)

**‚ùå Prohibit: `t("xxx.yyy")`** (no existeix, causa error de producci√≥)

#### Idiomes disponibles

| Codi | Idioma | TS (legacy) | JSON | Estat |
|------|--------|-------------|------|-------|
| `ca` | Catal√† | ‚úÖ | ‚úÖ | Base (complet) |
| `es` | Espa√±ol | ‚úÖ | ‚úÖ | Complet |
| `fr` | Fran√ßais | ‚úÖ | ‚úÖ | Complet |
| `pt` | Portugu√™s | ‚ùå | ‚úÖ | JSON-only |

#### Selector d'idioma

- Ubicaci√≥: Men√∫ usuari (cantonada superior dreta)
- Persist√®ncia: `localStorage`
- Comportament: Canvi immediat sense recarregar

#### Operativa SuperAdmin (Traduccions)

1. Accedir a SuperAdmin ‚Üí Traduccions
2. Seleccionar idioma
3. Descarregar JSON
4. Editar externament (Excel / POEditor / editor JSON)
5. Pujar JSON validat
6. Clicar "Publicar" (invalida cache global)

Els canvis s√≥n immediats per a tots els usuaris.

#### Afegir un idioma nou

1. Afegir codi d'idioma a `Language` (`src/i18n/index.ts`)
2. Crear `src/i18n/locales/{lang}.json` (copiat de `ca.json`)
3. Afegir idioma als selectors (app + SuperAdmin)
4. Descarregar plantilla via SuperAdmin
5. Traduir, pujar i publicar

#### Scripts

```bash
# Exportar traduccions TS a JSON i generar report de claus
npm run i18n:export
```

Exemple de report:
```
[i18n] Key comparison report:
  Base (ca): 850 keys
  es: ‚úì Perfect match (850 keys)
  fr: ‚úì Perfect match (850 keys)
  pt: ‚úì Perfect match (850 keys)
```

#### Fitxers clau

| Fitxer | Responsabilitat |
|--------|-----------------|
| `src/i18n/index.ts` | Tipus `Language`, context, hook |
| `src/i18n/provider.tsx` | Provider, listener versi√≥, carrega JSON |
| `src/i18n/json-runtime.ts` | Loader Storage/local, cache, `trFactory` |
| `src/i18n/locales/*.json` | Bundles JSON (fallback local) |
| `src/i18n/ca.ts`, `es.ts`, `fr.ts` | Traduccions TS legacy |
| `src/i18n/public.ts` | Traduccions p√†gines p√∫bliques (NOU v1.25) |
| `scripts/i18n/export-all.ts` | Export TS ‚Üí JSON |

Per a m√©s detall operatiu, veure `docs/i18n.md`.


### 3.9.8 i18n per a Rutes P√∫bliques (NOU v1.25)

#### Context i problema resolt

Les p√†gines p√∫bliques (login, privacy, contact) estaven nom√©s en catal√† amb textos hardcoded. Per millorar:
- SEO internacional amb canonical + hreflang
- Experi√®ncia d'usuari en el seu idioma preferit
- Consist√®ncia amb l'app privada (4 idiomes)

#### Arquitectura

Per evitar col¬∑lisi√≥ entre `[lang]` i `[orgSlug]` (tots dos segments din√†mics al root),
les p√†gines p√∫bliques estan sota un segment real `public`:

```
/src/app/public/[lang]/       ‚Üí Segment real + din√†mic (intern)
  /page.tsx                   ‚Üí HOME multiidioma
  /funcionalitats/page.tsx    ‚Üí Funcionalitats
  /login/page.tsx             ‚Üí P√†gina login multiidioma
  /privacy/page.tsx           ‚Üí Pol√≠tica de privacitat
  /contact/page.tsx           ‚Üí P√†gina de contacte
  layout.tsx                  ‚Üí Validaci√≥ idioma + SSG params

/src/app/page.tsx             ‚Üí Redirect stub ‚Üí /${lang}
/src/app/funcionalitats/page.tsx ‚Üí Redirect stub ‚Üí /${lang}/funcionalitats
/src/app/login/page.tsx       ‚Üí Redirect stub ‚Üí /${lang}/login
/src/app/privacy/page.tsx     ‚Üí Redirect stub ‚Üí /${lang}/privacy
/src/app/contacte/page.tsx    ‚Üí Redirect stub ‚Üí /${lang}/contact
/src/app/privacitat/page.tsx  ‚Üí Redirect stub ‚Üí /${lang}/privacy (legacy)
```

**Middleware rewrite:** `/fr/...` ‚Üí `/public/fr/...` (URL p√∫blica es mant√©)

**Slugs reservats** (no es poden usar com orgSlug):
`ca`, `es`, `fr`, `pt`, `public`, `login`, `admin`, `dashboard`, `privacy`, `api`, `q`, `registre`, `redirect-to-org`

#### Idiomes suportats (rutes p√∫bliques)

| Codi | Idioma | URL exemple |
|------|--------|-------------|
| `ca` | Catal√† | `/ca/login`, `/ca/privacy`, `/ca/contact` |
| `es` | Espa√±ol | `/es/login`, `/es/privacy`, `/es/contact` |
| `fr` | Fran√ßais | `/fr/login`, `/fr/privacy`, `/fr/contact` |
| `pt` | Portugu√™s | `/pt/login`, `/pt/privacy`, `/pt/contact` |

#### Detecci√≥ autom√†tica d'idioma

Quan un usuari accedeix a `/login` (sense idioma), el sistema:

1. Llegeix l'header `Accept-Language` del navegador
2. Parseja i ordena per qualitat (`q=0.9`, etc.)
3. Troba el primer idioma suportat
4. Redirigeix a `/{lang}/login`

**Exemple:**
```
Accept-Language: pt-BR,pt;q=0.9,en;q=0.8
‚Üí Redirigeix a /pt/login

Accept-Language: de-DE,de;q=0.9,en;q=0.8
‚Üí Redirigeix a /ca/login (default, alemany no suportat)
```

#### Fitxers clau

| Fitxer | Responsabilitat |
|--------|-----------------|
| `src/lib/public-locale.ts` | Tipus `PublicLocale`, `detectPublicLocale()`, `generatePublicPageMetadata()` |
| `src/i18n/public.ts` | Traduccions completes per home, funcionalitats, login, privacy, contact (CA/ES/FR/PT) |
| `src/middleware.ts` | Rewrite `/fr/...` ‚Üí `/public/fr/...` + protecci√≥ segments reservats |
| `src/app/public/[lang]/layout.tsx` | Validaci√≥ idioma + `generateStaticParams()` per SSG |
| `src/app/public/[lang]/*/page.tsx` | P√†gines amb traduccions i metadades SEO |
| `src/components/IdleLogoutProvider.tsx` | RESERVED_SEGMENTS (inclou idiomes) |

#### SEO: Canonical i Hreflang

Cada p√†gina p√∫blica genera metadades SEO correctes:

```typescript
// Exemple per /ca/privacy
{
  alternates: {
    canonical: "https://summasocial.app/ca/privacy",
    languages: {
      ca: "https://summasocial.app/ca/privacy",
      es: "https://summasocial.app/es/privacy",
      fr: "https://summasocial.app/fr/privacy",
      pt: "https://summasocial.app/pt/privacy"
    }
  }
}
```

Aix√≤ genera els tags HTML:
```html
<link rel="canonical" href="https://summasocial.app/ca/privacy" />
<link rel="alternate" hreflang="ca" href="https://summasocial.app/ca/privacy" />
<link rel="alternate" hreflang="es" href="https://summasocial.app/es/privacy" />
<link rel="alternate" hreflang="fr" href="https://summasocial.app/fr/privacy" />
<link rel="alternate" hreflang="pt" href="https://summasocial.app/pt/privacy" />
```

#### Estructura de traduccions (public.ts)

```typescript
// src/i18n/public.ts
export interface PublicTranslations {
  common: {
    appName: string;
    tagline: string;
    close: string;
    backToHome: string;
    // ...
  };
  login: {
    title: string;
    welcomeTitle: string;
    welcomeDescription: string;
    sessionExpired: string;
    // ...
  };
  privacy: {
    title: string;
    sections: {
      whoWeAre: { title: string; intro: string; /* ... */ };
      whatData: { /* ... */ };
      // 9 seccions completes
    };
  };
  contact: {
    title: string;
    subtitle: string;
    responseTime: string;
  };
}

// Traduccions per cada idioma
const ca: PublicTranslations = { /* ... */ };
const es: PublicTranslations = { /* ... */ };
const fr: PublicTranslations = { /* ... */ };
const pt: PublicTranslations = { /* ... */ };

export const publicTranslations: Record<PublicLocale, PublicTranslations> = {
  ca, es, fr, pt
};
```

#### √ös a les p√†gines

```tsx
// src/app/public/[lang]/login/page.tsx (URL p√∫blica: /{lang}/login)
import { getPublicTranslations } from '@/i18n/public';
import { isValidPublicLocale } from '@/lib/public-locale';

export default function LoginPage({ params }: { params: { lang: string } }) {
  const lang = isValidPublicLocale(params.lang) ? params.lang : 'ca';
  const t = getPublicTranslations(lang);

  return (
    <h1>{t.login.welcomeTitle}</h1>
    // "Benvingut a Summa Social" / "Bienvenido a Summa Social" / etc.
  );
}
```

#### Compatibilitat amb URLs antigues

Les URLs antigues continuen funcionant amb redirect:

| URL antiga | Redirigeix a |
|------------|--------------|
| `/login` | `/{detectat}/login` |
| `/privacy` | `/{detectat}/privacy` |
| `/privacitat` | `/{detectat}/privacy` |
| `/contacte` | `/{detectat}/contact` |

On `{detectat}` √©s l'idioma detectat via Accept-Language (default: `ca`).

#### Difer√®ncia amb i18n de l'app privada

| Aspecte | App privada (`/[orgSlug]/dashboard`) | P√†gines p√∫bliques (`/[lang]/*`) |
|---------|--------------------------------------|----------------------------------|
| **Traduccions** | `src/i18n/ca.ts`, `es.ts`, `fr.ts` + JSON | `src/i18n/public.ts` |
| **Tipus** | `Language` (`ca`, `es`, `fr`) | `PublicLocale` (`ca`, `es`, `fr`, `pt`) |
| **Persist√®ncia idioma** | `localStorage` (selector usuari) | URL path (`/ca/`, `/es/`, etc.) |
| **Detecci√≥** | Prefer√®ncia guardada | `Accept-Language` header |
| **SEO** | No aplica (app privada) | Canonical + hreflang |
| **SSG** | No (din√†mic) | S√≠ (`generateStaticParams`) |


## 3.10 IMPORTADOR STRIPE (NOU v1.9)

### 3.10.1 Visi√≥ general

L'importador Stripe permet dividir les liquidacions (payouts) de Stripe en transaccions individuals, identificant cada donaci√≥ i separant les comissions.

| Caracter√≠stica | Valor |
|----------------|-------|
| **Format entrada** | CSV exportat de Stripe ("Pagos ‚Üí Columnes predeterminades") |
| **Matching donants** | Per email (exacte, case insensitive) |
| **Creaci√≥ autom√†tica donants** | NO |
| **Gesti√≥ comissions** | Despesa agregada per payout |

**Principi fonamental:** El moviment bancari original (payout) MAI es modifica.

### 3.10.2 Flux d'√∫s

```
1. L'usuari veu un ingr√©s de Stripe al llistat de moviments
2. Men√∫ ‚ãÆ ‚Üí "Dividir remesa Stripe"
3. Puja el CSV exportat de Stripe
4. El sistema agrupa per Transfer (payout) i cerca el que quadra amb l'import bancari
5. Previsualitzaci√≥: donacions + comissions + matching donants
6. L'usuari revisa i assigna manualment els pendents
7. Confirma ‚Üí Es creen les transaccions filles
```

### 3.10.3 Condici√≥ per mostrar l'acci√≥

L'opci√≥ "Dividir remesa Stripe" apareix si:

```typescript
const canSplitStripeRemittance = (tx: Transaction): boolean => {
  const isIncome = tx.amount > 0;
  const isNotAlreadyDivided = tx.transactionType !== 'donation' && tx.transactionType !== 'fee';
  const isNotRemittance = !tx.isRemittance;
  
  if (!isIncome || !isNotAlreadyDivided || !isNotRemittance) return false;
  
  // Transaccions noves (ja tenen source)
  if (tx.source === 'stripe') return true;
  
  // Fallback legacy (backward compatibility)
  const descUpper = tx.description?.toUpperCase() || '';
  return descUpper.includes('STRIPE') || descUpper.includes('TRANSFERENCIA DE STRIPE');
};
```

### 3.10.4 Camps CSV requerits

| Camp Stripe | √ös a Summa Social | Obligatori |
|-------------|-------------------|------------|
| `id` | Tra√ßabilitat (`stripePaymentId`) | ‚úÖ |
| `Created date (UTC)` | Data de la donaci√≥ | ‚úÖ |
| `Amount` | Import brut | ‚úÖ |
| `Fee` | Comissi√≥ Stripe | ‚úÖ |
| `Customer Email` | Matching amb donant | ‚úÖ |
| `Status` | Filtrar nom√©s `succeeded` | ‚úÖ |
| `Transfer` | Agrupaci√≥ per payout (`po_xxx`) | ‚úÖ |
| `Amount Refunded` | Detectar reemborsos | ‚úÖ |
| `Description` | Concepte (opcional) | ‚ùå |

### 3.10.5 Filtratge autom√†tic

| Condici√≥ | Acci√≥ |
|----------|-------|
| `Status !== 'succeeded'` | Excloure silenciosament |
| `Amount Refunded > 0` | Excloure + mostrar av√≠s |

### 3.10.6 Agrupaci√≥ per payout

Les donacions s'agrupen pel camp `Transfer` (po_xxx):

```typescript
interface PayoutGroup {
  transferId: string;    // po_xxx
  rows: StripeRow[];     // Donacions del payout
  gross: number;         // Œ£ Amount
  fees: number;          // Œ£ Fee
  net: number;           // gross - fees
}
```

### 3.10.7 Match amb el banc

**Criteri:** Per import net (¬±0,02‚Ç¨ de toler√†ncia)

```typescript
const tolerance = 0.02;
const match = Math.abs(payoutGroup.net - bankTransaction.amount) <= tolerance;
```

> ‚ö†Ô∏è El banc NO porta el `Transfer` (po_xxx). El match √©s exclusivament per import.

### 3.10.8 Matching de donants

| Prioritat | Criteri | Implementaci√≥ |
|-----------|---------|---------------|
| 1 | Email | `donor.email.toLowerCase() === stripeRow.customerEmail.toLowerCase()` |

**Regles estrictes:**
- NO fuzzy matching
- NO crear donants autom√†ticament
- Si no hi ha match ‚Üí fila queda "Pendent d'assignar"

### 3.10.9 Transaccions generades

**Per cada donaci√≥ (N ingressos):**

```typescript
{
  date: stripeRow.createdDate,
  description: ensureStripeInDescription(stripeRow.description, stripeRow.customerEmail),
  amount: stripeRow.amount,              // Import BRUT (positiu)
  contactId: matchedDonor?.id || null,
  contactType: matchedDonor ? 'donor' : null,
  contactName: matchedDonor?.name || null,
  source: 'stripe',
  transactionType: 'donation',
  parentTransactionId: bankTransaction.id,
  stripePaymentId: stripeRow.id,         // ch_xxx
  stripeTransferId: selectedGroup.transferId,  // po_xxx
  categoryId: matchedDonor?.defaultCategoryId || null
}
```

**Per les comissions (1 despesa agregada):**

```typescript
{
  date: bankTransaction.date,
  description: `Comissions Stripe - ${count} donacions`,
  amount: -totalFees,                    // Negatiu (despesa)
  source: 'stripe',
  transactionType: 'fee',
  parentTransactionId: bankTransaction.id,
  stripeTransferId: selectedGroup.transferId,
  categoryId: bankFeesCategoryId         // Categoria 'bankFees'
}
```

**Cercabilitat (sufix autom√†tic):**

```typescript
function ensureStripeInDescription(desc: string | null, email: string): string {
  const base = desc || `Donaci√≥ Stripe - ${email}`;
  if (base.toUpperCase().includes('STRIPE')) return base;
  return `${base} (via Stripe)`;
}
```

### 3.10.10 Model de dades

**Camps espec√≠fics Stripe a Transaction:**

| Camp | Tipus | Descripci√≥ |
|------|-------|------------|
| `source` | `'stripe'` | Identifica origen |
| `transactionType` | `'donation' \| 'fee'` | Tipus de transacci√≥ |
| `stripePaymentId` | `string \| null` | ID pagament (`ch_xxx`) - Idempot√®ncia |
| `stripeTransferId` | `string \| null` | ID payout (`po_xxx`) - Correlaci√≥ |
| `parentTransactionId` | `string` | ID del moviment bancari pare |

### 3.10.11 Impacte fiscal

| Document | Tractament |
|----------|------------|
| **Model 182** | Nom√©s compten les filles amb `contactId` i `transactionType: 'donation'` |
| **Certificats** | Import = Œ£ donacions Stripe del donant |
| **Comissions** | NO afecten fiscalitat donants (s√≥n despeses de l'entitat) |

### 3.10.12 UI

**Pas 1: Pujar fitxer**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dividir remesa Stripe                   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Import al banc: 115,55 ‚Ç¨                ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Arrossega el CSV aqu√≠]                 ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚ö†Ô∏è No obrir el CSV amb Excel abans      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Pas 2: Revisi√≥**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3 donacions trobades                                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ Brut:        120,00 ‚Ç¨                                           ‚îÇ
‚îÇ Comissions:   -4,45 ‚Ç¨                                           ‚îÇ
‚îÇ Net:         115,55 ‚Ç¨ ‚úÖ (quadra amb banc)                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ
‚îÇ ‚úÖ lourdes@example.com    ‚Üí Lourdes Hoyal       50,00 ‚Ç¨         ‚îÇ
‚îÇ ‚úÖ pere@example.com       ‚Üí Pere Mart√≠          30,00 ‚Ç¨         ‚îÇ
‚îÇ ‚ö†Ô∏è nou@email.com          ‚Üí [Assignar]          40,00 ‚Ç¨         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                              [Cancel¬∑lar] [Processar]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3.10.13 Errors i missatges

| Codi | Condici√≥ | Missatge |
|------|----------|----------|
| `ERR_NO_COLUMNS` | Falten columnes | "El CSV no t√© les columnes necess√†ries: {columnes}" |
| `ERR_NO_MATCH` | Cap payout quadra | "No s'ha trobat cap payout que coincideixi amb {amount} ‚Ç¨" |
| `ERR_AMOUNT_MISMATCH` | Import no quadra | "L'import no quadra. Esperats {expected} ‚Ç¨, calculats {actual} ‚Ç¨" |
| `ERR_NO_BANK_FEES_CATEGORY` | Falta categoria | "No s'ha trobat la categoria de despeses banc√†ries" |
| `WARN_REFUNDED` | Hi ha reemborsos | "S'han excl√≤s {count} donacions reemborsades ({amount} ‚Ç¨)" |
| `WARN_NO_DONOR` | Sense match | "{count} donacions pendents d'assignar donant" |

### 3.10.14 L√≠mits del sistema

| Perm√®s | NO perm√®s |
|--------|-----------|
| Matching per email exacte | Fuzzy matching |
| Assignaci√≥ manual pendents | Creaci√≥ autom√†tica donants |
| M√∫ltiples payouts al CSV | Connexi√≥ directa API Stripe |
| Exclusi√≥ reemborsos | Processament autom√†tic refunds |

### 3.10.15 Estructura de fitxers

```
/src/components/stripe-importer/
  ‚îú‚îÄ‚îÄ useStripeImporter.ts    # Hook amb l√≤gica de parsing i matching
  ‚îú‚îÄ‚îÄ StripeImporter.tsx      # Component UI (modal)
  ‚îî‚îÄ‚îÄ index.ts                # Exports
```

**Punt de connexi√≥:** `transaction-table.tsx` ‚Üí men√∫ ‚ãÆ si `canSplitStripeRemittance(tx)`


## 3.11 M√íDUL PROJECTES ‚Äî JUSTIFICACI√ì ASSISTIDA (NOU v1.10)

### 3.11.0 Navegaci√≥ del M√≤dul Projectes (NOU v1.14)

El m√≤dul Projectes t√© una entrada √∫nica al sidebar amb un submenu col¬∑lapsable.

**Estructura del sidebar:**

| Nivell | Element | Ruta |
|--------|---------|------|
| Pare | **Projectes** (icona FolderKanban) | ‚Äî |
| ‚îî‚îÄ Fill 1 | Gesti√≥ de projectes | `/dashboard/project-module/projects` |
| ‚îî‚îÄ Fill 2 | Assignaci√≥ de despeses | `/dashboard/project-module/expenses` |

**Component:** `Collapsible` de shadcn/ui

**Comportament:**
- Per defecte tancat
- S'obre/tanca fent clic al pare
- Icona `ChevronRight` rota 90¬∞ quan obert
- Estil suau per a subelements (mida i color redu√Øts)

**Fitxer:** `src/components/dashboard-sidebar-content.tsx`

**Traduccions:**
- `sidebar.projectModule`: "Projectes"
- `sidebar.projectModuleManage`: "Gesti√≥ de projectes"
- `sidebar.projectModuleExpenses`: "Assignaci√≥ de despeses"

### 3.11.1 Objectiu del m√≤dul

Permetre a una persona t√®cnica quadrar la justificaci√≥ econ√≤mica d'un projecte (ACCD, Fons Catal√†, etc.) a partir de les despeses reals existents, sense treballar en Excel, sense preconfiguracions r√≠gides i sense modificar dades fins a la validaci√≥ final.

> ‚ö†Ô∏è **Aquest m√≤dul √©s extern al core de Summa Social** i segueix el patr√≥ d'exports descrit a l'Annex C.

### 3.11.2 Principis de disseny (no negociables)

| Principi | Descripci√≥ |
|----------|------------|
| **Sense mapa obligatori** | No existeix un mapa r√≠gid partides entitat ‚Üî finan√ßador |
| **Sense classificaci√≥ pr√®via** | No es for√ßa la classificaci√≥ pr√®via de despeses |
| **Sense workflows** | No hi ha workflows d'aprovaci√≥ ni estats de "justificat" |
| **Sense entitats noves** | No es creen entitats noves per simular |
| **Reversible** | Tot el proc√©s √©s reversible fins a "Aplicar" |

### 3.11.3 Pantalla base: Gesti√≥ Econ√≤mica del Projecte

| Element | Descripci√≥ |
|---------|------------|
| Targetes resum | Pressupostat / Executat / Pendent |
| Bloc principal | Seguiment Econ√≤mic (partides) |
| CTA | "Quadrar justificaci√≥" |

**Cap proc√©s de justificaci√≥ obliga a sortir d'aquesta pantalla.**

#### C√†lcul del pressupost

| Condici√≥ | Pressupost mostrat |
|----------|-------------------|
| Projecte **amb** partides | Suma de `budgetedAmountEUR` de totes les partides |
| Projecte **sense** partides | Camp `budgetEUR` del projecte |

```typescript
interface BudgetLinesData {
  sum: number;
  hasLines: boolean;  // Permet distingir "0 partides" de "partides amb sum=0"
}

const budgeted = budgetLinesData?.hasLines
  ? budgetLinesData.sum
  : (project.budgetEUR ?? 0);
```

#### Importador de pressupost (ACTUALITZAT v1.32)

Wizard d'importaci√≥ de partides des d'Excel (.xlsx) amb 5 passos:

| Pas | Descripci√≥ |
|-----|------------|
| 1. Fitxer | Pujar fitxer Excel (.xlsx) |
| 2. Pestanya | Seleccionar sheet (si n'hi ha m√∫ltiples) |
| 3. Columnes | Mapar columnes: nom, import del finan√ßador principal, codi (opcional) |
| 4. Agrupaci√≥ | Triar mode: agrupar subpartides a partida o importar tal qual |
| 5. Revisi√≥ | Previsualitzaci√≥ amb checkboxes per incloure/excloure |

**Caracter√≠stiques:**
- Auto-detecta columnes per patrons de cap√ßalera
- Parseja formats EU (1.234,56) i EN (1234.56)
- Exclou autom√†ticament files de totals/subtotals
- Mode "Agrupar" suma subpartides al seu pare (evita duplicitats)
- Substitueix completament el pressupost existent (batch delete + batch create)

**Extracci√≥ de codi del text (NOU v1.32):**

Opci√≥ toggle "Extreure codi del text" que detecta patrons de codi al nom de la partida:

| Patr√≥ | Exemple | Codi extret |
|-------|---------|-------------|
| `X)` | `A) Personal` | `A` |
| `x.n)` | `a.1) Salaris` | `a.1` |
| `x.n.m)` | `a.1.1) T√®cnics` | `a.1.1` |
| `n.m)` | `1.2) Despla√ßaments` | `1.2` |

**Agrupaci√≥ contextual:**

Quan "Extreure codi del text" est√† activat:
- Els cap√≠tols (codi sola lletra: A, B, C...) es destaquen visualment (ambre)
- Les subpartides s'agrupen autom√†ticament sota el seu pare segons nivell de codi
- Mode `useContextGrouping`: consolida files intel¬∑ligentment per jerarquia

**Pantalla de pressupost (millores v1.32):**

| Estat | Vista |
|-------|-------|
| **Sense partides** | Resum global del projecte amb totals agregats |
| **Amb partides** | Taula detallada amb resum superior + desviacions per partida |

**Important:**
- Nom√©s importa la columna del finan√ßador principal (p.ex. ACCD)
- No suport multi-finan√ßador ni contrapartida
- No suport PDF (nom√©s Excel)

**Fitxers:**
- `src/lib/budget-import.ts`: Utilitats de parsing (`extractCodeFromText`, `consolidateRows`)
- `src/components/project-module/budget-import-wizard.tsx`: Wizard UI

### 3.11.4 Mode "Quadrar justificaci√≥ del projecte"

- Vista assistida superposada (modal)
- L'usuari continua veient el seguiment econ√≤mic
- Organitzaci√≥ per **partida**, no per despesa
- Dos modes segons desviaci√≥:
  - **Infraexecuci√≥** ‚Üí afegir despeses
  - **Sobreexecuci√≥** ‚Üí treure o reduir imputacions

### 3.11.5 Infraexecuci√≥: afegir despeses

El sistema suggereix despeses del pool per defecte:
- Font = offBank (despeses fora de banc)
- Dins del per√≠ode del projecte
- No assignades o parcialment assignades

Les sugger√®ncies es basen en:
- Fam√≠lia sem√†ntica de la categoria
- Keywords a la descripci√≥
- Import que encaixa amb el d√®ficit

L'usuari pot:
- Acceptar una proposta sencera
- **Ampliar criteris de cerca** (afegir fonts, fora per√≠ode, altres projectes)
- Seleccionar manualment

**Les sugger√®ncies s√≥n heur√≠stiques, mai bloquegen, mai escriuen dades.**

> ‚ö†Ô∏è **Bloqueig FX (v1.33):** Les despeses off-bank amb `pendingConversion: true` (moneda local sense TC disponible) no es poden assignar. L'usuari ha de registrar un TC (manual a la despesa, o via fxTransfers del projecte) abans de poder incloure-les a cap partida.

#### Algorisme de scoring (v1.12)

| Factor | Punts | Descripci√≥ |
|--------|-------|------------|
| Categoria coincident | +3 | La despesa pertany a la mateixa fam√≠lia sem√†ntica |
| Descripci√≥ coincident | +2 | Keywords de la despesa apareixen a la partida |
| Import encaixa | +1 | L'import √©s ‚â§ d√®ficit de la partida |
| Assignada altre projecte | -3 | Penalitzaci√≥ per risc de desquadrar altre projecte |

**Pool de candidats per defecte:**
- Font = offBank (despeses fora de banc)
- Dins del per√≠ode del projecte
- No assignades o parcialment assignades

**Etiquetes informatives (NO afecten scoring):**

| Etiqueta | Condici√≥ | Visualitzaci√≥ |
|----------|----------|---------------|
| Sense document | `hasDocument = false` | Badge groc |
| Categoria pendent | Categoria "Revisar" o buida | Badge taronja amb icona |
| Sense contrapart | `counterpartyName` buit | Badge gris |

> ‚ö†Ô∏è **Canvi v1.12:** "Sense document" i "sense contrapart" ja no penalitzen el scoring. S√≥n etiquetes informatives que l'usuari veu per√≤ que no condicionen l'ordre de les sugger√®ncies.

#### Fam√≠lies sem√†ntiques

```typescript
const CATEGORY_FAMILIES = {
  viatges: ['transport', 'dietes', 'allotjament', 'taxi', 'avi√≥', ...],
  personal: ['n√≤mina', 'salari', 'seguretat social', ...],
  serveis: ['consultoria', 'assessorament', 'honoraris', ...],
  material: ['subministrament', 'fungible', 'oficina', ...],
  formacio: ['formaci√≥', 'curs', 'taller', ...],
  comunicacio: ['comunicaci√≥', 'm√†rqueting', 'difusi√≥', ...],
};
```

#### Classificaci√≥ de propostes

| Etiqueta | Criteri | Visualitzaci√≥ |
|----------|---------|---------------|
| `perfect` | Delta ‚â§ 0,50‚Ç¨ | Badge verd "Exacte" |
| `close` | Delta ‚â§ 2% del d√®ficit | Badge blau "Proper" |
| `approx` | Resta | Badge gris "Aproximat" |

### 3.11.6 Sobreexecuci√≥: treure despeses

Es pot:
- Treure **tota** la despesa de la partida
- Treure nom√©s una **part** de l'import (split parcial)

La part treta queda:
- Dins del projecte
- Sense partida assignada

> ‚ö†Ô∏è **El split parcial √©s una funcionalitat clau, no un edge case.** Aquesta √©s la forma m√©s habitual i realista de quadrar justificacions.

### 3.11.7 Simulaci√≥ (capa cr√≠tica)

| Element | Comportament |
|---------|--------------|
| Moviments | Es fan en mem√≤ria |
| Escriptura | NO fins que l'usuari clica "Aplicar" |
| Visualitzaci√≥ | Execuci√≥ abans / despr√©s, efecte per partida |
| Aplicar | Usa els hooks existents (`useSaveExpenseLink`) |

### 3.11.8 Tipus de canvi i justificaci√≥ (ACTUALITZAT v1.33)

#### Sistema FX: conversi√≥ de moneda estrangera

Molts projectes operen en moneda local (XOF, USD, VES, DOP, etc.) per√≤ la justificaci√≥ es quadra sempre en EUR. El sistema FX gestiona la conversi√≥.

**Nivells de TC (tipus de canvi):**

| Nivell | Camp | Significat |
|--------|------|------------|
| **Despesa** | `OffBankExpense.fxRate` | TC manual assignat a una despesa concreta |
| **Projecte (ponderat)** | Calculat de `fxTransfers` | `Œ£ eurSent / Œ£ localReceived` = EUR per 1 unitat moneda local |
| **Projecte (refer√®ncia)** | `Project.fxRate` | TC per defecte del projecte (legacy) |

**Fallback chain** (en ordre de prioritat):
1. TC manual de la despesa (`OffBankExpense.fxRate`)
2. TC ponderat del projecte (calculat de la sub-col¬∑lecci√≥ `fxTransfers`)
3. TC de refer√®ncia del projecte (`Project.fxRate`)
4. `null` ‚Üí la despesa queda amb `pendingConversion: true`

**F√≥rmula de conversi√≥:**
```
amountEUR = originalAmount √ó fxRate
```
On `fxRate` = EUR per 1 unitat de moneda local.

#### Sub-col¬∑lecci√≥ fxTransfers (NOU v1.33)

Registre de transfer√®ncies banc√†ries EUR ‚Üí moneda local associades a un projecte.

**Path Firestore:** `/organizations/{orgId}/projectModule/_/projects/{projectId}/fxTransfers/{transferId}`

```typescript
interface FxTransfer {
  id: string;
  date: string;              // YYYY-MM-DD
  eurSent: number;           // EUR enviats (positiu)
  localCurrency: string;     // ex: "XOF", "USD"
  localReceived: number;     // moneda local rebuda
  bankTxRef?: {              // refer√®ncia transacci√≥ banc√†ria (opcional)
    txId: string;
    accountId?: string;
  } | null;
  notes?: string | null;
}
```

**TC ponderat** = `Œ£ eurSent / Œ£ localReceived` (de totes les transfer√®ncies del projecte).

La UI de fxTransfers es mostra a la pantalla de pressupost del projecte (`budget/page.tsx`) amb CRUD complet (afegir, editar, eliminar transfer√®ncies).

#### Conversi√≥ EUR en assignaci√≥ (NOU v1.33)

Quan s'assigna una despesa off-bank en moneda local a una partida:
- El sistema calcula `amountEUR` en el moment de l'assignaci√≥ usant el TC disponible
- Si l'assignaci√≥ √©s parcial (split), la conversi√≥ √©s proporcional via `localPct` (0-100)
- `amountEUR = originalAmount √ó (localPct / 100) √ó fxRate`

**Bloqueig d'assignaci√≥:** Si una despesa t√© `pendingConversion: true` (no hi ha cap TC disponible), el bot√≥ d'assignaci√≥ es desactiva amb missatge informatiu.

#### Camps de justificaci√≥

- No s√≥n obligatoris
- S'editen nom√©s quan cal justificar davant del finan√ßador
- Existeixen per respondre al finan√ßador, no per comptabilitat
- Camps: `invoiceNumber`, `issuerTaxId`, `invoiceDate`, `paymentDate`, `supportDocNumber`

### 3.11.9 Qu√® NO fa Summa (expl√≠cit)

| NO fa | Motiu |
|-------|-------|
| No valida formalment justificacions | No som auditors |
| No bloqueja desviacions | L'usuari decideix |
| No obliga a quadrar al c√®ntim | Realisme operatiu |
| No substitueix el criteri t√®cnic | Eina, no workflow |
| No converteix la justificaci√≥ en proc√©s r√≠gid | Flexibilitat > rigidesa |

> **Blindatge:** Les assignacions i simulacions del m√≤dul de projectes no modifiquen ni condicionen els c√†lculs fiscals ni els informes oficials (Model 182, certificats).

### 3.11.10 Estructura de fitxers

```
/src/app/[orgSlug]/
  ‚îú‚îÄ‚îÄ quick-expense/                    # Landing fora de dashboard (NOU v1.22)
  ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                    # Layout m√≠nim (OrganizationProvider)
  ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                      # P√†gina landing
  ‚îî‚îÄ‚îÄ dashboard/project-module/
      ‚îú‚îÄ‚îÄ expenses/
      ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Llistat de despeses elegibles
      ‚îÇ   ‚îú‚îÄ‚îÄ [txId]/page.tsx           # Detall d'una despesa
      ‚îÇ   ‚îî‚îÄ‚îÄ capture/page.tsx          # Captura r√†pida de terreny (NOU v1.11)
      ‚îú‚îÄ‚îÄ projects/
      ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Llista de projectes
      ‚îÇ   ‚îî‚îÄ‚îÄ [projectId]/
      ‚îÇ       ‚îú‚îÄ‚îÄ budget/page.tsx       # Gesti√≥ Econ√≤mica (pantalla base)
      ‚îÇ       ‚îî‚îÄ‚îÄ edit/page.tsx         # Edici√≥ del projecte
      ‚îî‚îÄ‚îÄ quick-expense/
          ‚îî‚îÄ‚îÄ page.tsx                  # Redirect 307 a /{orgSlug}/quick-expense

/src/app/quick/
  ‚îî‚îÄ‚îÄ page.tsx                          # Shortcut global ‚Üí detecta org ‚Üí landing

/src/components/project-module/
  ‚îú‚îÄ‚îÄ add-off-bank-expense-modal.tsx    # Modal creaci√≥/edici√≥ despesa off-bank (FX integrat v1.33)
  ‚îú‚îÄ‚îÄ assignment-editor.tsx             # Editor d'assignaci√≥ amb FX split (v1.33)
  ‚îú‚îÄ‚îÄ balance-project-modal.tsx         # Modal "Quadrar justificaci√≥"
  ‚îú‚îÄ‚îÄ quick-expense-screen.tsx          # Component UI de captura r√†pida
  ‚îî‚îÄ‚îÄ ...

/src/lib/
  ‚îú‚îÄ‚îÄ project-module-types.ts           # Tipus del m√≤dul
  ‚îî‚îÄ‚îÄ project-module-suggestions.ts     # Scoring i combinacions (NOU v1.10)
```

### 3.11.11 Drag & Drop de documents a Assignaci√≥ de despeses (NOU v1.16)

Permet pujar documents arrossegant-los directament sobre cada fila de despesa a la safata d'assignaci√≥ (`/project-module/expenses`).

**Comportament:**

| Element | Descripci√≥ |
|---------|------------|
| Drop zone | Cada fila de la taula de despeses |
| Feedback visual | Ring blau i fons semitransparent durant arrossegament |
| Auto-naming | Format `YYYY.MM.DD_concepte_normalitzat.ext` |
| Tipus acceptats | PDF, imatges, Word, Excel |
| Mida m√†xima | 10 MB per fitxer |

**Implementaci√≥:**
- Despeses off-bank: S'afegeix a l'array `attachments[]`
- Despeses banc√†ries: S'assigna al camp `document` (objecte √∫nic)
- Nom generat autom√†ticament amb `buildDocumentFilename()`

**Component:** `DroppableExpenseRow` dins `expenses/page.tsx`

**Renomenar documents:**
- Bot√≥ llapis a cada attachment pujat
- Edici√≥ inline del nom (sense extensi√≥)
- Enter per guardar, Escape per cancel¬∑lar

### 3.11.12 Captura de despeses de terreny (NOU v1.11)

| Element | Descripci√≥ |
|---------|------------|
| Ruta | `/project-module/expenses/capture` |
| Objectiu | Pujada r√†pida de comprovants des del m√≤bil |
| Criteri | "Captura ara, assignaci√≥ despr√©s" |
| Temps objectiu | < 10 segons per pujada |

**Filosofia:**
- L'usuari de terreny (editor) fa foto i envia
- L'administraci√≥ (admin) revisa, classifica i assigna
- Camps m√≠nims: import, data, foto del comprovant
- Camp `needsReview: true` per defecte

**Rols:** (segons el camp `role` de `members`)
| Rol | Veu | Pot fer |
|-----|-----|---------|
| `viewer` | Res | Res |
| `user` | Nom√©s les seves pujades | Pujar comprovants |
| `admin` | Totes les pujades | Revisar, classificar, assignar |

> Nota: A la UI el rol `user` es mostra com "Editor" o "Usuari de terreny".

**Camps rellevants (OffBankExpense):**
- `needsReview: boolean` ‚Äî indica si est√† pendent de revisi√≥
- `attachments: Attachment[]` ‚Äî fitxers adjunts (justificants)
- `uploadedBy: string` ‚Äî UID de qui ha pujat
- `quickMode: boolean` ‚Äî indica pujada r√†pida (sense camps opcionals)

**Noms estandarditzats de fitxers (NOU v1.12):**
- Format: `{projectCode}_{date}_{concept}_{amount}{ext}`
- Exemple: `PROJ001_2025-01-15_Material_oficina_125.50.pdf`
- S'aplica a despeses off-bank i documents adjunts a transaccions

### 3.11.13 Model de dades (ACTUALITZAT v1.33)

**Veure Annex C.3** per l'estructura Firestore completa del m√≤dul projectes.

Camps afegits v1.10:

| Col¬∑lecci√≥ | Camp | Tipus | Descripci√≥ |
|------------|------|-------|------------|
| `projects` | `budgetEUR` | `number \| null` | Pressupost global (fallback si no hi ha partides) |
| `budgetLines` | `budgetedAmountEUR` | `number` | Import pressupostat de la partida |

Camps FX afegits v1.33:

| Col¬∑lecci√≥ | Camp | Tipus | Descripci√≥ |
|------------|------|-------|------------|
| `projects` | `fxRate` | `number \| null` | TC de refer√®ncia per defecte (EUR per 1 moneda local) |
| `projects` | `fxCurrency` | `string \| null` | Codi moneda local (ex: "XOF") |
| `offBankExpenses` | `originalCurrency` | `string \| null` | Moneda original (null = EUR) |
| `offBankExpenses` | `originalAmount` | `number \| null` | Import en moneda local |
| `offBankExpenses` | `fxRate` | `number \| null` | TC manual (1 moneda ‚Üí EUR) |
| `offBankExpenses` | `fxDate` | `string \| null` | Data del TC (opcional) |
| `expenseLinks.assignments[]` | `localPct` | `number` | Percentatge assignat (0-100) per FX split |

Sub-col¬∑lecci√≥ afegida v1.33:

| Sub-col¬∑lecci√≥ | Path | Descripci√≥ |
|----------------|------|------------|
| `fxTransfers` | `projects/{projectId}/fxTransfers/{transferId}` | Transfer√®ncies EUR‚Üímoneda local |

Flag a `UnifiedExpense`:

| Camp | Tipus | Descripci√≥ |
|------|-------|------------|
| `pendingConversion` | `boolean` | `true` si `originalAmount` existeix per√≤ no hi ha TC disponible |

### 3.11.14 Quick Expense Landing (NOU v1.22)

Pantalla dedicada per a l'entrada r√†pida de despeses des del m√≤bil, **sense layout de dashboard** (sense sidebar, header ni breadcrumbs).

**Arquitectura de rutes:**

| Ruta | Funci√≥ | Tipus |
|------|--------|-------|
| `/{orgSlug}/quick-expense` | Landing can√≤nica | P√†gina amb layout m√≠nim |
| `/quick` | Shortcut global | Redirecci√≥ a landing (detecta org de l'usuari) |
| `/{orgSlug}/dashboard/project-module/quick-expense` | Ruta antiga | Redirect 307 per backward-compatibility |

**Decisions arquitect√≤niques:**

| Decisi√≥ | Motiu |
|---------|-------|
| Fora de `/dashboard` | Next.js App Router no permet "saltar" layouts intermedis |
| Layout propi m√≠nim | Nom√©s `OrganizationProvider` + `InitializeData`, sense sidebar/header |
| Redirect 307 antic | Mant√© compatibilitat amb bookmarks i enlla√ßos existents |
| Shortcut `/quick` | Permet "Afegir a pantalla d'inici" sense necessitat de saber l'org |

**Permisos:**

| Rol | Pot accedir |
|-----|-------------|
| `superadmin` | ‚úÖ |
| `admin` | ‚úÖ |
| `user` | ‚úÖ |
| `viewer` | ‚ùå (redirigit a dashboard) |

**Flux d'acc√©s (ACTUALITZAT v1.24):**

```
/quick ‚Üí (si no user) ‚Üí /login?next=/quick
       ‚Üí (si user) ‚Üí /redirect-to-org?next=/quick-expense
                                    ‚Üì
                      detecta orgSlug via perfil/membres
                                    ‚Üì
                      /{orgSlug}/quick-expense (landing sense sidebar)
                                    ‚Üì
                      Bot√≥ "Tornar" ‚Üí /{orgSlug}/dashboard/project-module/expenses
```

**Middleware Routing (ACTUALITZAT v1.24):**

El middleware (`src/middleware.ts`) protegeix certes rutes per evitar loops de redirecci√≥:

```typescript
const PROTECTED_ROUTES = [
  '/redirect-to-org',  // Detecci√≥ d'org
  '/admin',            // Panell SuperAdmin
  '/login',            // Autenticaci√≥
  '/quick',            // Shortcut Quick Expense
  '/registre',         // Registre p√∫blic
];
```

**Regles del middleware:**
1. Mai redirigir rutes protegides (evita loops)
2. Sempre preservar `?next` quan redirigeix a `/redirect-to-org`
3. Sempre preservar tots els searchParams en redireccions

**Fitxers principals:**

| Fitxer | Funci√≥ |
|--------|--------|
| `src/middleware.ts` | Routing central amb PROTECTED_ROUTES |
| `src/app/[orgSlug]/quick-expense/layout.tsx` | Layout m√≠nim (OrganizationProvider) |
| `src/app/[orgSlug]/quick-expense/page.tsx` | P√†gina landing |
| `src/app/quick/page.tsx` | Shortcut global (delega a redirect-to-org) |
| `src/app/[orgSlug]/dashboard/project-module/quick-expense/page.tsx` | Redirect 307 legacy |
| `src/components/project-module/quick-expense-screen.tsx` | Component UI compartit |

**Connexi√≥ amb expenses:**

El bot√≥ c√†mera a la safata de despeses (`/dashboard/project-module/expenses`) apunta a `/{orgSlug}/quick-expense`:

```tsx
<Link href={buildUrl('/quick-expense')}>
  <Camera className="h-4 w-4" />
</Link>
```

### 3.11.15 Hub de Guies Procedimentals (NOU v1.23)

Centre d'ajuda contextual amb guies pas-a-pas per a les operacions m√©s freq√ºents de Summa Social.

**Ubicaci√≥:** `/{orgSlug}/dashboard/guides`

**Caracter√≠stiques:**
- Guies procedimentals amb format `whatIs` + `steps[]` + `avoid[]`
- Traduccions CA/ES/FR/PT amb fallback a catal√†
- CTAs directes a pantalla + enlla√ß al manual
- Indicadors visuals: `lookFirst`, `doNext`, `avoid`, `costlyError`
- Validador i18n automatitzat (`npm run i18n:validate-guides`)

**Guies disponibles:**

| ID | T√≠tol | Contingut |
|----|-------|-----------|
| `firstDay` | Primer dia | Checklist d'inici r√†pid |
| `firstMonth` | Primer mes | Guia d'operativa mensual |
| `monthClose` | Tancament mensual | Procediment de tancament |
| `movements` | Gesti√≥ de moviments | Operativa b√†sica |
| `importMovements` | Importar extracte | Pas a pas importaci√≥ |
| `bulkCategory` | Categoritzaci√≥ massiva | Selecci√≥ m√∫ltiple |
| `changePeriod` | Canviar de per√≠ode | Filtre per data |
| `selectBankAccount` | Seleccionar compte | Multicompte bancari |
| `attachDocument` | Adjuntar document | Drag & drop |
| `returns` | Devolucions | Gesti√≥ de retorns |
| `remittances` | Remeses d'ingressos | Divisi√≥ de remeses |
| `splitRemittance` | Dividir remesa | Split manual |
| `stripeDonations` | Donacions Stripe | Importador Stripe |
| `travelReceipts` | Tiquets de viatge | Captura r√†pida |
| `travelExpenseReport` | Liquidaci√≥ de despeses | Flux de liquidaci√≥ (NOU v1.27) |
| `mileageTravel` | Quilometratge de viatge | Registre de km (NOU v1.27) |
| `donors` | Gesti√≥ de donants | CRUD donants |
| `reports` | Informes fiscals | 182, 347, certificats |
| `projects` | M√≤dul projectes | Justificaci√≥ assistida |
| `monthlyFlow` | Flux mensual | Operativa recurrent |
| `yearEndFiscal` | Tancament fiscal | Fi d'any |
| `accessSecurity` | Acc√©s i seguretat | Multi-usuari |
| `initialLoad` | C√†rrega inicial | Primera configuraci√≥ |

**Format de traduccions (claus i18n):**

```
guides.{guideId}.title        ‚Äî T√≠tol de la guia
guides.{guideId}.intro        ‚Äî Introducci√≥ (opcional si whatIs)
guides.{guideId}.whatIs       ‚Äî Descripci√≥ breu
guides.{guideId}.steps.0-N    ‚Äî Passos ordenats
guides.{guideId}.avoid.0-N    ‚Äî Errors a evitar
guides.{guideId}.lookFirst.0-N ‚Äî Qu√® mirar primer
guides.{guideId}.doNext.0-N   ‚Äî Passos seg√ºents
guides.{guideId}.costlyError  ‚Äî Error cr√≠tic a destacar
guides.cta.{guideId}          ‚Äî Text del bot√≥ CTA
```

**Fitxers principals:**

| Fitxer | Funci√≥ |
|--------|--------|
| `src/app/[orgSlug]/dashboard/guides/page.tsx` | Hub central amb llista de guies |
| `src/i18n/locales/{ca,es,fr,pt}.json` | Traduccions (claus `guides.*`) |
| `scripts/i18n/validate-guides-translations.ts` | Validador de completitud |

**Validador i18n:**

```bash
npm run i18n:validate-guides
```

Comprova:
- Claus page-level obligat√≤ries (`guides.pageTitle`, `guides.viewManual`...)
- CTA per cada guia (`guides.cta.{guideId}`)
- T√≠tol i intro/whatIs per cada guia
- Arrays amb √≠ndexos consecutius (sense gaps)
- Claus extra que no existeixen al base (CA)


### 3.11.16 Exportaci√≥ Excel de justificaci√≥ per finan√ßadors (NOU v1.37)

Excel amb totes les despeses assignades a un projecte, pensat per entregar al finan√ßador.

**Punt d'entrada:** Pantalla de pressupost del projecte ‚Üí bot√≥ desc√†rrega o men√∫ ‚ãÆ ‚Üí "Exportar justificaci√≥ (Excel)"

**Di√†leg de selecci√≥ d'ordre:**

Abans de generar l'Excel, l'usuari escull com ordenar les files:

| Mode | Valor intern | Comportament |
|------|-------------|--------------|
| Per partida i data | `budgetLineThenChronological` | Agrupa per `budgetLineId`, dins de cada partida ordena per data. Per defecte. |
| Cronol√≤gic | `chronological` | Ordena totes les files per `dateExpense` ascendent, sense agrupaci√≥. |

**Columnes (A-L):**

| Col. | Cap√ßalera | Contingut | Format |
|------|-----------|-----------|--------|
| A | N√∫m. | N√∫mero correlatiu (recalculat segons ordre escollit) | Enter |
| B | Data | Data de la despesa | Date (Excel) |
| C | Concepte / Descripci√≥ | `concept` o `description` | Text |
| D | Prove√Ødor | `counterpartyName` | Text |
| E | N√∫m. factura | `invoiceNumber` (offBank directe, bank via `justification`) | Text |
| F | Partida | `budgetLineCode - budgetLineName` | Text |
| G | Tipus de canvi aplicat | `fxRate` de la despesa ‚Üí `projectFxRate` ‚Üí buit. 6 decimals. | `0.000000` |
| H | Import total (moneda despesa) | `|originalAmount|` si FX, `|amountEUR|` si EUR | `#,##0.00` |
| I | Moneda | `originalCurrency` o `EUR` | Text |
| J | Import total (EUR) | `|amountEUR|` | `#,##0.00` |
| K | Import imputat (moneda local) | `|originalAmount| √ó localPct / 100` (nom√©s si FX) | `#,##0.00` |
| L | Import imputat (EUR) | `amountAssignedEUR` de l'assignment | `#,##0.00` |

**Fila de totals:** Suma de columnes H, J, K, L.

**Cap√ßaleres tradu√Ødes:** Les etiquetes de columna es passen via `FundingColumnLabels` i es resolen amb `tr()` ‚Üí surten en l'idioma de l'usuari (ca/es/fr/pt).

**Fitxers:**

| Fitxer | Funci√≥ |
|--------|--------|
| `src/lib/project-justification-export.ts` | `buildProjectJustificationFundingXlsx()` ‚Äî generaci√≥ de l'Excel |
| `src/lib/project-justification-rows.ts` | `buildJustificationRows()` ‚Äî base de files (compartida amb ZIP) |
| `src/app/[orgSlug]/dashboard/project-module/projects/[projectId]/budget/page.tsx` | UI del di√†leg + invocaci√≥ |

**Tipus rellevants:**

```typescript
type FundingOrderMode = 'chronological' | 'budgetLineThenChronological';

interface FundingColumnLabels {
  order: string; date: string; concept: string; supplier: string;
  invoiceNumber: string; budgetLine: string; fxRateApplied: string;
  totalOriginalAmount: string; currency: string; totalEurAmount: string;
  assignedOriginalAmount: string; assignedEurAmount: string;
}
```

## 3.12 LIQUIDACIONS DE DESPESES (NOU v1.27)

Sistema per gestionar liquidacions de despeses de viatge i despla√ßaments amb tiquets, quilometratge i generaci√≥ de PDF.

### 3.12.1 Acc√©s i Ubicaci√≥

| Aspecte | Detall |
|---------|--------|
| **URL** | `/{orgSlug}/dashboard/movimientos/liquidacions` |
| **Requisit** | Feature flag `pendingDocs` activat |
| **Permisos** | Nom√©s `admin` pot crear/editar/arxivar |
| **Navegaci√≥** | Moviments ‚Üí Liquidacions |

### 3.12.2 Model de Dades

**Col¬∑lecci√≥ Firestore:** `organizations/{orgId}/expenseReports`

| Camp | Tipus | Descripci√≥ |
|------|-------|------------|
| `id` | string | Identificador Firestore |
| `status` | enum | `draft`, `submitted`, `matched`, `archived` |
| `title` | string? | Motiu/viatge |
| `dateFrom` | string? | Data inici (YYYY-MM-DD) |
| `dateTo` | string? | Data fi (YYYY-MM-DD) |
| `location` | string? | Ubicaci√≥/destinaci√≥ |
| `beneficiary` | object? | Qui rep el reemborsament |
| `receiptDocIds` | string[] | IDs de PendingDocuments (tickets) |
| `mileage` | object? | (Deprecated) quilometratge legacy |
| `mileageItems` | MileageItem[]? | L√≠nies individuals de quilometratge |
| `totalAmount` | number | Import total (tickets + km) |
| `notes` | string? | Notes addicionals |
| `matchedTransactionId` | string? | Transacci√≥ banc√†ria vinculada |
| `generatedPdf` | object? | Info PDF generat |
| `sepa` | object? | Info remesa SEPA |
| `payment` | object? | Info pagament (SEPA o futur) |
| `createdAt` | Timestamp | Data creaci√≥ |
| `updatedAt` | Timestamp | √öltima modificaci√≥ |
| `submittedAt` | Timestamp? | Data presentaci√≥ |

**Beneficiary (qui rep el reemborsament):**

| Variant | Camps |
|---------|-------|
| `employee` | `kind: 'employee'`, `employeeId: string` |
| `contact` | `kind: 'contact'`, `contactId: string` |
| `manual` | `kind: 'manual'`, `name: string`, `iban: string` |

**MileageItem (l√≠nia de quilometratge):**

| Camp | Tipus | Descripci√≥ |
|------|-------|------------|
| `id` | string | UUID de la l√≠nia |
| `date` | string | Data (YYYY-MM-DD) |
| `km` | number | Quil√≤metres |
| `rateEurPerKm` | number | Tarifa ‚Ç¨/km (defecte 0.26) |
| `totalEur` | number | Import calculat |
| `notes` | string? | Ruta / motiu |
| `attachment` | object? | Adjunt opcional |

### 3.12.3 Flux de Treball

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   DRAFT     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  SUBMITTED  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   MATCHED   ‚îÇ    ‚îÇ  ARCHIVED   ‚îÇ
‚îÇ (Esborrany) ‚îÇ    ‚îÇ (Presentada)‚îÇ    ‚îÇ (Conciliada)‚îÇ    ‚îÇ (Arxivada)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                  ‚îÇ                                     ‚ñ≤
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         (Arxivar directament)
```

**Estats:**

| Estat | Significat | Accions disponibles |
|-------|------------|---------------------|
| `draft` | Esborrany, en edici√≥ | Editar, PDF, Arxivar, Esborrar |
| `submitted` | Presentada, pendent pagament | Editar, PDF, Esborrar |
| `matched` | Vinculada a transacci√≥ banc√†ria | Nom√©s lectura |
| `archived` | Arxivada sense completar | Restaurar |

### 3.12.4 Tabs de la P√†gina

**Tabs principals:**

| Tab | Icona | Funci√≥ |
|-----|-------|--------|
| Liquidacions | FileText | Llista de liquidacions per estat |
| Tickets | Receipt | Safata de tiquets pendents |
| Quilometratge | Car | Gesti√≥ r√†pida de km |

**Subtabs de Liquidacions:**

| Subtab | Mostra |
|--------|--------|
| Esborranys | `status: 'draft'` |
| Presentades | `status: 'submitted'` |
| Conciliades | `status: 'matched'` |
| Arxivades | `status: 'archived'` |

### 3.12.5 Tickets Inbox

Component `<TicketsInbox>` per gestionar tiquets (PendingDocument amb `type: 'receipt'`).

**Funcionalitats:**
- Llista de tiquets amb preview
- Edici√≥ de camps (data, import, descripci√≥)
- Reprocessar amb IA (Sparkles)
- Arxivar tiquets
- Selecci√≥ m√∫ltiple per assignar a liquidaci√≥
- Upload de nous tiquets
- **Drag & drop (v1.28):** Arrossegar fitxers dins la card de tiquets per afegir-los directament

**Integraci√≥ amb PendingDocuments:**
- Els tickets s√≥n `PendingDocument` amb `type: 'receipt'`
- Es vinculen a la liquidaci√≥ via `receiptDocIds[]`
- En arxivar liquidaci√≥, es poden arxivar els tickets associats

**Drag & Drop de Tiquets (NOU v1.28):**
- La card de tiquets accepta drag & drop extern de fitxers
- Formats admesos: PDF, XML, JPG, JPEG, PNG
- Validaci√≥ al drop handler: si cap fitxer √©s v√†lid ‚Üí toast d'error (no s'obre modal buit)
- Els fitxers nous es pugen via modal Upload i es vinculen autom√†ticament a la liquidaci√≥

### 3.12.6 Quilometratge Multil√≠nia

**Evoluci√≥:**
- **v1.26 i anteriors:** Camp `mileage` amb una sola l√≠nia
- **v1.27+:** Array `mileageItems[]` amb m√∫ltiples l√≠nies

**Compatibilitat:**
- Si existeix `mileageItems[]`, t√© prioritat
- Si nom√©s existeix `mileage` (legacy), es mostra com a l√≠nia √∫nica
- En editar, es migra autom√†ticament a `mileageItems[]`

**Tarifa per defecte:** 0.26 ‚Ç¨/km (configurable per l√≠nia)

**Adjunts per l√≠nia:**
- Cada `MileageItem` pot tenir un adjunt opcional (`attachment`)
- Emmagatzematge: `organizations/{orgId}/expenseReports/{reportId}/mileage_{itemId}_{filename}`

### 3.12.7 Generaci√≥ de PDF

**Ubicaci√≥:** `src/lib/expense-reports/generate-pdf.ts`

**Contingut del PDF:**
- Cap√ßalera amb nom organitzaci√≥ i liquidaci√≥
- Dades del beneficiari
- Llista de tickets amb import
- Llista de quilometratge per l√≠nia
- Total desglossat (tickets + km)
- Notes addicionals

**Emmagatzematge:**
- Path: `organizations/{orgId}/expenseReports/{reportId}/liquidacio.pdf`
- Nom: `liquidacio_{reportId}.pdf`

**Tecnologia:** jsPDF (generaci√≥ client-side)

### 3.12.8 Deep Linking

El tab de quilometratge suporta deep linking amb scroll autom√†tic:

```
/{orgSlug}/dashboard/movimientos/liquidacions/{id}?tab=kilometratge
```

**Implementaci√≥:**
- Query param `tab=kilometratge` selecciona el tab
- Scroll autom√†tic a la secci√≥ de quilometratge
- Highlight temporal (parpadeig) de la secci√≥

### 3.12.9 Guies Relacionades

| ID Guia | T√≠tol | Enlla√ß |
|---------|-------|--------|
| `travelExpenseReport` | Liquidaci√≥ de despeses | CTA ‚Üí Liquidacions |
| `mileageTravel` | Quilometratge de viatge | CTA ‚Üí Liquidacions?tab=quilometratge |
| `travelReceipts` | Tiquets de viatge | CTA ‚Üí Quick Expense |

### 3.12.10 Fitxers Principals

| Fitxer | Funci√≥ |
|--------|--------|
| `src/app/[orgSlug]/dashboard/movimientos/liquidacions/page.tsx` | P√†gina principal |
| `src/app/[orgSlug]/dashboard/movimientos/liquidacions/[id]/page.tsx` | Detall liquidaci√≥ |
| `src/components/expense-reports/expense-report-detail.tsx` | Component detall |
| `src/components/expense-reports/tickets-inbox.tsx` | Safata de tickets |
| `src/lib/expense-reports/types.ts` | Tipus TypeScript |
| `src/lib/expense-reports/api.ts` | CRUD Firestore |
| `src/lib/expense-reports/generate-pdf.ts` | Generador PDF |
| `src/lib/expense-reports/refs.ts` | Refer√®ncies Firestore |

### 3.12.11 Traduccions i18n

**Namespace:** `expenseReports.*`

| Clau | Descripci√≥ |
|------|------------|
| `expenseReports.title` | T√≠tol p√†gina |
| `expenseReports.subtitle` | Subt√≠tol |
| `expenseReports.statuses.*` | Etiquetes d'estat |
| `expenseReports.tooltips.*` | Tooltips d'estat |
| `expenseReports.tabs.*` | Labels dels tabs |
| `expenseReports.actions.*` | Botons d'acci√≥ |
| `expenseReports.empty.*` | Empty states |
| `expenseReports.toasts.*` | Missatges toast |
| `expenseReports.details.*` | Detalls (receipts, km) |
| `expenseReports.confirmDelete.*` | Modal confirmaci√≥ |
| `expenseReports.banners.*` | Banners informatius |


## 3.10 PANELL SUPERADMIN GLOBAL (NOU v1.20)

Panell de control exclusiu per al SuperAdmin del sistema, accessible des de `/admin`.

### 3.10.1 Acc√©s i Seguretat

| Aspecte | Detall |
|---------|--------|
| **URL** | `/admin` (sense orgSlug) |
| **Acc√©s** | Nom√©s `SUPER_ADMIN_UID` (definit a `src/lib/data.ts`) |
| **Redirecci√≥** | Si no √©s SuperAdmin ‚Üí redirigeix a `/dashboard` |

### 3.10.2 Funcionalitats

| Secci√≥ | Descripci√≥ |
|--------|------------|
| **Estad√≠stiques** | Total organitzacions, actives, suspeses |
| **Llista d'organitzacions** | Taula amb nom, CIF, estat, data creaci√≥ |
| **Accions per organitzaci√≥** | Entrar (impersonar), suspendre/reactivar |
| **Nova organitzaci√≥** | Crear organitzaci√≥ manualment |
| **Migrar slugs** | Migraci√≥ d'organitzacions sense slug |

### 3.10.3 Reset de Contrasenya (NOU v1.20)

Secci√≥ per enviar correus de restabliment de contrasenya:

| Element | Detall |
|---------|--------|
| **Input** | Email de l'usuari |
| **Acci√≥** | `sendPasswordResetEmail()` de Firebase Auth |
| **Seguretat** | Missatge gen√®ric sempre ("Si l'adre√ßa existeix...") per no revelar si l'email existeix |

### 3.10.4 Secci√≥ Diagn√≤stic (NOU v1.20)

Enlla√ßos r√†pids per a manteniment i diagn√≤stic:

| Enlla√ß | Dest√≠ |
|--------|-------|
| **Firebase Console** | `console.firebase.google.com/project/summa-social/overview` |
| **Cloud Logging** | `console.cloud.google.com/logs/query?project=summa-social` |
| **DEV-SOLO-MANUAL.md** | Path copiable al porta-retalls |

### 3.10.5 Salut del Sistema - Sentinelles (NOU v1.23)

Sistema autom√†tic de detecci√≥ d'incid√®ncies accessible nom√©s des de `/admin`.

**Model de dades:** Col¬∑lecci√≥ `systemIncidents` a Firestore (nom√©s SuperAdmin pot llegir).

**Sentinelles:**

| ID | Nom | Tipus | Qu√® detecta |
|----|-----|-------|-------------|
| S1 | Permisos | CRITICAL | Errors "Missing or insufficient permissions" |
| S2 | Moviments | CRITICAL | Errors CLIENT_CRASH a ruta /movimientos |
| S3 | Importadors | CRITICAL | Errors d'importaci√≥ (banc, CSV, Stripe) |
| S4 | Exports | CRITICAL | Errors d'exportaci√≥ (Excel, PDF, SEPA) |
| S5 | Remeses OUT | CRITICAL | Invariants violades (deltaCents‚â†0, isValid=false) |
| S6 | Encallaments | CONSULTA | Transaccions sense classificar > 30 dies |
| S7 | Fiscal 182 | CONSULTA | Donants sense dades fiscals |
| S8 | Activitat | CONSULTA | Organitzacions inactives > 60 dies |
| S9 | Storage | CRITICAL | Errors `storage/unauthorized` (v1.28) |

**Storage Unauthorized (NOU v1.28):**
- Detecta errors de permisos de Firebase Storage
- Afecta: upload de pendingDocuments, generaci√≥ PDF liquidacions
- Report autom√†tic com a incident CRITICAL si passa a ruta core (/pendents, /liquidacions)
- Path sanititzat: sense tokens ni URLs signades

**Pol√≠tica d'alertes:**
- S1‚ÄìS5, S9: Generen incidents autom√†tics quan es detecta l'error
- S6‚ÄìS8: Nom√©s consulta, sense incidents autom√†tics

**Deduplicaci√≥:**
- Cada error genera una `signature` √∫nica (hash de type+route+message+stack)
- Si el mateix error es repeteix, s'incrementa el comptador
- Si un incident RESOLVED torna a apar√®ixer, es reobre autom√†ticament

**Accions disponibles:**
- **ACK**: Silencia temporalment (l'he vist, per√≤ encara treballo en la soluci√≥)
- **Resolt**: Tanca l'incident (corregit)

**Filtres anti-soroll:**
Errors ignorats autom√†ticament (no creen incidents):
- `ERR_BLOCKED_BY_CLIENT` ‚Äî Adblockers o extensions del navegador
- `ResizeObserver loop` ‚Äî Error benigne de layout
- `ChunkLoadError` / `Loading chunk` ‚Äî Problemes de xarxa temporals
- `Network request failed` / `Failed to fetch` ‚Äî Xarxa temporal
- `Script error.` ‚Äî Errors cross-origin sense informaci√≥ √∫til
- `AbortError` ‚Äî Requests cancel¬∑lats intencionalment

**Fitxers principals:**
- `src/lib/system-incidents.ts` ‚Äî Model, deduplicaci√≥, filtres, buildIncidentFixPack
- `src/components/ErrorBoundaryGlobal.tsx` ‚Äî Capturador client
- `src/components/admin/system-health.tsx` ‚Äî UI sentinelles + bot√≥ "Copiar prompt"
- `functions/src/alerts/sendIncidentAlert.ts` ‚Äî Cloud Function alertes email

**Alertes email (v1.1):**
- Cloud Function `sendIncidentAlert` envia email via Resend (prove√Ødor ja existent)
- Criteris d'enviament:
  - `severity === CRITICAL`
  - `status === OPEN` (mai si ACK o RESOLVED)
  - `count >= 2` O ruta core (movimientos, fiscalitat, project-module...)
  - Cooldown 24h per incident (un email per finestra)
- Email inclou prompt de reparaci√≥ per Claude Code
- Flag `ALERTS_ENABLED` (per defecte `false` en dev)
- Sense depend√®ncies noves: usa Resend API directament

**L√≠mits:**
- Nom√©s visible per SuperAdmin a `/admin`
- S6‚ÄìS8 requereixen implementaci√≥ de consultes espec√≠fiques

### 3.10.5b Integritat de Dades - Diagn√≤stic P0 (NOU v1.33)

Panell de diagn√≤stic d'integritat de dades accessible per administradors d'organitzaci√≥ al Dashboard.

**Ubicaci√≥:** Dashboard ‚Üí secci√≥ "Integritat de dades" (nom√©s visible per `userRole === 'admin'`)

**Blocs de verificaci√≥ (deterministes, sense heur√≠stiques):**

| Bloc | Qu√® detecta | Criteri |
|------|-------------|---------|
| **A) Categories legacy** | Categories guardades com nameKey (format pre-FASE0) | `category` √©s un nameKey conegut (ex: "donations_general") en lloc de docId |
| **B) Dates: formats** | Barreja de formats o dates inv√†lides | Classifica YYYY-MM-DD, ISO_WITH_T, INVALID |
| **C) Origen bancari** | Incoher√®ncies source ‚Üî bankAccountId | `source=bank\|stripe` sense bankAccountId (P0 error) |
| **D) ArchivedAt** | Transaccions arxivades al conjunt normal | `archivedAt != null` en queries no filtrades |
| **E) Signs per tipus** | Amount incompatible amb transactionType | donation‚Üí>0, return‚Üí<0, fee‚Üí<0, etc. |

**Comportament:**
- Diagn√≤stic nom√©s (no corregeix autom√†ticament)
- Mostra recompte i m√†xim 5 exemples per bloc
- Blocs amb issues s'obren autom√†ticament (HTML `<details>`)
- Log a consola si `totalIssues > 0` amb orgId i counts

**Fitxers:**
- `src/lib/category-health.ts` ‚Äî Checks i funci√≥ `runHealthCheck()`
- `src/app/[orgSlug]/dashboard/page.tsx` ‚Äî UI Card + Dialog

### 3.10.5c Guardrails d'Integritat: Categories i Eixos (NOU v1.35)

Guardrails per evitar inconsist√®ncies referenci√†ries quan s'arxiven categories o eixos d'actuaci√≥.

**Invariants:**

| ID | Descripci√≥ | Enforce |
|----|------------|---------|
| I1 | Prohibit delete f√≠sic de categories | `allow delete: if false` (Firestore Rules) |
| I2 | Prohibit delete f√≠sic de projects (eixos) | `allow delete: if false` (Firestore Rules) |
| I3 | Client no pot escriure archivedAt/ByUid/FromAction | Rules bloquegen modificaci√≥ de camps arxivat |
| I4 | Arxivat requereix 0 refer√®ncies actives | API `/api/categories/archive` i `/api/projects/archive` |
| I5 | Tra√ßa obligat√≤ria | `archivedByUid` + `archivedFromAction` sempre presents |

**Flux d'arxivat:**

1. Usuari clica "Arxivar" a UI (icona Archive, no Trash)
2. Sistema compta transaccions actives (`archivedAt == null`) amb refer√®ncia
3. Si count > 0 ‚Üí Modal de reassignaci√≥ obligatori
4. Si count == 0 ‚Üí Confirmaci√≥ directa
5. API escriu `archivedAt` (serverTimestamp), `archivedByUid`, `archivedFromAction`

**Camps afegits als tipus:**

```typescript
// Category i Project
archivedAt?: Timestamp | null;      // Quan arxivat (serverTimestamp)
archivedByUid?: string | null;      // UID de qui ha arxivat
archivedFromAction?: string | null; // 'archive-category-api' | 'archive-project-api'
```

**APIs:**

| Endpoint | Funci√≥ |
|----------|--------|
| `POST /api/categories/archive` | Arxiva categoria amb reassignaci√≥ opcional |
| `POST /api/projects/archive` | Arxiva eix amb reassignaci√≥ opcional |

**Validacions de les APIs:**
- Auth: token v√†lid requerit
- orgId: derivat de membership (no del body)
- Rol: admin per categories, admin/user per projects
- fromId: ha d'existir i no estar ja arxivat (idempotent si ja ho est√†)
- toId (si present): ha d'existir, no arxivat, diferent de fromId
- Count actiu: query real `where('category/projectId', '==', fromId) AND archivedAt == null`
- Si count > 0 sense toId ‚Üí error 400

**Health Check (orfes):**

Nous blocs al diagn√≤stic P0:
- **F) Categories √≤rfenes**: `tx.category` apunta a doc inexistent
- **G) Projects orfes**: `tx.projectId` apunta a doc inexistent

Nota: Una categoria/eix arxivat NO √©s orfe (el doc existeix). Orfe = el document no existeix.

**Fitxers:**
- `src/app/api/categories/archive/route.ts` ‚Äî API arxivar categories
- `src/app/api/projects/archive/route.ts` ‚Äî API arxivar eixos
- `src/components/reassign-modal.tsx` ‚Äî Modal reassignaci√≥
- `src/components/category-manager.tsx` ‚Äî UI categories (flux arxivat)
- `src/components/project-manager.tsx` ‚Äî UI eixos (flux arxivat)
- `firestore.rules` ‚Äî Rules actualitzades

### 3.10.5d Guardrails d'Integritat: Comptes Bancaris (NOU v1.36 - FASE 2A)

Guardrails per evitar desactivar comptes bancaris que tenen moviments associats.

**Invariants:**

| ID | Descripci√≥ | Enforce |
|----|------------|---------|
| B1 | Prohibit delete f√≠sic de bankAccounts | `allow delete: if false` (Firestore Rules) |
| B2 | Client no pot escriure isActive/deactivatedAt/ByUid/FromAction | Rules bloquegen |
| B3 | Desactivaci√≥ requereix 0 transaccions | API `/api/bank-accounts/deactivate` |
| B4 | Tra√ßa obligat√≤ria | `deactivatedByUid` + `deactivatedFromAction` |

**Difer√®ncia amb Categories/Eixos:** NO hi ha reassignaci√≥ possible. Si el compte t√© moviments, simplement no es pot desactivar.

**Flux:**
1. Usuari clica "Desactivar" compte
2. API compta TOTES les transaccions (actives + arxivades) amb `bankAccountId == accountId`
3. Si count > 0 ‚Üí Error amb toast "Compte t√© X moviments"
4. Si count == 0 ‚Üí Desactiva (`isActive: false`)

**API:** `POST /api/bank-accounts/deactivate`
- Body: `{ orgId, bankAccountId }`
- Resposta error: `{ code: 'HAS_TRANSACTIONS', transactionCount }`

**Health Check:** Bloc H detecta transaccions amb `bankAccountId` que no existeix a la col¬∑lecci√≥ bankAccounts.

### 3.10.5e Guardrails d'Integritat: Contactes (NOU v1.36 - FASE 2B)

Guardrails per evitar arxivar contactes (donants/prove√Ødors/treballadors) amb moviments actius.

**Invariants:**

| ID | Descripci√≥ | Enforce |
|----|------------|---------|
| C1 | Prohibit delete f√≠sic de contactes | `allow delete: if false` (Firestore Rules) |
| C2 | Client no pot escriure archivedAt/ByUid/FromAction | Rules bloquegen |
| C3 | Arxivat bloqueig per moviments ACTIUS | API `/api/contacts/archive` |
| C4 | Moviments arxivats NO bloquegen | Nom√©s `activeCount > 0` bloqueja |

**Difer√®ncia clau:** Un contacte amb 0 moviments actius + N moviments arxivats (historial) S√ç es pot arxivar.

**Flux amb dryRun:**
1. Usuari clica "Eliminar" contacte
2. UI crida API amb `dryRun: true`
3. API retorna `{ activeCount, archivedCount, canArchive }`
4. Si `canArchive: false` ‚Üí Modal informatiu amb desglossament
5. Si `canArchive: true` ‚Üí Modal confirmaci√≥ ‚Üí API sense dryRun

**API:** `POST /api/contacts/archive`
- Body: `{ orgId, contactId, dryRun?: boolean }`
- Resposta dryRun: `{ activeCount, archivedCount, canArchive }`
- Resposta error: `{ code: 'HAS_TRANSACTIONS', activeCount, archivedCount }`

**Health Check:** Bloc I detecta transaccions amb `contactId` que no existeix a la col¬∑lecci√≥ contacts.

**Updates de contactes via Admin API (v1.36+):**

Les Firestore Rules exigeixen immutabilitat de `archivedAt`/`archivedByUid`/`archivedFromAction` en updates. Amb `setDoc(merge: true)` client-side, un camp absent s'interpreta com `null` ‚â† valor existent ‚Üí `permission-denied`.

Soluci√≥: tots els updates de contactes passen per `POST /api/contacts/import` (Admin SDK), que:
1. Valida auth + membership (role `admin|user`)
2. Descarta `archived*` del payload client
3. Preserva `archived*` del document existent
4. Escriu amb Admin SDK (bypassa rules)

Flux d'edici√≥ de donant: UI ‚Üí `updateContactViaApi()` (`src/services/contacts.ts`) ‚Üí `/api/contacts/import` ‚Üí Admin SDK.

**Creates** (nous contactes) continuen client-side (`addDocumentNonBlocking`).

Fitxers: `src/app/api/contacts/import/route.ts`, `src/services/contacts.ts`.

Migrat: `donor-manager.tsx` (commits `d9c7ae0`, `9c3be85`). Pendent: `supplier-manager.tsx`, `employee-manager.tsx`.

**Fix Firestore Rules `.get()` per camps archived (v1.41):**

Les regles d'update accedien directament a `resource.data.archived`, que llan√ßava error si el camp no existia al document (documents creats abans del sistema d'arxivat). Ara s'utilitza `resource.data.get('archived', null)` per defecte segur. Afecta totes les regles d'update que comprovaven el camp `archived`.

### 3.10.5f Guardrails d'Integritat: Liquidacions (NOU v1.36 - FASE 2C)

Guardrails per evitar arxivar liquidacions (ExpenseReports) que tenen tiquets pendents.

**Invariants:**

| ID | Descripci√≥ | Enforce |
|----|------------|---------|
| L1 | Prohibit delete f√≠sic de expenseReports | `allow delete: if false` (Firestore Rules) |
| L2 | Client no pot canviar status a 'archived' | Rules bloquegen transici√≥ |
| L3 | Client no pot escriure archivedAt/ByUid/FromAction | Rules bloquegen |
| L4 | Arxivat bloqueig per tiquets PENDENTS | API `/api/expense-reports/archive` |
| L5 | Tiquets `matched` NO bloquegen | Nom√©s `status !== 'matched'` compta |
| L6 | Liquidacions `matched` NO es poden arxivar | Conciliades s√≥n immutables |

**Qu√® pot fer l'usuari:**

| Acci√≥ | Perm√®s? | Condicions |
|-------|---------|------------|
| Crear liquidaci√≥ | ‚úÖ | Sempre |
| Editar liquidaci√≥ | ‚úÖ | Si `status = draft` o `submitted` |
| Enviar liquidaci√≥ | ‚úÖ | Si `status = draft` |
| Arxivar liquidaci√≥ | ‚úÖ | Si NO t√© tiquets pendents |
| Restaurar liquidaci√≥ | ‚úÖ | Si `status = archived` |
| Esborrar liquidaci√≥ | ‚ùå | PROHIBIT |

**Flux amb dryRun:**
1. Usuari clica "Arxivar" liquidaci√≥
2. UI crida API amb `dryRun: true`
3. API retorna `{ pendingCount, matchedCount, canArchive }`
4. Si `pendingCount > 0` ‚Üí Modal informatiu
5. Si `pendingCount == 0` ‚Üí Arxiva directament

**API:** `POST /api/expense-reports/archive`
- Body: `{ orgId, reportId, dryRun?: boolean }`
- Resposta dryRun: `{ pendingCount, matchedCount, canArchive, code }`
- Resposta error: `{ code: 'HAS_PENDING_TICKETS', pendingCount, matchedCount }`
- Resposta error: `{ code: 'IS_MATCHED' }` (liquidaci√≥ conciliada)

**Health Check:** Bloc J detecta tiquets (`pendingDocuments`) amb `reportId` que no existeix a `expenseReports`.

**Fitxers:**
- `src/app/api/expense-reports/archive/route.ts` ‚Äî API arxivar liquidacions
- `src/app/[orgSlug]/dashboard/movimientos/liquidacions/page.tsx` ‚Äî UI liquidacions
- `src/lib/category-health.ts` ‚Äî checkOrphanTickets()

### 3.10.5g Resum Complet de Guardrails d'Integritat (ACTUALITZAT v1.40)

**Taula resum de totes les entitats protegides:**

| Entitat | Delete f√≠sic | Arxivat/Desactivat | Condici√≥ bloqueig | Reassignaci√≥ |
|---------|--------------|--------------------|--------------------|--------------|
| Categories | ‚ùå Prohibit | Via API | Moviments actius > 0 | ‚úÖ Obligat√≤ria |
| Eixos (Projects) | ‚ùå Prohibit | Via API | Moviments actius > 0 | ‚úÖ Obligat√≤ria |
| Comptes bancaris | ‚ùå Prohibit | Via API | Qualsevol moviment | ‚ùå No aplica |
| Contactes | ‚ùå Prohibit | Via API | Moviments actius > 0 | ‚ùå No aplica |
| Liquidacions | ‚ùå Prohibit | Via API | Tiquets pendents > 0 | ‚ùå No aplica |

**Health Check blocs d'integritat referencial:**

| Bloc | Detecta | Severitat |
|------|---------|-----------|
| F | Categories √≤rfenes (`tx.category` ‚Üí doc inexistent) | Warning |
| G | Projects orfes (`tx.projectId` ‚Üí doc inexistent) | Warning |
| H | BankAccounts orfes (`tx.bankAccountId` ‚Üí doc inexistent) | Warning |
| I | Contactes orfes (`tx.contactId` ‚Üí doc inexistent) | Warning |
| J | Tiquets orfes (`pendingDoc.reportId` ‚Üí doc inexistent) | Warning |
| K | Remeses √≤rfenes (fills amb `parentTransactionId` inexistent) | Warning |
| L | ExpenseLinks orfes (`txId` inexistent a transactions) | Warning |

**Nota v1.40:** Blocs K i L afegits. K integrat al dashboard de health; L exportat com a funci√≥ independent (`checkOrphanExpenseLinks()`) per√≤ no integrat al dashboard general perqu√® `expenseLinks` no es carreguen a la vista principal.

### 3.10.5h Admin SDK Compartit (NOU v1.40)

Centralitzaci√≥ de la inicialitzaci√≥ de Firebase Admin SDK en un √∫nic helper, eliminant ~500 l√≠nies de codi duplicat a les rutes API.

**Helper centralitzat:** `src/lib/api/admin-sdk.ts`

**Exports:**

| Export | Funci√≥ |
|--------|--------|
| `getAdminApp()` | Inst√†ncia singleton de l'app Admin |
| `getAdminDb()` | Refer√®ncia a Firestore Admin |
| `getAdminAuth()` | Refer√®ncia a Auth Admin |
| `verifyIdToken(token)` | Verifica i retorna el decoded token |
| `validateUserMembership(orgId, uid, roles?)` | Valida que l'usuari pertany a l'org amb rol adequat |
| `BATCH_SIZE` | Constant = 50 (m√†xim ops per batch Firestore) |
| `requireOperationalAccess(req)` | Valida acc√©s admin/user + superadmin bypass (NOU v1.41) |

**INVARIANT:** `BATCH_SIZE = 50` ‚Äî Firestore limita a 500 ops per batch, per√≤ per seguretat s'usa 50. No negociable.

**Inicialitzaci√≥:** Singleton cached (no reinit per request). Si ja existeix una app inicialitzada, la reutilitza.

**Rutes migrades a Admin SDK:**
- `POST /api/categories/archive`
- `POST /api/projects/archive`
- `POST /api/bank-accounts/archive`
- `POST /api/expense-reports/archive`
- `POST /api/contacts/archive`
- `POST /api/contacts/import`
- `POST /api/invitations/resolve` (NOU v1.40)
- `POST /api/invitations/accept` (NOU v1.40)

### 3.10.5h2 Acc√©s Operatiu Unificat (NOU v1.41)

Helper centralitzat que valida acc√©s operatiu (admin + user) amb bypass per superadmin, eliminant codi duplicat a les rutes API d'arxivat.

**Helper:** `src/lib/api/require-operational-access.ts`

**Signatura:** `requireOperationalAccess(req: NextRequest): Promise<{ orgId, uid, memberDoc }>`

**Qu√® fa:**
1. Extreu i verifica el token d'autenticaci√≥ (`Authorization: Bearer`)
2. Extreu `orgId` del body
3. Comprova membership amb rol `admin` o `user`
4. Si l'usuari √©s superadmin ‚Üí bypass (no cal membership)
5. Retorna `{ orgId, uid, memberDoc }` per √∫s de la ruta

**Rutes que l'usen:**
- `POST /api/categories/archive`
- `POST /api/projects/archive`
- `POST /api/bank-accounts/archive`
- `POST /api/expense-reports/archive`
- `POST /api/contacts/archive`
- `POST /api/contacts/import`

### 3.10.5i Registre i Invitacions via Admin API (NOU v1.40)

El flux de registre d'usuaris convidats ha estat migrat a Admin SDK per resoldre problemes amb les Firestore Rules que bloquejaven l'escriptura client.

**Problema:** Les Firestore Rules impedien que un usuari acabat de crear (sense document `members/{uid}` encara) pogu√©s escriure el seu propi document de membre.

**Soluci√≥:** Dues noves rutes API que operen amb Admin SDK:

| Ruta | Funci√≥ |
|------|--------|
| `POST /api/invitations/resolve` | Llegeix la invitaci√≥ per codi (Admin SDK, bypassa rules de lectura) |
| `POST /api/invitations/accept` | Crea el document `members/{uid}`, marca invitaci√≥ com `accepted`, assigna `organizationId` al perfil |

**Flux complet:**
1. Usuari obre link d'invitaci√≥ ‚Üí p√†gina `/registre?code=XXX`
2. UI crida `/api/invitations/resolve` amb el codi ‚Üí retorna dades de la invitaci√≥ (orgId, email, role)
3. Usuari crea compte Firebase Auth (email + password)
4. UI crida `/api/invitations/accept` amb `{ orgId, invitationId, uid, email, role }` ‚Üí Admin SDK crea membre + actualitza invitaci√≥

**Fitxers:**
- `src/app/api/invitations/resolve/route.ts` ‚Äî Resolve invitaci√≥
- `src/app/api/invitations/accept/route.ts` ‚Äî Acceptar invitaci√≥
- `src/app/registre/page.tsx` ‚Äî P√†gina de registre

### 3.10.6 Fitxers principals

| Fitxer | Funci√≥ |
|--------|--------|
| `src/app/admin/page.tsx` | P√†gina del panell SuperAdmin |
| `src/components/admin/create-organization-dialog.tsx` | Modal crear organitzaci√≥ |
| `src/lib/data.ts` | Constant `SUPER_ADMIN_UID` |
| `src/lib/api/admin-sdk.ts` | Helper centralitzat Admin SDK (NOU v1.40) |
| `src/lib/api/require-operational-access.ts` | Validaci√≥ acc√©s operatiu unificat (NOU v1.41) |
| `src/lib/donors/periodicity-suffix.ts` | Sufix periodicitat quota (NOU v1.41) |

### 3.10.7 Backup Local d'Organitzacions (NOU v1.28)

Funcionalitat per descarregar un backup complet d'una organitzaci√≥ en format JSON.

**Acc√©s:**
- Nom√©s SuperAdmin (verificaci√≥ server-side)
- Des del panell `/admin` ‚Üí Men√∫ ‚ãÆ d'una organitzaci√≥ ‚Üí "Backup local"

**Contingut del backup:**

| Col¬∑lecci√≥ | Incl√≤s |
|------------|--------|
| `organization` | Dades principals de l'org |
| `categories` | Totes les categories |
| `bankAccounts` | Comptes bancaris |
| `members` | Membres de l'org |
| `transactions` | Tots els moviments (paginat) |
| `contacts` | Donants, prove√Ødors, treballadors (paginat) |
| `remittances` | Remeses processades |
| `pendingDocuments` | Documents pendents |
| `expenseReports` | Liquidacions |
| `projectModule/*` | Projects, budgetLines, expenses (si existeix) |

**Camps sensibles exclosos:**
- `accessToken`, `refreshToken` ‚Äî Tokens
- `downloadUrl`, `signedUrl`, `tempUrl` ‚Äî URLs signades
- `logoUrl`, `signatureUrl`, `document`, `documentUrl` ‚Äî URLs de Storage

**Format de sortida:**
```json
{
  "schemaVersion": 1,
  "exportedAt": "2026-01-06T...",
  "orgId": "abc123",
  "orgSlug": "entitat-demo",
  "counts": { "transactions": 1234, ... },
  "data": { ... }
}
```

**Fitxer descarregat:** `summa_backup_{slug}_{YYYY-MM-DD}.json`

**Fitxers principals:**
- `src/app/api/admin/orgs/[orgId]/backup/local/route.ts` ‚Äî API Route
- `src/lib/admin/org-backup-export.ts` ‚Äî L√≤gica d'exportaci√≥

**Nota:** Aquesta funcionalitat √©s independent de la integraci√≥ de backups autom√†tics al n√∫vol. Permet desc√†rregues manuals puntuals per a migracions o auditories.


### 3.10.8 Backups al n√∫vol (Dropbox / Google Drive) ‚Äî DESACTIVAT

**ESTAT ACTUAL: DESACTIVAT (gener 2026)**

Aquesta funcionalitat est√† **desactivada per defecte**. El codi existeix per√≤ no √©s operatiu:
- La UI no mostra cap secci√≥ de backups al n√∫vol a Configuraci√≥
- Les rutes OAuth retornen 404
- El scheduler setmanal fa early-return sense processar
- Cap banner ni av√≠s apareix al Dashboard

El mecanisme **oficial i √∫nic** de backup √©s el **backup local** (secci√≥ 3.10.7), accessible nom√©s per SuperAdmin des de `/admin`.

#### Per qu√® est√† desactivat

- Funcionalitat mai verificada en producci√≥
- Dep√®n d'APIs de tercers que poden canviar sense av√≠s
- Complexitat operativa sense valor afegit demostrat
- El backup local cobreix les necessitats actuals

#### Com reactivar (si cal en el futur)

Canviar les constants `CLOUD_BACKUPS_ENABLED` / `CLOUD_BACKUPS_UI_ENABLED` a `true` en els fitxers seg√ºents:
- `src/components/backups-settings.tsx` (UI)
- `functions/src/backups/runWeeklyBackup.ts` (scheduler)
- `functions/src/backups/runBackupForOrg.ts` (executor)
- `src/app/api/integrations/backup/*/route.ts` (rutes OAuth)

A m√©s, caldria:
1. Configurar variables d'entorn (DROPBOX_APP_*, GOOGLE_DRIVE_*)
2. Registrar redirect URIs als prove√Ødors
3. Redesplegar Cloud Functions
4. Verificar el flux complet abans d'oferir-ho a usuaris

---

**La resta d'aquesta secci√≥ documenta la implementaci√≥ per refer√®ncia futura, per√≤ NO √©s funcionalitat activa.**

---

#### Visi√≥ i l√≠mits (contracte ‚Äî si s'activa)

- **Opcional**: cap entitat l'ha de tenir activat per defecte.
- **No garantit**: dep√®n d'APIs de tercers (Dropbox, Google) que poden canviar sense av√≠s.
- **Responsabilitat compartida**: Summa Social puja les dades; la cust√≤dia i permisos de la carpeta s√≥n responsabilitat de l'entitat.
- **Pot fallar**: si el token expira, si el prove√Ødor revoca acc√©s, si s'excedeix quota, o si hi ha errors de xarxa.

#### Qu√® es guarda (abast de dades)

Segons implementaci√≥ actual a `functions/src/backups/exportFirestoreOrg.ts`:

| Col¬∑lecci√≥ | Incl√≤s |
|------------|--------|
| `organization` | Dades principals de l'org |
| `categories` | Totes les categories |
| `contacts` | Donants, prove√Ødors, empleats (per tipus) |
| `transactions` | Totes les transaccions |
| `members` | Tots els membres |
| `projects` | Tots els projectes |
| `remittances` | Totes les remeses |

**NO inclou:**
- Tokens OAuth (ni de backup ni d'altres integracions)
- Fitxers binaris de Firebase Storage
- URLs signades
- Subcol¬∑leccions no llistades (integrations, backupOAuthRequests, etc.)

El dataset √©s equivalent al backup local (secci√≥ 3.10.7).

#### On es configura (UX)

Ruta: `/{orgSlug}/dashboard/configuracion` ‚Üí secci√≥ **C√≤pies de seguretat**

Flux:
1. Seleccionar prove√Ødor (Dropbox o Google Drive)
2. Clicar **Connectar** ‚Üí redirecci√≥ OAuth al prove√Ødor
3. Autoritzar acc√©s a l'app
4. Retorn autom√†tic a configuraci√≥ amb estat "Connectat"
5. Opci√≥: executar backup manual amb bot√≥ "Executar ara"
6. Alternativa: esperar backup autom√†tic setmanal

Nom√©s usuaris amb rol `admin` poden connectar/desconnectar prove√Ødors.

#### Prove√Ødors suportats

| Prove√Ødor | Estat | Carpeta dest√≠ |
|-----------|-------|---------------|
| Dropbox | Implementat | `/Summa Social/{orgSlug}/backups/{YYYY-MM-DD}/` |
| Google Drive | Implementat | Carpeta `Summa Social/{orgSlug}/backups/{YYYY-MM-DD}/` |

#### Requisits t√®cnics (variables d'entorn)

**Per Dropbox:**
```
DROPBOX_APP_KEY=<clau de l'app Dropbox>
DROPBOX_APP_SECRET=<secret de l'app Dropbox>
```

**Per Google Drive:**
```
GOOGLE_DRIVE_CLIENT_ID=<Client ID de Google Cloud Console>
GOOGLE_DRIVE_CLIENT_SECRET=<Client Secret de Google Cloud Console>
```

**Redirect URIs necess√†ries (registrar a cada prove√Ødor):**
- Dropbox: `https://{domini}/api/integrations/backup/dropbox/callback`
- Google Drive: `https://{domini}/api/integrations/backup/google-drive/callback`

Sense aquestes variables configurades, la funcionalitat no estar√† operativa. La UI mostra l'error "integration not configured" si falten.

#### OAuth: flux alt nivell

```
1. UI crida POST /api/integrations/backup/{provider}/start
2. API crea BackupOAuthRequest one-shot (expira 10 min)
3. API retorna URL d'autoritzaci√≥ del prove√Ødor
4. Usuari autoritza a Dropbox/Google
5. Prove√Ødor redirigeix a /api/integrations/backup/{provider}/callback
6. Callback valida state, intercanvia code per tokens
7. Refresh token es desa a /organizations/{orgId}/integrations/backup
8. Estat passa a "connected"
```

Els tokens es guarden a Firestore, xifrats en rep√≤s per Firebase.

#### Automatitzaci√≥ setmanal

Segons implementaci√≥ a `functions/src/backups/runWeeklyBackup.ts`:

- **Scheduler**: Cloud Function amb cron `0 3 * * 0` (diumenge 03:00 Europe/Madrid)
- **Abast**: processa totes les organitzacions amb `status: "connected"`
- **Per cada org**: executa `runBackupForOrg`, que exporta dades i puja a la carpeta del prove√Ødor
- **Retenci√≥**: aplica pol√≠tica de 8 setmanes (segons `applyRetention`)
- **Timeout**: 9 minuts m√†xim, 512MB mem√≤ria

El backup manual des de la UI crida la mateixa l√≤gica via `/api/integrations/backup/run-now`.

#### Operativa i diagn√≤stic

**On mirar errors:**
- Google Cloud Console ‚Üí Cloud Functions ‚Üí Logs
- Firestore: `/organizations/{orgId}/integrations/backup` ‚Üí camp `lastError`
- Firestore: `/organizations/{orgId}/backups/{backupId}` ‚Üí camp `error`

**Errors comuns i missatges sanititzats (segons `runBackupForOrg.ts`):**
| Causa | Missatge a l'usuari |
|-------|---------------------|
| Token expirat/revocat | "Error d'autenticaci√≥ amb el prove√Ødor. Reconnecta el servei." |
| Error de xarxa | "Error de connexi√≥ amb el prove√Ødor. Reintenta m√©s tard." |
| Quota excedida | "L√≠mit del prove√Ødor excedit. Reintenta m√©s tard." |
| Permisos/espai | "Error de permisos o espai al prove√Ødor." |

#### RGPD i cust√≤dia

- Les dades exportades passen a un servei de tercers (Dropbox/Google Drive) sota el control del compte de l'usuari que autoritza.
- L'entitat √©s responsable de:
  - Configurar permisos d'acc√©s a la carpeta dest√≠
  - Complir amb la seva pol√≠tica de protecci√≥ de dades
  - Gestionar qui t√© acc√©s al compte autoritzat
- Summa Social no t√© acc√©s a les carpetes dest√≠ un cop pujat el backup.
- El refresh token es guarda a Firestore; si es compromet, cal revocar acc√©s des del prove√Ødor.

#### Com desactivar

**Des de la UI:**
- No existeix bot√≥ "Desconnectar" implementat a la UI actual.
- Per desconnectar: esborrar manualment el document `/organizations/{orgId}/integrations/backup` o posar `status: "disconnected"`.

**Kill-switch t√®cnic:**
- Desactivar la Cloud Function `runWeeklyBackup` des de Google Cloud Console.
- Eliminar les variables d'entorn `DROPBOX_APP_*` / `GOOGLE_DRIVE_*` per impedir noves connexions.

#### Fitxers principals

| Fitxer | Descripci√≥ |
|--------|------------|
| `src/components/backups-settings.tsx` | Component UI (panell configuraci√≥) |
| `src/lib/backups/types.ts` | Tipus TypeScript |
| `src/lib/backups/run-backup.ts` | Executor backup (Next.js API routes) |
| `src/lib/backups/dropbox-api.ts` | Client HTTP Dropbox |
| `src/app/api/integrations/backup/dropbox/start/route.ts` | Inici OAuth Dropbox |
| `src/app/api/integrations/backup/dropbox/callback/route.ts` | Callback OAuth Dropbox |
| `src/app/api/integrations/backup/google-drive/start/route.ts` | Inici OAuth Google Drive |
| `src/app/api/integrations/backup/google-drive/callback/route.ts` | Callback OAuth Google Drive |
| `src/app/api/integrations/backup/run-now/route.ts` | API backup manual |
| `functions/src/backups/runWeeklyBackup.ts` | Cloud Function scheduler setmanal |
| `functions/src/backups/runBackupForOrg.ts` | Cloud Function executor principal |
| `functions/src/backups/exportFirestoreOrg.ts` | Exportaci√≥ dades Firestore |
| `functions/src/backups/providers/dropboxProvider.ts` | Provider Dropbox (Cloud Functions) |
| `functions/src/backups/providers/googleDriveProvider.ts` | Provider Google Drive (Cloud Functions) |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 4. FORMATS D'IMPORTACI√ì I EXPORTACI√ì
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 4.1 Importaci√≥ d'Extractes Bancaris

| Format | Extensions | Detecci√≥ |
|--------|------------|----------|
| CSV | .csv, .txt | Separador auto (;,\t) |
| Excel | .xlsx, .xls | SheetJS |

**Columnes detectades:** Data, Concepte/Descripci√≥, Import/Quantitat

## 4.2 Importaci√≥ de Donants

| Format | Extensions |
|--------|------------|
| Excel | .xlsx, .xls |
| CSV | .csv |

**Columnes:** Veure secci√≥ 3.5.4

## 4.3 Importaci√≥ de Prove√Ødors

| Format | Extensions |
|--------|------------|
| Excel | .xlsx, .xls |
| CSV | .csv |

## 4.4 Divisor de Remeses (Ingressos)

| Format | Extensions |
|--------|------------|
| CSV | .csv, .txt |
| Excel | .xlsx, .xls |

## 4.5 Importador de Devolucions (NOU v1.8)

| Format | Extensions | Banc |
|--------|------------|------|
| Excel | .xlsx | Santander |
| CSV | .csv | Triodos |
| XLS | .xls | Triodos |

**Columnes detectades autom√†ticament:** IBAN, Import, Data, DNI, Nom, Motiu

## 4.6 Importador Stripe (NOU v1.9)

| Format | Extensions | Font |
|--------|------------|------|
| CSV | .csv | Stripe Dashboard ‚Üí Pagos ‚Üí Exportar |

**Columnes requerides:** id, Created date (UTC), Amount, Fee, Customer Email, Status, Transfer, Amount Refunded

**Veure secci√≥ 3.9 per detalls complets.**

## 4.7 Exportacions

| Informe | Format | Nom fitxer |
|---------|--------|------------|
| Model 182 | Excel (.xlsx) | Model182_{org}_{any}.xlsx |
| Model 347 | CSV | Model347_{org}_{any}.csv |
| Certificats | PDF / ZIP | certificat_{donant}_{any}.pdf |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 5. CAMPS REQUERITS PER INFORME FISCAL
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 5.1 Model 182 - Donants

| Camp Summa Social | Camp Model 182 | Obligatori |
|-------------------|----------------|------------|
| taxId | NIF DECLARADO | ‚úÖ |
| name | APELLIDOS Y NOMBRE | ‚úÖ |
| zipCode (2 primers) | PROVINCIA | ‚úÖ |
| donorType | NATURALEZA (F/J) | ‚úÖ |
| - | CLAVE | ‚úÖ (fix "A") |
| Suma transaccions | VALOR | ‚úÖ |
| Suma any -1 | VALOR_1 | ‚ùå |
| Suma any -2 | VALOR_2 | ‚ùå |
| Hist√≤ric | RECURRENTE | ‚ùå |

## 5.2 Model 347 - Prove√Ødors

| Camp Summa Social | Camp Model 347 | Obligatori |
|-------------------|----------------|------------|
| taxId | NIF | ‚úÖ |
| name | NOMBRE/RAZON SOCIAL | ‚úÖ |
| Suma transaccions | IMPORTE | ‚úÖ |

## 5.3 Certificats de Donaci√≥

| Camp | Obligatori |
|------|------------|
| Nom donant | ‚úÖ |
| NIF donant | ‚úÖ |
| Import (net de devolucions) | ‚úÖ |
| Data | ‚úÖ |
| Nom organitzaci√≥ | ‚úÖ |
| CIF organitzaci√≥ | ‚úÖ |
| Nom signant | ‚úÖ |
| C√†rrec signant | ‚úÖ |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 6. TERMINOLOGIA IMPORTANT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Terme | Definici√≥ |
|-------|-----------|
| **Transfer√®ncies a contraparts** | Enviaments a organitzacions s√≤cies internacionals |
| **Remesa (ingressos)** | Agrupaci√≥ de quotes de socis en un √∫nic ingr√©s |
| **Remesa (devolucions)** | Agrupaci√≥ de devolucions en un √∫nic moviment negatiu |
| **Devoluci√≥** | Rebut retornat pel banc (compte sense fons, IBAN erroni, etc.) |
| **Matching** | Assignaci√≥ autom√†tica de contactes per coincid√®ncia |
| **Categoria per defecte** | Categoria que s'aplica autom√†ticament |
| **Model 182** | Declaraci√≥ de donatius - l√≠mit 31 gener |
| **Model 347** | Operacions amb tercers >3.005,06‚Ç¨ - l√≠mit 28 febrer |
| **Soci** | Donant recurrent amb quota peri√≤dica |
| **Donant puntual** | Donant amb aportacions espor√†diques |
| **Emissor** | Terme intern per qualsevol contacte |
| **Eix d'actuaci√≥** | Sin√≤nim de projecte |
| **Gestoria** | Professional extern que presenta models fiscals |
| **Recurr√®ncia** | Ha donat els 2 anys anteriors consecutius |
| **Remesa parcial** | Remesa amb algunes devolucions pendents d'identificar |
| **dateConfidence** | Fiabilitat de la data: 'line' (per fila), 'file' (global), 'none' |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 7. OPTIMITZACIONS T√àCNIQUES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 7.1 Rendiment
- Memoitzaci√≥ de contexts Firebase
- Cleanup de timeouts i subscripcions
- L√≠mits a queries Firestore (m√†x 500)
- CollectionGroup queries
- AbortController per cancel¬∑lar peticions

## 7.2 Firebase Storage
- CORS configurat per c√†rrega d'imatges
- Logo i firma als PDFs generats al client

### Pol√≠tica temporal d'uploads (Des 2025)
**Estat actual:** Qualsevol usuari autenticat pot pujar documents a paths d'organitzaci√≥.
- Afecta: `pendingDocuments`, `transactions/attachments`, `expenseReports`, `projectExpenses`, etc.
- Motiu: Desbloquejar operativa mentre es completa RBAC Manager (Bloc 2)
- Pendent: Reintroduir restricci√≥ per membres quan RBAC Manager estigui complet

## 7.3 Autenticaci√≥
- Session persistence (caduca en tancar navegador)

## 7.4 Modals Radix UI (NOU v1.8)
- Fix bloqueig `aria-hidden` en tancar modals
- DropdownMenu controlat per evitar conflictes
- `setTimeout` + `blur()` abans d'obrir modals des de men√∫s

## 7.5 Convencions UI/UX (NOU v1.17)

### 7.5.1 Contracte Crom√†tic

| Color | √ös exclusiu |
|-------|-------------|
| **Vermell** (`text-destructive`, `bg-red-*`) | Errors, accions destructives, alertes |
| **Verd** (`text-green-*`, `bg-green-*`) | √àxit, estat positiu |
| **Groc/Taronja** (`text-amber-*`, `bg-amber-*`) | Advert√®ncies, pendents |
| **Gris** (`text-muted-foreground`) | Informaci√≥ secund√†ria, marcadors neutres |

**Regla clau:** El vermell MAI s'usa per indicadors neutres com marcadors de camps requerits (`*`).
Els camps requerits usen `text-muted-foreground` per evitar confusi√≥ amb errors.

### 7.5.2 Cap√ßaleres de P√†gina

**Patr√≥ est√†ndard:**
```tsx
<h1 className="text-2xl font-bold tracking-tight font-headline">{t√≠tol}</h1>
<p className="text-muted-foreground">{subt√≠tol descriptiu}</p>
```

| P√†gina | T√≠tol | Subt√≠tol |
|--------|-------|----------|
| Dashboard | "Dashboard" | "Visi√≥ general de la situaci√≥ financera de l'organitzaci√≥." |
| Moviments | "Moviments" | "Importa, revisa i assigna categories, contactes i documents." |
| Donants | "Donants" | "Gestiona donants i prepara dades per al Model 182 i certificats." |
| Prove√Ødors | "Prove√Ødors" | "Gestiona prove√Ødors i prepara dades per al Model 347." |
| Assignaci√≥ despeses | "Assignaci√≥ de despeses" | "Assigna despeses sense projecte als teus projectes." |

### 7.5.3 Densitat de Taules

**Configuraci√≥ base (`src/components/ui/table.tsx`):**

| Element | Estil |
|---------|-------|
| `TableRow` | `border-b border-border/50 hover:bg-muted/30` |
| `TableHead` | `h-10 px-3 text-xs text-muted-foreground` |
| `TableCell` | `px-3 py-2` |

**Principis:**
- Separadors subtils (`border-border/50`) per evitar soroll visual
- Hover suau (`bg-muted/30`) que no competeix amb el focus
- Cap√ßaleres compactes per√≤ llegibles (`text-xs`, `h-10`)

### 7.5.4 Breadcrumbs

**Quan usar:**
- P√†gines de nivell 2 o superior (dins d'un m√≤dul)
- Quan la navegaci√≥ amb bot√≥ "enrere" no √©s suficient

**Quan NO usar:**
- P√†gines de nivell 1 (Dashboard, Moviments, Donants, etc.)
- P√†gines amb navegaci√≥ lateral visible

**Implementaci√≥:**
```tsx
import { Breadcrumb, BreadcrumbList, BreadcrumbItem, BreadcrumbLink, BreadcrumbPage, BreadcrumbSeparator } from "@/components/ui/breadcrumb"

<Breadcrumb>
  <BreadcrumbList>
    <BreadcrumbItem>
      <BreadcrumbLink asChild>
        <Link href="/dashboard/project-module/projects">{t.breadcrumb?.projects}</Link>
      </BreadcrumbLink>
    </BreadcrumbItem>
    <BreadcrumbSeparator />
    <BreadcrumbItem>
      <BreadcrumbPage>{t.breadcrumb?.expenseAssignment}</BreadcrumbPage>
    </BreadcrumbItem>
  </BreadcrumbList>
</Breadcrumb>
```

### 7.5.5 Accessibilitat (Keyboard + Focus)

| Element | Comportament |
|---------|-------------|
| Di√†legs (Radix) | `Esc` tanca autom√†ticament |
| Editors inline | `Enter` confirma, `Esc` cancel¬∑la |
| Botons icona | M√≠nim `36x36px` hit target |
| Focus rings | `focus-visible:ring-2 focus-visible:ring-ring` |

**Aria labels obligatoris per botons nom√©s icona:**
```tsx
<Button variant="ghost" size="icon" aria-label={t.common.edit}>
  <Pencil className="h-4 w-4" />
</Button>
```

### 7.5.6 Empty States

**To institucional, mai humor√≠stic:**
- ‚úÖ "No hi ha moviments per mostrar"
- ‚ùå "Encara no has afegit cap moviment! Comen√ßa ara!"

**Estructura:**
```tsx
<div className="text-center py-8 text-muted-foreground">
  <p>{t.emptyState.noResults}</p>
</div>
```

### 7.5.7 Tooltips IA

Quan una acci√≥ usa IA, el tooltip ha de ser descriptiu i no implicar confirmaci√≥:
- ‚úÖ "Classifica autom√†ticament amb IA"
- ‚ùå "Vols que la IA classifiqui?"

### 7.5.8 Confirmacions Destructives

**Sempre requerides per:**
- Eliminaci√≥ de dades
- Accions irreversibles
- Operacions massives

**Format:**
```tsx
<AlertDialog>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>{t.confirm.deleteTitle}</AlertDialogTitle>
      <AlertDialogDescription>{t.confirm.deleteDescription}</AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>{t.common.cancel}</AlertDialogCancel>
      <AlertDialogAction className="bg-destructive">{t.common.delete}</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```
- Components com `DonorSearchCombobox` reescrits sense `cmdk` per evitar problemes de portals niuats

### 7.5.9 Dashboard Layout i Overflow (NOU v1.27)

**Problema resolt:**
Contingut ample (com `TransactionsTable` amb `min-w-[600px]`) pot expandir el contenidor principal i emp√®nyer elements fora del viewport, fent desapar√®ixer icones del header.

**Soluci√≥ aplicada a `src/app/[orgSlug]/dashboard/layout.tsx`:**

```tsx
<SidebarInset className="flex min-w-0 flex-1 flex-col overflow-x-hidden ...">
  <DashboardHeader />
  <main className="flex-1 overflow-y-auto p-4 md:p-6">{children}</main>
</SidebarInset>
```

**Regles obligat√≤ries per al layout del dashboard:**

| Propietat | Motiu |
|-----------|-------|
| `min-w-0` | Permet que flex children es comprimeixin per sota del seu contingut natural |
| `overflow-x-hidden` | Evita que contingut ample (taules, grids) expandeixi el contenidor |

**Header responsive (`DashboardHeader`):**

```tsx
<header className="... flex items-center justify-between gap-2 ...">
  {/* Bloc esquerra: degradable */}
  <div className="flex min-w-0 flex-1 items-center gap-2">
    <SidebarTrigger className="shrink-0" />
    <Breadcrumb className="min-w-0">
      <BreadcrumbList className="flex-nowrap overflow-hidden">
        <BreadcrumbItem className="min-w-0 max-w-[8rem] sm:max-w-[12rem]">
          <BreadcrumbPage className="truncate">{label}</BreadcrumbPage>
        </BreadcrumbItem>
      </BreadcrumbList>
    </Breadcrumb>
  </div>
  {/* Bloc dreta: fix (icones sempre visibles) */}
  <div className="flex shrink-0 items-center gap-2">
    <HelpSheet />
    <NotificationBell />
  </div>
</header>
```

**Patr√≥ de responsivitat:**
- El bloc esquerra (`flex-1 min-w-0`) s'adapta i trunca el breadcrumb si cal
- El bloc dreta (`shrink-0`) mai es comprimeix ni desapareix
- Les icones d'ajuda i notificacions s√≥n sempre accessibles

### 7.5.10 Adaptaci√≥ M√≤bil (NOU v1.29)

**Detecci√≥ de dispositiu:**
```tsx
import { useIsMobile } from '@/hooks/use-mobile';
const isMobile = useIsMobile();
```

**Patrons obligatoris per a pantalles m√≤bils:**

| Situaci√≥ | Patr√≥ Desktop | Patr√≥ M√≤bil |
|----------|---------------|-------------|
| **Barra d'accions amb m√∫ltiples botons** | Tots els botons visibles | CTA principal (`w-full`) + DropdownMenu "M√©s accions" |
| **Tabs de navegaci√≥** | `<TabsList>` amb `<TabsTrigger>` | `<Select>` amb les mateixes opcions |
| **Taules de dades** | `<Table>` amb columnes | `<MobileListItem>` amb title, badges, meta i actions |
| **Filtres m√∫ltiples** | Botons en l√≠nia | `<Select>` per cada grup de filtres |
| **Zona de perill** | Card sempre visible | `<Accordion>` col¬∑lapsable |

**Exemple - Barra d'accions m√≤bil:**
```tsx
{isMobile ? (
  <div className="flex flex-col gap-2">
    <Button onClick={handlePrimaryAction} className="w-full">
      <Plus className="h-4 w-4 mr-2" />
      {t.primaryAction}
    </Button>
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" className="w-full">
          <MoreVertical className="h-4 w-4 mr-2" />
          M√©s accions
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem onClick={handleSecondaryAction}>
          {t.secondaryAction}
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  </div>
) : (
  <div className="flex items-center gap-2">
    {/* Tots els botons visibles */}
  </div>
)}
```

**Exemple - Tabs ‚Üí Select:**
```tsx
const [activeTab, setActiveTab] = useState<string>('tab1');

<Tabs value={activeTab} onValueChange={setActiveTab}>
  {isMobile ? (
    <Select value={activeTab} onValueChange={setActiveTab}>
      <SelectTrigger className="w-full">
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="tab1">{t.tab1Label}</SelectItem>
        <SelectItem value="tab2">{t.tab2Label}</SelectItem>
      </SelectContent>
    </Select>
  ) : (
    <TabsList>
      <TabsTrigger value="tab1">{t.tab1Label}</TabsTrigger>
      <TabsTrigger value="tab2">{t.tab2Label}</TabsTrigger>
    </TabsList>
  )}
  <TabsContent value="tab1">...</TabsContent>
  <TabsContent value="tab2">...</TabsContent>
</Tabs>
```

**Espai per FAB (Floating Action Button):**
Quan hi ha un FAB a la p√†gina, afegir `pb-24 md:pb-0` al contenidor principal per evitar col¬∑lisions amb el contingut.

**Fitxers principals adaptats (v1.29):**
- `src/app/[orgSlug]/dashboard/project-module/expenses/page.tsx`
- `src/app/[orgSlug]/dashboard/project-module/projects/[projectId]/budget/page.tsx`
- `src/app/[orgSlug]/dashboard/super-admin/page.tsx`
- `src/app/admin/page.tsx`
- `src/components/danger-zone.tsx`
- `src/components/admin/product-updates-section.tsx`
- `src/components/super-admin/i18n-manager.tsx`

## 7.6 Onboarding / Benvinguda Inicial (ACTUALITZAT v1.20)

### Objectiu
Donar la benvinguda al primer admin d'una nova organitzaci√≥ amb una √∫nica modal simple, sense bloquejar l'√∫s de l'aplicaci√≥.

### Principis
- **Modal √∫nica**: Una sola modal de benvinguda, sense checklist persistent.
- **No bloquejant**: L'usuari pot continuar sense completar res.
- **Primer admin**: Nom√©s el primer admin (per `joinedAt`) veu la modal.
- **Definitiu**: Un cop vista, `welcomeSeenAt` s'escriu i la modal no torna a apar√®ixer.

### Flux simplificat (v1.20)

1. **Primera c√†rrega del Dashboard**: Si l'usuari √©s el primer admin i `welcomeSeenAt` no existeix, es mostra la modal de benvinguda.
2. **Opci√≥ "Guia'm"**: Obre el wizard de configuraci√≥ (dades fiscals, firma, categories).
3. **Opci√≥ "Comen√ßar pel meu compte"**: Tanca la modal i permet treballar directament.
4. **En ambd√≥s casos**: Es marca `welcomeSeenAt` a Firestore ‚Üí la modal no torna.

### Model de dades

```typescript
// A Organization (src/lib/data.ts)
onboarding?: {
  welcomeSeenAt?: string;  // YYYY-MM-DD quan el primer admin ha vist la modal
};
```

### L√≤gica de decisi√≥

| Condici√≥ | Resultat |
|----------|----------|
| `welcomeSeenAt` existeix | No mostrar modal |
| Usuari NO √©s primer admin | No mostrar modal |
| Usuari √©s primer admin + `welcomeSeenAt` no existeix | Mostrar modal |

**Primer admin**: L'admin amb `joinedAt` m√©s antic. Si nom√©s hi ha un admin, √©s ell. Si no hi ha `joinedAt`, fallback a √∫nic admin.

### Fitxers principals

| Fitxer | Funci√≥ |
|--------|--------|
| `src/lib/onboarding.ts` | `isFirstAdmin()`, `shouldShowWelcomeModal()` |
| `src/components/onboarding/WelcomeOnboardingModal.tsx` | Modal de benvinguda |
| `src/components/onboarding/OnboardingWizard.tsx` | Wizard de configuraci√≥ (obert des de modal o Configuraci√≥) |

### Canvis respecte v1.18

| v1.18 | v1.20 |
|-------|-------|
| Checklist persistent al Dashboard | Modal √∫nica, apareix una sola vegada |
| P√†gina `/onboarding` dedicada | Eliminada, wizard s'obre des de modal o Configuraci√≥ |
| `OnboardingChecklist.tsx` | Eliminat |
| `onboardingSkippedAt` | Substitu√Øt per `onboarding.welcomeSeenAt` |
| L√≤gica complexa `computeOnboardingStatus()` | Simplificat a `shouldShowWelcomeModal()` |

## 7.7 Perfil de Rendiment (NOU v1.21)

### Escala objectiu
Summa Social est√† optimitzat per a **<100 usuaris concurrents** amb marge operatiu. El l√≠mit pr√†ctic dep√®n del volum de dades per organitzaci√≥ (transaccions, contactes).

### Optimitzacions aplicades

| Problema | Soluci√≥ | Fitxer |
|----------|---------|--------|
| N+1 queries (links) | Batching amb `documentId()` en chunks de 10 | `src/hooks/use-project-module.ts:172` |
| N+1 queries (expenses) | Batching paral¬∑lel off-bank + bank | `src/hooks/use-project-module.ts:388` |
| N+1 llistat projectes | Lazy-load de budgetLines, usar `project.budgetEUR` | `src/app/.../projects/page.tsx` |
| Inst√†ncia √∫nica | `maxInstances: 3` a Firebase App Hosting | `apphosting.yaml` |
| Listener audit logs | `limit(100)` | `src/app/.../super-admin/page.tsx:149` |
| Listener donor drawer | `limit(500)` + filtre client | `src/components/donor-detail-drawer.tsx:157` |

### Patr√≥ de batching Firestore

Quan cal carregar m√∫ltiples documents per ID, usar aquest patr√≥:

```typescript
import { documentId } from 'firebase/firestore';

function chunkArray<T>(arr: T[], size: number): T[][] {
  const out: T[][] = [];
  for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
  return out;
}

// Carregar en paral¬∑lel (m√†xim 10 IDs per query, l√≠mit Firestore)
const chunks = chunkArray(ids, 10);
const snaps = await Promise.all(
  chunks.map((chunkIds) =>
    getDocs(query(collectionRef, where(documentId(), 'in', chunkIds)))
  )
);
```

### Listeners `onSnapshot` - Classificaci√≥

| Fitxer | Tipus | Decisi√≥ |
|--------|-------|---------|
| `use-collection.tsx` | Hook base | CORE - no tocar |
| `use-doc.tsx` | Hook base | CORE - no tocar |
| `use-bank-accounts.ts` | Comptes bancaris | OK - pocs docs, real-time √∫til |
| `donor-detail-drawer.tsx` | Transaccions donant | Limitat a 500, filtre client |
| `super-admin/page.tsx` | Audit logs | Limitat a 100 |

### Qu√® NO cal fer (sense evid√®ncia de necessitat)

- Refactors de model (denormalitzacions)
- Observabilitat avan√ßada (Sentry)
- Pujar `maxInstances` a 5+
- Reescriure hooks base
- Paginaci√≥ infinita a moviments (nom√©s si org t√© >1000 visibles)

### Quan escalar

Indicadors que requeririen intervenci√≥:
- Lat√®ncia UI >2s consistent
- Errors Firestore per quota
- Usuaris reportant lentitud


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 8. FLUX DE TREBALL RECOMANAT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 8.1 Configuraci√≥ Inicial

1. Configurar dades de l'organitzaci√≥
2. Pujar logo
3. Configurar firma i signant
4. Revisar categories
5. Importar contactes des d'Excel
6. Assignar categoria per defecte a cada contacte
7. Crear projectes/eixos

## 8.2 Dia a Dia

1. Descarregar extracte del banc (mensual)
2. Importar a Summa Social
3. Revisar alertes al Dashboard
4. Corregir moviments pendents
5. Dividir remeses si n'hi ha
6. **Gestionar devolucions pendents** (NOU v1.8)

## 8.3 Gesti√≥ de Devolucions (NOU v1.8)

1. Veure banner "Devolucions pendents" a Moviments
2. Clicar "Revisar"
3. Per cada devoluci√≥:
   - Si saps de qui √©s ‚Üí "Assignar donant"
   - Si tens el fitxer del banc ‚Üí Icona üìÑ ‚Üí Importar fitxer
4. Revisar remeses parcials i completar-les

## 8.4 Fi d'Any

1. Revisar donants amb dades incompletes
2. **Verificar devolucions assignades**
3. Generar Excel Model 182 (abans 31 gener)
4. Enviar a gestoria
5. Generar Model 347 (abans 28 febrer)
6. Emetre certificats als donants


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 9. SINCRONITZACI√ì I DESPLEGAMENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 9.1 Entorn
- IDE: VS Code
- Assistent IA: Claude Code
- Control de versions: Git + GitHub

## 9.2 Flux
```
1. Demanar canvis a Claude Code
2. Claude Code modifica fitxers
3. git add . && git commit -m "descripci√≥"
4. git push
5. Desplegament autom√†tic
```

## 9.3 URLs
- Producci√≥: https://summasocial.app
- Firebase: https://studio--summa-social.us-central1.hosted.app

## 9.4 Tests
- Tests unitaris a `src/lib/__tests__/` (7 fitxers)
- Hook pre-commit amb Husky
- `npm test` abans de cada commit

## 9.5 Gate i18n pre-commit (NOU v1.40)

Validaci√≥ autom√†tica que bloqueja commits si falten claus `tr()` a `ca.json` (idioma base).

**Funcionament:**
1. Script `scripts/i18n/validate-tr-keys-exist-in-ca.mjs` escaneja el codi font buscant crides `tr("clau")` i `tr('clau')`
2. Comprova que cada clau existeix a `src/i18n/locales/ca.json`
3. Si falten claus ‚Üí llista les absents i bloqueja el commit (exit 1)

**Integraci√≥:**
- Executat al hook pre-commit (`.husky/pre-commit`)
- Executat a `scripts/verify-local.sh` (verificaci√≥ local pre-deploy)
- Comanda: `npm run i18n:check`

**Merge Storage + local (NOU v1.40):**
- `src/i18n/json-runtime.ts` fa merge entre traduccions remotes (Firebase Storage, editades per SuperAdmin) i el bundle local
- Si una clau existeix a Storage, t√© prioritat; si no, cau al bundle local
- Correcci√≥: abans el merge podia perdre claus locals noves si Storage no les tenia

## 9.6 SafeSelect ‚Äî Guard per SelectItem (NOU v1.40)

Helper centralitzat per filtrar valors inv√†lids abans de renderitzar `Select.Item` (Radix UI), que llan√ßa error si `value` √©s buit.

**Helper:** `src/lib/ui/safe-select-options.ts` ‚Äî `safeSelectOptions(items)`

**Qu√® fa:** Filtra items on `value` √©s `""`, `null`, `undefined` o `false` abans de passar-los al `Select.Root`.

**Usat a:** `donor-importer.tsx`, `donor-manager.tsx`, `employee-manager.tsx`, `supplier-manager.tsx`, `transactions-table.tsx`

**Problema que resol:** Categories amb ID inv√†lid (buit o null) provocaven crash de Radix UI. Pot passar amb dades legacy o importacions parcials.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 10. ROADMAP / FUNCIONALITATS PENDENTS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## Pendents (deute menor)

- ‚ö†Ô∏è **i18n PT**: `guides.importDonors.steps` longitud diferent (base=5, pt=6) + clau extra `.steps.5`
- ‚ö†Ô∏è **i18n FR**: `help.dashboard.steps` longitud diferent (base=5, fr=4) + `help.dashboard.extra.order.items` (base=4, fr=3)

## Completades v1.41
- ‚úÖ Persona de contacte per empreses (`contactPersonName`): camp, import, export, UI
- ‚úÖ Filtres dashboard donants: Tipus, Modalitat, Periodicitat (l√≤gica AND, comptadors)
- ‚úÖ Quota amb sufix de periodicitat (/mes, /trim, /sem, /any)
- ‚úÖ Acc√©s operatiu unificat (`require-operational-access.ts`), superadmin bypass
- ‚úÖ Fix Firestore Rules: `.get('archived', null)` per docs sense camp archived
- ‚úÖ Fix i18n clau bot√≥ arxivar categories/projectes
- ‚úÖ Fix typecheck: ExpenseLink type + guard seq√º√®ncia SEPA

## Completades v1.40
- ‚úÖ Pre-selecci√≥ autom√†tica de donants al wizard SEPA pain.008 per periodicitat natural
- ‚úÖ Din√†mica de donants redissenyada: 5 blocs, separaci√≥ PF/PJ, Top 15
- ‚úÖ Admin SDK compartit centralitzat (`admin-sdk.ts`), -500 l√≠nies duplicades
- ‚úÖ Registre/invitacions migrat a Admin API (bypass Firestore Rules)
- ‚úÖ Health Check blocs K (remeses √≤rfenes) i L (expenseLinks orfes)
- ‚úÖ Gate i18n pre-commit: hard block si falten claus `tr()` a ca.json
- ‚úÖ Dashboard i SEPA 100% tradu√Øbles via `tr()` (PT complet)
- ‚úÖ Merge Storage + local per i18n amb fallback correcte
- ‚úÖ SafeSelect guard per evitar crash Radix UI amb valors buits
- ‚úÖ Periodicitat donants: mostra "sense periodicitat" quan null, persisteix monthly expl√≠citament
- ‚úÖ Neteja massiva de console.logs en producci√≥

## Completades v1.29
- ‚úÖ Adaptaci√≥ m√≤bil completa: patrons normalitzats per a barres d'accions, navegaci√≥ i taules
- ‚úÖ CTA + "M√©s accions" DropdownMenu per a pantalles m√≤bils
- ‚úÖ Tabs ‚Üí Select per a navegaci√≥ m√≤bil
- ‚úÖ MobileListItem per a taules en m√≤bil
- ‚úÖ DangerZone col¬∑lapsable amb Accordion
- ‚úÖ Fix traduccions de categories al Dashboard (TopCategoriesTable)
- ‚úÖ P√†gines adaptades: expenses, super-admin, admin, configuracio, product-updates, i18n-manager

## Completades v1.16
- ‚úÖ Drag & drop de documents a la safata de despeses (per fila)
- ‚úÖ Auto-naming de documents amb `buildDocumentFilename()` (format YYYY.MM.DD_concepte.ext)
- ‚úÖ Renomenar documents inline (bot√≥ llapis, Enter/Escape)
- ‚úÖ Exportaci√≥ Excel de donants (nom, NIF, quota, IBAN, estat)

## Completades v1.10
- ‚úÖ M√≤dul Projectes: justificaci√≥ assistida per partides
- ‚úÖ Mode infraexecuci√≥: afegir despeses amb sugger√®ncies heur√≠stiques
- ‚úÖ Mode sobreexecuci√≥: treure o reduir imputacions (split parcial)
- ‚úÖ Simulaci√≥ en mem√≤ria fins a "Aplicar"
- ‚úÖ Pressupost unificat als cards (suma partides vs global)
- ‚úÖ Scoring per fam√≠lies sem√†ntiques (viatges, personal, serveis, etc.)

## Completades v1.9
- ‚úÖ Importador Stripe (dividir payouts en donacions + comissions)
- ‚úÖ Matching donants per email exacte
- ‚úÖ Tra√ßabilitat completa (stripePaymentId, stripeTransferId)

## Completades v1.8
- ‚úÖ Importador de devolucions del banc (Santander, Triodos)
- ‚úÖ Detecci√≥ autom√†tica d'agrupacions de devolucions
- ‚úÖ Remeses parcials de devolucions
- ‚úÖ Matching per IBAN ‚Üí DNI ‚Üí Nom exacte
- ‚úÖ UX simplificada per devolucions
- ‚úÖ Tests unitaris (77 tests) + Husky pre-commit
- ‚úÖ Fixes bloqueig aria-hidden modals Radix
- ‚úÖ Estat actiu/baixa per donants
- ‚úÖ Importador actualitza donants existents
- ‚úÖ Vista agrupada de remeses (1 l√≠nia + modal detall)
- ‚úÖ Detecci√≥ i reactivaci√≥ de socis de baixa a remeses
- ‚úÖ Link al donant des de modal de remesa
- ‚úÖ Eina per esborrar √∫ltima remesa (Zona Perill)

## Completades v1.7
- ‚úÖ Suport Excel per divisor de remeses
- ‚úÖ Camps city/province a l'importador de donants
- ‚úÖ Exportaci√≥ Excel Model 182 per gestoria (amb recurr√®ncia)
- ‚úÖ Session persistence (seguretat)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 11. HISTORIAL DE VERSIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Versi√≥ | Data | Canvis principals |
|--------|------|-------------------|
| 1.0 | Nov 2024 | Versi√≥ inicial, single-user |
| 1.5 | Nov 2024 | Multi-organitzaci√≥, sistema de rols |
| 1.6 | Des 2024 | DonorDetailDrawer, certificats amb firma, Zona Perill, divisor remeses |
| 1.7 | Des 2024 | Excel Model 182 per gestoria, suport Excel remeses, camps city/province, session persistence |
| 1.8 | Des 2024 | Importador devolucions del banc, remeses parcials, suport multi-banc (Santander/Triodos), tests unitaris, fixes modals Radix, UX simplificada |
| 1.9 | Des 2025 | Importador Stripe (payouts ‚Üí donacions + comissions), matching per email, tra√ßabilitat completa |
| **1.10** | **Des 2025** | **M√≤dul Projectes: justificaci√≥ assistida per partides, sugger√®ncies heur√≠stiques, split parcial de despeses, simulaci√≥ en mem√≤ria** |
| **1.11** | **Des 2025** | **Captura de despeses de terreny (quickMode, pujada r√†pida <10s), i18n Franc√®s complet (fr.ts), selector d'idioma amb 3 opcions** |
| **1.12** | **Des 2025** | **Multicomptes bancaris (CRUD, filtre per compte, tra√ßabilitat bankAccountId), filtre per origen (source), di√†leg crear donant a importador devolucions, mode bulk NET** |
| **1.13** | **Des 2025** | **Selecci√≥ m√∫ltiple a Moviments (checkboxes + accions en bloc), assignar/treure categoria massivament, batched writes Firestore (50 ops/batch), traduccions CA/ES/FR** |
| **1.14** | **Des 2025** | **Reorganitzaci√≥ UX Moviments (FiltersSheet, TransactionsFilters), drag & drop documents, indicadors visuals remeses processades, modal RemittanceSplitter redissenyat (wide layout), sidebar Projectes col¬∑lapsable** |
| **1.15** | **Des 2025** | **Documentaci√≥ completa de regles de normalitzaci√≥ de dades (noms, NIF/NIE/CIF, IBAN, email, tel√®fon E.164, adreces, normalizedName per deduplicaci√≥)** |
| **1.16** | **Des 2025** | **Importador de pressupost Excel (wizard 5 passos, agrupaci√≥ subpartides, columna finan√ßador principal), fix redirect-to-org O(1) amb collectionGroup, fix idle logout redirecci√≥ a login d'org** |
| **1.17** | **Des 2025** | **Polish UX: convencions UI documentades (contracte crom√†tic, cap√ßaleres est√†ndard, densitat taules, breadcrumbs, accessibilitat, empty states, tooltips IA, confirmacions destructives)** |
| **1.18** | **Des 2025** | **Onboarding: configuraci√≥ inicial per admins (checklist Dashboard, wizard, "Ho far√© despr√©s", camp onboardingSkippedAt), no bloquejant, discret, definitiu** |
| **1.19** | **Des 2025** | **Simplificaci√≥ onboarding a modal de benvinguda √∫nica per primer admin, eliminaci√≥ checklist persistent** |
| **1.20** | **Des 2025** | **Panell Admin: reset contrasenya + secci√≥ diagn√≤stic (Firebase Console, Cloud Logging, DEV-SOLO-MANUAL.md). Dashboard: neteja blocs Celebracions/Alertes, millora taula categories (exclou comissions), bloc projectes condicional. Nou document docs/DEV-SOLO-MANUAL.md per manteniment.** |
| **1.21** | **Des 2025** | **i18n p√†gina p√∫blica (ca/es), SEO tags amb canonical + hreflang, m√≤dul documents pendents hardened (permisos, guardrails, UI responsive)** |
| **1.22** | **29 Des 2025** | **Quick Expense Landing: ruta can√≤nica `/{orgSlug}/quick-expense` fora de `/dashboard` (sense sidebar/header), shortcut global `/quick`, redirect 307 per backward-compatibility, arquitectura neta sense hacks de layout** |
| **1.23** | **30 Des 2025** | **System Health Sentinelles (S1‚ÄìS8): detecci√≥ autom√†tica d'errors amb deduplicaci√≥, alertes email per incidents CRITICAL, filtres anti-soroll. Hub de Guies: guies procedimentals amb traduccions CA/ES/FR/PT (changePeriod, selectBankAccount, monthClose), validador i18n.** |
| **1.24** | **31 Des 2025** | **Routing hardening: simplificaci√≥ `/quick` (delega a `/redirect-to-org`), middleware amb PROTECTED_ROUTES per evitar loops, preservaci√≥ de `?next` params.** |
| **1.25** | **31 Des 2025** | **i18n rutes p√∫bliques complet (CA/ES/FR/PT): estructura `[lang]` per login, privacy i contact. Detecci√≥ autom√†tica idioma via Accept-Language. SEO amb canonical + hreflang per 4 idiomes. Redirect stubs per compatibilitat URLs antigues. Nou fitxer `src/i18n/public.ts` amb traduccions separades de l'app privada.** |
| **1.26** | **31 Des 2025** | **Resoluci√≥ col¬∑lisi√≥ `[lang]` vs `[orgSlug]`: arquitectura `public/[lang]` amb middleware rewrite (URL p√∫blica intacta). HOME i Funcionalitats multiidioma. x-default hreflang. Slugs reservats (ca/es/fr/pt/public). Rutes can√≤niques: `/{lang}/funcionalitats`, `/{lang}/privacy`, `/{lang}/contact`. Aliases naturals: FR (`fonctionnalites`, `confidentialite`), ES (`funcionalidades`, `privacidad`, `contacto`), PT (`funcionalidades`, `privacidade`, `contacto`).** |
| **1.27** | **2 Gen 2026** | **Fix routing Next 15 (`searchParams` Promise), header responsive (icones ajuda/novetats sempre visibles), cercador natural guies amb sin√≤nims i scoring i18n, validador i18n claus de cerca, layout dashboard overflow fix (`min-w-0 + overflow-x-hidden` a SidebarInset). Secci√≥ 3.12 Liquidacions de Despeses: model ExpenseReport, quilometratge multil√≠nia (mileageItems[]), generaci√≥ PDF, tabs Liquidacions/Tickets/Quilometratge, deep linking. Guies: travelExpenseReport, mileageTravel. Fix sidebar m√≤bil: submen√∫ Projectes ara expandeix correctament (isSidebarCollapsed = !isMobile && collapsed).** |
| **1.28** | **5 Gen 2026** | **Importadors millorats: plantilla oficial √∫nica per Categories/Donants/Prove√Ødors (detecci√≥ 100%), export=import per donants i prove√Ødors, categoria per defecte agn√≤stica amb warning d'ambig√ºitat, dedupe ignora deletedAt/archivedAt. Categories: normalitzaci√≥ label, scroll preview, motiu omissi√≥, delete warning + count, Danger Zone esborrar categories. Pendents/Liquidacions: drag & drop com a punt d'entrada per pujar fitxers, validaci√≥ d'extensions al drop handler (pdf/xml/jpg/png), toast feedback si cap v√†lid. Storage observability: detecci√≥ i report `storage/unauthorized` com a incident CRITICAL.** |
| **1.29** | **12 Gen 2026** | **Adaptaci√≥ m√≤bil completa: patrons UI normalitzats (CTA + DropdownMenu "M√©s accions", Tabs ‚Üí Select, Table ‚Üí MobileListItem, DangerZone col¬∑lapsable amb Accordion). P√†gines adaptades: expenses, super-admin, admin, configuracio, product-updates-section, i18n-manager. Fix traduccions categories Dashboard (TopCategoriesTable resol category.name ‚Üí t.categories). Nova secci√≥ documentaci√≥ 7.5.10 Adaptaci√≥ M√≤bil amb exemples de codi.** |
| **1.30** | **13 Gen 2026** | **Dashboard: reorganitzaci√≥ KPIs en dos blocs (Diners/Qui ens sost√©), nou KPI "Altres ingressos" per reconciliaci√≥ visual (subvencions, loteria, interessos), datasets separats per evitar duplicats remesa. Fix hydration warning extensions navegador (`suppressHydrationWarning` a `<html>`). Eliminats logs debug BUILD-SIGNATURE.** |
| **1.31** | **14 Gen 2026** | **UX novetats: eliminat toast autom√†tic de novetats al dashboard (ara nom√©s via campaneta/FAB inbox). Reducci√≥ soroll logs: console.debug dev-only per i18n listener, org-provider superadmin access. Tra√ßa toast DEV-ONLY per debugging. Clarificat acc√©s SuperAdmin sense membership com a comportament esperat. Documentat ERR_BLOCKED_BY_CLIENT com a possible adblocker (no bug).** |
| **1.32** | **29 Gen 2026** | **Din√†mica de donants: nou panell d'an√†lisi per per√≠ode (altes, baixes, reactivacions, devolucions, aportaci√≥ decreixent). Wizard SEPA pain.008 complet: 3 passos (config, selecci√≥, revisi√≥), periodicitat de quota (monthly/quarterly/semiannual/annual/manual), mem√≤ria d'execuci√≥ (lastSepaRunDate), bulk selection amb filtre, col¬∑lecci√≥ sepaCollectionRuns. Importador pressupost millorat: extracci√≥ codi del text amb patrons (A), a.1), a.1.1)), agrupaci√≥ contextual per jerarquia, cap√≠tols destacats (ambre), vista sense/amb partides. Traduccions i18n donorDynamics (CA/ES). Doc GOVERN-DE-CODI-I-DEPLOY v3.0: classificaci√≥ risc (BAIX/MITJ√Ä/ALT), ritual deploy per nivell, gate hum√† √∫nic.** |
| **1.33** | **30 Gen 2026** | **Health Check P0: panell d'integritat de dades al Dashboard (nom√©s admin). 5 blocs deterministes: A) categories legacy (docIds), B) dates formats mixtos/inv√†lids, C) coher√®ncia origen bancari (source‚ÜîbankAccountId), D) archivedAt en queries normals, E) signs per transactionType. UI amb details expandibles, badge recompte, taula exemples (max 5). Deduplicaci√≥ global importaci√≥ banc√†ria (per rang dates), guardrails UX solapament extractes, camps bancaris readonly (description/amount) per moviments importats. Fitxer category-health.ts amb runHealthCheck().** |
| **1.34** | **31 Gen 2026** | **Invariant A4 source‚ÜîbankAccountId: `bank`/`stripe` requereixen bankAccountId (P0 error si absent), `remittance` hereta del pare, `manual` no aplica. Health check actualitzat per detectar stripe sense bankAccountId. Camps (date/amount/description) bloquejats si bankAccountId present. Backfill dades legacy Flores (363 transaccions: 340 bank + 23 remittance).** |
| **1.35** | **1 Feb 2026** | **Guardrails integritat Categories i Eixos: prohibit delete f√≠sic (Firestore Rules), arxivat nom√©s via API amb reassignaci√≥ obligat√≤ria si count > 0, camps archivedAt/ByUid/FromAction protegits contra escriptura client. APIs `/api/categories/archive` i `/api/projects/archive` amb validaci√≥ orgId derivat de membership. Health Check nou: blocs F (categories √≤rfenes) i G (projects orfes). UI: icona Archive, ReassignModal, traduccions CA/ES/FR.** |
| **1.41** | **11 Feb 2026** | **Donants: persona de contacte per empreses (contactPersonName), 3 filtres dashboard (Tipus/Modalitat/Periodicitat) amb comptadors i l√≤gica AND, quota amb sufix periodicitat. Acc√©s operatiu unificat (require-operational-access.ts) amb superadmin bypass. Fix Firestore Rules `.get('archived', null)` per docs legacy. Fixes menors i18n i typecheck.** |
| **1.40** | **10 Feb 2026** | **Admin SDK compartit centralitzat (admin-sdk.ts, -500 l√≠nies). Registre/invitacions via Admin API. Pre-selecci√≥ SEPA pain.008 per periodicitat natural. Din√†mica donants redissenyada (5 blocs, PF/PJ). Health Check K/L. Gate i18n pre-commit. SafeSelect guard. Neteja console.logs.** |
| **1.39** | **9 Feb 2026** | **Delete guardrails complets: budget lines bloquejades si linkades, expense links bloquejats si amb assignacions, FX transfers amb AlertDialog. Danger zone: findLinkedTxIds per remeses i bulk delete. i18n blockedByProjectLinks.** |
| **1.38** | **8 Feb 2026** | **tx.category = docId (invariant): helper centralitzat isCategoryIdCompatibleStrict, guardrails a handleSetCategory/handleSetContact/handleBulkUpdateCategory/transaction-importer. Badge legacy "Cal recategoritzar". Bulk desactivat si selecci√≥ mixed.** |
| **1.37** | **7 Feb 2026** | **M√≤dul Projectes: off-bank hard delete amb batch Firestore + cleanup Storage. Conversi√≥ EUR en moment d'assignaci√≥ amb FX split proporcional. Bloqueig assignaci√≥ si pendingConversion.** |
| **1.36** | **1 Feb 2026** | **Guardrails integritat FASE 2 completa: (2A) Comptes bancaris - desactivaci√≥ via API, bloqueig si t√© moviments, prohibit delete. (2B) Contactes - arxivat via API amb dryRun, bloqueig nom√©s si moviments actius (permet arxivar amb historial arxivat), modal desglossament actius/arxivats. (2C) Liquidacions - arxivat via API, bloqueig si tiquets pendents (status‚â†matched), prohibit delete. Health Check: blocs H (bankAccounts orfes), I (contactes orfes), J (tiquets orfes). Nou endpoint `/api/expense-reports/archive`. Traduccions CA/ES/FR per modals "no es pot arxivar".** |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 12. √ÄMBIT I L√çMITS DEL PRODUCTE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 12.1 Qu√® NO Far√† Summa Social (Per Disseny)

| Funcionalitat Exclosa | Motiu |
|-----------------------|-------|
| **Generaci√≥ de fitxers BOE** | Les entitats deleguen a gestories |
| **Presentaci√≥ telem√†tica AEAT** | Complexitat legal elevada |
| **Integraci√≥ directa APIs banc√†ries** | Requereix certificacions |
| **Comptabilitat doble entrada** | NO √©s programa de comptabilitat |
| **Facturaci√≥ electr√≤nica** | Fora d'√†mbit |
| **Models d'IA opacs** | Tota IA ha de ser determinista o supervisada |
| **Fuzzy matching de noms** | Massa risc d'errors en fiscalitat |
| **Assignaci√≥ autom√†tica sense confirmaci√≥** | L'usuari sempre ha de validar |

## 12.2 Focus del Producte

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                 ‚îÇ
‚îÇ   1. GESTIONAR MOVIMENTS BANCARIS                              ‚îÇ
‚îÇ      Importar, categoritzar, assignar contactes                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   2. RECONCILIAR BANC                                          ‚îÇ
‚îÇ      Saldos, detecci√≥ d'errors, control, devolucions           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   3. PREPARAR FISCALITAT                                       ‚îÇ
‚îÇ      Model 182, Model 347, certificats de donaci√≥              ‚îÇ
‚îÇ      ‚Üí Output: Excel net per enviar a la gestoria              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   4. ORDENAR DONANTS / PROVE√èDORS / PROJECTES                  ‚îÇ
‚îÇ      Base de dades centralitzada i actualitzada                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   5. DASHBOARD DE SEGUIMENT                                    ‚îÇ
‚îÇ      Visualitzaci√≥ d'informaci√≥ clau per seguiment general     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## 12.3 Qu√® NO Garanteix el Sistema

| NO garanteix | Motiu |
|--------------|-------|
| Abs√®ncia d'errors humans | L'usuari pot introduir dades incorrectes |
| Substituci√≥ de revisi√≥ professional | No som assessors fiscals ni auditors |
| Validaci√≥ de documents oficials | Els fitxers generats s√≥n per a la gestoria |
| Bloqueig d'accions incorrectes | L'usuari t√© llibertat operativa total |

> **Responsabilitat:** Summa Social √©s una eina de suport. La responsabilitat final sobre les dades i els informes fiscals recau en l'organitzaci√≥ i els seus assessors professionals.

## 12.4 P√∫blic Objectiu

| S√≠ | No |
|----|----|
| Entitats petites i mitjanes d'Espanya | Grans entitats amb ERP propi |
| Entitats sense √†nim de lucre | Empreses amb √†nim de lucre |
| Fundacions petites | Administracions p√∫bliques |
| Associacions culturals, socials | Entitats fora d'Espanya |

## 12.4 Filosofia de Desenvolupament

> **"Menys √©s m√©s"**
>
> Summa Social resol **molt b√©** uns problemes concrets (conciliaci√≥ + fiscalitat) en lloc de resoldre **regular** molts problemes diferents.
>
> Cada funcionalitat nova ha de passar el filtre:
> - Redueix errors a l'entitat? ‚úÖ
> - Estalvia temps real? ‚úÖ
> - √âs mantenible per una sola persona? ‚úÖ
> - Contribueix als objectius estrat√®gics? ‚úÖ


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 13. REGLES PER A L'√öS DE LLMs
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| # | Regla |
|---|-------|
| 1 | Cap proposta pot contradir l'√Ämbit i L√≠mits (Secci√≥ 12) |
| 2 | No modificar l'esquema Firestore existent |
| 3 | No eliminar ni renomenar camps |
| 4 | Nom√©s afegir camps opcionals si √©s imprescindible |
| 5 | No afegir depend√®ncies noves sense justificaci√≥ |
| 6 | Nom√©s funcions pures i codi modular |
| 7 | Prioritat per simplicitat i manteniment baix |
| 8 | No IA que "aprengui" autom√†ticament |
| 9 | Tot alineat amb Bloc 1 (Conciliaci√≥) o Bloc 2 (Fiscalitat) |
| 10 | Millores Transversals sempre admissibles |
| 11 | **NO fuzzy matching de noms** |
| 12 | **NO assignaci√≥ autom√†tica sense confirmaci√≥ de l'usuari** |

## 13.1 Comportament Esperat

**Quan se li demani codi:**
- Proporcionar codi COMPLET
- Indicar path del fitxer
- Incloure passos de verificaci√≥
- Respondre en CATAL√Ä

## 13.2 Patrons de Codi Obligatoris

### Firestore: `null` vs `undefined`

> ‚ö†Ô∏è **CR√çTIC**: Firestore **NO accepta `undefined`** com a valor de camp.

**MAL** (provoca error):
```typescript
const newTxData = {
  contactType: contactId ? 'donor' : undefined,  // ‚ùå ERROR
  projectId: transaction.projectId,               // ‚ùå ERROR si √©s undefined
};
batch.set(docRef, newTxData);
```

**B√â** (patr√≥ correcte):
```typescript
const newTxData = {
  contactType: contactId ? 'donor' : null,        // ‚úÖ null acceptat
  projectId: transaction.projectId ?? null,       // ‚úÖ converteix undefined a null
};
batch.set(docRef, newTxData);
```

**Alternativa** (ometre camp si no existeix):
```typescript
const newTxData = {
  ...(contactId && { contactType: 'donor' }),     // ‚úÖ nom√©s afegeix si existeix
  ...(transaction.projectId && { projectId: transaction.projectId }),
};
```

**Regla general**: Tots els camps opcionals han de ser `string | null`, mai `undefined`.

### Gesti√≥ de transaccions consumides (NOU v1.8)

> ‚ö†Ô∏è **CR√çTIC**: NO usar `splice()` per marcar transaccions com a usades.

**MAL** (mutaci√≥ d'array):
```typescript
const idx = pendingReturns.findIndex(t => t.id === matchingTx.id);
if (idx > -1) pendingReturns.splice(idx, 1);  // ‚ùå Mutaci√≥ fr√†gil
```

**B√â** (Set d'IDs):
```typescript
const usedTransactionIds = new Set<string>();

const matchingTx = pendingReturns.find(tx => 
  !usedTransactionIds.has(tx.id) && ...
);

if (matchingTx) {
  usedTransactionIds.add(matchingTx.id);  // ‚úÖ Immutable
}
```

**Quan se li demani nova funcionalitat:**
- Validar si encaixa amb blocs estrat√®gics
- Si no encaixa, informar i suggerir alternatives


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 14. PARAULES CLAU I INTENCIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Terme | Interpretaci√≥ Correcta | ‚ö†Ô∏è NO significa |
|-------|------------------------|-----------------|
| "Conciliaci√≥ banc√†ria" | Saldos, desquadraments, regles, devolucions | Integraci√≥ amb bancs |
| "Fiscalitat" | Model 182, 347, certificats, Excel | Presentaci√≥ a AEAT |
| "Excel net" | Fitxer simple per gestoria | Fitxer BOE oficial |
| "Determinista" | Regla fixa, mateix resultat | IA aut√≤noma |
| "Auto-assignaci√≥" | Matching + categoria defecte | IA sense supervisi√≥ |
| "Remesa" | Agrupaci√≥ quotes socis O devolucions | Qualsevol ingr√©s |
| "Gestoria" | Professional extern | L'entitat mateixa |
| "Matching exacte" | IBAN/DNI/Nom id√®ntic | Fuzzy, aproximat |
| "Remesa parcial" | Algunes devolucions pendents | Remesa incompleta per error |
| "Payout Stripe" | Liquidaci√≥ de Stripe al banc (po_xxx) | Donaci√≥ individual |
| "Comissi√≥ Stripe" | Despesa agregada per payout | Cost per donaci√≥ |
| "Remesa Stripe" | Payout dividit en donacions individuals | Connexi√≥ API Stripe |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 15. NORMALITZACI√ì DE DADES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 15.1 Principi General

Totes les dades d'entrada es normalitzen abans de desar-les a Firestore. L'objectiu √©s garantir:
- Consist√®ncia en les cerques i el matching
- Deduplicaci√≥ fiable
- Formats v√†lids per a fiscalitat (Model 182, 347)

> **Fitxer principal**: `src/lib/normalize.ts`

## 15.2 Noms de Persones F√≠siques

### Regles de capitalitzaci√≥

| Entrada | Sortida | Regla |
|---------|---------|-------|
| `JOAN GARCIA` | `Joan Garcia` | Cada paraula amb maj√∫scula inicial |
| `maria del carmen` | `Maria del Carmen` | Part√≠cules en min√∫scula |
| `pau de la font` | `Pau de la Font` | Part√≠cules: de, del, de la, de les, dels |

### Part√≠cules i excepcions

Les seg√ºents part√≠cules es mantenen en min√∫scula quan van entre mots:
- `de`, `del`, `de la`, `de les`, `dels`
- `i`, `y`
- `la`, `el`, `les`, `els` (quan s√≥n articles)

**Apostrofats** (catal√†):
- `d'Amat` ‚Üí mant√© l'ap√≤strof i maj√∫scula al nom
- `l'Hospitalet` ‚Üí mant√© format

**Exemple**:
```
Input:  "MARIA DELS ANGELS DE LA FONT I PUIG"
Output: "Maria dels √Ängels de la Font i Puig"
```

## 15.3 Noms de Persones Jur√≠diques

### Sufixos de societat

| Entrada | Sortida normalitzada |
|---------|---------------------|
| `S L`, `s.l`, `SL` | `S.L.` |
| `S A`, `s.a`, `SA` | `S.A.` |
| `S L U`, `slu`, `S.L.U` | `S.L.U.` |
| `S COOP`, `s. coop` | `S.Coop.` |
| `S C P`, `scp` | `S.C.P.` |
| `C B`, `cb` | `C.B.` |

**Exemple**:
```
Input:  "CONSULTORIA TECH sl"
Output: "Consultoria Tech S.L."
```

### Fundacions i associacions

| Tipus | Paraules clau | Tracte |
|-------|---------------|--------|
| Fundaci√≥ | `Fundaci√≥`, `Fundaci√≥n` | Maj√∫scula inicial |
| Associaci√≥ | `Associaci√≥`, `Asociaci√≥n` | Maj√∫scula inicial |

## 15.4 NIF, NIE i CIF

### Formats acceptats i normalitzaci√≥

| Entrada | Sortida | V√†lid |
|---------|---------|-------|
| `12345678-Z` | `12345678Z` | ‚úÖ |
| `12345678 z` | `12345678Z` | ‚úÖ |
| `x-1234567-w` | `X1234567W` | ‚úÖ |
| `b-12345678` | `B12345678` | ‚úÖ |

### Regles

1. **Eliminar**: espais, guions, punts
2. **Convertir**: tot a maj√∫scules
3. **Validar**: lletra de control (opcional, nom√©s av√≠s)

### Patrons v√†lids

| Tipus | Patr√≥ | Exemple |
|-------|-------|---------|
| NIF | `8 d√≠gits + lletra` | `12345678Z` |
| NIE | `X/Y/Z + 7 d√≠gits + lletra` | `X1234567W` |
| CIF | `lletra + 8 car√†cters` | `B12345678` |

## 15.5 IBAN

### Normalitzaci√≥

| Entrada | Sortida |
|---------|---------|
| `ES91 2100 0418 4502 0005 1332` | `ES91210004184502000051332` |
| `es91-2100-0418-4502-0005-1332` | `ES91210004184502000051332` |

### Regles

1. **Eliminar**: espais, guions
2. **Convertir**: tot a maj√∫scules
3. **Validar**: longitud 24 car√†cters (Espanya)

> **Emmagatzematge**: Sempre sense espais ni guions
> **Visualitzaci√≥**: Amb espais cada 4 car√†cters (`formatIBAN()`)

## 15.6 Email

### Normalitzaci√≥

| Entrada | Sortida |
|---------|---------|
| `  Joan.Garcia@Gmail.COM  ` | `joan.garcia@gmail.com` |
| `Maria@Empresa.Es` | `maria@empresa.es` |

### Regles

1. **Trim**: eliminar espais al principi i final
2. **Lowercase**: tot en min√∫scules
3. **Validar**: format email b√†sic (cont√© `@` i `.`)

## 15.7 Tel√®fon

### Normalitzaci√≥ a E.164

| Entrada | Sortida |
|---------|---------|
| `612 34 56 78` | `+34612345678` |
| `+34 612-345-678` | `+34612345678` |
| `0034612345678` | `+34612345678` |
| `612345678` | `+34612345678` |

### Regles

1. **Eliminar**: espais, guions, par√®ntesis, punts
2. **Normalitzar prefix**:
   - Si comen√ßa per `0034` ‚Üí reempla√ßar per `+34`
   - Si comen√ßa per `34` ‚Üí afegir `+`
   - Si comen√ßa per `6` o `9` ‚Üí afegir `+34`
3. **Resultat**: format E.164 (`+34XXXXXXXXX`)

> **Emmagatzematge**: Format E.164
> **Visualitzaci√≥**: Amb espais (`formatPhone()`)

## 15.8 Adreces

### Camps separats (no normalitzaci√≥ agressiva)

Les adreces es desen en camps separats sense modificar excessivament:

| Camp | Normalitzaci√≥ |
|------|---------------|
| `street` | Trim, sense canvis de capitalitzaci√≥ |
| `city` | Trim |
| `province` | Trim |
| `postalCode` | Trim, nom√©s d√≠gits, 5 car√†cters |
| `country` | Trim, default `Espanya` |

### Codi Postal

| Entrada | Sortida |
|---------|---------|
| `08001` | `08001` |
| `8001` | `08001` |
| `08-001` | `08001` |

> **Regla**: Sempre 5 d√≠gits, amb zero inicial si cal

## 15.9 Espais en Blanc

### Regles generals

1. **Trim**: eliminar espais al principi i final de tots els camps
2. **Col¬∑lapsar**: m√∫ltiples espais consecutius ‚Üí un sol espai
3. **Eliminar NBSP**: reempla√ßar `\u00A0` per espai normal

```typescript
function normalizeWhitespace(s: string): string {
  return s
    .replace(/\u00A0/g, ' ')  // NBSP ‚Üí espai
    .replace(/\s+/g, ' ')     // col¬∑lapsar
    .trim();                   // trim
}
```

## 15.10 Clau de Deduplicaci√≥ (normalizedName)

### Prop√≤sit

Camp calculat per detectar duplicats i fer matching aproximat.

### C√†lcul

```typescript
function normalizedName(name: string): string {
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')  // eliminar accents
    .replace(/[^a-z0-9]/g, '')        // nom√©s alfanum√®ric
    .trim();
}
```

### Exemples

| Nom original | normalizedName |
|--------------|----------------|
| `Joan Garc√≠a` | `joangarcia` |
| `Mar√≠a del Carmen` | `mariadelcarmen` |
| `Fundaci√≥ l'√Äncora` | `fundaciolancora` |

> **√ös**: Cercar duplicats, no per matching fiscal (que usa NIF/IBAN exactes)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX A ‚Äî DECISIONS IRREVERSIBLES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| # | Decisi√≥ | Estat |
|---|---------|-------|
| 1 | **Base de dades**: Firestore | üîí TANCAT |
| 2 | **Model de dades**: Collections estables | üîí TANCAT |
| 3 | **Rol**: Conciliaci√≥ + Fiscalitat | üîí TANCAT |
| 4 | **Arquitectura**: Next.js 15 + Firebase | üîí TANCAT |
| 5 | **IA**: Nom√©s Genkit + Gemini | üîí TANCAT |
| 6 | **√Ämbit**: No ERP, CRM, facturaci√≥ | üîí TANCAT |
| 7 | **Matching**: Nom√©s exacte (IBAN/DNI/Nom) | üîí TANCAT |
| 8 | **Moviments bancaris**: Immutables | üîí TANCAT |

> ‚õî **Cap LLM pot proposar:**
> - Migrar a SQL, MongoDB, Supabase
> - Canviar Next.js per altre framework
> - Afegir backend separat
> - Fine-tuning de models IA
> - Funcionalitats CRM, ERP, facturaci√≥
> - Integraci√≥ directa APIs banc√†ries
> - Fuzzy matching de noms
> - Modificar/esborrar moviments bancaris originals

> ‚úÖ **Un LLM S√ç pot proposar:**
> - Millores dins l'arquitectura actual
> - Nous camps opcionals a Firestore
> - Noves subcollections si imprescindible
> - Optimitzacions de rendiment
> - Millores UX sense canviar funcionalitat
> - Nous patrons de matching EXACTE (email, tel√®fon...)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX B ‚Äî DOCUMENT PER GPT ASSISTENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## CONTEXT

Summa Social √©s una aplicaci√≥ de gesti√≥ financera per entitats espanyoles.
Gestiona moviments bancaris, donants, prove√Ødors i fiscalitat (Model 182, 347, certificats).
El m√≤dul de devolucions resol el problema de rebuts retornats pel banc sense identificar.

## CONCEPTES CLAU

- DEVOLUCI√ì = Rebut que el banc no ha pogut cobrar i retorna a l'entitat
- REMESA = Agrupaci√≥ de m√∫ltiples moviments en un sol apunt bancari
- REMESA PARCIAL = Remesa amb algunes devolucions pendents d'identificar
- MATCHING = Assignaci√≥ de contacte per coincid√®ncia exacta (IBAN/DNI/Nom)

## FLUX DEVOLUCIONS

1. Usuari veu banner "Devolucions pendents" a Moviments
2. Clica "Revisar" ‚Üí Filtra per devolucions
3. Per cada devoluci√≥:
   - "Assignar donant" ‚Üí Cerca manual
   - Icona üìÑ ‚Üí Importador de fitxer del banc
4. L'importador fa matching per IBAN ‚Üí DNI ‚Üí Nom exacte
5. Es creen transaccions filles, el pare queda immutable

## BANCS SUPORTATS

- Santander: XLSX, data global a cap√ßalera
- Triodos: CSV/XLS, data per l√≠nia
- Altres: Detecci√≥ autom√†tica de columnes

## ERRORS COMUNS

| Error | Causa | Soluci√≥ |
|-------|-------|---------|
| "No s'ha trobat cap donant" | IBAN diferent | Actualitzar IBAN del donant |
| "M√∫ltiples candidates" | Diverses transaccions possibles | Assignar manualment |
| "Sense data fiable" | Banc no informa data | Normal, funciona igualment |

## FRASES PER RESPONDRE

- "Les devolucions es resten autom√†ticament del total un cop assignades."
- "El moviment bancari original no es toca."
- "Si una remesa queda parcial, pots completar-la m√©s tard."
- "Summa Social no fa assignacions autom√†tiques sense coincid√®ncia exacta."

## L√çMITS

- NO fuzzy matching de noms
- NO assignaci√≥ autom√†tica sense confirmaci√≥
- NO modificar moviments bancaris
- Les remeses parcials requereixen acci√≥ manual


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX C ‚Äî EXPORTS I M√íDULS DESACOBLATS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## C.1 Principi Arquitect√≤nic

Summa Social pot generar **feeds de dades de nom√©s lectura** mitjan√ßant Cloud Functions.

Aquests feeds serveixen perqu√® m√≤duls externs consumeixin dades sense afectar el core de l'aplicaci√≥. L'objectiu √©s permetre extensions opcionals mantenint la integritat i simplicitat del producte principal.

## C.2 Patr√≥ Oficial

| Responsabilitat | Actor |
|-----------------|-------|
| **Escriptura del feed** | Backend de Summa Social (Cloud Functions) |
| **Lectura del feed** | Aplicacions o m√≤duls externs |
| **Escriptura al m√≤dul extern** | Nom√©s el m√≤dul extern |

> ‚ö†Ô∏è **Regla fonamental**: Cap m√≤dul extern pot escriure dins del core de Summa Social.

## C.3 Exemple Normatiu: M√≤dul de Projectes

### Estructura Firestore

**Feed de despeses (escriu Summa, llegeix m√≤dul extern):**

```
/organizations/{orgId}/exports/projectExpenses/items/{txId}
```

**Assignacions a projectes (fora de Summa, escriu m√≤dul extern):**

```
/organizations/{orgId}/projectModule/_/expenseLinks/{txId}
```

**Projectes del m√≤dul:**

```
/organizations/{orgId}/projectModule/_/projects/{projectId}
```

**Transfer√®ncies FX del projecte (NOU v1.33):**

```
/organizations/{orgId}/projectModule/_/projects/{projectId}/fxTransfers/{transferId}
```

Camps: `date`, `eurSent`, `localCurrency`, `localReceived`, `bankTxRef?`, `notes?`

> Nota: El document `_` √©s un placeholder t√®cnic necessari per complir l'estructura de Firestore (segments alterns col¬∑lecci√≥/document).

### Join Client-Side

El m√≤dul extern fa el join entre:
- La despesa (del feed `exports/projectExpenses/items`)
- L'assignaci√≥ (de `projectModule/_/expenseLinks`)

Summa Social no coneix ni gestiona les assignacions.

## C.4 L√≠mits Expl√≠cits del Producte

Summa Social **NO**:
- Gestiona projectes (m√©s enll√† dels eixos d'actuaci√≥ existents)
- Gestiona subvencions
- Fa justificacions econ√≤miques
- Controla pressupostos de projectes

Qualsevol funcionalitat en aquesta l√≠nia √©s **externa i opcional**, i s'ha d'implementar fora del core mitjan√ßant el patr√≥ d'exports descrit.

## C.5 Firestore Rules

### CollectionGroup per membres (v1.16)

Permet a un usuari trobar les seves membresies via `collectionGroup`:

```javascript
match /{path=**}/members/{memberId} {
  allow read: if isSignedIn() && request.auth.uid == memberId;
}
```

### Exports i projectModule

Els feeds d'exports s√≥n de nom√©s lectura per als clients:

```javascript
match /exports/{exportType} {
  allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
  allow write: if false; // Nom√©s Cloud Functions

  match /items/{itemId} {
    allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
    allow write: if false; // Nom√©s Cloud Functions
  }
}

match /projectModule/{document=**} {
  allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
  allow write: if (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']) || isSuperAdmin();
}
```

## C.6 √çndexos Firestore (M√≤dul Projectes)

Els √≠ndexos necessaris per al m√≤dul de projectes:

### expenseLinks (projectModule/_/expenseLinks)

| Col¬∑lecci√≥ | Camps | Ordre | √ös |
|------------|-------|-------|-----|
| expenseLinks | `projectIds` (array-contains) | - | Filtrar despeses per projecte |
| expenseLinks | `budgetLineIds` (array-contains) | - | Filtrar despeses per partida pressupost√†ria |

> **Nota**: No s'utilitza `orderBy` en aquestes queries per evitar necessitat d'√≠ndexos compostos. L'ordenaci√≥ es fa client-side.

### exports/projectExpenses/items

| Col¬∑lecci√≥ | Camps | Ordre |
|------------|-------|-------|
| items | `isEligibleForProjects`, `deletedAt`, `date` | date DESC |

> **Nota**: Aquest √≠ndex ja existeix per al feed de despeses elegibles.

### Backfill de budgetLineIds

Les assignacions creades abans de la implementaci√≥ del camp `budgetLineIds` no el tindran poblat. El codi implementa un fallback:
1. Si la query per `budgetLineIds` retorna 0 resultats i hi ha `projectId` disponible
2. Es carreguen els links del projecte i es filtra client-side per `assignments[].budgetLineId`
3. Es trackeja amb `expenses.filter.fallback_used` per monitoritzaci√≥


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX D: NOVETATS DEL PRODUCTE (v1.33)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## D.1 Descripci√≥ del Sistema

Sistema unificat per comunicar novetats del producte als usuaris a trav√©s de m√∫ltiples canals:
- **Campaneta/FAB (inst√†ncia)**: Mostra N √∫ltimes novetats dins l'aplicaci√≥ (inbox pull, sense toast autom√†tic)
- **Web p√∫blic**: P√†gina `/novetats` per SEO i sharing
- **Social**: Copy per X i LinkedIn (manual)

### Comportament UX (v1.31)

Les novetats es mostren **nom√©s via inbox** (campaneta o FAB), mai amb toast autom√†tic:
- L'usuari decideix quan vol veure novetats (pull, no push)
- Badge num√®ric indica novetats no llegides
- Zero interrupcions al flux de treball
- Toast reservat per feedback d'accions expl√≠cites (guardar, importar, errors)

## D.2 Arquitectura

### Font √∫nica: Firestore `productUpdates`

```
/productUpdates/{updateId}
  id: string
  title: string
  description: string
  link: string | null
  isActive: boolean
  publishedAt: Timestamp
  createdAt: Timestamp

  // Detall (TEXT PLA, NO HTML)
  contentLong?: string | null
  guideUrl?: string | null
  videoUrl?: string | null

  // Web
  web?: {
    enabled: boolean
    slug: string
    excerpt?: string | null
    content?: string | null
  } | null

  // Social
  social?: {
    enabled: boolean
    xText?: string | null
    linkedinText?: string | null
    linkUrl?: string | null
  } | null
```

### Web p√∫blic: JSON est√†tic (NO Firestore directe)

El web p√∫blic `/novetats` NO llegeix Firestore directament per seguretat.

**Flux:**
1. SuperAdmin genera novetat amb `web.enabled: true`
2. SuperAdmin clica "Exportar web JSON" ‚Üí descarrega `novetats-data.json`
3. Commit manual a `public/novetats-data.json`
4. Deploy

## D.3 Guardrails (NO NEGOCIABLES)

| Regla | Motiu |
|-------|-------|
| NO HTML a `contentLong` | XSS prevention, render segur |
| NO `dangerouslySetInnerHTML` | Seguretat |
| NO Firestore list p√∫blic | Evitar leaks i costos |
| NO `undefined` a writes | Firestore errors |
| NO deps noves | Estabilitat |

## D.4 Fitxers Principals

```
src/hooks/use-product-updates.ts           # Hook Firestore + fallback
src/lib/render-structured-text.tsx         # Render text pla (NO HTML)
src/lib/firestore-utils.ts                 # stripUndefined helpers
src/components/notifications/              # Campaneta + modal
src/components/admin/product-updates-section.tsx  # SuperAdmin
src/app/api/ai/generate-product-update/    # Endpoint IA
src/app/public/[lang]/novetats/            # Web p√∫blic
public/novetats-data.json                  # JSON est√†tic web
```

## D.5 Ritual Publicaci√≥ Web

1. Crear/editar novetat amb `web.enabled: true` a SuperAdmin
2. Clicar "Exportar web JSON"
3. Substituir `public/novetats-data.json` amb el fitxer descarregat
4. `git add && git commit && git push`
5. Deploy (Firebase Hosting)

> **Important**: El web NO s'actualitza autom√†ticament. Cal fer commit + deploy.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# E. TROUBLESHOOTING - INCIDENTS RESOLTS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## E.1 Build App Hosting falla amb "PermissionDenied" per secrets

**Data:** 2025-01-02
**Commits:** `fd9754c`, `1833864`, `f7d82de`, `7fcd176`

### S√≠mptoma

El build de Firebase App Hosting falla amb:
```
Error resolving secret version with name=projects/summa-social/secrets/RESEND_API_KEY/versions/latest
Permission 'secretmanager.versions.get' denied
```

### Causa

Quan es crea un secret nou via `gcloud` o manualment, **no s'afegeixen autom√†ticament** els rols IAM que App Hosting necessita per:
1. Llegir metadades del secret (`viewer`)
2. "Pin" la versi√≥ latest a una concreta (`secretVersionManager`)
3. Accedir al valor (`secretAccessor`)

El secret `GOOGLE_API_KEY` funcionava perqu√® Firebase CLI l'havia configurat autom√†ticament. `RESEND_API_KEY` es va crear manualment i no tenia els rols.

### Soluci√≥ (3 passos)

```bash
# 1. Afegir secretAccessor (llegir valor)
gcloud secrets add-iam-policy-binding RESEND_API_KEY \
  --project=summa-social \
  --member="serviceAccount:service-469685881071@gcp-sa-firebaseapphosting.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"

# 2. Afegir secretVersionManager (pin versions)
gcloud secrets add-iam-policy-binding RESEND_API_KEY \
  --project=summa-social \
  --member="serviceAccount:service-469685881071@gcp-sa-firebaseapphosting.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretVersionManager"

# 3. Afegir viewer (llegir metadades)
gcloud secrets add-iam-policy-binding RESEND_API_KEY \
  --project=summa-social \
  --member="serviceAccount:firebase-app-hosting-compute@summa-social.iam.gserviceaccount.com" \
  --role="roles/secretmanager.viewer"
```

### Prevenci√≥

Quan afegeixis un **nou secret** per App Hosting:
1. Crea el secret: `gcloud secrets create NOM_SECRET --project=summa-social`
2. Afegeix el valor: `echo -n "valor" | gcloud secrets versions add NOM_SECRET --data-file=-`
3. **Copia els rols IAM** d'un secret que funcioni (ex: `GOOGLE_API_KEY`):
   ```bash
   gcloud secrets get-iam-policy GOOGLE_API_KEY --project=summa-social
   # Replicar els bindings al nou secret
   ```

### Verificaci√≥

```bash
gcloud secrets get-iam-policy NOM_SECRET --project=summa-social
```

Ha de mostrar com a m√≠nim:
- `roles/secretmanager.secretAccessor` ‚Üí service agent
- `roles/secretmanager.secretVersionManager` ‚Üí service agent
- `roles/secretmanager.viewer` ‚Üí compute SA


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# INVARIANTS DE DOCUMENTACI√ì
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Les seg√ºents regles han de ser certes en tot moment. Si es trenca alguna, cal corregir la documentaci√≥:

1. **Cap path citat pot ser inexistent** ‚Äî Tot fitxer referenciat ha d'existir al repositori.
2. **Cap camp al model 2.2 pot ser inventat** ‚Äî Cada camp ha de correspondre a un camp real del tipus TypeScript (`src/lib/data.ts` o fitxers de tipus associats).
3. **SuperAdmin √©s global, no rol d'organitzaci√≥** ‚Äî `OrganizationRole = 'admin' | 'user' | 'viewer'`. SuperAdmin es gestiona via `systemSuperAdmins/{uid}`.
4. **Rutes p√∫bliques sota `/public/[lang]/`** ‚Äî El segment `public` √©s real (no virtual). El middleware reescriu `/{lang}/...` ‚Üí `/public/{lang}/...`.
5. **Portugu√®s (pt) √©s JSON-only** ‚Äî No existeix `src/i18n/pt.ts`. Les traduccions pt viuen exclusivament a `src/i18n/locales/pt.json`.
6. **Remittances √©s subcol¬∑lecci√≥** ‚Äî `organizations/{orgId}/remittances/{remittanceId}` existeix amb subcol¬∑lecci√≥ `pending/`.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# FI DEL DOCUMENT
# √öltima actualitzaci√≥: 10 Febrer 2026 - Versi√≥ 1.40
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
