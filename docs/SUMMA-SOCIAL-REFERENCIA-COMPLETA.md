# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# SUMMA SOCIAL - REFER√àNCIA COMPLETA DEL PROJECTE
# Versi√≥ 1.10 - Desembre 2025
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 0. AQUEST DOCUMENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Aquest document √©s la **REFER√àNCIA MESTRA** de Summa Social.

Defineix:
- La visi√≥ del producte
- L'arquitectura funcional
- El model de dades
- Les funcionalitats existents i previstes
- Els l√≠mits i l'√†mbit del producte

**Jerarquia de documents:**
- Aquest document t√© **PRIORITAT ABSOLUTA**
- Qualsevol altre document (guies de desenvolupament, prompts per IA, manuals d'usuari, etc.) √©s complementari
- En cas de conflicte entre documents, aquest text **SEMPRE** t√© prioritat
- Cap LLM ni desenvolupador pot contradir el que est√† escrit aqu√≠

**Quan usar aquest document:**
- Per entendre qu√® fa i qu√® NO fa Summa Social
- Per prendre decisions de producte
- Per validar si una nova funcionalitat encaixa amb la visi√≥
- Per donar context a qualsevol IA que treballi amb el projecte

**Estructura de la documentaci√≥:**
```
/docs
‚îú‚îÄ‚îÄ SUMMA-SOCIAL-REFERENCIA-COMPLETA.md   # Aquest document (mestre)
‚îú‚îÄ‚îÄ CHANGELOG.md                           # Historial de canvis detallat
‚îú‚îÄ‚îÄ manual-usuari-summa-social.md          # Per a usuaris finals
‚îî‚îÄ‚îÄ CATALEG-FUNCIONALITATS.md              # Refer√®ncia r√†pida de funcionalitats
```


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 1. INFORMACI√ì GENERAL
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 1.1 Qu√® √©s Summa Social?

Summa Social √©s una aplicaci√≥ web de gesti√≥ financera dissenyada espec√≠ficament per a petites i mitjanes ONGs i entitats sense √†nim de lucre d'Espanya. L'aplicaci√≥ substitueix els fulls de c√†lcul (Excel/Google Sheets) per una eina intel¬∑ligent i centralitzada.

## 1.2 Problema que Resol

Les ONGs espanyoles gestionen les seves finances amb fulls de c√†lcul, cosa que provoca:
- Errors humans en la categoritzaci√≥ de moviments
- Dificultat per generar informes fiscals obligatoris (Model 182, Model 347)
- Impossibilitat de tenir una visi√≥ consolidada de les finances
- P√®rdua de temps en tasques repetitives
- Dificultats per fer seguiment de donants i prove√Ødors
- Problemes per emetre certificats de donaci√≥
- Conciliaci√≥ banc√†ria manual i propensa a errors
- Gesti√≥ manual de devolucions banc√†ries

## 1.3 Soluci√≥

Eina centralitzada amb:
- Importaci√≥ autom√†tica d'extractes bancaris (CSV/XLSX)
- Categoritzaci√≥ intel¬∑ligent amb IA (Gemini)
- Auto-assignaci√≥ de contactes als moviments
- Generaci√≥ autom√†tica d'informes fiscals (Excel per gestoria)
- Certificats de donaci√≥ PDF amb firma digitalitzada
- Dashboard amb m√®triques en temps real
- Multi-organitzaci√≥ amb sistema de rols
- Divisor de remeses amb matching intel¬∑ligent
- **Importador de devolucions del banc (NOU v1.8)**
- **Importador de donacions Stripe (NOU v1.9)**

## 1.4 URLs i Recursos

| Recurs | URL |
|--------|-----|
| **Producci√≥** | https://summasocial.app |
| **Hosting Firebase** | https://studio--summa-social.us-central1.hosted.app |
| **Repositori** | https://github.com/raulvico1975/summa-social |
| **Entorn desenvolupament** | VS Code + Claude Code |

## 1.5 Stack Tecnol√≤gic

| Component | Tecnologia | Versi√≥ |
|-----------|------------|--------|
| Frontend | Next.js (App Router) | 14.x |
| Llenguatge | TypeScript | 5.x |
| UI Components | shadcn/ui | - |
| Estils | Tailwind CSS | 3.x |
| Base de dades | Firebase Firestore | - |
| Autenticaci√≥ | Firebase Auth | - |
| Emmagatzematge | Firebase Storage | - |
| IA | Genkit + Google Gemini | - |
| Idiomes | Catal√† i Espanyol | i18n |
| Excel/CSV | SheetJS (xlsx) | - |
| PDF | jsPDF | - |

## 1.6 Sobre l'Usuari Desenvolupador

- **Nom**: Raul
- **Perfil**: NO programador - Assessor d'ONGs que porta els comptes de diverses entitats
- **Entorn**: VS Code + Claude Code
- **Necessitats**: Codi COMPLET (mai fragments), passos verificables, respostes en CATAL√Ä

## 1.7 Prioritats Estrat√®giques 2025-2026

Per a les properes versions, Summa Social se centra en **dos blocs principals**:

### Bloc 1: Conciliaci√≥ Banc√†ria Real

| Funcionalitat | Descripci√≥ | Estat |
|---------------|------------|-------|
| **Saldos per compte** | Saldo inicial, moviments, saldo final per compte bancari | üî≤ Pendent |
| **Detecci√≥ desquadraments** | Alertes quan el saldo calculat no coincideix amb l'extracte | üî≤ Pendent |
| **Regles deterministes** | Categoritzaci√≥ autom√†tica per patrons de text | üî≤ Pendent |
| **Mem√≤ria de classificaci√≥** | Reutilitzar decisions pr√®vies | üî≤ Pendent |
| **Detecci√≥ d'anomalies** | Duplicats, moviments sense contacte, imports inusuals | üî≤ Pendent |
| **Gesti√≥ de devolucions** | Importador de fitxers del banc, remeses parcials | ‚úÖ Implementat v1.8 |

### Bloc 2: Fiscalitat Fina Orientada a Gestoria

| Funcionalitat | Descripci√≥ | Estat |
|---------------|------------|-------|
| **Validaci√≥ estricta NIF/CIF** | Algorisme oficial, no permetre dades inv√†lides | üî≤ Pendent |
| **Dades m√≠nimes obligat√≤ries** | CP i adre√ßa per Model 182 | ‚úÖ Implementat |
| **Consolidaci√≥ anual** | Import total per donant/prove√Ødor amb devolucions aplicades | ‚úÖ Implementat |
| **Checklist pre-informe** | Llista d'errors a corregir abans de generar 182/347 | üî≤ Pendent |
| **Excel net per gestoria** | Format est√†ndard Model 182 amb recurr√®ncia | ‚úÖ Implementat v1.7 |
| **Importador Stripe** | Dividir remeses Stripe amb tra√ßabilitat completa (donacions + comissions) | ‚úÖ Implementat v1.9 |

### Criteri de Prioritzaci√≥

> ‚ö†Ô∏è **Qualsevol nova funcionalitat s'ha de valorar segons si contribueix a aquests dos objectius.**
>
> Si una funcionalitat no millora la conciliaci√≥ banc√†ria ni la preparaci√≥ fiscal, **NO √©s priorit√†ria**.


## 1.8 Millores Transversals

A m√©s dels dos blocs prioritaris, Summa Social incorpora un conjunt de **millores transversals** que s√≥n sempre admissibles i prioritzables.

> ‚úÖ Aquestes l√≠nies de millora es poden implementar en **qualsevol moment**, sense necessitat d'avaluaci√≥ estrat√®gica addicional.

### 1.8.1 Millores de Robustesa
- Correcci√≥ d'errors o comportaments inesperats
- Validacions addicionals per evitar dades incompletes
- Maneig d'errors m√©s predictible i informatiu

### 1.8.2 Millores de Rendiment
- Optimitzaci√≥ de consultes i paginaci√≥ a Firestore
- Reducci√≥ de renders innecessaris en components React
- Simplificaci√≥ de fluxos intensius en mem√≤ria o c√†lcul

### 1.8.3 Millores de Seguretat
- Refor√ß de la protecci√≥ de dades sensibles
- Validaci√≥ estricta de l'input de l'usuari
- Millora i revisi√≥ del sistema de permisos i rols

### 1.8.4 Millores d'Experi√®ncia d'Usuari (UX/UI)
- Simplificaci√≥ d'interf√≠cies o formularis sense alterar funcionalitats
- Clarificaci√≥ de textos, etiquetes i missatges
- Reducci√≥ de passos innecessaris en fluxos d'√∫s actuals

### 1.8.5 Millores de Mantenibilitat
- Refactors orientats a reduir complexitat o duplicaci√≥
- Reorganitzaci√≥ de fitxers o components per guanyar llegibilitat
- Eliminaci√≥ de depend√®ncies innecess√†ries o obsoletes

### 1.8.6 Millores de Diagn√≤stic i Observabilitat
- Logs m√©s clars i estructurats
- Avisos o mecanismes per facilitar la depuraci√≥
- Indicadors interns per detectar problemes

### Principi General

> üí° Aquestes millores s√≥n sempre compatibles amb la visi√≥ del producte i contribueixen directament a la seva estabilitat i longevitat.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 2. ARQUITECTURA T√àCNICA
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 2.1 Estructura de Fitxers

```
/src
  /app                          ‚Üí P√†gines (Next.js App Router)
    /[orgSlug]                   ‚Üí Rutes per organitzaci√≥
      /dashboard
        /page.tsx                ‚Üí Dashboard principal
        /movimientos             ‚Üí Gesti√≥ de transaccions
        /donantes                ‚Üí Gesti√≥ de donants
        /proveedores             ‚Üí Gesti√≥ de prove√Ødors
        /trabajadores            ‚Üí Gesti√≥ de treballadors
        /ejes-de-actuacion       ‚Üí Gesti√≥ de projectes/eixos
        /informes                ‚Üí Informes fiscals (182, 347)
          /certificats           ‚Üí Certificats de donaci√≥
        /configuracion           ‚Üí Configuraci√≥ de l'organitzaci√≥
      /login                     ‚Üí Login per organitzaci√≥
    /admin                       ‚Üí Panel SuperAdmin global
  /components                    ‚Üí Components React reutilitzables
    /ui                          ‚Üí Components shadcn/ui
    /return-importer             ‚Üí Importador de devolucions (NOU v1.8)
      useReturnImporter.ts       ‚Üí Hook amb l√≤gica de matching
      ReturnImporter.tsx         ‚Üí Modal UI de l'importador
      index.ts                   ‚Üí Exports
    /stripe-importer             ‚Üí Importador de donacions Stripe (NOU v1.9)
      useStripeImporter.ts       ‚Üí Hook amb l√≤gica de parsing i matching
      StripeImporter.tsx         ‚Üí Modal UI de l'importador
      index.ts                   ‚Üí Exports
    donor-manager.tsx            ‚Üí Gesti√≥ de donants
    donor-importer.tsx           ‚Üí Importador massiu de donants
    supplier-manager.tsx         ‚Üí Gesti√≥ de prove√Ødors
    supplier-importer.tsx        ‚Üí Importador massiu de prove√Ødors
    transaction-table.tsx        ‚Üí Taula de moviments
    transaction-importer.tsx     ‚Üí Importador d'extractes
    remittance-splitter.tsx      ‚Üí Divisor de remeses
    donations-report-generator.tsx ‚Üí Generador Model 182
    donation-certificate-generator.tsx ‚Üí Generador certificats
    dashboard-*.tsx              ‚Üí Components del dashboard
  /firebase                      ‚Üí Configuraci√≥ i hooks de Firebase
  /hooks                         ‚Üí Hooks personalitzats de React
  /lib                           ‚Üí Utilitats, tipus i dades
    /data.ts                     ‚Üí Definicions de tipus (Donor, Supplier, etc.)
    /__tests__                   ‚Üí Tests unitaris (NOU v1.8)
      normalize.test.ts          ‚Üí 35 tests
      auto-match.test.ts         ‚Üí 24 tests
      model182.test.ts           ‚Üí 18 tests
  /i18n                          ‚Üí Traduccions
    /ca.ts                       ‚Üí Catal√†
    /es.ts                       ‚Üí Espanyol
  /ai                            ‚Üí Fluxos de Genkit (IA)
```

## 2.2 Model de Dades Firestore

```
organizations/
  ‚îî‚îÄ‚îÄ {orgId}/
      ‚îÇ
      ‚îú‚îÄ‚îÄ name: string                    # Nom de l'organitzaci√≥
      ‚îú‚îÄ‚îÄ taxId: string                   # CIF de l'entitat
      ‚îú‚îÄ‚îÄ slug: string                    # Identificador URL √∫nic
      ‚îú‚îÄ‚îÄ address: string                 # Adre√ßa fiscal
      ‚îú‚îÄ‚îÄ city: string                    # Ciutat
      ‚îú‚îÄ‚îÄ zipCode: string                 # Codi postal
      ‚îú‚îÄ‚îÄ phone: string                   # Tel√®fon
      ‚îú‚îÄ‚îÄ email: string                   # Email de contacte
      ‚îú‚îÄ‚îÄ website: string                 # P√†gina web
      ‚îú‚îÄ‚îÄ logoUrl: string | null          # URL del logo
      ‚îú‚îÄ‚îÄ signatureUrl: string | null     # URL de la firma digitalitzada
      ‚îú‚îÄ‚îÄ signerName: string | null       # Nom del signant
      ‚îú‚îÄ‚îÄ signerRole: string | null       # C√†rrec del signant
      ‚îÇ
      ‚îú‚îÄ‚îÄ settings/
      ‚îÇ   ‚îî‚îÄ‚îÄ preferences/
      ‚îÇ       ‚îî‚îÄ‚îÄ contactAlertThreshold: number
      ‚îÇ
      ‚îú‚îÄ‚îÄ members/
      ‚îÇ   ‚îî‚îÄ‚îÄ {userId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ role: "superadmin" | "admin" | "user" | "viewer"
      ‚îÇ       ‚îú‚îÄ‚îÄ email: string
      ‚îÇ       ‚îî‚îÄ‚îÄ displayName: string
      ‚îÇ
      ‚îú‚îÄ‚îÄ transactions/
      ‚îÇ   ‚îî‚îÄ‚îÄ {transactionId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ date: string                    # Data (YYYY-MM-DD)
      ‚îÇ       ‚îú‚îÄ‚îÄ description: string             # Concepte bancari
      ‚îÇ       ‚îú‚îÄ‚îÄ amount: number                  # Import (+ ingr√©s, - despesa)
      ‚îÇ       ‚îú‚îÄ‚îÄ category: string | null         # ID de categoria
      ‚îÇ       ‚îú‚îÄ‚îÄ categoryName: string | null     # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ emisorId: string | null         # ID del contacte
      ‚îÇ       ‚îú‚îÄ‚îÄ emisorName: string | null       # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ contactId: string | null        # ID contacte (alias emisorId)
      ‚îÇ       ‚îú‚îÄ‚îÄ contactType: string | null      # 'donor' | 'supplier' | 'employee'
      ‚îÇ       ‚îú‚îÄ‚îÄ contactName: string | null      # Nom contacte (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ projectId: string | null        # ID del projecte
      ‚îÇ       ‚îú‚îÄ‚îÄ projectName: string | null      # Nom (desnormalitzat)
      ‚îÇ       ‚îú‚îÄ‚îÄ documentUrl: string | null      # URL document adjunt
      ‚îÇ       ‚îú‚îÄ‚îÄ notes: string | null            # Notes internes
      ‚îÇ       ‚îú‚îÄ‚îÄ isCounterpartTransfer: boolean  # Transfer√®ncia a contrapart?
      ‚îÇ       ‚îú‚îÄ‚îÄ transactionType: string | null  # 'return' si √©s devoluci√≥
      ‚îÇ       ‚îú‚îÄ‚îÄ donationStatus: string | null   # 'returned' si marcada
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de remeses:
      ‚îÇ       ‚îú‚îÄ‚îÄ isRemittance: boolean | null    # √âs una remesa agrupada?
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceItemCount: number | null  # Nombre total de quotes
      ‚îÇ       ‚îú‚îÄ‚îÄ source: 'bank' | 'remittance' | 'manual' | 'stripe' | null  # Origen
      ‚îÇ       ‚îú‚îÄ‚îÄ parentTransactionId: string | null  # ID remesa pare
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de remeses de devolucions (NOU v1.8):
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceType: 'returns' | null    # Tipus de remesa
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceStatus: 'complete' | 'partial' | 'pending' | null
      ‚îÇ       ‚îú‚îÄ‚îÄ remittanceResolvedCount: number | null   # Filles creades
      ‚îÇ       ‚îú‚îÄ‚îÄ remittancePendingCount: number | null    # Pendents d'identificar
      ‚îÇ       ‚îú‚îÄ‚îÄ remittancePendingTotalAmount: number | null  # Import pendent ‚Ç¨
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps de donacions Stripe (NOU v1.9):
      ‚îÇ       ‚îú‚îÄ‚îÄ stripePaymentId: string | null      # ID pagament (ch_xxx)
      ‚îÇ       ‚îú‚îÄ‚îÄ stripeTransferId: string | null     # ID payout (po_xxx)
      ‚îÇ       ‚îú‚îÄ‚îÄ transactionType: 'donation' | 'fee' | 'return' | null  # Tipus espec√≠fic
      ‚îÇ       ‚îÇ
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
      ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
      ‚îÇ
      ‚îú‚îÄ‚îÄ categories/
      ‚îÇ   ‚îî‚îÄ‚îÄ {categoryId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ name: string
      ‚îÇ       ‚îú‚îÄ‚îÄ type: "income" | "expense"
      ‚îÇ       ‚îî‚îÄ‚îÄ order: number
      ‚îÇ
      ‚îú‚îÄ‚îÄ emissors/  (tamb√© anomenats "contacts")
      ‚îÇ   ‚îî‚îÄ‚îÄ {emisorId}/
      ‚îÇ       ‚îú‚îÄ‚îÄ name: string                    # Nom del contacte
      ‚îÇ       ‚îú‚îÄ‚îÄ taxId: string                   # NIF/CIF
      ‚îÇ       ‚îú‚îÄ‚îÄ zipCode: string                 # Codi postal
      ‚îÇ       ‚îú‚îÄ‚îÄ address: string                 # Adre√ßa (carrer, n√∫mero)
      ‚îÇ       ‚îú‚îÄ‚îÄ city: string                    # Ciutat
      ‚îÇ       ‚îú‚îÄ‚îÄ province: string                # Prov√≠ncia
      ‚îÇ       ‚îú‚îÄ‚îÄ email: string                   # Email
      ‚îÇ       ‚îú‚îÄ‚îÄ phone: string                   # Tel√®fon
      ‚îÇ       ‚îú‚îÄ‚îÄ iban: string                    # IBAN
      ‚îÇ       ‚îú‚îÄ‚îÄ type: "donor" | "supplier" | "employee"
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps espec√≠fics per DONANTS:
      ‚îÇ       ‚îú‚îÄ‚îÄ donorType: "individual" | "company"
      ‚îÇ       ‚îú‚îÄ‚îÄ membershipType: "one-time" | "recurring"
      ‚îÇ       ‚îú‚îÄ‚îÄ monthlyAmount: number           # Quota mensual
      ‚îÇ       ‚îú‚îÄ‚îÄ memberSince: string             # Data alta soci
      ‚îÇ       ‚îú‚îÄ‚îÄ status: "active" | "inactive"   # Estat
      ‚îÇ       ‚îú‚îÄ‚îÄ inactiveSince: string | null    # Data de baixa
      ‚îÇ       ‚îú‚îÄ‚îÄ returnCount: number             # Comptador devolucions
      ‚îÇ       ‚îú‚îÄ‚îÄ lastReturnDate: string          # √öltima devoluci√≥
      ‚îÇ       ‚îÇ
      ‚îÇ       # Camps comuns:
      ‚îÇ       ‚îú‚îÄ‚îÄ defaultCategoryId: string | null
      ‚îÇ       ‚îú‚îÄ‚îÄ notes: string
      ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
      ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
      ‚îÇ
      ‚îî‚îÄ‚îÄ projects/
          ‚îî‚îÄ‚îÄ {projectId}/
              ‚îú‚îÄ‚îÄ name: string
              ‚îú‚îÄ‚îÄ description: string
              ‚îú‚îÄ‚îÄ funderId: string | null
              ‚îú‚îÄ‚îÄ isActive: boolean
              ‚îú‚îÄ‚îÄ createdAt: timestamp
              ‚îî‚îÄ‚îÄ updatedAt: timestamp
```

## 2.3 Sistema d'Autenticaci√≥ i Rols

### Rols disponibles

| Rol | Descripci√≥ | Permisos |
|-----|------------|----------|
| **SuperAdmin** | Creador de l'organitzaci√≥ | Tot + Zona de Perill |
| **Admin** | Administrador | Tot excepte Zona de Perill |
| **User** | Usuari est√†ndard | Crear i editar, no eliminar ni configurar |
| **Viewer** | Nom√©s lectura | Veure dades, no modificar |

### Permisos detallats

| Acci√≥ | SuperAdmin | Admin | User | Viewer |
|-------|------------|-------|------|--------|
| Veure dashboard | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Veure moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Crear moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Editar moviments | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Eliminar moviments | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Importar extractes | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Gestionar contactes | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Gestionar categories | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Gestionar membres | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Configurar organitzaci√≥ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Generar informes | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Zona de Perill | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |

### Persist√®ncia de sessi√≥

- **Tipus**: `browserSessionPersistence`
- La sessi√≥ caduca autom√†ticament en tancar el navegador
- Implementat a v1.7 per seguretat

## 2.4 Multi-Organitzaci√≥

- Cada usuari pot pert√†nyer a m√∫ltiples organitzacions
- Les dades estan completament a√Øllades entre organitzacions
- L'URL inclou el slug de l'organitzaci√≥: `/[orgSlug]/dashboard/...`
- Un usuari pot tenir rols diferents a cada organitzaci√≥
- Sistema centralitzat de slugs per evitar duplicats

## 2.5 Tests Unitaris (NOU v1.8)

**77 tests unitaris** per funcions pures:

| Fitxer | Tests | Cobertura |
|--------|-------|-----------|
| `normalize.test.ts` | 35 | normalizeTaxId, normalizeIBAN, normalizeZipCode, formatNumberEU, parseNumberEU |
| `auto-match.test.ts` | 24 | normalizeForMatching, extractNameTokens, findMatchingContact |
| `model182.test.ts` | 18 | calculateModel182Totals, calculateTransactionNetAmount, isReturnTransaction |

**Hook pre-commit (Husky):** Els tests s'executen autom√†ticament abans de cada commit.


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 3. FUNCIONALITATS DETALLADES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 3.1 DASHBOARD

### 3.1.1 Bloc Celebracions
Apareix quan hi ha fites positives:
- ‚úÖ "Totes les transaccions categoritzades"
- üìà "Balan√ß positiu"
- ‚ù§Ô∏è "X donants han contribu√Øt"
- üéØ "Tot al dia, bona feina!"
- üéÅ "Primera donaci√≥ del mes"

### 3.1.2 Targetes Principals (StatCards)

| Targeta | C√†lcul |
|---------|--------|
| **Ingressos** | Suma moviments amount > 0 |
| **Despeses operatives** | Suma amount < 0 EXCLOENT contraparts |
| **Balan√ß operatiu** | Ingressos - Despeses operatives |
| **Transfer√®ncies a contraparts** | Suma isCounterpartTransfer = true |

### 3.1.3 Bloc Donacions i Socis

| M√®trica | Comparativa |
|---------|-------------|
| Donacions | vs any anterior |
| Donants actius | vs any anterior |
| Socis actius | vs any anterior |
| Quotes socis | vs any anterior |

### 3.1.4 Bloc Obligacions Fiscals

| Obligaci√≥ | Data l√≠mit | Acci√≥ |
|-----------|------------|-------|
| Model 182 | 31 gener | Bot√≥ "Preparar" |
| Model 347 | 28 febrer | Bot√≥ "Preparar" |

### 3.1.5 Bloc Alertes

| Alerta | Descripci√≥ |
|--------|------------|
| X moviments sense categoritzar | Transaccions pendents |
| X donants amb dades incompletes | Sense NIF o CP |
| X moviments sense contacte | Per sobre del llindar |
| **X devolucions pendents** (NOU v1.8) | Devolucions sense assignar |

### 3.1.6 Filtre de Dates
- Any complet
- Trimestre
- Mes
- Personalitzat
- Tot


## 3.2 GESTI√ì DE MOVIMENTS

### 3.2.1 Importaci√≥ d'Extractes Bancaris

**Formats suportats:**
- CSV (detecci√≥ autom√†tica de separador)
- XLSX / XLS (Excel)

**Proc√©s:**
1. Pujar fitxer (drag & drop o selecci√≥)
2. Detecci√≥ autom√†tica de columnes
3. Vista pr√®via
4. Detecci√≥ de duplicats
5. Importaci√≥ amb auto-assignaci√≥

### 3.2.2 Sistema d'Auto-Assignaci√≥ Intel¬∑ligent

**FASE 1: Matching per Nom (instantani)**
- Cerca el nom de cada contacte a la descripci√≥
- ~70% dels moviments assignats autom√†ticament

**FASE 2: IA amb Gemini (si cal)**
- Envia descripci√≥ a Gemini
- Suggereix contacte m√©s probable
- ~16% addicional

**Aplicaci√≥ de Categoria per Defecte:**
- Si contacte t√© defaultCategoryId ‚Üí s'aplica autom√†ticament

### 3.2.3 Taula de Moviments

| Columna | Editable |
|---------|----------|
| Data | ‚úÖ |
| Descripci√≥ | ‚úÖ |
| Import | ‚úÖ |
| Categoria | ‚úÖ (selector amb cerca) |
| Contacte | ‚úÖ (selector amb cerca) |
| Projecte | ‚úÖ |
| Document | ‚úÖ (upload) |
| Nota | ‚úÖ |

### 3.2.4 Filtres
- Per data (any, trimestre, mes, personalitzat)
- Per categoria
- Per contacte
- Per projecte
- Sense categoritzar
- Sense contacte
- **Devolucions pendents** (NOU v1.8)

### 3.2.5 Banner de Devolucions Pendents (NOU v1.8)

Quan hi ha devolucions sense assignar, apareix un banner vermell:

> ‚ö†Ô∏è Hi ha devolucions pendents d'assignar [Revisar]

El bot√≥ "Revisar" filtra la taula per mostrar nom√©s devolucions pendents.


## 3.3 DIVISOR DE REMESES (INGRESSOS)

### 3.3.1 Qu√® √©s una Remesa?
Agrupaci√≥ de m√∫ltiples quotes de socis en un √∫nic ingr√©s bancari.

### 3.3.2 Formats suportats
- **CSV** amb detecci√≥ de separador
- **XLSX / XLS** (Excel)
- Detecci√≥ autom√†tica de fila inicial de dades

### 3.3.3 Proc√©s de Divisi√≥

1. **Seleccionar remesa** ‚Üí Men√∫ ‚ãÆ ‚Üí "Dividir remesa"
2. **Pujar detall** ‚Üí Fitxer CSV o Excel del banc
3. **Mapejat columnes**:
   - üü¢ Import
   - üîµ Nom
   - üü£ DNI/CIF
   - üî∑ IBAN
4. **Matching de socis** (prioritat):
   - Per DNI/CIF (m√†xima)
   - Per IBAN (alta)
   - Per Nom (mitjana)
5. **Detecci√≥ de socis de baixa**:
   - Av√≠s visual si es detecten socis marcats com "baixa"
   - Opci√≥ de reactivar individualment o tots alhora
6. **Processar**

### 3.3.4 Vista Agrupada de Remeses

- La remesa processada queda com **1 sola l√≠nia** al llistat de moviments
- Badge amb comptador de quotes: "üëÅ 303"
- **Filtre**: "Ocultar desglose de remesas" (activat per defecte)
- **Modal de detall**: Clicar el badge obre una modal amb:
  - Llista de totes les quotes individuals
  - Cerca per nom o DNI
  - Link directe al donant (clicar nom)
  - Resum del donant (hover)

### 3.3.5 Model de Dades de Remeses (Ingressos)

**Transacci√≥ pare (remesa):**
```
isRemittance: true
remittanceItemCount: 303
```

**Transaccions filles (quotes):**
```
source: 'remittance'
parentTransactionId: '{id_remesa}'
```

### 3.3.6 Guardar Configuraci√≥
Es pot guardar el mapejat per banc (Triodos, La Caixa, Santander, etc.)


## 3.4 GESTI√ì DE DEVOLUCIONS (NOU v1.8)

### 3.4.1 Visi√≥ general

Les devolucions banc√†ries (rebuts retornats) es gestionen sense modificar el moviment bancari original.

| M√®tode | Quan usar-lo |
|--------|--------------|
| **Assignaci√≥ manual** | Devolucions individuals, una a una |
| **Importador de fitxer** | Devolucions massives o agrupades |

**Principi fonamental:** El moviment bancari original MAI es modifica ni s'esborra.

### 3.4.2 Assignaci√≥ manual

1. Ves a **Moviments** ‚Üí Banner "Devolucions pendents" ‚Üí **Revisar**
2. Per cada devoluci√≥: bot√≥ **"Assignar donant"**
3. Cerca per nom, DNI, IBAN o email
4. Confirma l'assignaci√≥

### 3.4.3 Importador de fitxer del banc

#### Ubicaci√≥
- Moviments ‚Üí Fila de devoluci√≥ ‚Üí Icona üìÑ (pujar fitxer)
- O des del filtre "Devolucions pendents"

#### Bancs suportats

| Banc | Format | Particularitat |
|------|--------|----------------|
| Santander | XLSX | Data global a cap√ßalera, agrupa per fitxer |
| Triodos | CSV/XLS | Data per l√≠nia, agrupa per dia |
| Altres | CSV/XLSX | Detecci√≥ autom√†tica columnes |

#### Flux t√®cnic

```
1. PARSEJAR FITXER ‚Üí Extreure IBAN, Import, Data, Nom
2. NORMALITZAR ‚Üí Imports positius, dateConfidence (line/file/none)
3. MATCHING DONANTS ‚Üí IBAN ‚Üí DNI ‚Üí Nom exacte (sense tocar transaccions)
4. DETECTAR AGRUPACIONS ‚Üí Suma = moviment bancari (¬±0.02‚Ç¨, ¬±5 dies)
5. MATCHING INDIVIDUAL ‚Üí Nom√©s per les NO agrupades
6. PROCESSAR ‚Üí Crear filles, marcar pare, actualitzar donants
```

#### Matching de donants

| Prioritat | Criteri | Normalitzaci√≥ |
|-----------|---------|---------------|
| 1 | IBAN | Sense espais, maj√∫scules |
| 2 | DNI/NIF | Sense guions, maj√∫scules |
| 3 | Nom | Sense accents, min√∫scules, exacte |

**NO es fa matching aproximat ni fuzzy.**

#### Detecci√≥ autom√†tica de columnes

| Camp | Patrons detectats |
|------|-------------------|
| IBAN | cuenta de adeudo, cuenta destino, iban, account |
| Import | importe, cantidad, amount, monto |
| Data | fecha de liquidaci√≥n, fecha rechazo, date |
| DNI | referencia externa, dni, nif |
| Nom | nombre cliente, nombre, titular |
| Motiu | motivo devoluci√≥n, motivo, reason |

### 3.4.4 Devolucions agrupades (remeses)

Alguns bancs agrupen m√∫ltiples devolucions en un sol moviment:

```
Extracte bancari:  -55,00‚Ç¨ "DEVOLUCION RECIBOS"
Fitxer detall:     10‚Ç¨ + 20‚Ç¨ + 15‚Ç¨ + 10‚Ç¨ = 55‚Ç¨
```

#### Comportament

1. El moviment original (-55‚Ç¨) es marca com a "remesa pare"
2. Es creen transaccions filles per cada devoluci√≥ identificada
3. El pare mant√© `amount`, `date`, `description` intactes

#### Model de dades (Remeses de devolucions)

**Transacci√≥ pare:**
```typescript
isRemittance: true
remittanceType: 'returns'
remittanceStatus: 'complete' | 'partial' | 'pending'
remittanceItemCount: number           // Total devolucions
remittanceResolvedCount: number       // Amb donant
remittancePendingCount: number        // Sense donant
remittancePendingTotalAmount: number  // Suma pendents ‚Ç¨
// contactId: null (MAI s'assigna al pare)
```

**Transaccions filles:**
```typescript
source: 'remittance'
parentTransactionId: string    // ID del pare
transactionType: 'return'
amount: number                 // Negatiu
contactId: string              // ID donant
contactType: 'donor'
contactName: string            // Nom (desnormalitzat)
```

### 3.4.5 Remeses parcials

Si algunes devolucions no es poden identificar:

| Element | Estat |
|---------|-------|
| Devolucions amb donant | ‚Üí Es creen com a filles |
| Devolucions sense donant | ‚Üí Queden pendents |
| Remesa | ‚Üí `remittanceStatus: 'partial'` |

**Visualitzaci√≥:** Badge taronja "2/4 quotes (2 pendents: 25‚Ç¨)"

**Per completar una remesa parcial:**
1. Buscar el donant a Summa Social i actualitzar el seu IBAN
2. O crear el donant nou si no existeix
3. Tornar a importar el fitxer del banc

### 3.4.6 Impacte fiscal

| Document | C√†lcul |
|----------|--------|
| Model 182 | Total = Œ£ donacions - Œ£ devolucions |
| Certificats | Import = Œ£ donacions - Œ£ devolucions |

**Important:**
- El pare (remesa) NO t√© `contactId` ‚Üí No es compta
- Les filles S√ç tenen `contactId` ‚Üí Es compten com devolucions
- Si total ‚â§ 0 ‚Üí Donant no apareix al Model 182

### 3.4.7 UI de devolucions

#### Banner (Moviments)
- Un sol banner vermell: "Hi ha devolucions pendents d'assignar"
- CTA "Revisar" ‚Üí Filtra per devolucions pendents

#### Accions per fila

| Bot√≥ | Acci√≥ |
|------|-------|
| "Assignar donant" (vermell) | Di√†leg assignaci√≥ manual |
| üìÑ (icona) | Obre importador fitxer |

#### Badge remesa

| Estat | Visualitzaci√≥ |
|-------|---------------|
| Completa | "4 quotes" |
| Parcial | Badge taronja "2/4 quotes (2 pendents: 25‚Ç¨)" |

#### Modal importador - Resultats del matching

| Badge | Significat |
|-------|------------|
| üü¢ **Individual** | Donant i transacci√≥ trobats |
| üîµ **Agrupada** | Part d'una remesa |
| üü† **Pendent** | Donant no identificat |

### 3.4.8 L√≠mits del sistema

| Perm√®s | NO perm√®s |
|--------|-----------|
| Matching IBAN/DNI/Nom exacte | Fuzzy matching noms |
| Assignaci√≥ amb confirmaci√≥ | Assignaci√≥ autom√†tica |
| Remeses parcials | For√ßar remesa completa |
| Crear donant nou | Inventar dades |

### 3.4.9 Millores pendents

| Millora | Prioritat | Descripci√≥ |
|---------|-----------|------------|
| Botons funcionals "Buscar donant" / "Crear donant" | Alta | Ara s√≥n stubs UI |
| Completar remesa parcial | Alta | Flux per reassignar pendents |
| Suggeriments passius | Mitjana | Coincid√®ncies exactes sense auto-assignar |
| Exportar pendents | Baixa | Llista offline per revisar |
| Suport m√©s bancs | Baixa | CaixaBank, BBVA, Sabadell... |


## 3.5 GESTI√ì DE CONTACTES

### 3.5.1 Tipus de Contactes

| Tipus | Subtipus |
|-------|----------|
| **Donants** | Particular, Empresa |
| **Prove√Ødors** | Per categoria |
| **Treballadors** | - |

### 3.5.2 Donants - Camps

| Camp | Obligatori | Model 182 |
|------|------------|-----------|
| Nom | ‚úÖ | ‚úÖ |
| NIF/DNI | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Codi postal | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Ciutat | ‚ùå | ‚ùå |
| Prov√≠ncia | ‚ùå | ‚ùå |
| Adre√ßa | ‚ùå | ‚ùå |
| Tipus (Particular/Empresa) | ‚úÖ | ‚úÖ NATURALEZA |
| Modalitat (Puntual/Soci) | ‚úÖ | ‚ùå |
| Estat (Actiu/Baixa) | ‚ùå | ‚ùå |
| Data de baixa | ‚ùå | ‚ùå |
| Quota mensual | ‚ùå | ‚ùå |
| IBAN | ‚ùå | ‚ùå |
| Email | ‚ùå | ‚ùå |
| Tel√®fon | ‚ùå | ‚ùå |
| Categoria per defecte | ‚ùå | ‚ùå |
| **Comptador devolucions** | ‚ùå | ‚ùå |
| **Data √∫ltima devoluci√≥** | ‚ùå | ‚ùå |

### 3.5.3 Gesti√≥ d'Estat Actiu/Baixa

- **Filtre per estat**: Per defecte es mostren nom√©s actius
- **Badge visual**: Els donants de baixa mostren badge "Baixa"
- **Reactivar**: Bot√≥ per tornar a donar d'alta un soci
- **Edici√≥**: Es pot canviar l'estat des del formulari d'edici√≥
- **Importador**: Detecta columna "Estado/Estat" autom√†ticament

### 3.5.4 Importador de Donants

**Columnes detectades autom√†ticament:**

| Camp | Patrons de detecci√≥ |
|------|---------------------|
| Nom | nom, nombre, name |
| DNI/CIF | dni, nif, cif, taxid, documento |
| Codi postal | cp, codipostal, codigopostal, zipcode |
| Ciutat | ciudad, ciutat, city, localidad, poblaci√≥n |
| Prov√≠ncia | provincia, province, comunidad, regi√≥n |
| Adre√ßa | direccion, adre√ßa, address, domicilio, calle |
| Tipus | tipus, tipo, type, persona |
| Modalitat | modalitat, modalidad, membership, soci |
| Estat | estado, estat, status, activo, baja, baixa |
| Import | import, importe, quota, cuota, amount |
| IBAN | iban, compte, cuenta, banc |
| Email | email, correu, correo, mail |
| Tel√®fon | telefon, telefono, phone |
| Categoria | categoria, category |

**Funcionalitat "Actualitzar existents":**

- Checkbox opcional a la previsualitzaci√≥
- Si un DNI ja existeix i el checkbox est√† activat ‚Üí Actualitza en lloc d'ometre
- Camps actualitzables: status, zipCode, address, email, phone, iban, membershipType, donorType
- NO actualitza: name, taxId, createdAt (per seguretat)

### 3.5.5 Prove√Ødors - Camps

| Camp | Obligatori | Model 347 |
|------|------------|-----------|
| Nom | ‚úÖ | ‚úÖ |
| NIF/CIF | ‚ö†Ô∏è | ‚úÖ Obligatori |
| Categoria per defecte | ‚ùå | ‚ùå |
| Adre√ßa | ‚ùå | ‚ùå |
| IBAN | ‚ùå | ‚ùå |

### 3.5.6 DonorDetailDrawer

Panel lateral que s'obre clicant el nom d'un donant:
- Informaci√≥ completa del donant
- Historial de donacions (paginat)
- **Historial de devolucions** (NOU v1.8)
- Resum per any
- Generaci√≥ de certificats


## 3.6 PROJECTES / EIXOS D'ACTUACI√ì

| Camp | Obligatori |
|------|------------|
| Nom | ‚úÖ |
| Descripci√≥ | ‚ùå |
| Finan√ßador | ‚ùå |
| Actiu | ‚úÖ |

Estad√≠stiques per projecte:
- Total ingressos
- Total despeses
- Balan√ß


## 3.7 INFORMES FISCALS

### 3.7.1 Model 182 - Declaraci√≥ de Donacions

**Data l√≠mit:** 31 de gener

**Exportaci√≥ Excel per Gestoria:**

| Columna | Valor | Font |
|---------|-------|------|
| NIF | DNI/CIF | donor.taxId |
| NOMBRE | Nom complet | donor.name |
| CLAVE | "A" | Fix (dinerari Llei 49/2002) |
| PROVINCIA | Codi 2 d√≠gits | donor.zipCode.substring(0,2) |
| PORCENTAJE | *(buit)* | Gestoria ho calcula |
| VALOR | Import any actual | Suma donacions - devolucions |
| VALOR_1 | Import any -1 | Hist√≤ric |
| VALOR_2 | Import any -2 | Hist√≤ric |
| RECURRENTE | "X" o buit | Si VALOR_1 > 0 AND VALOR_2 > 0 |
| NATURALEZA | "F" o "J" | individual ‚Üí F, company ‚Üí J |

**Gesti√≥ de devolucions:**
- `transactionType === 'return'` ‚Üí Es resta autom√†ticament
- `donationStatus === 'returned'` ‚Üí Es resta autom√†ticament
- Les filles de remeses amb `contactId` ‚Üí Es compten
- Els pares de remeses sense `contactId` ‚Üí S'ignoren

**Fitxer generat:** `Model182_{org}_{any}.xlsx`

### 3.7.2 Model 347 - Operacions amb Tercers

**Data l√≠mit:** 28 de febrer

**Llindar:** > 3.005,06‚Ç¨ anuals per prove√Ødor

**Exportaci√≥:** CSV amb NIF, Nom, Import total

### 3.7.3 Certificats de Donaci√≥

**Tipus:**
- Individual (per donaci√≥)
- Anual (totes les donacions d'un any)
- Massiu (ZIP amb tots)

**Format PDF:**
- Logo de l'organitzaci√≥
- Firma digitalitzada
- Text legal Llei 49/2002

**C√†lcul de l'import:**
- Import = Œ£ donacions - Œ£ devolucions
- Si import ‚â§ 0 ‚Üí No es genera certificat


## 3.8 CONFIGURACI√ì

### 3.8.1 Dades de l'Organitzaci√≥
Nom, CIF, adre√ßa, ciutat, CP, tel√®fon, email, web, logo

### 3.8.2 Configuraci√≥ de Certificats
Firma digitalitzada, nom signant, c√†rrec

### 3.8.3 Prefer√®ncies
Llindar alertes contacte: 0‚Ç¨, 50‚Ç¨, 100‚Ç¨, 500‚Ç¨

### 3.8.4 Categories Comptables
Categories d'ingressos i despeses personalitzables

### 3.8.5 Gesti√≥ de Membres
Convidar, canviar rol, eliminar

### 3.8.6 Zona de Perill (SuperAdmin)

Accions irreversibles nom√©s per SuperAdmin:

| Acci√≥ | Descripci√≥ |
|-------|------------|
| Esborrar tots els donants | Elimina tots els donants de l'organitzaci√≥ |
| Esborrar tots els prove√Ødors | Elimina tots els prove√Ødors |
| Esborrar tots els treballadors | Elimina tots els treballadors |
| Esborrar tots els moviments | Elimina totes les transaccions |
| Esborrar √∫ltima remesa | Esborra les transaccions filles i restaura la remesa original |

**Esborrar √∫ltima remesa:**
- Busca l'√∫ltima remesa processada (isRemittance === true)
- Mostra info: data, concepte, import, nombre de quotes
- Demana confirmaci√≥ escrivint "BORRAR"
- Esborra totes les transaccions filles
- Restaura la transacci√≥ original per tornar-la a processar


## 3.9 IMPORTADOR STRIPE (NOU v1.9)

### 3.9.1 Visi√≥ general

L'importador Stripe permet dividir les liquidacions (payouts) de Stripe en transaccions individuals, identificant cada donaci√≥ i separant les comissions.

| Caracter√≠stica | Valor |
|----------------|-------|
| **Format entrada** | CSV exportat de Stripe ("Pagos ‚Üí Columnes predeterminades") |
| **Matching donants** | Per email (exacte, case insensitive) |
| **Creaci√≥ autom√†tica donants** | NO |
| **Gesti√≥ comissions** | Despesa agregada per payout |

**Principi fonamental:** El moviment bancari original (payout) MAI es modifica.

### 3.9.2 Flux d'√∫s

```
1. L'usuari veu un ingr√©s de Stripe al llistat de moviments
2. Men√∫ ‚ãÆ ‚Üí "Dividir remesa Stripe"
3. Puja el CSV exportat de Stripe
4. El sistema agrupa per Transfer (payout) i cerca el que quadra amb l'import bancari
5. Previsualitzaci√≥: donacions + comissions + matching donants
6. L'usuari revisa i assigna manualment els pendents
7. Confirma ‚Üí Es creen les transaccions filles
```

### 3.9.3 Condici√≥ per mostrar l'acci√≥

L'opci√≥ "Dividir remesa Stripe" apareix si:

```typescript
const canSplitStripeRemittance = (tx: Transaction): boolean => {
  const isIncome = tx.amount > 0;
  const isNotAlreadyDivided = tx.transactionType !== 'donation' && tx.transactionType !== 'fee';
  const isNotRemittance = !tx.isRemittance;
  
  if (!isIncome || !isNotAlreadyDivided || !isNotRemittance) return false;
  
  // Transaccions noves (ja tenen source)
  if (tx.source === 'stripe') return true;
  
  // Fallback legacy (backward compatibility)
  const descUpper = tx.description?.toUpperCase() || '';
  return descUpper.includes('STRIPE') || descUpper.includes('TRANSFERENCIA DE STRIPE');
};
```

### 3.9.4 Camps CSV requerits

| Camp Stripe | √ös a Summa Social | Obligatori |
|-------------|-------------------|------------|
| `id` | Tra√ßabilitat (`stripePaymentId`) | ‚úÖ |
| `Created date (UTC)` | Data de la donaci√≥ | ‚úÖ |
| `Amount` | Import brut | ‚úÖ |
| `Fee` | Comissi√≥ Stripe | ‚úÖ |
| `Customer Email` | Matching amb donant | ‚úÖ |
| `Status` | Filtrar nom√©s `succeeded` | ‚úÖ |
| `Transfer` | Agrupaci√≥ per payout (`po_xxx`) | ‚úÖ |
| `Amount Refunded` | Detectar reemborsos | ‚úÖ |
| `Description` | Concepte (opcional) | ‚ùå |

### 3.9.5 Filtratge autom√†tic

| Condici√≥ | Acci√≥ |
|----------|-------|
| `Status !== 'succeeded'` | Excloure silenciosament |
| `Amount Refunded > 0` | Excloure + mostrar av√≠s |

### 3.9.6 Agrupaci√≥ per payout

Les donacions s'agrupen pel camp `Transfer` (po_xxx):

```typescript
interface PayoutGroup {
  transferId: string;    // po_xxx
  rows: StripeRow[];     // Donacions del payout
  gross: number;         // Œ£ Amount
  fees: number;          // Œ£ Fee
  net: number;           // gross - fees
}
```

### 3.9.7 Match amb el banc

**Criteri:** Per import net (¬±0,02‚Ç¨ de toler√†ncia)

```typescript
const tolerance = 0.02;
const match = Math.abs(payoutGroup.net - bankTransaction.amount) <= tolerance;
```

> ‚ö†Ô∏è El banc NO porta el `Transfer` (po_xxx). El match √©s exclusivament per import.

### 3.9.8 Matching de donants

| Prioritat | Criteri | Implementaci√≥ |
|-----------|---------|---------------|
| 1 | Email | `donor.email.toLowerCase() === stripeRow.customerEmail.toLowerCase()` |

**Regles estrictes:**
- NO fuzzy matching
- NO crear donants autom√†ticament
- Si no hi ha match ‚Üí fila queda "Pendent d'assignar"

### 3.9.9 Transaccions generades

**Per cada donaci√≥ (N ingressos):**

```typescript
{
  date: stripeRow.createdDate,
  description: ensureStripeInDescription(stripeRow.description, stripeRow.customerEmail),
  amount: stripeRow.amount,              // Import BRUT (positiu)
  contactId: matchedDonor?.id || null,
  contactType: matchedDonor ? 'donor' : null,
  contactName: matchedDonor?.name || null,
  source: 'stripe',
  transactionType: 'donation',
  parentTransactionId: bankTransaction.id,
  stripePaymentId: stripeRow.id,         // ch_xxx
  stripeTransferId: selectedGroup.transferId,  // po_xxx
  categoryId: matchedDonor?.defaultCategoryId || null
}
```

**Per les comissions (1 despesa agregada):**

```typescript
{
  date: bankTransaction.date,
  description: `Comissions Stripe - ${count} donacions`,
  amount: -totalFees,                    // Negatiu (despesa)
  source: 'stripe',
  transactionType: 'fee',
  parentTransactionId: bankTransaction.id,
  stripeTransferId: selectedGroup.transferId,
  categoryId: bankFeesCategoryId         // Categoria 'bankFees'
}
```

**Cercabilitat (sufix autom√†tic):**

```typescript
function ensureStripeInDescription(desc: string | null, email: string): string {
  const base = desc || `Donaci√≥ Stripe - ${email}`;
  if (base.toUpperCase().includes('STRIPE')) return base;
  return `${base} (via Stripe)`;
}
```

### 3.9.10 Model de dades

**Camps espec√≠fics Stripe a Transaction:**

| Camp | Tipus | Descripci√≥ |
|------|-------|------------|
| `source` | `'stripe'` | Identifica origen |
| `transactionType` | `'donation' \| 'fee'` | Tipus de transacci√≥ |
| `stripePaymentId` | `string \| null` | ID pagament (`ch_xxx`) - Idempot√®ncia |
| `stripeTransferId` | `string \| null` | ID payout (`po_xxx`) - Correlaci√≥ |
| `parentTransactionId` | `string` | ID del moviment bancari pare |

### 3.9.11 Impacte fiscal

| Document | Tractament |
|----------|------------|
| **Model 182** | Nom√©s compten les filles amb `contactId` i `transactionType: 'donation'` |
| **Certificats** | Import = Œ£ donacions Stripe del donant |
| **Comissions** | NO afecten fiscalitat donants (s√≥n despeses de l'entitat) |

### 3.9.12 UI

**Pas 1: Pujar fitxer**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dividir remesa Stripe                   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Import al banc: 115,55 ‚Ç¨                ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Arrossega el CSV aqu√≠]                 ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚ö†Ô∏è No obrir el CSV amb Excel abans      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Pas 2: Revisi√≥**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3 donacions trobades                                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ Brut:        120,00 ‚Ç¨                                           ‚îÇ
‚îÇ Comissions:   -4,45 ‚Ç¨                                           ‚îÇ
‚îÇ Net:         115,55 ‚Ç¨ ‚úÖ (quadra amb banc)                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ
‚îÇ ‚úÖ lourdes@example.com    ‚Üí Lourdes Hoyal       50,00 ‚Ç¨         ‚îÇ
‚îÇ ‚úÖ pere@example.com       ‚Üí Pere Mart√≠          30,00 ‚Ç¨         ‚îÇ
‚îÇ ‚ö†Ô∏è nou@email.com          ‚Üí [Assignar]          40,00 ‚Ç¨         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                              [Cancel¬∑lar] [Processar]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3.9.13 Errors i missatges

| Codi | Condici√≥ | Missatge |
|------|----------|----------|
| `ERR_NO_COLUMNS` | Falten columnes | "El CSV no t√© les columnes necess√†ries: {columnes}" |
| `ERR_NO_MATCH` | Cap payout quadra | "No s'ha trobat cap payout que coincideixi amb {amount} ‚Ç¨" |
| `ERR_AMOUNT_MISMATCH` | Import no quadra | "L'import no quadra. Esperats {expected} ‚Ç¨, calculats {actual} ‚Ç¨" |
| `ERR_NO_BANK_FEES_CATEGORY` | Falta categoria | "No s'ha trobat la categoria de despeses banc√†ries" |
| `WARN_REFUNDED` | Hi ha reemborsos | "S'han excl√≤s {count} donacions reemborsades ({amount} ‚Ç¨)" |
| `WARN_NO_DONOR` | Sense match | "{count} donacions pendents d'assignar donant" |

### 3.9.14 L√≠mits del sistema

| Perm√®s | NO perm√®s |
|--------|-----------|
| Matching per email exacte | Fuzzy matching |
| Assignaci√≥ manual pendents | Creaci√≥ autom√†tica donants |
| M√∫ltiples payouts al CSV | Connexi√≥ directa API Stripe |
| Exclusi√≥ reemborsos | Processament autom√†tic refunds |

### 3.9.15 Estructura de fitxers

```
/src/components/stripe-importer/
  ‚îú‚îÄ‚îÄ useStripeImporter.ts    # Hook amb l√≤gica de parsing i matching
  ‚îú‚îÄ‚îÄ StripeImporter.tsx      # Component UI (modal)
  ‚îî‚îÄ‚îÄ index.ts                # Exports
```

**Punt de connexi√≥:** `transaction-table.tsx` ‚Üí men√∫ ‚ãÆ si `canSplitStripeRemittance(tx)`


## 3.10 M√íDUL PROJECTES ‚Äî JUSTIFICACI√ì ASSISTIDA (NOU v1.10)

### 3.10.1 Objectiu del m√≤dul

Permetre a una persona t√®cnica quadrar la justificaci√≥ econ√≤mica d'un projecte (ACCD, Fons Catal√†, etc.) a partir de les despeses reals existents, sense treballar en Excel, sense preconfiguracions r√≠gides i sense modificar dades fins a la validaci√≥ final.

> ‚ö†Ô∏è **Aquest m√≤dul √©s extern al core de Summa Social** i segueix el patr√≥ d'exports descrit a l'Annex C.

### 3.10.2 Principis de disseny (no negociables)

| Principi | Descripci√≥ |
|----------|------------|
| **Sense mapa obligatori** | No existeix un mapa r√≠gid partides entitat ‚Üî finan√ßador |
| **Sense classificaci√≥ pr√®via** | No es for√ßa la classificaci√≥ pr√®via de despeses |
| **Sense workflows** | No hi ha workflows d'aprovaci√≥ ni estats de "justificat" |
| **Sense entitats noves** | No es creen entitats noves per simular |
| **Reversible** | Tot el proc√©s √©s reversible fins a "Aplicar" |

### 3.10.3 Pantalla base: Gesti√≥ Econ√≤mica del Projecte

| Element | Descripci√≥ |
|---------|------------|
| Targetes resum | Pressupostat / Executat / Pendent |
| Bloc principal | Seguiment Econ√≤mic (partides) |
| CTA | "Quadrar justificaci√≥" |

**Cap proc√©s de justificaci√≥ obliga a sortir d'aquesta pantalla.**

#### C√†lcul del pressupost

| Condici√≥ | Pressupost mostrat |
|----------|-------------------|
| Projecte **amb** partides | Suma de `budgetedAmountEUR` de totes les partides |
| Projecte **sense** partides | Camp `budgetEUR` del projecte |

```typescript
interface BudgetLinesData {
  sum: number;
  hasLines: boolean;  // Permet distingir "0 partides" de "partides amb sum=0"
}

const budgeted = budgetLinesData?.hasLines
  ? budgetLinesData.sum
  : (project.budgetEUR ?? 0);
```

### 3.10.4 Mode "Quadrar justificaci√≥ del projecte"

- Vista assistida superposada (modal)
- L'usuari continua veient el seguiment econ√≤mic
- Organitzaci√≥ per **partida**, no per despesa
- Dos modes segons desviaci√≥:
  - **Infraexecuci√≥** ‚Üí afegir despeses
  - **Sobreexecuci√≥** ‚Üí treure o reduir imputacions

### 3.10.5 Infraexecuci√≥: afegir despeses

El sistema suggereix despeses:
- Sense projecte assignat
- Amb resson√†ncia (categoria / concepte / prove√Ødor)
- Amb imports que encaixen (individuals o combinats)

Pot incloure:
- Despeses de terreny
- Despeses de seu
- Despeses sense document (amb av√≠s visual)

L'usuari pot:
- Acceptar una proposta sencera
- Ampliar criteris de cerca
- Seleccionar manualment

**Les sugger√®ncies s√≥n heur√≠stiques, mai bloquegen, mai escriuen dades.**

#### Algorisme de scoring

| Factor | Punts | Descripci√≥ |
|--------|-------|------------|
| Categoria coincident | +3 | La despesa pertany a la mateixa fam√≠lia sem√†ntica |
| Contrapart coincident | +2 | El nom del prove√Ødor apareix a la partida |
| Descripci√≥ coincident | +2 | Keywords de la despesa apareixen a la partida |
| Import encaixa | +1 | L'import √©s ‚â§ d√®ficit |
| Assignada altre projecte | -3 | Risc de desquadrar altre projecte |
| Sense document | -2 | No justificable |

#### Fam√≠lies sem√†ntiques

```typescript
const CATEGORY_FAMILIES = {
  viatges: ['transport', 'dietes', 'allotjament', 'taxi', 'avi√≥', ...],
  personal: ['n√≤mina', 'salari', 'seguretat social', ...],
  serveis: ['consultoria', 'assessorament', 'honoraris', ...],
  material: ['subministrament', 'fungible', 'oficina', ...],
  formacio: ['formaci√≥', 'curs', 'taller', ...],
  comunicacio: ['comunicaci√≥', 'm√†rqueting', 'difusi√≥', ...],
};
```

#### Classificaci√≥ de propostes

| Etiqueta | Criteri | Visualitzaci√≥ |
|----------|---------|---------------|
| `perfect` | Delta ‚â§ 0,50‚Ç¨ | Badge verd "Exacte" |
| `close` | Delta ‚â§ 2% del d√®ficit | Badge blau "Proper" |
| `approx` | Resta | Badge gris "Aproximat" |

### 3.10.6 Sobreexecuci√≥: treure despeses

Es pot:
- Treure **tota** la despesa de la partida
- Treure nom√©s una **part** de l'import (split parcial)

La part treta queda:
- Dins del projecte
- Sense partida assignada

> ‚ö†Ô∏è **El split parcial √©s una funcionalitat clau, no un edge case.** Aquesta √©s la forma m√©s habitual i realista de quadrar justificacions.

### 3.10.7 Simulaci√≥ (capa cr√≠tica)

| Element | Comportament |
|---------|--------------|
| Moviments | Es fan en mem√≤ria |
| Escriptura | NO fins que l'usuari clica "Aplicar" |
| Visualitzaci√≥ | Execuci√≥ abans / despr√©s, efecte per partida |
| Aplicar | Usa els hooks existents (`useSaveExpenseLink`) |

### 3.10.8 Tipus de canvi i justificaci√≥

- El projecte defineix un tipus de canvi de refer√®ncia
- Les despeses de terreny poden tenir moneda original
- La justificaci√≥ sempre es quadra en EUR
- Camps de justificaci√≥:
  - No s√≥n obligatoris
  - S'editen nom√©s quan cal justificar
  - Existeixen per respondre al finan√ßador, no per comptabilitat

### 3.10.9 Qu√® NO fa Summa (expl√≠cit)

| NO fa | Motiu |
|-------|-------|
| No valida formalment justificacions | No som auditors |
| No bloqueja desviacions | L'usuari decideix |
| No obliga a quadrar al c√®ntim | Realisme operatiu |
| No substitueix el criteri t√®cnic | Eina, no workflow |
| No converteix la justificaci√≥ en proc√©s r√≠gid | Flexibilitat > rigidesa |

### 3.10.10 Estructura de fitxers

```
/src/app/[orgSlug]/dashboard/project-module/
  ‚îú‚îÄ‚îÄ projects/
  ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                    # Llista de projectes
  ‚îÇ   ‚îî‚îÄ‚îÄ [projectId]/
  ‚îÇ       ‚îú‚îÄ‚îÄ budget/page.tsx         # Gesti√≥ Econ√≤mica (pantalla base)
  ‚îÇ       ‚îî‚îÄ‚îÄ edit/page.tsx           # Edici√≥ del projecte

/src/components/project-module/
  ‚îú‚îÄ‚îÄ balance-project-modal.tsx       # Modal "Quadrar justificaci√≥"
  ‚îî‚îÄ‚îÄ ...

/src/lib/
  ‚îú‚îÄ‚îÄ project-module-types.ts         # Tipus del m√≤dul
  ‚îî‚îÄ‚îÄ project-module-suggestions.ts   # Scoring i combinacions (NOU v1.10)
```

### 3.10.11 Model de dades

**Veure Annex C.3** per l'estructura Firestore completa del m√≤dul projectes.

Camps afegits v1.10:

| Col¬∑lecci√≥ | Camp | Tipus | Descripci√≥ |
|------------|------|-------|------------|
| `projects` | `budgetEUR` | `number \| null` | Pressupost global (fallback si no hi ha partides) |
| `budgetLines` | `budgetedAmountEUR` | `number` | Import pressupostat de la partida |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 4. FORMATS D'IMPORTACI√ì I EXPORTACI√ì
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 4.1 Importaci√≥ d'Extractes Bancaris

| Format | Extensions | Detecci√≥ |
|--------|------------|----------|
| CSV | .csv, .txt | Separador auto (;,\t) |
| Excel | .xlsx, .xls | SheetJS |

**Columnes detectades:** Data, Concepte/Descripci√≥, Import/Quantitat

## 4.2 Importaci√≥ de Donants

| Format | Extensions |
|--------|------------|
| Excel | .xlsx, .xls |
| CSV | .csv |

**Columnes:** Veure secci√≥ 3.5.4

## 4.3 Importaci√≥ de Prove√Ødors

| Format | Extensions |
|--------|------------|
| Excel | .xlsx, .xls |
| CSV | .csv |

## 4.4 Divisor de Remeses (Ingressos)

| Format | Extensions |
|--------|------------|
| CSV | .csv, .txt |
| Excel | .xlsx, .xls |

## 4.5 Importador de Devolucions (NOU v1.8)

| Format | Extensions | Banc |
|--------|------------|------|
| Excel | .xlsx | Santander |
| CSV | .csv | Triodos |
| XLS | .xls | Triodos |

**Columnes detectades autom√†ticament:** IBAN, Import, Data, DNI, Nom, Motiu

## 4.6 Importador Stripe (NOU v1.9)

| Format | Extensions | Font |
|--------|------------|------|
| CSV | .csv | Stripe Dashboard ‚Üí Pagos ‚Üí Exportar |

**Columnes requerides:** id, Created date (UTC), Amount, Fee, Customer Email, Status, Transfer, Amount Refunded

**Veure secci√≥ 3.9 per detalls complets.**

## 4.7 Exportacions

| Informe | Format | Nom fitxer |
|---------|--------|------------|
| Model 182 | Excel (.xlsx) | Model182_{org}_{any}.xlsx |
| Model 347 | CSV | Model347_{org}_{any}.csv |
| Certificats | PDF / ZIP | certificat_{donant}_{any}.pdf |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 5. CAMPS REQUERITS PER INFORME FISCAL
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 5.1 Model 182 - Donants

| Camp Summa Social | Camp Model 182 | Obligatori |
|-------------------|----------------|------------|
| taxId | NIF DECLARADO | ‚úÖ |
| name | APELLIDOS Y NOMBRE | ‚úÖ |
| zipCode (2 primers) | PROVINCIA | ‚úÖ |
| donorType | NATURALEZA (F/J) | ‚úÖ |
| - | CLAVE | ‚úÖ (fix "A") |
| Suma transaccions | VALOR | ‚úÖ |
| Suma any -1 | VALOR_1 | ‚ùå |
| Suma any -2 | VALOR_2 | ‚ùå |
| Hist√≤ric | RECURRENTE | ‚ùå |

## 5.2 Model 347 - Prove√Ødors

| Camp Summa Social | Camp Model 347 | Obligatori |
|-------------------|----------------|------------|
| taxId | NIF | ‚úÖ |
| name | NOMBRE/RAZON SOCIAL | ‚úÖ |
| Suma transaccions | IMPORTE | ‚úÖ |

## 5.3 Certificats de Donaci√≥

| Camp | Obligatori |
|------|------------|
| Nom donant | ‚úÖ |
| NIF donant | ‚úÖ |
| Import (net de devolucions) | ‚úÖ |
| Data | ‚úÖ |
| Nom organitzaci√≥ | ‚úÖ |
| CIF organitzaci√≥ | ‚úÖ |
| Nom signant | ‚úÖ |
| C√†rrec signant | ‚úÖ |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 6. TERMINOLOGIA IMPORTANT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Terme | Definici√≥ |
|-------|-----------|
| **Transfer√®ncies a contraparts** | Enviaments a organitzacions s√≤cies internacionals |
| **Remesa (ingressos)** | Agrupaci√≥ de quotes de socis en un √∫nic ingr√©s |
| **Remesa (devolucions)** | Agrupaci√≥ de devolucions en un √∫nic moviment negatiu |
| **Devoluci√≥** | Rebut retornat pel banc (compte sense fons, IBAN erroni, etc.) |
| **Matching** | Assignaci√≥ autom√†tica de contactes per coincid√®ncia |
| **Categoria per defecte** | Categoria que s'aplica autom√†ticament |
| **Model 182** | Declaraci√≥ de donatius - l√≠mit 31 gener |
| **Model 347** | Operacions amb tercers >3.005,06‚Ç¨ - l√≠mit 28 febrer |
| **Soci** | Donant recurrent amb quota peri√≤dica |
| **Donant puntual** | Donant amb aportacions espor√†diques |
| **Emissor** | Terme intern per qualsevol contacte |
| **Eix d'actuaci√≥** | Sin√≤nim de projecte |
| **Gestoria** | Professional extern que presenta models fiscals |
| **Recurr√®ncia** | Ha donat els 2 anys anteriors consecutius |
| **Remesa parcial** | Remesa amb algunes devolucions pendents d'identificar |
| **dateConfidence** | Fiabilitat de la data: 'line' (per fila), 'file' (global), 'none' |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 7. OPTIMITZACIONS T√àCNIQUES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 7.1 Rendiment
- Memoitzaci√≥ de contexts Firebase
- Cleanup de timeouts i subscripcions
- L√≠mits a queries Firestore (m√†x 500)
- CollectionGroup queries
- AbortController per cancel¬∑lar peticions

## 7.2 Firebase Storage
- CORS configurat per c√†rrega d'imatges
- Logo i firma als PDFs generats al client

## 7.3 Autenticaci√≥
- Session persistence (caduca en tancar navegador)

## 7.4 Modals Radix UI (NOU v1.8)
- Fix bloqueig `aria-hidden` en tancar modals
- DropdownMenu controlat per evitar conflictes
- `setTimeout` + `blur()` abans d'obrir modals des de men√∫s
- Components com `DonorSearchCombobox` reescrits sense `cmdk` per evitar problemes de portals niuats


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 8. FLUX DE TREBALL RECOMANAT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 8.1 Configuraci√≥ Inicial

1. Configurar dades de l'organitzaci√≥
2. Pujar logo
3. Configurar firma i signant
4. Revisar categories
5. Importar contactes des d'Excel
6. Assignar categoria per defecte a cada contacte
7. Crear projectes/eixos

## 8.2 Dia a Dia

1. Descarregar extracte del banc (mensual)
2. Importar a Summa Social
3. Revisar alertes al Dashboard
4. Corregir moviments pendents
5. Dividir remeses si n'hi ha
6. **Gestionar devolucions pendents** (NOU v1.8)

## 8.3 Gesti√≥ de Devolucions (NOU v1.8)

1. Veure banner "Devolucions pendents" a Moviments
2. Clicar "Revisar"
3. Per cada devoluci√≥:
   - Si saps de qui √©s ‚Üí "Assignar donant"
   - Si tens el fitxer del banc ‚Üí Icona üìÑ ‚Üí Importar fitxer
4. Revisar remeses parcials i completar-les

## 8.4 Fi d'Any

1. Revisar donants amb dades incompletes
2. **Verificar devolucions assignades**
3. Generar Excel Model 182 (abans 31 gener)
4. Enviar a gestoria
5. Generar Model 347 (abans 28 febrer)
6. Emetre certificats als donants


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 9. SINCRONITZACI√ì I DESPLEGAMENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 9.1 Entorn
- IDE: VS Code
- Assistent IA: Claude Code
- Control de versions: Git + GitHub

## 9.2 Flux
```
1. Demanar canvis a Claude Code
2. Claude Code modifica fitxers
3. git add . && git commit -m "descripci√≥"
4. git push
5. Desplegament autom√†tic
```

## 9.3 URLs
- Producci√≥: https://summasocial.app
- Firebase: https://studio--summa-social.us-central1.hosted.app

## 9.4 Tests (NOU v1.8)
- 77 tests unitaris
- Hook pre-commit amb Husky
- `npm test` abans de cada commit


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 10. ROADMAP / FUNCIONALITATS PENDENTS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## Completades v1.10
- ‚úÖ M√≤dul Projectes: justificaci√≥ assistida per partides
- ‚úÖ Mode infraexecuci√≥: afegir despeses amb sugger√®ncies heur√≠stiques
- ‚úÖ Mode sobreexecuci√≥: treure o reduir imputacions (split parcial)
- ‚úÖ Simulaci√≥ en mem√≤ria fins a "Aplicar"
- ‚úÖ Pressupost unificat als cards (suma partides vs global)
- ‚úÖ Scoring per fam√≠lies sem√†ntiques (viatges, personal, serveis, etc.)

## Completades v1.9
- ‚úÖ Importador Stripe (dividir payouts en donacions + comissions)
- ‚úÖ Matching donants per email exacte
- ‚úÖ Tra√ßabilitat completa (stripePaymentId, stripeTransferId)

## Completades v1.8
- ‚úÖ Importador de devolucions del banc (Santander, Triodos)
- ‚úÖ Detecci√≥ autom√†tica d'agrupacions de devolucions
- ‚úÖ Remeses parcials de devolucions
- ‚úÖ Matching per IBAN ‚Üí DNI ‚Üí Nom exacte
- ‚úÖ UX simplificada per devolucions
- ‚úÖ Tests unitaris (77 tests) + Husky pre-commit
- ‚úÖ Fixes bloqueig aria-hidden modals Radix
- ‚úÖ Estat actiu/baixa per donants
- ‚úÖ Importador actualitza donants existents
- ‚úÖ Vista agrupada de remeses (1 l√≠nia + modal detall)
- ‚úÖ Detecci√≥ i reactivaci√≥ de socis de baixa a remeses
- ‚úÖ Link al donant des de modal de remesa
- ‚úÖ Eina per esborrar √∫ltima remesa (Zona Perill)

## Completades v1.7
- ‚úÖ Suport Excel per divisor de remeses
- ‚úÖ Camps city/province a l'importador de donants
- ‚úÖ Exportaci√≥ Excel Model 182 per gestoria (amb recurr√®ncia)
- ‚úÖ Session persistence (seguretat)

## Pendents priorit√†ries
- üî≤ Completar remesa parcial (flux UI per reassignar pendents)
- üî≤ Botons funcionals "Buscar donant" / "Crear donant" a importador
- üî≤ Tancaments mensuals/anuals
- üî≤ Saldos per compte bancari
- üî≤ Regles deterministes de categoritzaci√≥
- üî≤ Validaci√≥ estricta NIF/CIF
- üî≤ Checklist pre-informe fiscal

## Pendents secund√†ries
- üî≤ Suggeriments passius (coincid√®ncies exactes)
- üî≤ Exportar devolucions pendents
- üî≤ Suport m√©s bancs (CaixaBank, BBVA, Sabadell)
- üî≤ Detecci√≥ d'anomalies (duplicats)
- üî≤ Mem√≤ria de classificaci√≥
- üî≤ Notificacions per email
- ‚úÖ Importaci√≥ web Stripe (v1.9)
- üî≤ Importaci√≥ web (altres plataformes)

## Futures (sense data)
- üî≤ Integraci√≥ Open Banking
- üî≤ App m√≤bil


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 11. HISTORIAL DE VERSIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Versi√≥ | Data | Canvis principals |
|--------|------|-------------------|
| 1.0 | Nov 2024 | Versi√≥ inicial, single-user |
| 1.5 | Nov 2024 | Multi-organitzaci√≥, sistema de rols |
| 1.6 | Des 2024 | DonorDetailDrawer, certificats amb firma, Zona Perill, divisor remeses |
| 1.7 | Des 2024 | Excel Model 182 per gestoria, suport Excel remeses, camps city/province, session persistence |
| 1.8 | Des 2024 | Importador devolucions del banc, remeses parcials, suport multi-banc (Santander/Triodos), tests unitaris, fixes modals Radix, UX simplificada |
| 1.9 | Des 2025 | Importador Stripe (payouts ‚Üí donacions + comissions), matching per email, tra√ßabilitat completa |
| **1.10** | **Des 2025** | **M√≤dul Projectes: justificaci√≥ assistida per partides, sugger√®ncies heur√≠stiques, split parcial de despeses, simulaci√≥ en mem√≤ria** |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 12. √ÄMBIT I L√çMITS DEL PRODUCTE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## 12.1 Qu√® NO Far√† Summa Social (Per Disseny)

| Funcionalitat Exclosa | Motiu |
|-----------------------|-------|
| **Generaci√≥ de fitxers BOE** | Les ONGs deleguen a gestories |
| **Presentaci√≥ telem√†tica AEAT** | Complexitat legal elevada |
| **Integraci√≥ directa APIs banc√†ries** | Requereix certificacions |
| **Comptabilitat doble entrada** | NO √©s programa de comptabilitat |
| **Facturaci√≥ electr√≤nica** | Fora d'√†mbit |
| **Models d'IA opacs** | Tota IA ha de ser determinista o supervisada |
| **Fuzzy matching de noms** | Massa risc d'errors en fiscalitat |
| **Assignaci√≥ autom√†tica sense confirmaci√≥** | L'usuari sempre ha de validar |

## 12.2 Focus del Producte

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                 ‚îÇ
‚îÇ   1. GESTIONAR MOVIMENTS BANCARIS                              ‚îÇ
‚îÇ      Importar, categoritzar, assignar contactes                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   2. RECONCILIAR BANC                                          ‚îÇ
‚îÇ      Saldos, detecci√≥ d'errors, control, devolucions           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   3. PREPARAR FISCALITAT                                       ‚îÇ
‚îÇ      Model 182, Model 347, certificats de donaci√≥              ‚îÇ
‚îÇ      ‚Üí Output: Excel net per enviar a la gestoria              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   4. ORDENAR DONANTS / PROVE√èDORS / PROJECTES                  ‚îÇ
‚îÇ      Base de dades centralitzada i actualitzada                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   5. DASHBOARD PER A LA JUNTA                                  ‚îÇ
‚îÇ      M√®triques clares per prendre decisions                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## 12.3 P√∫blic Objectiu

| S√≠ | No |
|----|----|
| ONGs petites i mitjanes d'Espanya | Grans ONGs amb ERP propi |
| Entitats sense √†nim de lucre | Empreses amb √†nim de lucre |
| Fundacions petites | Administracions p√∫bliques |
| Associacions culturals, socials | Entitats fora d'Espanya |

## 12.4 Filosofia de Desenvolupament

> **"Menys √©s m√©s"**
>
> Summa Social resol **molt b√©** uns problemes concrets (conciliaci√≥ + fiscalitat) en lloc de resoldre **regular** molts problemes diferents.
>
> Cada funcionalitat nova ha de passar el filtre:
> - Redueix errors a l'ONG? ‚úÖ
> - Estalvia temps real? ‚úÖ
> - √âs mantenible per una sola persona? ‚úÖ
> - Contribueix als objectius estrat√®gics? ‚úÖ


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 13. REGLES PER A L'√öS DE LLMs
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| # | Regla |
|---|-------|
| 1 | Cap proposta pot contradir l'√Ämbit i L√≠mits (Secci√≥ 12) |
| 2 | No modificar l'esquema Firestore existent |
| 3 | No eliminar ni renomenar camps |
| 4 | Nom√©s afegir camps opcionals si √©s imprescindible |
| 5 | No afegir depend√®ncies noves sense justificaci√≥ |
| 6 | Nom√©s funcions pures i codi modular |
| 7 | Prioritat per simplicitat i manteniment baix |
| 8 | No IA que "aprengui" autom√†ticament |
| 9 | Tot alineat amb Bloc 1 (Conciliaci√≥) o Bloc 2 (Fiscalitat) |
| 10 | Millores Transversals sempre admissibles |
| 11 | **NO fuzzy matching de noms** |
| 12 | **NO assignaci√≥ autom√†tica sense confirmaci√≥ de l'usuari** |

## 13.1 Comportament Esperat

**Quan se li demani codi:**
- Proporcionar codi COMPLET
- Indicar path del fitxer
- Incloure passos de verificaci√≥
- Respondre en CATAL√Ä

## 13.2 Patrons de Codi Obligatoris

### Firestore: `null` vs `undefined`

> ‚ö†Ô∏è **CR√çTIC**: Firestore **NO accepta `undefined`** com a valor de camp.

**MAL** (provoca error):
```typescript
const newTxData = {
  contactType: contactId ? 'donor' : undefined,  // ‚ùå ERROR
  projectId: transaction.projectId,               // ‚ùå ERROR si √©s undefined
};
batch.set(docRef, newTxData);
```

**B√â** (patr√≥ correcte):
```typescript
const newTxData = {
  contactType: contactId ? 'donor' : null,        // ‚úÖ null acceptat
  projectId: transaction.projectId ?? null,       // ‚úÖ converteix undefined a null
};
batch.set(docRef, newTxData);
```

**Alternativa** (ometre camp si no existeix):
```typescript
const newTxData = {
  ...(contactId && { contactType: 'donor' }),     // ‚úÖ nom√©s afegeix si existeix
  ...(transaction.projectId && { projectId: transaction.projectId }),
};
```

**Regla general**: Tots els camps opcionals han de ser `string | null`, mai `undefined`.

### Gesti√≥ de transaccions consumides (NOU v1.8)

> ‚ö†Ô∏è **CR√çTIC**: NO usar `splice()` per marcar transaccions com a usades.

**MAL** (mutaci√≥ d'array):
```typescript
const idx = pendingReturns.findIndex(t => t.id === matchingTx.id);
if (idx > -1) pendingReturns.splice(idx, 1);  // ‚ùå Mutaci√≥ fr√†gil
```

**B√â** (Set d'IDs):
```typescript
const usedTransactionIds = new Set<string>();

const matchingTx = pendingReturns.find(tx => 
  !usedTransactionIds.has(tx.id) && ...
);

if (matchingTx) {
  usedTransactionIds.add(matchingTx.id);  // ‚úÖ Immutable
}
```

**Quan se li demani nova funcionalitat:**
- Validar si encaixa amb blocs estrat√®gics
- Si no encaixa, informar i suggerir alternatives


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 14. PARAULES CLAU I INTENCIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| Terme | Interpretaci√≥ Correcta | ‚ö†Ô∏è NO significa |
|-------|------------------------|-----------------|
| "Conciliaci√≥ banc√†ria" | Saldos, desquadraments, regles, devolucions | Integraci√≥ amb bancs |
| "Fiscalitat" | Model 182, 347, certificats, Excel | Presentaci√≥ a AEAT |
| "Excel net" | Fitxer simple per gestoria | Fitxer BOE oficial |
| "Determinista" | Regla fixa, mateix resultat | IA aut√≤noma |
| "Auto-assignaci√≥" | Matching + categoria defecte | IA sense supervisi√≥ |
| "Remesa" | Agrupaci√≥ quotes socis O devolucions | Qualsevol ingr√©s |
| "Gestoria" | Professional extern | L'ONG mateixa |
| "Matching exacte" | IBAN/DNI/Nom id√®ntic | Fuzzy, aproximat |
| "Remesa parcial" | Algunes devolucions pendents | Remesa incompleta per error |
| "Payout Stripe" | Liquidaci√≥ de Stripe al banc (po_xxx) | Donaci√≥ individual |
| "Comissi√≥ Stripe" | Despesa agregada per payout | Cost per donaci√≥ |
| "Remesa Stripe" | Payout dividit en donacions individuals | Connexi√≥ API Stripe |


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX A ‚Äî DECISIONS IRREVERSIBLES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| # | Decisi√≥ | Estat |
|---|---------|-------|
| 1 | **Base de dades**: Firestore | üîí TANCAT |
| 2 | **Model de dades**: Collections estables | üîí TANCAT |
| 3 | **Rol**: Conciliaci√≥ + Fiscalitat | üîí TANCAT |
| 4 | **Arquitectura**: Next.js 14 + Firebase | üîí TANCAT |
| 5 | **IA**: Nom√©s Genkit + Gemini | üîí TANCAT |
| 6 | **√Ämbit**: No ERP, CRM, facturaci√≥ | üîí TANCAT |
| 7 | **Matching**: Nom√©s exacte (IBAN/DNI/Nom) | üîí TANCAT |
| 8 | **Moviments bancaris**: Immutables | üîí TANCAT |

> ‚õî **Cap LLM pot proposar:**
> - Migrar a SQL, MongoDB, Supabase
> - Canviar Next.js per altre framework
> - Afegir backend separat
> - Fine-tuning de models IA
> - Funcionalitats CRM, ERP, facturaci√≥
> - Integraci√≥ directa APIs banc√†ries
> - Fuzzy matching de noms
> - Modificar/esborrar moviments bancaris originals

> ‚úÖ **Un LLM S√ç pot proposar:**
> - Millores dins l'arquitectura actual
> - Nous camps opcionals a Firestore
> - Noves subcollections si imprescindible
> - Optimitzacions de rendiment
> - Millores UX sense canviar funcionalitat
> - Nous patrons de matching EXACTE (email, tel√®fon...)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX B ‚Äî DOCUMENT PER GPT ASSISTENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## CONTEXT

Summa Social √©s una aplicaci√≥ de gesti√≥ financera per ONGs espanyoles.
Gestiona moviments bancaris, donants, prove√Ødors i fiscalitat (Model 182, 347, certificats).
El m√≤dul de devolucions resol el problema de rebuts retornats pel banc sense identificar.

## CONCEPTES CLAU

- DEVOLUCI√ì = Rebut que el banc no ha pogut cobrar i retorna a l'ONG
- REMESA = Agrupaci√≥ de m√∫ltiples moviments en un sol apunt bancari
- REMESA PARCIAL = Remesa amb algunes devolucions pendents d'identificar
- MATCHING = Assignaci√≥ de contacte per coincid√®ncia exacta (IBAN/DNI/Nom)

## FLUX DEVOLUCIONS

1. Usuari veu banner "Devolucions pendents" a Moviments
2. Clica "Revisar" ‚Üí Filtra per devolucions
3. Per cada devoluci√≥:
   - "Assignar donant" ‚Üí Cerca manual
   - Icona üìÑ ‚Üí Importador de fitxer del banc
4. L'importador fa matching per IBAN ‚Üí DNI ‚Üí Nom exacte
5. Es creen transaccions filles, el pare queda immutable

## BANCS SUPORTATS

- Santander: XLSX, data global a cap√ßalera
- Triodos: CSV/XLS, data per l√≠nia
- Altres: Detecci√≥ autom√†tica de columnes

## ERRORS COMUNS

| Error | Causa | Soluci√≥ |
|-------|-------|---------|
| "No s'ha trobat cap donant" | IBAN diferent | Actualitzar IBAN del donant |
| "M√∫ltiples candidates" | Diverses transaccions possibles | Assignar manualment |
| "Sense data fiable" | Banc no informa data | Normal, funciona igualment |

## FRASES PER RESPONDRE

- "Les devolucions es resten autom√†ticament del total un cop assignades."
- "El moviment bancari original no es toca."
- "Si una remesa queda parcial, pots completar-la m√©s tard."
- "Summa Social no fa assignacions autom√†tiques sense coincid√®ncia exacta."

## L√çMITS

- NO fuzzy matching de noms
- NO assignaci√≥ autom√†tica sense confirmaci√≥
- NO modificar moviments bancaris
- Les remeses parcials requereixen acci√≥ manual


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANNEX C ‚Äî EXPORTS I M√íDULS DESACOBLATS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## C.1 Principi Arquitect√≤nic

Summa Social pot generar **feeds de dades de nom√©s lectura** mitjan√ßant Cloud Functions.

Aquests feeds serveixen perqu√® m√≤duls externs consumeixin dades sense afectar el core de l'aplicaci√≥. L'objectiu √©s permetre extensions opcionals mantenint la integritat i simplicitat del producte principal.

## C.2 Patr√≥ Oficial

| Responsabilitat | Actor |
|-----------------|-------|
| **Escriptura del feed** | Backend de Summa Social (Cloud Functions) |
| **Lectura del feed** | Aplicacions o m√≤duls externs |
| **Escriptura al m√≤dul extern** | Nom√©s el m√≤dul extern |

> ‚ö†Ô∏è **Regla fonamental**: Cap m√≤dul extern pot escriure dins del core de Summa Social.

## C.3 Exemple Normatiu: M√≤dul de Projectes

### Estructura Firestore

**Feed de despeses (escriu Summa, llegeix m√≤dul extern):**

```
/organizations/{orgId}/exports/projectExpenses/items/{txId}
```

**Assignacions a projectes (fora de Summa, escriu m√≤dul extern):**

```
/organizations/{orgId}/projectModule/_/expenseLinks/{txId}
```

**Projectes del m√≤dul:**

```
/organizations/{orgId}/projectModule/_/projects/{projectId}
```

> Nota: El document `_` √©s un placeholder t√®cnic necessari per complir l'estructura de Firestore (segments alterns col¬∑lecci√≥/document).

### Join Client-Side

El m√≤dul extern fa el join entre:
- La despesa (del feed `exports/projectExpenses/items`)
- L'assignaci√≥ (de `projectModule/_/expenseLinks`)

Summa Social no coneix ni gestiona les assignacions.

## C.4 L√≠mits Expl√≠cits del Producte

Summa Social **NO**:
- Gestiona projectes (m√©s enll√† dels eixos d'actuaci√≥ existents)
- Gestiona subvencions
- Fa justificacions econ√≤miques
- Controla pressupostos de projectes

Qualsevol funcionalitat en aquesta l√≠nia √©s **externa i opcional**, i s'ha d'implementar fora del core mitjan√ßant el patr√≥ d'exports descrit.

## C.5 Firestore Rules

Els feeds d'exports s√≥n de nom√©s lectura per als clients:

```javascript
match /exports/{exportType} {
  allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
  allow write: if false; // Nom√©s Cloud Functions

  match /items/{itemId} {
    allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
    allow write: if false; // Nom√©s Cloud Functions
  }
}

match /projectModule/{document=**} {
  allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
  allow write: if (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']) || isSuperAdmin();
}
```

## C.6 √çndexos Firestore (M√≤dul Projectes)

Els √≠ndexos necessaris per al m√≤dul de projectes:

### expenseLinks (projectModule/_/expenseLinks)

| Col¬∑lecci√≥ | Camps | Ordre | √ös |
|------------|-------|-------|-----|
| expenseLinks | `projectIds` (array-contains) | - | Filtrar despeses per projecte |
| expenseLinks | `budgetLineIds` (array-contains) | - | Filtrar despeses per partida pressupost√†ria |

> **Nota**: No s'utilitza `orderBy` en aquestes queries per evitar necessitat d'√≠ndexos compostos. L'ordenaci√≥ es fa client-side.

### exports/projectExpenses/items

| Col¬∑lecci√≥ | Camps | Ordre |
|------------|-------|-------|
| items | `isEligibleForProjects`, `deletedAt`, `date` | date DESC |

> **Nota**: Aquest √≠ndex ja existeix per al feed de despeses elegibles.

### Backfill de budgetLineIds

Les assignacions creades abans de la implementaci√≥ del camp `budgetLineIds` no el tindran poblat. El codi implementa un fallback:
1. Si la query per `budgetLineIds` retorna 0 resultats i hi ha `projectId` disponible
2. Es carreguen els links del projecte i es filtra client-side per `assignments[].budgetLineId`
3. Es trackeja amb `expenses.filter.fallback_used` per monitoritzaci√≥


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# FI DEL DOCUMENT
# √öltima actualitzaci√≥: Desembre 2025 - Versi√≥ 1.10
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
