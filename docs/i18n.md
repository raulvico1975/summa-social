# Sistema i18n - Summa Social

## Checklist per text nou

1. Crear clau a `ca.json`
2. Copiar a `es/fr/pt`
3. Usar `tr("...")` al component
4. Executar:
   - `npm run i18n:check`
   - `npm run i18n:check-tr-keys`
5. Commit amb els 4 JSON

## Arquitectura

```
Source of truth editable: Firebase Storage (global app)
├── gs://.../i18n/ca.json
├── gs://.../i18n/es.json
├── gs://.../i18n/fr.json
└── gs://.../i18n/pt.json

Fallback (repo): src/i18n/locales/*.json

Runtime load order:
1. JSON de Storage (si existeix i és vàlid)
2. JSON local del repo (fallback)
3. Retorna la clau si no hi ha traducció
```

## Dues maneres de traduir

### `t.xxx.yyy` (legacy - objecte niuat)

- Definit a `src/i18n/ca.ts`, `es.ts`, `fr.ts`
- Tipat estàticament (TypeScript detecta claus inexistents)
- NO es pot editar via SuperAdmin
- Usat per la majoria del codi existent

```tsx
const { t } = useTranslations();
<h1>{t.dashboard.title}</h1>
```

### `tr("xxx.yyy")` (nou - JSON pla)

- Definit a `src/i18n/locales/*.json`
- Claus en format dot-notation
- Editable via SuperAdmin (Storage override)
- Suporta idiomes nous sense codi (ex: `pt`)

```tsx
const { tr } = useTranslations();
<h1>{tr("dashboard.title")}</h1>
<p>{tr("missing.key", "Fallback text")}</p>
```

### Regla

- **Prohibit:** `t("...")` (no existeix)
- **Legacy:** `t.xxx.yyy` (objecte)
- **Nou:** `tr("xxx.yyy")` (funció)

**Tot el text nou hauria d'usar `tr()` per ser gestionable externament.**

## Idiomes suportats

| Codi | Nom | TS (legacy) | JSON |
|------|-----|-------------|------|
| `ca` | Català | ✅ | ✅ |
| `es` | Español | ✅ | ✅ |
| `fr` | Français | ✅ | ✅ |
| `pt` | Português | ❌ | ✅ |

## Flux SuperAdmin

1. **Descarregar**: Baixa el JSON actual (prioritza Storage, fallback local)
2. **Editar**: Tradueix externament (Excel, POEditor, editor JSON...)
3. **Pujar**: Valida i puja a Firebase Storage
4. **Publicar**: Incrementa `system/i18n.version` per invalidar cache

Els canvis es veuen immediatament per tots els usuaris sense recarregar.

## Com afegir un idioma nou

### Checklist

1. **Tipus**: Afegir codi a `Language` union (`src/i18n/index.ts`)
   ```ts
   export type Language = 'ca' | 'es' | 'fr' | 'pt' | 'NEW';
   ```

2. **JSON local**: Crear `src/i18n/locales/NEW.json`
   - Copiar `ca.json` com a plantilla

3. **Loader**: Afegir import a `src/i18n/json-runtime.ts`
   ```ts
   import NEW from './locales/NEW.json';
   const localBundles = { ca, es, fr, pt, NEW };
   ```

4. **UI**: Afegir a selectors
   - `src/components/language-selector.tsx`
   - `src/components/super-admin/i18n-manager.tsx`

5. **Detecció**: Afegir a `detectBrowserLanguage()` (`src/i18n/provider.tsx`)

### Operativa (via SuperAdmin)

1. Descarregar plantilla (ca.json)
2. Traduir externament
3. Pujar com NEW.json
4. Publicar

## Fitxers clau

| Fitxer | Responsabilitat |
|--------|-----------------|
| `src/i18n/index.ts` | Tipus `Language`, context, hook `useTranslations` |
| `src/i18n/provider.tsx` | Provider, listener versió, carrega JSON |
| `src/i18n/json-runtime.ts` | Loader Storage/local, cache, `trFactory` |
| `src/i18n/locales/*.json` | Bundles JSON (fallback local) |
| `src/i18n/ca.ts`, `es.ts`, `fr.ts` | Traduccions TS legacy (objecte niuat) |
| `scripts/i18n/export-all.ts` | Export TS → JSON |
| `storage.rules` | Permisos Storage (lectura pública, escriptura SuperAdmin) |

## Invalidació de cache

- Document Firestore: `system/i18n` amb camp `version`
- El provider escolta canvis en temps real
- Quan `version` canvia, es recarreguen les traduccions de Storage
- No cal recarregar la pàgina

## Validació automàtica

- `npm run i18n:check` comprova que totes les claus de `ca.json` existeixin a `es.json`, `fr.json` i `pt.json`. Si falta alguna clau, bloqueja amb `exit 1`.
- `npm run i18n:check-tr-keys` comprova que totes les claus literals `tr("…")` del codi existeixin a `ca.json`. Bloqueja si alguna clau del codi no té traducció.
- `node scripts/i18n/forbid-t-call.mjs` bloqueja `t("...")` i `t('...')` a `src/`.
- Tots tres s'executen automàticament a `.husky/pre-commit` i dins `scripts/verify-local.sh`.

## Scripts

```bash
# Exportar traduccions TS a JSON (sincronitza locales/)
npm run i18n:export

# Validar completesa CA → ES/FR/PT (bloquejant)
npm run i18n:check

# Validar que tot tr("…") del codi existeix a ca.json (bloquejant)
npm run i18n:check-tr-keys
```

## Migració progressiva

Per migrar de `t.xxx` a `tr("xxx")`:

1. Executar `npm run i18n:export` per generar JSON actualitzats
2. Canviar `t.xxx.yyy` per `tr("xxx.yyy")` progressivament
3. Els JSON ja contenen totes les claus exportades

No cal migrar tot de cop. Ambdós sistemes conviuen.
