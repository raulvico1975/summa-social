rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ════════════════════════════════════════════════════════════════════════════
    // Funcions auxiliars
    // ════════════════════════════════════════════════════════════════════════════

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isSignedIn() && request.auth.uid == 'f2AHJqjXiOZkYajwkOnZ8RY6h2k2';
    }

    function orgDocumentsEnabled(orgId) {
      return firestore.get(/databases/(default)/documents/organizations/$(orgId)).data.documentsEnabled == true;
    }

    function isOrgMemberWithRole(orgId) {
      return isSignedIn()
        && firestore.exists(/databases/(default)/documents/organizations/$(orgId)/members/$(request.auth.uid))
        && firestore.get(/databases/(default)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role in ['admin', 'user'];
    }

    // ════════════════════════════════════════════════════════════════════════════
    // i18n translations - SuperAdmin can write, everyone can read
    // ════════════════════════════════════════════════════════════════════════════
    match /i18n/{langFile} {
      // Lectura pública (l'app necessita carregar traduccions)
      allow read: if true;

      // Escriptura només per SuperAdmin
      allow write: if isSuperAdmin();
    }

    // ════════════════════════════════════════════════════════════════════════════
    // pendingDocuments - Pujada de factures/nòmines per organització
    // Requereix: usuari autenticat + membre amb rol admin/user + documentsEnabled
    // ════════════════════════════════════════════════════════════════════════════
    match /organizations/{orgId}/pendingDocuments/{path=**} {
      // Lectura: SuperAdmin o membre amb rol adequat
      allow read: if isSuperAdmin() || isOrgMemberWithRole(orgId);

      // Escriptura: (SuperAdmin o membre) + documentsEnabled ha de ser true
      allow write: if (isSuperAdmin() || isOrgMemberWithRole(orgId)) && orgDocumentsEnabled(orgId);
    }

    // ════════════════════════════════════════════════════════════════════════════
    // Per defecte, denegar tot el que no estigui explícitament permès
    // ════════════════════════════════════════════════════════════════════════════
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
