rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSuperAdmin() {
      return request.auth != null && request.auth.uid == 'f2AHJqjXiOZkYajwkOnZ8RY6h2k2';
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isMemberOf(orgId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }

    function getMemberRole(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role;
    }

    function isAdminOf(orgId) {
      return isMemberOf(orgId) && getMemberRole(orgId) == 'admin';
    }

    function canEditFinances(orgId) {
      return isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'treasurer'];
    }

    // ═══════════════════════════════════════════════════════════════════════
    // USUARIS
    // ═══════════════════════════════════════════════════════════════════════

    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      // Super Admin pot llegir tots els usuaris
      allow read: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // INVITACIONS (col·lecció global per facilitar consultes per token)
    // ═══════════════════════════════════════════════════════════════════════

    match /invitations/{invitationId} {
      // Qualsevol pot llegir una invitació (necessari per validar el token)
      allow read: if true;
      
      // Només Super Admin pot crear invitacions
      allow create: if isSuperAdmin();
      
      // Només Super Admin pot eliminar invitacions
      allow delete: if isSuperA