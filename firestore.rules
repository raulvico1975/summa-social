rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSuperAdmin() {
      return request.auth != null && request.auth.uid == 'f2AHJqjXiOZkYajwkOnZ8RY6h2k2';
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isMemberOf(orgId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }

    function getMemberRole(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role;
    }

    function isAdminOf(orgId) {
      return isMemberOf(orgId) && getMemberRole(orgId) == 'admin';
    }

    function hasOrgInProfile(orgId) {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // SLUGS (índex d'unicitat per URLs d'organitzacions)
    // ═══════════════════════════════════════════════════════════════════════

    match /slugs/{slug} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // USUARIS
    // ═══════════════════════════════════════════════════════════════════════

    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      allow read: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // INVITACIONS
    // ═══════════════════════════════════════════════════════════════════════

    match /invitations/{invitationId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSuperAdmin() || (isSignedIn() && resource.data.createdBy == request.auth.uid);
    }

    // ═══════════════════════════════════════════════════════════════════════
    // ORGANITZACIONS
    // ═══════════════════════════════════════════════════════════════════════

    match /organizations/{orgId} {
      // Llegir: membres o usuaris amb l'org al perfil
      allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
      
      // Crear: només Super Admin
      allow create: if isSuperAdmin();
      
      // Actualitzar: admins de l'org o Super Admin
      allow update: if isAdminOf(orgId) || isSuperAdmin();
      
      // Eliminar: només Super Admin
      allow delete: if isSuperAdmin();

      // ─────────────────────────────────────────────────────────────────────
      // MEMBRES de l'organització
      // ─────────────────────────────────────────────────────────────────────

      match /members/{memberId} {
        allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
        allow create: if isSignedIn() && (request.auth.uid == memberId || isAdminOf(orgId) || isSuperAdmin());
        allow update, delete: if isAdminOf(orgId) || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // TRANSACCIONS
      // ─────────────────────────────────────────────────────────────────────

      match /transactions/{transactionId} {
        allow read: if isSuperAdmin() || isMemberOf(orgId);
        allow create, update, delete: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);
      }

      // ─────────────────────────────────────────────────────────────────────
      // CATEGORIES
      // ─────────────────────────────────────────────────────────────────────

      match /categories/{categoryId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isAdminOf(orgId) || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROJECTES
      // ─────────────────────────────────────────────────────────────────────

      match /projects/{projectId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // CONTACTES (unificat: donants + proveïdors)
      // ─────────────────────────────────────────────────────────────────────

      match /contacts/{contactId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // DONANTS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /donors/{donorId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROVEÏDORS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /suppliers/{supplierId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // EMISSORS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /emissors/{emissorId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // COMPTES BANCARIS
      // ─────────────────────────────────────────────────────────────────────

      match /bankAccounts/{bankAccountId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isAdminOf(orgId) || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // CONFIGURACIONS DE REMESES
      // ─────────────────────────────────────────────────────────────────────

      match /remittanceMappings/{mappingId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // AUDIT LOGS (només Super Admin)
      // ─────────────────────────────────────────────────────────────────────

      match /audit_logs/{logId} {
        // Llegir: només Super Admin
        allow read: if isSuperAdmin();
        // Crear: qualsevol membre autenticat (el sistema crea logs)
        allow create: if isMemberOf(orgId) || isSuperAdmin();
        // Actualitzar/Eliminar: només Super Admin
        allow update, delete: if isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // EXPORTS (feed només lectura per clients; escriptura només backend)
      // Estructura: /organizations/{orgId}/exports/{exportType}/items/{id}
      // ─────────────────────────────────────────────────────────────────────

      match /exports/{exportType} {
        // (Opcional) llegir el document "exportType" si existeix
        allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
        allow write: if false;

        match /items/{itemId} {
          // El nou mòdul pot llegir el feed si és membre de l'org
          allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();

          // Cap client pot escriure exports
          allow create, update, delete: if false;
        }
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROJECT MODULE (Projectes) — lectura/escriptura per membres de l'org
      // Path: /organizations/{orgId}/projectModule/...
      // ─────────────────────────────────────────────────────────────────────

      match /projectModule/{document=**} {
        allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
        allow write: if (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']) || isSuperAdmin();
      }
    }
  }
}