rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSuperAdmin() {
      return request.auth != null && request.auth.uid == 'f2AHJqjXiOZkYajwkOnZ8RY6h2k2';
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isMemberOf(orgId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }

    function getMemberRole(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role;
    }

    function isAdminOf(orgId) {
      return isMemberOf(orgId) && getMemberRole(orgId) == 'admin';
    }

    function hasOrgInProfile(orgId) {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // USUARIS
    // ═══════════════════════════════════════════════════════════════════════

    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      allow read: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // INVITACIONS
    // ═══════════════════════════════════════════════════════════════════════

    match /invitations/{invitationId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSuperAdmin() || (isSignedIn() && resource.data.createdBy == request.auth.uid);
    }

    // ═══════════════════════════════════════════════════════════════════════
    // ORGANITZACIONS
    // ═══════════════════════════════════════════════════════════════════════

    match /organizations/{orgId} {
      // Llegir: membres o usuaris amb l'org al perfil
      allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
      
      // Crear: només Super Admin
      allow create: if isSuperAdmin();
      
      // Actualitzar: admins de l'org o Super Admin
      allow update: if isAdminOf(orgId) || isSuperAdmin();
      
      // Eliminar: només Super Admin
      allow delete: if isSuperAdmin();

      // ─────────────────────────────────────────────────────────────────────
      // MEMBRES de l'organització
      // ─────────────────────────────────────────────────────────────────────

      match /members/{memberId} {
        allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
        allow create: if isSignedIn() && (request.auth.uid == memberId || isAdminOf(orgId) || isSuperAdmin());
        allow update, delete: if isAdminOf(orgId) || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // TRANSACCIONS
      // ─────────────────────────────────────────────────────────────────────

      match /transactions/{transactionId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // CATEGORIES
      // ─────────────────────────────────────────────────────────────────────

      match /categories/{categoryId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isAdminOf(orgId) || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROJECTES
      // ─────────────────────────────────────────────────────────────────────

      match /projects/{projectId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // CONTACTES (unificat: donants + proveïdors)
      // ─────────────────────────────────────────────────────────────────────

      match /contacts/{contactId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // DONANTS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /donors/{donorId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROVEÏDORS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /suppliers/{supplierId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // EMISSORS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /emissors/{emissorId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // CONFIGURACIONS DE REMESES
      // ─────────────────────────────────────────────────────────────────────

      match /remittanceMappings/{mappingId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }
    }
  }
}