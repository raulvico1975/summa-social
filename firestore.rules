rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSuperAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/systemSuperAdmins/$(request.auth.uid));
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isMemberOf(orgId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }

    function getMemberRole(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role;
    }

    function isAdminOf(orgId) {
      return isMemberOf(orgId) && getMemberRole(orgId) == 'admin';
    }

    function hasOrgInProfile(orgId) {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // COLLECTIONGROUP: MEMBERS (permet a un usuari trobar les seves membresies)
    // ═══════════════════════════════════════════════════════════════════════

    match /{path=**}/members/{memberId} {
      // Un usuari pot llegir el seu propi document de membre via collectionGroup
      allow read: if isSignedIn() && request.auth.uid == memberId;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // SYSTEM CONFIG (i18n versions, feature flags, etc.)
    // ═══════════════════════════════════════════════════════════════════════

    match /system/{docId} {
      // Llegir: qualsevol usuari autenticat (per rebre versions d'i18n)
      allow read: if isSignedIn();
      // Escriure: només SuperAdmin
      allow write: if isSuperAdmin();
    }

    // Col·lecció top-level superAdmins (per governar qui és SuperAdmin)
    // Cada usuari pot llegir el SEU document (necessari per a Storage rules cross-service)
    // Llistar tots: només SuperAdmin. Escriure: només SuperAdmin.
    match /systemSuperAdmins/{uid} {
      // Permet llegir el propi document (Storage rules ho necessita per isSuperAdmin())
      allow get: if isSignedIn() && request.auth.uid == uid;
      // Llistar tots els superadmins: només SuperAdmin
      allow list: if isSuperAdmin();
      // Escriure: només SuperAdmin
      allow write: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PRODUCT UPDATES (novetats del producte - només SuperAdmin)
    // Updated: 2024-12-31 - Force redeploy
    // ═══════════════════════════════════════════════════════════════════════

    match /productUpdateDrafts/{draftId} {
      // Permet get i list per SuperAdmin
      allow get, list: if isSuperAdmin();
      allow create, update, delete: if isSuperAdmin();
    }

    match /productUpdates/{updateId} {
      // Lectura: usuaris autenticats (campaneta)
      // Escriptura: només SuperAdmin
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // SYSTEM INCIDENTS (alertes internes per a SuperAdmin)
    // P1 FIX: Restringit update per evitar DoS/spam
    // ═══════════════════════════════════════════════════════════════════════

    match /systemIncidents/{incidentId} {
      // Llegir: només SuperAdmin
      allow read: if isSuperAdmin();
      // P1 FIX: Create permet que el sistema client reporti errors
      // però limitat a usuaris que són membres d'alguna org (no anònims)
      // Update: només SuperAdmin (per canviar status, assignar, etc.)
      allow create: if isSignedIn();
      allow update: if isSuperAdmin();
      // Eliminar: només SuperAdmin
      allow delete: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // SLUGS (índex d'unicitat per URLs d'organitzacions)
    // ═══════════════════════════════════════════════════════════════════════

    match /slugs/{slug} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // ADMIN AUDIT LOGS (registre d'accions de SuperAdmin)
    // ═══════════════════════════════════════════════════════════════════════

    match /adminAuditLogs/{logId} {
      // Llegir i escriure: només SuperAdmin
      allow read, write: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // USUARIS
    // ═══════════════════════════════════════════════════════════════════════

    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      allow read: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // INVITACIONS
    // P0 FIX: Restringit read/create/update per evitar exposició i manipulació
    // ═══════════════════════════════════════════════════════════════════════

    match /invitations/{invitationId} {
      // P0 FIX: read només per:
      // - SuperAdmin (gestió global)
      // - Creador de la invitació
      // - Admin de l'org de la invitació
      // - Usuari amb l'email de la invitació (per acceptar-la)
      allow read: if isSuperAdmin()
        || (isSignedIn() && resource.data.createdBy == request.auth.uid)
        || (isSignedIn() && isAdminOf(resource.data.organizationId))
        || (isSignedIn() && resource.data.email == request.auth.token.email);

      // P0 FIX: create només per admin de l'org o superadmin
      // Validació: cal que organizationId i createdBy siguin correctes
      allow create: if isSuperAdmin()
        || (isSignedIn()
            && isAdminOf(request.resource.data.organizationId)
            && request.resource.data.createdBy == request.auth.uid
            && request.resource.data.keys().hasAll(['organizationId', 'email', 'role', 'createdBy', 'createdAt', 'expiresAt'])
            && request.resource.data.role in ['admin', 'user', 'viewer']);

      // P0 FIX: update només per creador, admin de l'org, o superadmin
      // O l'usuari convidat pot marcar-la com usada (acceptar invitació)
      // P1 FIX: Blindat amb immutabilitat i validació de usedBy
      allow update: if isSuperAdmin()
        || (isSignedIn() && resource.data.createdBy == request.auth.uid)
        || (isSignedIn() && isAdminOf(resource.data.organizationId))
        // Acceptació d'invitació: només el convidat pot marcar-la
        || (isSignedIn()
            // L'email ha de coincidir
            && resource.data.email == request.auth.token.email
            // Invitació no usada
            && resource.data.usedAt == null
            // Marcar com usada
            && request.resource.data.usedAt != null
            // usedBy ha de ser l'UID de l'usuari autenticat
            && request.resource.data.usedBy == request.auth.uid
            // Només afectar camps permesos
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedAt', 'usedBy'])
            // IMMUTABILITAT: camps crítics no poden canviar
            && request.resource.data.organizationId == resource.data.organizationId
            && request.resource.data.email == resource.data.email
            && request.resource.data.role == resource.data.role
            && request.resource.data.createdBy == resource.data.createdBy);

      // Delete: creador, admin de l'org, o superadmin
      allow delete: if isSuperAdmin()
        || (isSignedIn() && resource.data.createdBy == request.auth.uid)
        || (isSignedIn() && isAdminOf(resource.data.organizationId));
    }

    // ═══════════════════════════════════════════════════════════════════════
    // ORGANITZACIONS
    // ═══════════════════════════════════════════════════════════════════════

    match /organizations/{orgId} {
      // Llegir: membres o usuaris amb l'org al perfil
      allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
      
      // Crear: només Super Admin
      allow create: if isSuperAdmin();
      
      // Actualitzar: admins de l'org o Super Admin
      allow update: if isAdminOf(orgId) || isSuperAdmin();
      
      // Eliminar: només Super Admin
      allow delete: if isSuperAdmin();

      // ─────────────────────────────────────────────────────────────────────
      // MEMBRES de l'organització
      // P0 FIX: Eliminat self-join - només admin/superadmin poden crear membres
      // El flux d'invitació crea el membre via acceptació d'invitació vàlida
      // ─────────────────────────────────────────────────────────────────────

      match /members/{memberId} {
        allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
        // P0 FIX: Només admin de l'org o superadmin poden crear membres
        // Self-join eliminat per evitar escalada de privilegis cross-org
        // P1 FIX: El rol del membre ha de derivar de la invitació (client no pot triar)
        allow create: if isAdminOf(orgId) || isSuperAdmin()
          // Excepció: permetre self-create NOMÉS si existeix una invitació vàlida
          // amb el mateix email i orgId, i l'usuari s'està afegint ell mateix
          || (isSignedIn()
              && request.auth.uid == memberId
              // Invitació ha d'existir
              && exists(/databases/$(database)/documents/invitations/$(request.resource.data.invitationId))
              // orgId ha de coincidir
              && get(/databases/$(database)/documents/invitations/$(request.resource.data.invitationId)).data.organizationId == orgId
              // email ha de coincidir
              && get(/databases/$(database)/documents/invitations/$(request.resource.data.invitationId)).data.email == request.auth.token.email
              // Invitació no usada
              && get(/databases/$(database)/documents/invitations/$(request.resource.data.invitationId)).data.usedAt == null
              // ROL DERIVAT: el rol del membre HA de ser el de la invitació (client no pot triar)
              && request.resource.data.role == get(/databases/$(database)/documents/invitations/$(request.resource.data.invitationId)).data.role
              // Camps permesos (evita que el client afegeixi camps arbitraris)
              // Nota: userId, joinedAt són camps del client actual
              && request.resource.data.keys().hasOnly(['role', 'invitationId', 'email', 'displayName', 'photoURL', 'userId', 'joinedAt']));
        allow update, delete: if isAdminOf(orgId) || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // TRANSACCIONS
      // P1 FIX: Validació mínima de camps crítics per integritat de saldos
      // ─────────────────────────────────────────────────────────────────────

      match /transactions/{transactionId} {
        allow read: if isSuperAdmin() || isMemberOf(orgId);

        // P1 FIX: Validació de camps crítics
        // Fase 1: Només valida tipus (amount és number, date és string)
        // No bloqueja camps opcionals per compatibilitat amb UI existent
        allow create: if isSuperAdmin()
          || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']
              // VALIDACIÓ MÍNIMA: camps obligatoris existeixen
              && request.resource.data.keys().hasAll(['amount', 'date', 'description'])
              // VALIDACIÓ DE TIPUS: amount ha de ser número
              && request.resource.data.amount is number
              // VALIDACIÓ: amount no pot ser NaN (implícit amb is number)
          );

        // Update: més permissiu per no trencar edicions parcials
        // Però validem que amount segueixi sent number si es modifica
        allow update: if isSuperAdmin()
          || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']
              // Si s'actualitza amount, ha de ser number
              && (!('amount' in request.resource.data) || request.resource.data.amount is number)
          );

        allow delete: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);
      }

      // ─────────────────────────────────────────────────────────────────────
      // CATEGORIES
      // GUARDRAIL v1.35: Prohibit delete físic, camps d'arxivat només via API
      // ─────────────────────────────────────────────────────────────────────

      match /categories/{categoryId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create: if isAdminOf(orgId) || isSuperAdmin();

        // UPDATE: bloquejar modificació directa de camps d'arxivat
        // Només l'API (Admin SDK) pot escriure aquests camps
        // GUARDRAIL: Ni tan sols SuperAdmin pot via client (arxivat sempre via API)
        // NOTA: .get(field, null) per documents antics que no tenen camps d'arxivat
        allow update: if (isAdminOf(orgId) || isSuperAdmin())
          && (
            request.resource.data.get('archivedAt', null) == resource.data.get('archivedAt', null)
            && request.resource.data.get('archivedByUid', null) == resource.data.get('archivedByUid', null)
            && request.resource.data.get('archivedFromAction', null) == resource.data.get('archivedFromAction', null)
          );

        // DELETE FÍSIC: PROHIBIT (integritat referencial)
        allow delete: if false;
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROJECTES (Eixos d'actuació)
      // GUARDRAIL v1.35: Prohibit delete físic, camps d'arxivat només via API
      // ─────────────────────────────────────────────────────────────────────

      match /projects/{projectId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();

        // UPDATE: només admin (no user) + bloquejar modificació directa de camps d'arxivat
        // GUARDRAIL: Ni tan sols SuperAdmin pot via client (arxivat sempre via API)
        // NOTA: .get(field, null) per documents antics que no tenen camps d'arxivat
        allow update: if (isAdminOf(orgId) || isSuperAdmin())
          && (
            request.resource.data.get('archivedAt', null) == resource.data.get('archivedAt', null)
            && request.resource.data.get('archivedByUid', null) == resource.data.get('archivedByUid', null)
            && request.resource.data.get('archivedFromAction', null) == resource.data.get('archivedFromAction', null)
          );

        // DELETE FÍSIC: PROHIBIT (integritat referencial)
        allow delete: if false;
      }

      // ─────────────────────────────────────────────────────────────────────
      // CONTACTES (unificat: donants + proveïdors)
      // FIX: Funcions inline per evitar falsos negatius en avaluació de rules
      // ─────────────────────────────────────────────────────────────────────

      match /contacts/{contactId} {
        // Funcions inline per evitar problemes d'avaluació en cadena
        function isOrgMemberDirect() {
          return request.auth != null &&
            exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
        }

        function isSuperAdminDirect() {
          return request.auth != null &&
            exists(/databases/$(database)/documents/systemSuperAdmins/$(request.auth.uid));
        }

        function canWriteContacts() {
          return isSuperAdminDirect()
            || (isOrgMemberDirect() &&
                get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role in ['admin', 'user']);
        }

        allow read: if isOrgMemberDirect() || isSuperAdminDirect();
        allow create: if canWriteContacts();

        // UPDATE: bloquejar modificació directa de camps de desactivació
        // Només l'API (Admin SDK) pot escriure aquests camps
        // GUARDRAIL v1.36: evitar desactivació directa via client
        // NOTA: .get(field, null) per documents antics que no tenen camps d'arxivat
        allow update: if canWriteContacts()
          && (
            request.resource.data.get('archivedAt', null) == resource.data.get('archivedAt', null)
            && request.resource.data.get('archivedByUid', null) == resource.data.get('archivedByUid', null)
            && request.resource.data.get('archivedFromAction', null) == resource.data.get('archivedFromAction', null)
          );

        // DELETE FÍSIC: PROHIBIT (integritat referencial)
        allow delete: if false;
      }

      // ─────────────────────────────────────────────────────────────────────
      // DONANTS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /donors/{donorId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROVEÏDORS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /suppliers/{supplierId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // EMISSORS (legacy - mantenir per compatibilitat)
      // ─────────────────────────────────────────────────────────────────────

      match /emissors/{emissorId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // COMPTES BANCARIS
      // GUARDRAIL v1.36: Prohibit delete físic, camps d'arxivat només via API
      // ─────────────────────────────────────────────────────────────────────

      match /bankAccounts/{bankAccountId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create: if isAdminOf(orgId) || isSuperAdmin();

        // UPDATE: bloquejar modificació directa de camps d'arxivat
        // Només l'API (Admin SDK) pot escriure aquests camps
        // GUARDRAIL: Ni tan sols SuperAdmin pot via client (arxivat sempre via API)
        // NOTA: .get(field, null) per documents antics que no tenen camps d'arxivat
        allow update: if (isAdminOf(orgId) || isSuperAdmin())
          && (
            request.resource.data.get('archivedAt', null) == resource.data.get('archivedAt', null)
            && request.resource.data.get('archivedByUid', null) == resource.data.get('archivedByUid', null)
            && request.resource.data.get('archivedFromAction', null) == resource.data.get('archivedFromAction', null)
          );

        // DELETE FÍSIC: PROHIBIT (integritat referencial)
        allow delete: if false;
      }

      // ─────────────────────────────────────────────────────────────────────
      // HISTÒRIC D'IMPORTACIONS (importRuns)
      // Col·lecció de logs operatius: només admins poden crear/llegir
      // ─────────────────────────────────────────────────────────────────────

      match /importRuns/{runId} {
        // Read per veure històric i obtenir "últim importRun"
        allow read: if isSuperAdmin() || isAdminOf(orgId);

        // Create només per admins (i superadmin)
        // (és un log operatiu: ha de ser fiable, no writable per qualsevol user)
        allow create: if isSuperAdmin() || isAdminOf(orgId);

        // No cal update/delete des del client
        allow update, delete: if false;
      }

      // ─────────────────────────────────────────────────────────────────────
      // CONFIGURACIONS DE REMESES
      // ─────────────────────────────────────────────────────────────────────

      match /remittanceMappings/{mappingId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user'] || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // AUDIT LOGS (només Super Admin)
      // ─────────────────────────────────────────────────────────────────────

      match /audit_logs/{logId} {
        // Llegir: només Super Admin
        allow read: if isSuperAdmin();
        // Crear: qualsevol membre autenticat (el sistema crea logs)
        allow create: if isMemberOf(orgId) || isSuperAdmin();
        // Actualitzar/Eliminar: només Super Admin
        allow update, delete: if isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // EXPORTS (feed només lectura per clients; escriptura només backend)
      // Estructura: /organizations/{orgId}/exports/{exportType}/items/{id}
      // ─────────────────────────────────────────────────────────────────────

      match /exports/{exportType} {
        // (Opcional) llegir el document "exportType" si existeix
        allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
        allow write: if false;

        match /items/{itemId} {
          // El nou mòdul pot llegir el feed si és membre de l'org
          allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();

          // Cap client pot escriure exports
          allow create, update, delete: if false;
        }
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROJECT MODULE (Projectes) — lectura/escriptura per membres de l'org
      // Path: /organizations/{orgId}/projectModule/...
      // ─────────────────────────────────────────────────────────────────────

      match /projectModule/{document=**} {
        allow read: if isMemberOf(orgId) || hasOrgInProfile(orgId) || isSuperAdmin();
        allow write: if (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']) || isSuperAdmin();
      }

      // ─────────────────────────────────────────────────────────────────────
      // LIQUIDACIONS (expense reports)
      // Path: /organizations/{orgId}/expenseReports/{reportId}
      // Updated: 2026-02-01 - FASE 2C: Guardrails d'integritat
      // ─────────────────────────────────────────────────────────────────────

      match /expenseReports/{reportId} {
        allow read: if isSuperAdmin() || isMemberOf(orgId) || hasOrgInProfile(orgId);
        allow create: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);

        // UPDATE: bloquejar transició a 'archived' i camps de traça des de client
        // Només l'API (Admin SDK) pot arxivar amb validació de tiquets
        allow update: if (isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']))
          && (
            // Si l'estat canvia a 'archived', només via API
            request.resource.data.status != 'archived' || resource.data.status == 'archived'
          )
          && (
            // Camps de traça d'arxivat: no es poden modificar des de client
            // NOTA: .get(field, null) per documents antics que no tenen camps d'arxivat
            request.resource.data.get('archivedAt', null) == resource.data.get('archivedAt', null)
            && request.resource.data.get('archivedByUid', null) == resource.data.get('archivedByUid', null)
            && request.resource.data.get('archivedFromAction', null) == resource.data.get('archivedFromAction', null)
          );

        // DELETE FÍSIC: PROHIBIT (v1.36)
        allow delete: if false;
      }

      // ─────────────────────────────────────────────────────────────────────
      // DOCUMENTS PENDENTS DE CONCILIACIÓ
      // Path: /organizations/{orgId}/pendingDocuments/{docId}
      // Nota: Aquests documents NO afecten saldos ni fiscalitat fins a match
      // Updated: 2025-12-28
      // ─────────────────────────────────────────────────────────────────────

      match /pendingDocuments/{docId} {
        allow read: if isSuperAdmin() || isMemberOf(orgId) || hasOrgInProfile(orgId);
        allow create, update, delete: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);
      }

      // ─────────────────────────────────────────────────────────────────────
      // REMESES (per a SEPA i altres operacions de pagament en bloc)
      // Path: /organizations/{orgId}/remittances/{remittanceId}
      // ─────────────────────────────────────────────────────────────────────

      match /remittances/{remittanceId} {
        allow read: if isMemberOf(orgId) || isSuperAdmin();
        allow create, update, delete: if (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']) || isSuperAdmin();

        // Subcol·lecció per ítems pendents de remesa (sense taxId vàlid, etc.)
        match /pending/{pendingId} {
          allow read: if isMemberOf(orgId) || isSuperAdmin();
          allow create, update, delete: if (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']) || isSuperAdmin();
        }
      }

      // ─────────────────────────────────────────────────────────────────────
      // PREBANK REMITTANCES (remeses pendents de conciliar amb el banc)
      // Path: /organizations/{orgId}/prebankRemittances/{remittanceId}
      // ─────────────────────────────────────────────────────────────────────

      match /prebankRemittances/{remittanceId} {
        allow read: if isSuperAdmin() || isMemberOf(orgId) || hasOrgInProfile(orgId);
        allow create, update, delete: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);
      }

      // ─────────────────────────────────────────────────────────────────────
      // INTEGRACIONS (backups, OAuth, etc.)
      // Path: /organizations/{orgId}/integrations/{integrationId}
      // FIX: hasOrgInProfile afegit per permetre lectura durant inicialització
      // ─────────────────────────────────────────────────────────────────────

      match /integrations/{integrationId} {
        // Read: membre, perfil amb org, o superadmin
        allow read: if isSuperAdmin() || isMemberOf(orgId) || hasOrgInProfile(orgId);
        // Write: només admin de l'org o superadmin
        allow create, update, delete: if isSuperAdmin() || isAdminOf(orgId);

        // Subcol·lecció per OAuth requests
        match /backupOAuthRequests/{requestId} {
          allow read: if isSuperAdmin() || isMemberOf(orgId) || hasOrgInProfile(orgId);
          allow create, update, delete: if isSuperAdmin() || isAdminOf(orgId);
        }
      }

      // ─────────────────────────────────────────────────────────────────────
      // ONBOARDING (configuració inicial)
      // Path: /organizations/{orgId}/onboarding/{docId}
      // ─────────────────────────────────────────────────────────────────────

      match /onboarding/{docId} {
        allow read: if isSuperAdmin() || isMemberOf(orgId) || hasOrgInProfile(orgId);
        allow create, update, delete: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);
      }

      // ─────────────────────────────────────────────────────────────────────
      // SEPA COLLECTION RUNS (log operatiu de remeses pain.008)
      // Path: /organizations/{orgId}/sepaCollectionRuns/{runId}
      // ─────────────────────────────────────────────────────────────────────

      match /sepaCollectionRuns/{runId} {
        allow read: if isSuperAdmin() || isMemberOf(orgId);
        allow create: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);
        allow update, delete: if false;
      }

      // ─────────────────────────────────────────────────────────────────────
      // SEPA PAIN.008 RUNS (registre operatiu de remeses pain.008)
      // Path: /organizations/{orgId}/sepaPain008Runs/{runId}
      // ─────────────────────────────────────────────────────────────────────

      match /sepaPain008Runs/{runId} {
        allow read: if isSuperAdmin() || isMemberOf(orgId);
        allow create: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);
        allow update, delete: if false;
      }

      // ─────────────────────────────────────────────────────────────────────
      // PROCESS LOCKS (bloqueig per operacions multiusuari)
      // Path: /organizations/{orgId}/processLocks/{lockId}
      // Permisos: admin/user poden crear/llegir/esborrar locks
      // Viewer NO pot bloquejar processos
      // ─────────────────────────────────────────────────────────────────────

      match /processLocks/{lockId} {
        allow read, create, update, delete: if isSuperAdmin() || (isMemberOf(orgId) && getMemberRole(orgId) in ['admin', 'user']);
      }

      // ─────────────────────────────────────────────────────────────────────
      // SUPPORT BOT QUESTIONS (learning system)
      // Path: /organizations/{orgId}/supportBotQuestions/{questionId}
      // INVARIANT: escriptura NOMÉS via Admin SDK (API routes), mai client-side
      // ─────────────────────────────────────────────────────────────────────

      match /supportBotQuestions/{questionId} {
        allow read: if isSuperAdmin() ||
                     (isMemberOf(orgId) &&
                      getMemberRole(orgId) in ['admin', 'user']);
        allow write: if false;
      }
    }
  }
}